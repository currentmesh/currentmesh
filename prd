# Versa Insurance CRM - Complete PRD and Associated Files
# This file contains all .ai directory files for copy-paste



# ============================================
# PRD (Product Requirements Document)
# ============================================

# Product Requirements Document (PRD)
## Versa Insurance Agency CRM with AI Agent

**Status**: `draft`  
**Version**: 1.39  
**Created**: 2025-01-13  
**Last Updated**: 2025-01-27 (Carrier Management Refactor - Business Line Separation)
**Owner**: Mario Alasu  
**Domain**: crm.versainsuranceagency.com

---

## Executive Summary

**üéØ Project Status**: 16 of 17 Epics Complete | Production Ready  
**üöÄ Current Focus**: All Core Epics Complete - System Fully Operational  
**üí∞ Business Impact**: 20+ minutes saved per consultation, 91.8%+ AI accuracy  
**üìà Success Metrics**: Multi-line insurance CRM with AI agent fully deployed

### Epic Dependency Graph

The following diagram shows relationships and dependencies between all epics. Use this to understand build order, integration points, and feature dependencies.

```mermaid
graph TB
    %% Foundation Layer
    E1[Epic 1: Core CRM Foundation<br/>‚úÖ Complete]
    
    %% Core Features Layer
    E2[Epic 2: AI Agent Integration<br/>‚úÖ Complete]
    E3[Epic 3: Client Portal<br/>‚úÖ Complete]
    E6[Epic 6: Review Management<br/>‚úÖ Complete]
    E7[Epic 7: Calendar System<br/>‚úÖ Complete]
    E8[Epic 8: Georgia Health Data<br/>‚úÖ Complete]
    E12[Epic 12: Docusend E-Signature<br/>‚úÖ Complete]
    
    %% Platform Layer
    E4[Epic 4: Multi-Tenant SaaS<br/>‚úÖ Complete]
    E5[Epic 5: Advanced Features<br/>‚úÖ Complete]
    
    %% Enhancement Layer
    E10[Epic 10: Mantis Design Upgrade<br/>üöß In Progress]
    E9[Epic 9: After-Hours Booking<br/>‚è≥ Future]
    E11[Epic 11: Medicare SOA Automation<br/>üöß In Progress]
    
    %% Marketing Layer
    E13[Epic 13: Autopilot Lead Outreach<br/>‚è≥ Future]
    E14[Epic 14: Facebook Ads<br/>‚úÖ Complete]
    E15[Epic 15: LinkedIn Ads<br/>‚úÖ Complete]
    E16[Epic 16: Google Ads<br/>‚úÖ Complete]
    E17[Epic 17: Bing Ads<br/>‚úÖ Complete]
    E18[Epic 18: TikTok Ads<br/>‚úÖ Complete]
    E19[Epic 19: Twitter Ads<br/>‚úÖ Complete]
    E20[Epic 20: Reddit Ads<br/>‚úÖ Complete]
    E21[Epic 21: Pinterest Ads<br/>‚úÖ Complete]
    
    %% Infrastructure Layer
    E22[Epic 22: IVR System<br/>‚è≥ Future]
        E23[Epic 23: Lob Direct Mail System<br/>‚úÖ Complete]
    E24[Epic 24: Brevo Email Campaign<br/>‚úÖ Complete]
    
    %% Foundation Dependencies
    E1 --> E2
    E1 --> E3
    E1 --> E4
    E1 --> E5
    E1 --> E6
    E1 --> E7
    E1 --> E8
    E1 --> E10
    E1 --> E12
    E1 --> E13
    E1 --> E14
    E1 --> E15
    E1 --> E16
    E1 --> E17
    E1 --> E18
    E1 --> E19
    E1 --> E20
    E1 --> E21
    E1 --> E22
    E1 --> E23
    E1 --> E24
    
    %% Core Feature Dependencies
    E2 --> E5
    E2 --> E11
    E2 --> E13
    E2 --> E22
    
    %% Calendar Dependencies
    E7 --> E3
    E7 --> E9
    E7 --> E11
    E7 --> E13
    
    %% E-Signature Dependencies
    E12 --> E11
    
    %% Multi-Tenant Dependencies
    E6 --> E4
    
    %% Design System (affects all)
    E10 -.->|Upgrades| E3
    E10 -.->|Upgrades| E6
    E10 -.->|Upgrades| E7
    
    %% Marketing Dependencies
    E14 --> E13
    E15 --> E13
    E16 --> E13
    E17 --> E13
    E18 --> E13
    E19 --> E13
    E20 --> E13
    E21 --> E13
    
    %% Styling
    classDef foundation fill:#2563eb,stroke:#1e40af,stroke-width:3px,color:#fff
    classDef complete fill:#10b981,stroke:#059669,stroke-width:2px,color:#fff
    classDef inProgress fill:#f59e0b,stroke:#d97706,stroke-width:2px,color:#fff
    classDef future fill:#6b7280,stroke:#4b5563,stroke-width:2px,color:#fff
    
    class E1 foundation
    class E2,E3,E4,E5,E6,E7,E8,E12,E14,E15,E16,E17,E18,E19,E20,E21,E23 complete
    class E10,E11 inProgress
    class E9,E13,E22 future
```

**Legend:**
- **Solid arrows (‚Üí)**: Direct dependency (Epic B requires Epic A)
- **Dashed arrows (-.->)**: Enhancement/upgrade relationship (Epic B enhances Epic A)
- **Foundation (Blue)**: Core infrastructure that all epics depend on
- **Complete (Green)**: Fully implemented and in production
- **In Progress (Orange)**: Currently being developed
- **Future (Gray)**: Planned but not yet started

**Key Dependency Patterns:**
- **Foundation First**: [[Epic 1: Core CRM Foundation]] is required by all other epics
- **Calendar Integration**: [[Epic 7: Calendar Scheduling System]] enables multiple features (Portal, SOA, Autopilot)
- **Marketing Suite**: All ads integrations (Epic 14-21) enable [[Epic 13: Autopilot Lead Outreach App]]
- **Design System**: [[Epic 10: Mantis Design System Upgrade]] enhances UI across multiple epics
- **E-Signature Chain**: [[Epic 12: Docusend E-Signature System]] enables [[Epic 11: Medicare SOA Automation]]

### Quick Status Overview
| Epic | Status | Key Achievement | Dependencies |
|------|--------|----------------|--------------|
| [[Epic 1: Core CRM Foundation]] | ‚úÖ Complete | Full client management system | Foundation |
| [[Epic 2: AI Agent Integration]] | ‚úÖ Complete | 91.8%+ field extraction accuracy | [[Epic 1]] |
| [[Epic 3: Client Portal]] | ‚úÖ Complete | Self-service portal deployed | [[Epic 1]], [[Epic 7]] |
| [[Epic 4: Multi-Tenant SaaS Platform]] | ‚úÖ Complete | SaaS platform ready | [[Epic 1]], [[Epic 6]] |
| [[Epic 5: Advanced Features]] | ‚úÖ Complete | Plan recommendations & analytics | [[Epic 1]], [[Epic 2]] |
| [[Epic 6: Review Management System]] | ‚úÖ Complete | HIPAA compliant, all security fixes | [[Epic 1]] |
| [[Epic 7: Calendar Scheduling System]] | ‚úÖ Complete | Full scheduling & booking system | [[Epic 1]] |
| [[Epic 8: Georgia Health Data]] | ‚úÖ Complete | State-specific data integration | [[Epic 1]] |
| [[Epic 9: After-Hours Booking Slots]] | ‚è≥ Future | Premium booking slots for full schedules | [[Epic 7]] |
| [[Epic 10: Mantis Design System Upgrade]] | üöß In Progress | Modern, responsive UI/UX upgrade | [[Epic 1]] |
| [[Epic 11: Medicare SOA Automation]] | üöß In Progress | Automated Scope of Appointment workflow | [[Epic 1]], [[Epic 7]], [[Epic 12]] |
| [[Epic 12: Docusend E-Signature System]] | ‚úÖ Complete | Full e-signature system with PDF manipulation | [[Epic 1]] |
| [[Epic 13: Autopilot Lead Outreach App]] | ‚è≥ Future | Automated SMS marketing to ad leads | [[Epic 1]], [[Epic 2]], [[Epic 7]], [[Epic 14-21]] |
| [[Epic 14: Facebook Ads Integration]] | ‚úÖ Complete | Full Facebook Marketing API integration | [[Epic 1]] |
| [[Epic 15: LinkedIn Ads Integration]] | ‚úÖ Complete | Full LinkedIn Marketing API integration | [[Epic 1]] |
| [[Epic 16: Google Ads Integration]] | ‚úÖ Complete | Full Google Ads API integration | [[Epic 1]] |
| [[Epic 17: Bing Ads Integration]] | ‚úÖ Complete | Full Microsoft Advertising API integration | [[Epic 1]] |
| [[Epic 18: TikTok Ads Integration]] | ‚úÖ Complete | Full TikTok Ads API integration | [[Epic 1]] |
| [[Epic 19: Twitter Ads Integration]] | ‚úÖ Complete | Full X (Twitter) Ads API integration | [[Epic 1]] |
| [[Epic 20: Reddit Ads Integration]] | ‚úÖ Complete | Full Reddit Ads API integration | [[Epic 1]] |
| [[Epic 21: Pinterest Ads Integration]] | ‚úÖ Complete | Full Pinterest Ads API integration | [[Epic 1]] |
| [[Epic 24: Brevo Email Campaign Integration]] | ‚úÖ Complete | Full Brevo API integration for email marketing campaigns | [[Epic 1]] |
| [[Epic 22: IVR System]] | ‚è≥ Future | Automated call routing with menu system | [[Epic 1]], [[Epic 2]] |
| [[Epic 23: Lob Direct Mail System]] | ‚úÖ Complete | Full direct mail campaign management with templates, scheduling, and response tracking | [[Epic 1]] |

### Key Deliverables Completed
- ‚úÖ **Multi-line Insurance CRM** supporting Medicare, Health, Life, Group Benefits, Commercial
- ‚úÖ **AI-Powered Conversation Processing** with real-time field extraction
- ‚úÖ **Client Self-Service Portal** with plan summaries and document management
- ‚úÖ **Calendar Scheduling System** with booking pages and appointment management
- ‚úÖ **Multi-Tenant SaaS Platform** ready for scaling to multiple agencies
- ‚úÖ **Security & Compliance** with HIPAA compliance and comprehensive security fixes

---

## 1. Project Overview

### 1.1 Vision Statement
Build a comprehensive, AI-powered multi-line insurance CRM system that revolutionizes how insurance agents manage client relationships across all lines of business (Medicare, Health Insurance, Life Insurance, Group Benefits, Commercial). The system automates data entry, provides real-time AI assistance during calls, ensures regulatory compliance, and scales from single-agency to multi-tenant SaaS platform.

### 1.2 Project Goals
- **Streamline Operations**: Save 20+ minutes per client consultation through automation
- **Improve Accuracy**: Never lose client information with AI-powered extraction
- **Increase Conversions**: Better plan recommendations through intelligent matching
- **Ensure Compliance**: Automatic CMS rule checking and regulatory compliance
- **Scale Business**: Support multiple agents and agencies with multi-tenant architecture

### 1.3 Success Metrics
**Target Metrics (Aspirational - Baseline TBD):**
- **Time Savings**: 20+ minutes saved per client consultation (baseline: TBD)
- **Data Accuracy**: 95%+ accuracy in AI field extraction (current: 91.8%+)
- **Conversion Rate**: 15%+ improvement in plan enrollment (baseline: TBD)
- **User Satisfaction**: 90%+ agent satisfaction score (baseline: TBD)
- **System Uptime**: 99.9% availability (baseline: TBD)

**Note**: Baseline metrics will be established after 30 days of production use. Current AI extraction accuracy is 91.8%+ based on 28/28 fields supported.

### 1.4 Project Scope
**In Scope:**
- **Multi-Line Insurance CRM**: Single platform managing all insurance lines of business
  - Medicare (65+)
  - Health Insurance (Individual & Family Plans / IFP)
  - Life Insurance
  - Group Benefits
  - Commercial
- Single-agency CRM (current phase)
- AI-powered conversation processing across all business lines
- Real-time plan recommendations for all insurance types
- Client portal supporting all lines of business (in progress)
- Multi-tenant SaaS platform (future)

**Out of Scope:**
- Mobile native apps (web-responsive only)
- Email marketing automation (future consideration)
- Advanced analytics dashboard (future consideration)
- Third-party integrations beyond Twilio, OpenAI, SendGrid

---

## 2. Business Requirements

### 2.1 Business Objectives
1. **Automate Client Data Entry**: AI extracts and types client information during conversations across all lines of business
2. **Real-Time Assistance**: AI provides suggestions, questions, and recommendations during calls
3. **Plan Matching**: Intelligent algorithm matches clients to best-fit plans (Medicare, Health Insurance, Life, Group Benefits, Commercial)
4. **Compliance Assurance**: Automatic regulatory compliance checking (CMS rules for Medicare, state regulations for other lines)
5. **Client Self-Service**: Client portal for viewing plans, documents, and scheduling across all business lines
6. **Multi-Line Management**: Single CRM platform managing all insurance lines of business

### 2.2 Target Users

#### Primary User: Insurance Agent (Mario Alasu)
- **Needs**: Quick client lookup, hands-free data entry, real-time plan recommendations
- **Pain Points**: Manual data entry, missing client information, compliance concerns
- **Goals**: Save time, increase conversions, ensure compliance

#### Secondary User: Agency Admin
- **Needs**: Team management, performance metrics, subscription management
- **Pain Points**: Manual reporting, lack of visibility
- **Goals**: Scale operations, track performance

#### Future User: Client (Portal)
- **Needs**: View plan details, access documents, schedule appointments
- **Pain Points**: Calling agent for simple questions
- **Goals**: Self-service access to information

### 2.3 Business Rules
- All client data must be HIPAA compliant
- Conversations must be securely stored and encrypted
- AI recommendations are advisory only (agent makes final decisions)
- CMS compliance is mandatory for all recommendations
- Data retention policies must be maintained
- Multi-tenant data isolation required (future)

---

## 3. User Personas

### 3.1 Primary Persona: Insurance Agent
**Name**: Mario Alasu  
**Role**: Multi-Line Insurance Agent (Medicare, Health Insurance, Life, Group Benefits, Commercial)  
**Experience**: 10+ years  
**Tech Comfort**: Moderate

**Goals:**
- Quickly find client information during calls across all business lines
- Capture client details without typing
- Get real-time plan recommendations for any line of business
- Ensure regulatory compliance (CMS for Medicare, state regulations for others)
- Manage clients across multiple insurance lines in one platform

**Frustrations:**
- Manual data entry takes too long
- Missing client information during calls
- Uncertainty about plan recommendations
- Compliance concerns

**How CRM Helps:**
- Instant client lookup by phone number
- AI automatically extracts and types client info
- Real-time plan recommendations with reasoning
- Automatic compliance checking

### 3.2 Secondary Persona: Agency Admin
**Name**: Future Agency Manager  
**Role**: Agency Administrator  
**Experience**: 5+ years  
**Tech Comfort**: High

**Goals:**
- Manage team of agents
- Track performance metrics
- Manage subscriptions and billing
- Ensure data security

**Frustrations:**
- Manual reporting
- Lack of visibility into agent performance
- Complex billing management

**How CRM Helps:**
- Automated performance reports
- Team management dashboard
- Subscription management interface
- Audit logging and compliance tracking

### 3.3 Future Persona: Client
**Name**: Insurance Client  
**Role**: Client across any line of business (Medicare, Health Insurance, Life, Group Benefits, Commercial)  
**Experience**: Varies  
**Tech Comfort**: Low to Moderate

**Goals:**
- View plan details and benefits for their coverage
- Access important documents (policy documents, enrollment forms, etc.)
- Schedule appointments with their agent
- Update personal information
- View enrolled family members and coverage details

**Frustrations:**
- Calling agent for simple questions
- Lost documents
- Difficulty scheduling appointments
- Not knowing what coverage they have

**How CRM Helps:**
- Self-service portal with all information across all lines of business
- Document storage and access
- Integrated scheduling
- Easy information updates
- Plan summary dashboard showing Health, Dental, Vision coverage

---

## 4. Success Criteria

### 4.1 Functional Requirements
- ‚úÖ **Client Management**: Full CRUD operations for clients
- ‚úÖ **Phone Lookup**: Instant client lookup by phone number
- ‚úÖ **AI Extraction**: 28+ fields automatically extracted from conversations
- ‚úÖ **Real-Time Processing**: AI processes conversations every 5-10 seconds
- üöß **Plan Recommendations**: Database tables ready, AI mentions plans in conversations, but formal "top 3 with reasoning" recommendation engine not yet implemented (Epic 5)
- ‚úÖ **Multi-Business Lines**: Support Medicare, Health Insurance, Life, Group Benefits, Commercial
- üöß **Client Portal**: Backend API complete, frontend application not yet created
- ‚è≥ **Multi-Tenant**: Support multiple agencies with data isolation

### 4.2 Performance Requirements
- **Page Load**: < 2 seconds
- **API Response**: < 500ms
- **AI Processing**: < 5 seconds for real-time extraction
- **Database Queries**: < 100ms for client lookup
- **Concurrent Users**: Support 50+ concurrent users
- **Uptime**: 99.9% availability

### 4.3 Security Requirements
- **HIPAA Compliance**: All PHI encrypted at rest and in transit
- **Authentication**: JWT-based with refresh tokens
- **Authorization**: Role-based access control (admin, agent, client)
- **Audit Logging**: All PHI access logged
- **Data Isolation**: Strict tenant/client isolation
- **Encryption**: TLS 1.2+ for all connections

### 4.4 User Experience Requirements
- **Intuitive Interface**: No training required
- **Mobile Responsive**: Works on tablet and mobile devices
- **Real-Time Updates**: No page refresh needed
- **Accessible**: WCAG 2.1 AA compliance
- **Fast Interactions**: < 100ms response to user actions

---

## 5. Technical Requirements

### 5.1 Technology Stack

#### Frontend
- **Framework**: React 19
- **Build Tool**: Vite
- **UI Library**: Mantine 8.3.6
- **Routing**: React Router DOM
- **Styling**: Tailwind CSS
- **Forms**: Mantine Form (with built-in validation)
- **Icons**: Tabler Icons React
- **Voice**: Twilio Voice SDK
- **Real-Time**: Socket.io Client

#### Backend
- **Runtime**: Node.js 18+
- **Framework**: Express.js
- **Language**: TypeScript
- **Database**: Neon PostgreSQL (cloud)
- **ORM**: Direct SQL queries (no ORM)
- **Authentication**: JWT + bcrypt
- **Process Manager**: PM2

#### AI Services
- **Primary**: Google Gemini 2.5 Flash (50% cost savings)
- **Fallback**: OpenAI GPT-4o-mini
- **Speech-to-Text**: OpenAI Whisper API
- **Voice**: Twilio Voice SDK
- **Email**: SendGrid

#### Infrastructure
- **Hosting**: DigitalOcean Droplet (Ubuntu)
- **Domain**: crm.versainsuranceagency.com
- **SSL**: Let's Encrypt
- **Backups**: Automated to Dropbox
- **Monitoring**: PM2 monitoring

### 5.2 Database Architecture

#### Current: Single Database (Database 1)
**Status**: ‚úÖ Active  
**Purpose**: Current agency's CRM data  
**Tables**: users, clients, conversations, conversation_messages, client_health_info, commissions, etc.

#### Future: Multi-Tenant (3 Databases)
**Status**: ‚è≥ Planned  
**Database 2**: Agencies management (agencies, subscriptions, audit_logs)  
**Database 3**: Multi-tenant client data (clients, commissions, conversations with agency_id)

### 5.3 API Endpoints

#### Authentication
- `POST /api/auth/login` - User login
- `POST /api/auth/register` - User registration
- `GET /api/auth/me` - Get current user
- `POST /api/auth/refresh` - Refresh JWT token
- `POST /api/auth/logout` - Logout

#### Clients
- `GET /api/clients` - List clients (with pagination, search, filter)
- `GET /api/clients/:id` - Get client details
- `POST /api/clients` - Create new client
- `PUT /api/clients/:id` - Update client
- `DELETE /api/clients/:id` - Delete client
- `GET /api/clients/search?phone=...` - Search by phone (instant lookup)
- `GET /api/clients/:id/conversations` - Get conversation history

#### Conversations
- `POST /api/conversations` - Start new conversation
- `GET /api/conversations/:id` - Get conversation details
- `POST /api/conversations/:id/messages` - Add message
- `POST /api/conversations/:id/audio` - Process audio input

#### AI Services
- `POST /api/ai/extract-form-data` - Extract client info from conversation (28+ fields)
- `POST /api/ai/messages/suggest` - Generate AI message suggestions during conversations
- ‚è≥ `POST /api/ai/recommendations` - Get plan recommendations (Future - Epic 5)
- ‚è≥ `POST /api/ai/transcribe` - Transcribe audio to text (Future - if separate endpoint needed)

#### Calendar & Scheduling (Epic 7)

**‚úÖ Implemented Endpoints:**
- `GET /api/booking-pages` - List all booking pages for authenticated user
- `POST /api/booking-pages` - Create new booking page
- `GET /api/booking-pages/:id` - Get specific booking page with questions and event types
- `PUT /api/booking-pages/:id` - Update booking page
- `DELETE /api/booking-pages/:id` - Delete booking page
- `POST /api/booking-pages/:id/duplicate` - Duplicate booking page
- `GET /api/event-types` - List all event types for authenticated user
- `POST /api/event-types` - Create new event type
- `GET /api/event-types/:id` - Get specific event type
- `PUT /api/event-types/:id` - Update event type
- `DELETE /api/event-types/:id` - Delete event type

**‚è≥ Pending Endpoints:**
- `GET /api/calendar/appointments` - List appointments
- `POST /api/calendar/appointments` - Create appointment
- `PUT /api/calendar/appointments/:id` - Update appointment
- `DELETE /api/calendar/appointments/:id` - Cancel appointment
- `GET /api/calendar/availability` - Get agent availability
- `POST /api/calendar/availability` - Set availability
- `GET /api/calendar/availability/slots` - Get available time slots
- `GET /api/calendar/sync/status` - Get calendar sync status
- `POST /api/calendar/sync/google/authorize` - Google Calendar OAuth
- `POST /api/calendar/sync/outlook/authorize` - Outlook OAuth
- `GET /api/booking/:slug` - Get public booking page (partially implemented)
- `POST /api/booking/:slug/book` - Book appointment (public)

#### Plans (Future)
- `GET /api/plans` - List available plans
- `GET /api/plans/:id` - Get plan details
- `POST /api/plans/search` - Search plans by criteria
- `GET /api/plans/compare` - Compare multiple plans

### 5.4 Security Requirements
- **HTTPS Only**: All connections encrypted
- **JWT Authentication**: Token-based auth with refresh tokens
- **Password Hashing**: bcrypt with 10 rounds
- **SQL Injection Prevention**: Parameterized queries only
- **CORS Configuration**: Restricted to allowed origins
- **Rate Limiting**: API rate limiting on public endpoints
- **Input Validation**: All inputs validated and sanitized
- **Audit Logging**: All PHI access logged

---

## 6. Epics

### Epic 1: Core CRM Foundation
**Status**: ‚úÖ **Complete**  
**Priority**: P0 (Critical)  
**Description**: Basic CRM functionality including authentication, client management, dashboard, and multi-business line support.

**Related Epics**: Foundation for all other epics. See [[Epic 2: AI Agent Integration]], [[Epic 3: Client Portal]], [[Epic 7: Calendar Scheduling System]], [[Epic 10: Mantis Design System Upgrade]].

**Definition of "Complete"**: All core features implemented, tested, and in production use. No critical bugs blocking daily operations.

**Completed Features:**
- ‚úÖ User authentication (JWT, refresh tokens)
- ‚úÖ Client CRUD operations (Create, Read, Update, Delete)
- ‚úÖ Phone number search (instant lookup)
- ‚úÖ Dashboard with statistics
- ‚úÖ Multi-business line support (Medicare, Health Insurance, Life, Group Benefits, Commercial)
- ‚úÖ Client forms with validation (Mantine Form)
- ‚úÖ Security fixes (14/14 complete)
- ‚úÖ Call integration (Twilio)
- ‚úÖ AI message generation
- ‚úÖ Conversation tracking
- ‚úÖ 1095-A Form Integration (Covered California Consumer Delegation with HIPAA-compliant consent capture)
- ‚úÖ API Key Management (Edit functionality for business line permissions)
- ‚úÖ Client Deletion Cascade (Automatic cleanup of notifications and appointments)
- ‚úÖ Carrier Management (Five separate pages per business line: Medicare, Health Insurance, Life Insurance, Group Benefits, Commercial)

**Deliverables:**
- Working CRM with full client management
- Secure authentication system
- Multi-business line support
- Dashboard and reporting

---

### Epic 2: AI Agent Integration
**Status**: ‚úÖ **Complete**  
**Priority**: P0 (Critical)  
**Description**: Real-time AI conversation processing, field extraction, and intelligent assistance during calls.

**Related Epics**: Depends on [[Epic 1: Core CRM Foundation]]. Enables [[Epic 5: Advanced Features]] and [[Epic 11: Medicare SOA Automation]].

**Definition of "Complete"**: All core AI features implemented, tested, and in production use. AI extraction working with 91.8%+ accuracy.

**Completed Features:**
- ‚úÖ AI field extraction (28+ fields supported, 91.8%+ accuracy)
- ‚úÖ Real-time conversation processing (every 5-10 seconds)
- ‚úÖ AI message suggestions (`/api/ai/messages/suggest`)
- ‚úÖ Voicemail summarization
- ‚úÖ Multi-provider AI strategy (Gemini 2.5 Flash primary, OpenAI GPT-4o-mini fallback)
- ‚úÖ Extraction caching for performance
- ‚úÖ Response time: <1 second average

**Deliverables:**
- AI-powered conversation processing
- Automatic client information extraction
- Real-time AI assistance during calls
- High-accuracy field extraction (91.8%+)

**Note**: Plan recommendation engine (top 3 with reasoning) is planned for Epic 5, not Epic 2. AI can mention plans in conversations but formal recommendation system is future work.

---

### Epic 3: Client Portal
**Status**: ‚úÖ **Complete**  
**Priority**: P1 (High)  
**Description**: Client-facing self-service portal where clients can view their insurance information, benefits, documents, and schedule appointments.

**Definition of "Complete"**: All core client portal features implemented, tested, and in production use. Frontend application fully functional with authentication, dashboard, plan summaries, documents, and broker information.

**Completed Features:**
- ‚úÖ Magic link authentication (`/api/client-auth/magic-link/*`)
- ‚úÖ Multi-business line portal support (Medicare, Health Insurance, Life, Group Benefits, Commercial)
- ‚úÖ Frontend portal application (Next.js) fully functional
- ‚úÖ Authentication pages (login, verify)
- ‚úÖ Dashboard with plan summaries (Health, Dental, Vision)
- ‚úÖ Enrolled members display
- ‚úÖ Primary Care Physician (PCP) information
- ‚úÖ Broker information display
- ‚úÖ Document management system (upload, view, download)
- ‚úÖ Plans and broker information pages
- ‚úÖ Benefits & coverage information
- ‚úÖ Integration ready for [[Epic 7: Calendar Scheduling System]] calendar system

**Stories:**
- [[Story 3.1: Client Portal Foundation]] - Next.js setup and authentication
- [[Story 3.2: Plan Summary Dashboard]] - Dashboard with plan summaries

**Deliverables:**
- ‚úÖ Client portal at client.versainsuranceagency.com
- ‚úÖ Magic link authentication system
- ‚úÖ Plan summary and benefits pages
- ‚úÖ Document management system
- ‚úÖ Scheduling integration (via Epic 7)
- SendGrid email integration (already configured)

**Estimated Timeline**: 6 weeks

---

### Epic 4: Multi-Tenant SaaS Platform
**Status**: ‚è≥ **Future**  
**Priority**: P2 (Medium)  
**Description**: Transform single-agency CRM into multi-tenant SaaS platform supporting multiple agencies with complete data isolation.

**Related Epics**: Depends on [[Epic 1: Core CRM Foundation]], [[Epic 6: Security & Compliance]]. Extends all existing epics to multi-tenant architecture.

**Planned Features:**
- 3-database architecture (Agencies, Multi-tenant clients, Current agency)
- Agency signup and registration
- Subscription system (Stripe integration)
- Agency management dashboard
- Agent management per agency
- Data isolation and tenant routing
- HIPAA compliance features
- Audit logging system
- Usage tracking and billing

**Deliverables:**
- Multi-tenant architecture
- Agency signup and onboarding
- Subscription management
- Complete data isolation
- HIPAA-compliant audit logging

**Dependencies:**
- Create Databases 2 & 3 in Neon
- Set environment variables (AGENCIES_DATABASE_URL, AGENCIES_CLIENTS_DATABASE_URL)
- Stripe integration
- Database routing middleware

**Estimated Timeline**: 8-10 weeks

---

### Epic 5: Advanced Features
**Status**: ‚è≥ **Future**  
**Priority**: P3 (Low)  
**Description**: Advanced features including plan recommendation engine, knowledge base, reporting, and analytics.

**Current State:**
- üöß Database tables exist (`medicare_plans`, `plan_recommendations`) but not populated
- üöß AI can mention plans in conversations but no formal recommendation engine
- ‚è≥ No dedicated recommendation API endpoint (`/api/ai/recommendations`)

**Planned Features:**
- Plan database population and management
- Intelligent plan matching algorithm
- Real-time plan recommendations during calls (top 3 with reasoning)
- Plan comparison interface
- CMS rules and regulations database
- Compliance checking engine
- Knowledge base integration
- Advanced reporting and analytics
- Performance metrics dashboard

**Deliverables:**
- Complete plan database (populated with carrier data)
- AI-powered plan matching algorithm
- Real-time recommendations API (`POST /api/ai/recommendations`)
- Compliance checking system
- Advanced analytics dashboard

**Dependencies:**
- Plan data import (carrier data, formularies, networks)
- CMS rules database creation and population
- Carrier API integrations (if available)
- Recommendation algorithm development

**Estimated Timeline**: 6-8 weeks (TBD - depends on data availability)

---

### Epic 6: Review Management System
**Status**: ‚úÖ **Complete**  
**Priority**: P1 (High)  
**Description**: Custom review management system to replace GiveMe5.ai integration, providing comprehensive review invitation, tracking, and management capabilities.

**Related Epics**: Depends on [[Epic 1: Core CRM Foundation]]. Standalone system integrated with client management.

**Definition of "Complete"**: All core review management features implemented, tested, and in production use. System fully functional for sending invitations, tracking reviews, and managing review requests.

**Completed Features:**
- ‚úÖ Review invitation system (Email and SMS via SendGrid/Twilio)
- ‚úÖ Template management (customizable email/SMS templates with variable replacement)
- ‚úÖ Review request tracking (pending, sent, opened, clicked, completed, cancelled)
- ‚úÖ Public review submission page (`/reviews/:token`)
- ‚úÖ Review automation triggers (on client created, on status change to client)
- ‚úÖ Background scheduler for delayed review requests and follow-up sequences
- ‚úÖ Review statistics dashboard
- ‚úÖ Integration status monitoring (SendGrid, Twilio, Google, Facebook)
- ‚úÖ Settings configuration (follow-up sequences, link expiration, rating filters)
- ‚úÖ Review request management (send, resend, cancel, delete)
- ‚úÖ Review deletion functionality (delete collected reviews from My Reviews tab)
- ‚úÖ Google Business Profile and Facebook Business Page URL configuration
- ‚úÖ URL parameter persistence for tab navigation
- ‚úÖ Delete functionality for review requests
- ‚úÖ Cancel functionality for review requests (all statuses except completed)
- ‚úÖ Follow-up sequence system (configurable max attempts and interval days)
- ‚úÖ Star rating in email (clickable 1-5 stars with rating-based routing)
- ‚úÖ Rating-based routing (4-5 stars ‚Üí Google, 1-3 stars ‚Üí internal feedback)
- ‚úÖ Collapsible settings sections (matching Portal Settings style)
- ‚úÖ Dark theme compatibility for all UI components

**Deliverables:**
- Complete review management system at `/marketing/reviews`
- Email/SMS invitation system with tracking
- Public review submission interface
- Review automation and scheduling
- Integration status dashboard
- Settings and configuration management

**Key Files Created:**
- `crm/server/src/routes/reviews.ts` - Review management API endpoints
- `crm/server/src/services/reviewEmailService.ts` - Email invitation service with tracking
- `crm/server/src/services/reviewSmsService.ts` - SMS invitation service with tracking
- `crm/server/src/services/templateProcessor.ts` - Template variable replacement
- `crm/server/src/services/reviewAutomationService.ts` - Automation trigger service
- `crm/server/src/services/reviewScheduler.ts` - Background job scheduler
- `crm/client/src/pages/reviews/ReviewsPage.tsx` - Main review management page
- `crm/client/src/pages/reviews/GetReviewsTab.tsx` - Review invitation management
- `crm/client/src/pages/reviews/SettingsTab.tsx` - System configuration
- `crm/client/src/pages/reviews/DashboardTab.tsx` - Statistics dashboard
- `crm/client/src/pages/reviews/IntegrationsTab.tsx` - Integration status
- `crm/client/src/pages/reviews/MyReviewsTab.tsx` - Review display
- `crm/client/src/pages/reviews/PrivateFeedbackTab.tsx` - Private feedback management
- `crm/client/src/pages/ReviewSubmissionPage.tsx` - Public review submission page

**Database Tables:**
- `review_requests` - Review invitation tracking
- `review_templates` - Email/SMS templates
- `reviews` - Submitted reviews
- `portal_config.review_config` - System configuration (JSONB)

**API Endpoints:**
- `GET /api/reviews/config` - Get system configuration
- `PUT /api/reviews/config` - Update system configuration
- `GET /api/reviews/requests` - List review requests
- `POST /api/reviews/requests` - Create review request
- `POST /api/reviews/requests/:id/send` - Send invitation
- `POST /api/reviews/requests/:id/resend` - Resend invitation
- `POST /api/reviews/requests/:id/cancel` - Cancel request
- `DELETE /api/reviews/requests/:id` - Delete request
- `GET /api/reviews/templates` - List templates
- `POST /api/reviews/templates` - Create template
- `PUT /api/reviews/templates/:id` - Update template
- `DELETE /api/reviews/templates/:id` - Delete template
- `GET /api/reviews/stats` - Get statistics
- `GET /api/reviews/integrations` - Get integration status
- `GET /api/reviews/link/:token` - Get review submission page (public)
- `POST /api/reviews/link/:token/submit` - Submit review (public)
- `GET /api/reviews/track/open/:requestId` - Track email open (public)
- `GET /api/reviews/track/click/:requestId` - Track link click (public)
- `POST /api/reviews/track/rating/:requestId` - Track rating selection (public)
- `GET /api/reviews` - List reviews with pagination and filters
- `DELETE /api/reviews/:id` - Delete review

**Issues Encountered and Solutions:**

1. **Issue: Invitation sending not working**
   - **Problem**: `handleInviteCustomer` function was a TODO placeholder
   - **Solution**: Implemented complete invitation flow with client search/creation, review request creation, and automatic sending

2. **Issue: Invited Customers tab not showing data**
   - **Problem**: Missing URL parameter persistence, incorrect sub-tab filtering logic
   - **Solution**: Implemented `useSearchParams` for URL persistence, fixed sub-tab filtering to correctly display requests by status

3. **Issue: Page redirects to dashboard on refresh**
   - **Problem**: URL parameters not being preserved, causing tab state loss
   - **Solution**: Added `useSearchParams` to persist main tab and sub-tab states in URL, ensuring state persists across refreshes

4. **Issue: SQL query errors (500 errors)**
   - **Problem**: Neon SQL template literals don't support dynamic query building with `sql.unsafe` or string concatenation
   - **Solution**: Simplified queries to remove conditional filters, relying on frontend filtering instead

5. **Issue: CSP blocking email review links**
   - **Problem**: Content Security Policy blocking Chrome DevTools connections and localhost URLs in production
   - **Solution**: Updated Helmet CSP configuration to conditionally allow localhost connections in development, fixed `upgradeInsecureRequests` to only apply in production

6. **Issue: 502 Bad Gateway errors after CSP fix**
   - **Problem**: Incorrect CSP directive causing server crash, port conflicts
   - **Solution**: Fixed CSP configuration, resolved port conflicts by killing existing processes, restarted server

7. **Issue: Review links pointing to localhost in production**
   - **Problem**: `reviewLink` stored in database with localhost URLs from development
   - **Solution**: Added logic to replace localhost URLs with production URL before sending emails, updated `baseUrl` generation to use production URL in production

8. **Issue: Delete functionality missing**
   - **Problem**: No way to delete review requests
   - **Solution**: Added `DELETE /api/reviews/requests/:id` endpoint and integrated delete button (trash icon) in frontend

9. **Issue: Cancel button not working**
   - **Problem**: Backend only allowed canceling `pending` requests, too restrictive
   - **Solution**: Updated cancel logic to allow canceling `sent`, `opened`, and `clicked` requests, only blocking `completed` requests

10. **Issue: Settings URLs not persisting after refresh**
    - **Problem**: Default config objects missing URL fields, config merge not preserving URLs
    - **Solution**: Added `googlePageUrl` and `facebookPageUrl` to all default config objects, fixed backend config merge to preserve URLs, added explicit URL preservation in frontend loadConfig

11. **Issue: Enable Review System toggle resets to off**
    - **Problem**: `enabled` field not being explicitly preserved during save/load
    - **Solution**: Added explicit `enabled` field preservation in save and load functions, ensured backend always includes `enabled` field

12. **Issue: Integration tab shows "not configured" incorrectly**
    - **Problem**: Empty strings being converted to `null`, `configured` check using `!!url` which fails for empty strings
    - **Solution**: Fixed URL loading to preserve empty strings, updated `configured` check to validate non-empty strings with `trim().length > 0`

13. **Issue: Settings toggle not persisting (enabled resets to off)**
    - **Problem**: Race condition in `SettingsTab.tsx` where `enabled` toggle would reset after save due to async config reload
    - **Solution**: Added `isAutoSaving` ref to prevent `useEffect` from overwriting local state during async operations, added safeguard to prevent `localConfig.enabled: true` from being reset to `false` by stale props

14. **Issue: Page refresh loop when changing automation trigger toggles**
    - **Problem**: Auto-save logic was triggering on every toggle change, causing refresh loops
    - **Solution**: Removed auto-save for automation trigger toggles (`onClientCreated.enabled`, `onStatusChange.enabled`), requiring manual "Save Settings" click

15. **Issue: Localhost URLs in email templates and tracking URLs**
    - **Problem**: Review links and tracking URLs contained localhost in production emails
    - **Solution**: Enforced production URLs (`https://crm.versainsuranceagency.com`) in all email templates, tracking URLs, and review link generation. Added explicit localhost replacement logic in `reviewEmailService.ts`

16. **Issue: Platform selection dropdown in review submission page**
    - **Problem**: Users had to manually select platform, but system should post to all configured platforms
    - **Solution**: Removed platform selection dropdown, automatically creating review records for all platforms configured in `defaultPlatforms` setting

17. **Issue: Default platform configuration**
    - **Problem**: Default was `['google', 'facebook']` but user preferred Google-only
    - **Solution**: Changed default `defaultPlatforms` to `['google']` in both frontend and backend

18. **Issue: Dark theme compatibility for settings sections**
    - **Problem**: White backgrounds too bright in dark theme
    - **Solution**: Removed explicit white backgrounds from trigger cards and settings sections, allowing dark theme adaptation

19. **Issue: Settings sections not matching Portal Settings style**
    - **Problem**: Sections were touching each other, lacked proper spacing and styling
    - **Solution**: Replaced `Accordion` with `CollapsibleSection` component (matching Portal Settings), added proper spacing, icons, and dark theme compatibility. All sections collapsed by default.

20. **Issue: No way to delete collected reviews**
    - **Problem**: Users could not delete reviews from My Reviews tab
    - **Solution**: Added `DELETE /api/reviews/:id` endpoint and delete button with confirmation modal in `MyReviewsTab.tsx`

21. **Issue: Follow-up sequence not implemented**
    - **Problem**: User requested configurable follow-up sequences (3 requests over 3 days)
    - **Solution**: Implemented follow-up sequence system with `maxAttempts` and `intervalDays` configuration, automatic scheduling in `reviewScheduler.ts`, and max attempts enforcement in `reviewAutomationService.ts`

22. **Issue: No star rating in email**
    - **Problem**: Email only had text button, no visual rating selection
    - **Solution**: Added clickable star ratings (1-5 stars) in email template, each star links to review page with rating parameter. Implemented rating-based routing (4-5 stars ‚Üí Google, 1-3 stars ‚Üí internal form)

23. **Issue: Automation triggers too complex**
    - **Problem**: Three triggers (on client created, on status change, on enrollment complete) were confusing
    - **Solution**: Removed "On Enrollment Complete" trigger, renamed "On Status Change" to "On Status Change to Client" with automatic status setting

**Technical Decisions:**
- Used Neon SQL template literals (no ORM) for all database operations
- Implemented public routes before authentication middleware for review submission page
- Used URL parameters for tab state persistence (better than localStorage for bookmarking)
- Template variable replacement using regex (simple, effective)
- Email tracking via pixel and link wrapping (standard approach)
- Background scheduler using Node.js `setInterval` (simple, effective for current scale)

**Dependencies:**
- SendGrid API key for email invitations
- Twilio credentials for SMS invitations
- Database tables: `review_requests`, `review_templates`, `reviews`, `portal_config`
- Integration with client creation/status change flows

**Estimated Timeline**: 4 weeks (Completed)

---

### Epic 7: Calendar Scheduling System (OnceHub-Style)
**Status**: ‚úÖ **Complete** (Core Booking & Event Management System Fully Operational)  
**Priority**: P1 (High)  
**Description**: Comprehensive calendar scheduling system similar to OnceHub, enabling agents to manage appointments, sync with external calendars (Google, Outlook), and provide client-facing booking pages.

**Definition of "Complete"**: Full calendar management system with appointment CRUD, availability management, external calendar sync, and public booking pages. Agents can manage schedules, clients can book appointments, and system prevents conflicts and handles timezones.

**Current Progress**: Complete booking pages and event types management system with full CRUD operations, database schema, API routes, and public booking interface. All core functionality operational in production. Advanced calendar UI and external integrations remain for future phases.

**Completed Features:**
- ‚úÖ **Event Types Management**: Complete CRUD interface for event types with duration, pricing, categories
- ‚úÖ **Booking Pages Management**: Full booking page configuration with OnceHub-style interface
- ‚úÖ **Master Pages Management**: Master page configuration and management system
- ‚úÖ **Database Schema**: Complete booking pages, event types, master pages, and questions tables implemented
- ‚úÖ **API Routes**: Full REST API for booking pages, event types, and master pages management
- ‚úÖ **Public Booking Interface**: Client-facing booking pages with business line categories
- ‚úÖ **Form Questions**: Custom booking form questions with validation
- ‚úÖ **Page Duplication**: Booking page duplication functionality
- ‚úÖ **Slug Management**: URL-friendly slugs for public booking pages
- ‚úÖ **Business Line Integration**: 14 pre-configured insurance business line booking pages
- ‚úÖ **Form State Management**: Proper form reset and state isolation between event types
- ‚úÖ **Duration Management**: Individual event type duration settings with proper persistence
- ‚úÖ **Authentication Integration**: JWT-based authentication for all calendar endpoints
- ‚úÖ **CSRF Protection**: Security middleware for all calendar API routes
- ‚úÖ **Production Deployment**: Fully deployed and operational in production environment
- ‚úÖ **Booking Page UI Improvements**: Text positioning, time slot height optimization, 4:15 PM cutoff
- ‚úÖ **Availability Settings**: 12-hour time format display, edit functionality, booking page integration
- ‚úÖ **Time Slot Generation**: Dynamic slot generation based on agent availability settings
- ‚úÖ **Calendar API Key Management**: Complete API key system for calendar booking endpoints with permission-based access control
- ‚úÖ **Public Booking API Endpoints**: RESTful API for external calendar integrations (booking page details, available slots, appointment booking)
- ‚úÖ **Business Line Restrictions**: API keys can be restricted to specific business lines (Medicare, Health Insurance, etc.)
- ‚úÖ **Booking Page Restrictions**: API keys can be restricted to specific booking page slugs
- ‚úÖ **API Key Authentication**: Secure API key validation with bcrypt hashing and permission checking
- ‚úÖ **Calendar API Tab**: Frontend UI for managing calendar API keys in settings page
- ‚úÖ **Conflict Detection and Prevention**: Comprehensive conflict detection with buffer time enforcement across all appointment endpoints
- ‚úÖ **Buffer Time Management**: Configurable buffer times (default 15 minutes) per booking page, enforced in conflict detection
- ‚úÖ **Minimum Advance Booking**: Configurable minimum days in advance (0-7 days) clients must book appointments, with "Same Day" option for 0 days
- ‚úÖ **Calendar Initialization Fixes**: Fixed calendar booking page to correctly show first available date on initial load and refresh
- ‚úÖ **Weekend Filtering**: Automatic filtering of weekends that are not in the agent's availability schedule

**Recent Work & Issues (December 2025):**

**Minimum Advance Booking Feature:**
- ‚úÖ **Database Schema**: Added `min_advance_booking_days` column to `users` table (0-7 days, default 1)
- ‚úÖ **API Endpoints**: Created `GET /api/calendar/settings/advance-booking` and `PUT /api/calendar/settings/advance-booking` endpoints
- ‚úÖ **Settings UI**: Added "Minimum Advance Booking" setting in `/settings/calendar` with NumberInput (displays "Same Day" for 0 days)
- ‚úÖ **Backend Validation**: Integrated minimum advance booking validation into booking slot generation and appointment creation endpoints
- ‚úÖ **Frontend Logic**: Updated booking page to filter available dates based on minimum advance requirement, disable non-compliant dates, and auto-select first valid date with slots

**Calendar Booking Page Issues Fixed:**
1. **Initial Date Selection Issue**: Calendar was defaulting to today (Dec 8) instead of first available date (Dec 12 with 3-day restriction)
   - **Root Cause**: `selectedDate` was initialized to `today` before `findNextAvailableDay` could run
   - **Fix**: Changed initial `selectedDate` to minimum advance date (3 days from today), and set it immediately when booking page loads
   - **Files Modified**: `crm/client-portal/app/(portal)/booking/page.tsx`

2. **Refresh Issue**: Calendar showed nothing on refresh, then worked after navigating to January
   - **Root Cause**: `hasAutoSelected` flag was preventing auto-selection from running on refresh
   - **Fix**: Added `useEffect` to reset `hasAutoSelected` when booking page ID changes (handles refresh)
   - **Files Modified**: `crm/client-portal/app/(portal)/booking/page.tsx`

3. **Weekend Display Issue**: Weekends were appearing as valid appointment days even when not in agent's schedule
   - **Root Cause**: Availability schedule wasn't filtering out weekends that weren't explicitly available
   - **Fix**: Added filtering in `loadAvailabilitySchedule` to exclude weekends not marked as available, and updated `isDayAvailable` to return `false` if day not in schedule
   - **Files Modified**: `crm/client-portal/app/(portal)/booking/page.tsx`

4. **Month Navigation Issue**: When navigating to January, calendar showed December slots
   - **Root Cause**: `loadTimeSlots` was loading slots for `selectedDate` even when it was in a different month
   - **Fix**: Modified `useEffect` for `loadTimeSlots` to only load slots if `selectedDate` is in the current month being viewed, and added logic to find first available date in new month when month changes
   - **Files Modified**: `crm/client-portal/app/(portal)/booking/page.tsx`

**Technical Implementation:**
- **Database Migration**: `crm/database-migrations/007-add-min-advance-booking-days.sql` - Adds `min_advance_booking_days` column with constraint (0-7)
- **Backend Routes**: `crm/server/src/routes/calendar.ts` - Added GET/PUT endpoints for advance booking setting, integrated validation into booking endpoints
- **Frontend Settings**: `crm/client/src/pages/calendar/SettingsTab.tsx` - Added NumberInput for minimum advance booking setting
- **Frontend Booking Page**: `crm/client-portal/app/(portal)/booking/page.tsx` - Complete rewrite of date selection logic, weekend filtering, and month navigation

**Pending Features:**
- ‚è≥ **Tab System**: 4-tab navigation (Home, Settings, Integration, Booking Pages)
- ‚è≥ **Tab 1 (Home)**: Core calendar UI (month/week/day views)
- ‚è≥ **Tab 1 (Home)**: Appointment management (create, edit, cancel, reschedule)
- ‚è≥ **Tab 2 (Settings)**: Profile overview (agency info, email, status, role)
- ‚è≥ **Tab 2 (Settings)**: Agent availability management (recurring schedules, overrides)
- ‚è≥ **Tab 2 (Settings)**: Email settings (sent from email/name, guest replies)
- ‚è≥ **Tab 2 (Settings)**: Licenses management (scheduled meeting licenses, live engagement licenses)
- ‚è≥ **Tab 3 (Integration)**: External calendar sync (Google Calendar, Outlook/Exchange OAuth)
- ‚è≥ **Tab 3 (Integration)**: Video conferencing (Google Meet, Zoom, Microsoft Teams)
- ‚è≥ **Tab 3 (Integration)**: Zapier integration
- ‚è≥ **Tab 3 (Integration)**: SMS notifications (Twilio)
- ‚úÖ Conflict detection and prevention
- ‚è≥ Timezone-aware scheduling
- ‚úÖ Buffer times between appointments
- ‚è≥ Email confirmations and reminders
- ‚è≥ Recurring appointments
- ‚è≥ Multiple calendar management per agent
- ‚è≥ AI chatbot for scheduling - Future

**Completed Deliverables:**
- ‚úÖ **Event Types Management** - Complete CRUD interface at `/calendar/event-types`
- ‚úÖ **Event Type Manager** - Individual event type configuration at `/calendar/event-types/:id`
- ‚úÖ **Booking Pages Management** - OnceHub-style booking page configuration with three-tab system
- ‚úÖ **Master Pages Management** - Master page configuration and management system
- ‚úÖ **Database Schema** - Complete booking pages, event types, master pages, and questions tables (migration 006)
- ‚úÖ **API Endpoints** - Full REST API for booking pages, event types, and master pages (`/api/booking-pages`, `/api/event-types`)
- ‚úÖ **Public Booking Pages** - Client-facing booking interface at `/booking/:slug`
- ‚úÖ **Business Line Categories** - 14 pre-configured insurance booking pages
- ‚úÖ **Form Questions System** - Custom booking form questions with validation
- ‚úÖ **Production System** - Fully deployed and operational calendar management system
- ‚úÖ **Error Resolution** - All form state, duration management, and database schema issues resolved
- ‚úÖ **Conflict Detection System** - Comprehensive conflict detection with buffer time enforcement implemented in all appointment endpoints (create, update, public booking, API booking)
- ‚úÖ **Buffer Time Enforcement** - Configurable buffer times per booking page, enforced in conflict detection logic

**Pending Deliverables:**
- ‚è≥ Complete calendar scheduling system at `/calendar` with tab-based navigation
- ‚è≥ **Tab 1: Home** - Main calendar view with appointments (month/week/day views)
- ‚è≥ **Tab 2: Settings** - Profile overview, availability settings, email settings, licenses
- ‚è≥ **Tab 3: Integration** - Calendar sync (Google, Outlook), video conferencing (Google Meet, Zoom, Teams), Zapier, SMS notifications
- ‚è≥ Agent availability management interface
- ‚è≥ External calendar sync (Google, Outlook)
- ‚è≥ Appointment management and tracking
- ‚è≥ Email notifications and reminders

**Database Schema:**

1. **`appointments` table:**
```sql
CREATE TABLE appointments (
  id SERIAL PRIMARY KEY,
  user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,
  client_id INTEGER REFERENCES clients(id) ON DELETE SET NULL,
  title VARCHAR(255) NOT NULL,
  description TEXT,
  appointment_type VARCHAR(50), -- 'consultation', 'follow-up', 'enrollment', 'review', etc.
  start_time TIMESTAMP WITH TIME ZONE NOT NULL,
  end_time TIMESTAMP WITH TIME ZONE NOT NULL,
  timezone VARCHAR(50) NOT NULL, -- 'America/Los_Angeles', etc.
  status VARCHAR(20) DEFAULT 'scheduled', -- 'scheduled', 'confirmed', 'cancelled', 'completed', 'no-show'
  location VARCHAR(50), -- 'in-person', 'phone', 'video', 'address'
  location_address TEXT, -- For in-person appointments
  video_link VARCHAR(500), -- For video appointments (Zoom, Teams, etc.)
  reminder_sent BOOLEAN DEFAULT FALSE,
  confirmation_sent BOOLEAN DEFAULT FALSE,
  booking_page_id INTEGER, -- If booked via public booking page
  external_calendar_id VARCHAR(255), -- ID from Google/Outlook calendar
  external_calendar_provider VARCHAR(50), -- 'google', 'outlook'
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  created_by INTEGER REFERENCES users(id),
  cancelled_at TIMESTAMP,
  cancelled_by INTEGER REFERENCES users(id),
  cancellation_reason TEXT
);

CREATE INDEX idx_appointments_user_id ON appointments(user_id);
CREATE INDEX idx_appointments_client_id ON appointments(client_id);
CREATE INDEX idx_appointments_start_time ON appointments(start_time);
CREATE INDEX idx_appointments_status ON appointments(status);
CREATE INDEX idx_appointments_external_calendar ON appointments(external_calendar_provider, external_calendar_id);
```

2. **`agent_availability` table:**
```sql
CREATE TABLE agent_availability (
  id SERIAL PRIMARY KEY,
  user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,
  day_of_week INTEGER NOT NULL, -- 0=Sunday, 1=Monday, ..., 6=Saturday
  start_time TIME NOT NULL,
  end_time TIME NOT NULL,
  timezone VARCHAR(50) NOT NULL,
  is_recurring BOOLEAN DEFAULT TRUE,
  recurrence_pattern VARCHAR(50), -- 'weekly', 'bi-weekly', 'monthly'
  valid_from DATE,
  valid_until DATE,
  is_active BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_availability_user_id ON agent_availability(user_id);
CREATE INDEX idx_availability_day ON agent_availability(day_of_week);
```

3. **`availability_overrides` table:**
```sql
CREATE TABLE availability_overrides (
  id SERIAL PRIMARY KEY,
  user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,
  date DATE NOT NULL,
  start_time TIME,
  end_time TIME,
  is_available BOOLEAN DEFAULT FALSE, -- FALSE = blocked time
  reason TEXT,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_overrides_user_date ON availability_overrides(user_id, date);
```

4. **`calendar_sync` table:**
```sql
CREATE TABLE calendar_sync (
  id SERIAL PRIMARY KEY,
  user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,
  provider VARCHAR(50) NOT NULL, -- 'google', 'outlook'
  access_token TEXT NOT NULL, -- Encrypted
  refresh_token TEXT, -- Encrypted
  token_expires_at TIMESTAMP,
  calendar_id VARCHAR(255), -- External calendar ID
  calendar_name VARCHAR(255),
  sync_enabled BOOLEAN DEFAULT TRUE,
  sync_direction VARCHAR(20) DEFAULT 'two-way', -- 'one-way-in', 'one-way-out', 'two-way'
  last_sync_at TIMESTAMP,
  sync_frequency INTEGER DEFAULT 15, -- Minutes between syncs
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  UNIQUE(user_id, provider, calendar_id)
);

CREATE INDEX idx_calendar_sync_user ON calendar_sync(user_id);
CREATE INDEX idx_calendar_sync_provider ON calendar_sync(provider);
```

5. **`event_types` table:** (‚úÖ **Implemented**)
```sql
CREATE TABLE event_types (
  id SERIAL PRIMARY KEY,
  user_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  name VARCHAR(255) NOT NULL,
  description TEXT,
  duration INTEGER NOT NULL DEFAULT 60, -- minutes
  price DECIMAL(10,2), -- optional pricing
  display_price BOOLEAN DEFAULT FALSE,
  mode VARCHAR(20) NOT NULL DEFAULT 'automatic', -- 'automatic', 'manual_approval', 'request_only'
  category VARCHAR(100), -- business line category
  color VARCHAR(7) DEFAULT '#1976d2', -- hex color
  icon VARCHAR(10) DEFAULT 'üìÖ', -- emoji icon
  is_active BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  CONSTRAINT unique_user_event_type_name UNIQUE(user_id, name),
  CONSTRAINT valid_duration CHECK (duration >= 5 AND duration <= 480),
  CONSTRAINT valid_mode CHECK (mode IN ('automatic', 'manual_approval', 'request_only'))
);
```

6. **`booking_pages` table:** (‚úÖ **Implemented**)
```sql
CREATE TABLE booking_pages (
  id SERIAL PRIMARY KEY,
  user_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  slug VARCHAR(100) NOT NULL UNIQUE,
  name VARCHAR(255) NOT NULL,
  description TEXT,
  duration INTEGER NOT NULL DEFAULT 60, -- minutes
  meeting_type VARCHAR(20) NOT NULL DEFAULT 'virtual', -- 'virtual', 'in-person', 'phone'
  category VARCHAR(100),
  color VARCHAR(7) DEFAULT '#1976d2', -- hex color
  icon VARCHAR(10) DEFAULT 'üìÖ', -- emoji icon
  is_active BOOLEAN DEFAULT true,
  custom_message TEXT,
  thank_you_message TEXT,
  brand_color VARCHAR(7) DEFAULT '#1976d2',
  timezone VARCHAR(50) DEFAULT 'America/New_York',
  buffer_before INTEGER DEFAULT 0, -- minutes before appointment
  buffer_after INTEGER DEFAULT 0, -- minutes after appointment
  price DECIMAL(10,2) DEFAULT 0.00, -- for paid consultations
  requires_payment BOOLEAN DEFAULT false,
  max_advance_days INTEGER DEFAULT 30, -- how far in advance can book
  min_advance_hours INTEGER DEFAULT 2, -- minimum notice required
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
```

7. **`booking_page_questions` table:** (‚úÖ **Implemented**)
```sql
CREATE TABLE booking_page_questions (
  id SERIAL PRIMARY KEY,
  booking_page_id INTEGER NOT NULL REFERENCES booking_pages(id) ON DELETE CASCADE,
  question TEXT NOT NULL,
  question_type VARCHAR(20) NOT NULL DEFAULT 'text', -- 'text', 'email', 'phone', 'select', 'checkbox', 'textarea'
  options TEXT[], -- for select/checkbox types
  is_required BOOLEAN DEFAULT false,
  sort_order INTEGER DEFAULT 0,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
```

8. **`master_pages` table:** (‚úÖ **Implemented**)
```sql
CREATE TABLE master_pages (
  id SERIAL PRIMARY KEY,
  user_id INTEGER NOT NULL REFERENCES users(id) ON DELETE CASCADE,
  slug VARCHAR(100) NOT NULL UNIQUE,
  name VARCHAR(255) NOT NULL,
  description TEXT,
  custom_message TEXT,
  thank_you_message TEXT,
  brand_color VARCHAR(7) DEFAULT '#1976d2',
  timezone VARCHAR(50) DEFAULT 'America/New_York',
  is_active BOOLEAN DEFAULT TRUE,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);
```

**API Endpoints:**

#### Calendar Management
- `GET /api/calendar/appointments` - List appointments (filters: date range, agent, client, status)
- `POST /api/calendar/appointments` - Create appointment
- `GET /api/calendar/appointments/:id` - Get appointment details
- `PUT /api/calendar/appointments/:id` - Update appointment
- `DELETE /api/calendar/appointments/:id` - Cancel appointment
- `POST /api/calendar/appointments/:id/reschedule` - Reschedule appointment
- `POST /api/calendar/appointments/:id/confirm` - Confirm appointment
- `GET /api/calendar/appointments/conflicts` - Check for scheduling conflicts

#### Availability Management
- `GET /api/calendar/availability` - Get agent availability
- `POST /api/calendar/availability` - Set recurring availability
- `PUT /api/calendar/availability/:id` - Update availability
- `DELETE /api/calendar/availability/:id` - Remove availability
- `POST /api/calendar/availability/override` - Create availability override (block/unblock time)
- `DELETE /api/calendar/availability/override/:id` - Remove override
- `GET /api/calendar/availability/slots` - Get available time slots for date range
- `GET /api/calendar/availability/conflicts` - Check availability conflicts

#### Calendar Sync
- `GET /api/calendar/sync/status` - Get sync status for all providers
- `POST /api/calendar/sync/google/authorize` - Initiate Google OAuth flow
- `GET /api/calendar/sync/google/callback` - Google OAuth callback
- `POST /api/calendar/sync/outlook/authorize` - Initiate Outlook OAuth flow
- `GET /api/calendar/sync/outlook/callback` - Outlook OAuth callback
- `POST /api/calendar/sync/:id/enable` - Enable calendar sync
- `POST /api/calendar/sync/:id/disable` - Disable calendar sync
- `POST /api/calendar/sync/:id/sync-now` - Trigger manual sync
- `PUT /api/calendar/sync/:id` - Update sync settings
- `DELETE /api/calendar/sync/:id` - Disconnect calendar

#### Booking Pages (Public)
- `GET /api/booking/:slug` - Get booking page details (public)
- `GET /api/booking/:slug/availability` - Get available slots for booking page (public)
- `POST /api/booking/:slug/book` - Create appointment via booking page (public)
- `GET /api/booking/:slug/confirm/:token` - Confirm appointment (public)
- `POST /api/booking/:slug/cancel/:token` - Cancel appointment (public)

#### Event Types (Admin)
- `GET /api/calendar/event-types` - List event types
- `POST /api/calendar/event-types` - Create event type
- `PUT /api/calendar/event-types/:id` - Update event type
- `DELETE /api/calendar/event-types/:id` - Delete event type

#### Booking Pages (Admin)
- `GET /api/calendar/booking-pages` - List booking pages
- `POST /api/calendar/booking-pages` - Create booking page
- `GET /api/calendar/booking-pages/:id` - Get booking page details
- `PUT /api/calendar/booking-pages/:id` - Update booking page
- `DELETE /api/calendar/booking-pages/:id` - Delete booking page
- `POST /api/calendar/booking-pages/:id/duplicate` - Duplicate booking page

#### Master Pages (Admin)
- `GET /api/calendar/master-pages` - List master pages
- `POST /api/calendar/master-pages` - Create master page
- `GET /api/calendar/master-pages/:id` - Get master page details
- `PUT /api/calendar/master-pages/:id` - Update master page
- `DELETE /api/calendar/master-pages/:id` - Delete master page

#### Settings (Profile, Availability, Email, Licenses)
- `GET /api/calendar/settings/profile` - Get profile overview (agency info, email, status, role)
- `PUT /api/calendar/settings/profile` - Update profile settings
- `GET /api/calendar/settings/email` - Get email settings
- `PUT /api/calendar/settings/email` - Update email settings (sent from email/name, guest replies)
- `GET /api/calendar/settings/licenses` - Get license status
- `PUT /api/calendar/settings/licenses` - Update license assignments

#### Integration (Calendar Sync, Video Conferencing, Zapier, SMS)
- `GET /api/calendar/integrations` - Get all integration statuses
- `GET /api/calendar/integrations/calendar-sync` - Get calendar sync status
- `GET /api/calendar/integrations/video-conferencing` - Get video conferencing status
- `GET /api/calendar/integrations/zapier` - Get Zapier integration status
- `GET /api/calendar/integrations/sms` - Get SMS integration status
- `PUT /api/calendar/integrations/video-conferencing` - Configure video conferencing
- `PUT /api/calendar/integrations/zapier` - Configure Zapier
- `PUT /api/calendar/integrations/sms` - Configure SMS notifications

**Implementation Phases:**

### Phase 1: Core Calendar Infrastructure (Priority: P0)
**Timeline**: 2 weeks

**Backend:**
- Create database tables (`appointments`, `agent_availability`, `availability_overrides`)
- Implement appointment CRUD endpoints
- Implement availability management endpoints
- Add conflict detection logic
- Timezone handling utilities

**Frontend:**
- Tab system implementation (Home, Settings, Integration, Booking Pages)
- **Tab 1 (Home)**: Calendar UI component (month/week/day views)
- **Tab 1 (Home)**: Appointment form (create/edit)
- **Tab 1 (Home)**: Basic calendar display with appointments
- **Tab 2 (Settings)**: Profile overview section (agency info, email, status, role)
- **Tab 2 (Settings)**: Availability management section (recurring schedules, overrides)
- **Tab 2 (Settings)**: Email settings section (sent from email/name, guest replies)
- **Tab 2 (Settings)**: Licenses section (scheduled meeting licenses, live engagement licenses)
- **Tab 3 (Integration)**: Calendar sync section (Google, Outlook OAuth buttons, sync status)
- **Tab 3 (Integration)**: Video conferencing section (Google Meet, Zoom, Teams)
- **Tab 3 (Integration)**: Zapier integration section
- **Tab 3 (Integration)**: SMS notifications section (Twilio)
- **Tab 4 (Booking Pages)**: Three-panel layout (Event Types, Booking Pages, Master Pages)

**Dependencies**: None

---

### Phase 2: External Calendar Integration (Priority: P1)
**Timeline**: 2 weeks

**Backend:**
- Create `calendar_sync` table
- Google Calendar OAuth integration
- Outlook/Exchange OAuth integration
- Two-way sync service (read from external, write to external)
- Sync conflict resolution
- Background sync job

**Frontend:**
- **Tab 3 (Integration)**: Calendar sync section (Google, Outlook OAuth buttons)
- **Tab 3 (Integration)**: Sync status display (connected calendars, last sync time)
- **Tab 3 (Integration)**: Manual sync trigger button
- **Tab 3 (Integration)**: Video conferencing integration (Google Meet, Zoom, Teams connect buttons)
- **Tab 3 (Integration)**: Zapier integration status and configuration
- **Tab 3 (Integration)**: SMS notifications status (Twilio configuration)

**Dependencies**: Phase 1, Google Calendar API credentials, Microsoft Graph API credentials

---

### Phase 3: Booking Pages & Client Access (Priority: P1)
**Timeline**: 2 weeks

**Backend:**
- Create `booking_pages` table
- Public booking page endpoints
- Lead qualification form processing
- Available slot calculation
- Email confirmations and reminders
- Booking page CRUD endpoints

**Frontend:**
- **Tab 3 (Booking Pages)**: Event types management panel (create, edit, delete event types)
- **Tab 3 (Booking Pages)**: Booking pages list panel (create, edit, delete, duplicate booking pages)
- **Tab 3 (Booking Pages)**: Master pages panel (create, edit, delete master pages)
- **Tab 3 (Booking Pages)**: Booking page builder modal/drawer (customization, branding, lead forms)
- Public booking page (client-facing)
- Lead qualification form component
- Appointment confirmation page
- Email template integration

**Dependencies**: Phase 1, SendGrid email service

---

### Phase 4: Advanced Features (Priority: P2)
**Timeline**: 1-2 weeks

**Backend:**
- Recurring appointments
- Buffer time enforcement
- Advanced conflict detection
- Appointment reminders (email/SMS)
- Cancellation handling
- No-show tracking

**Frontend:**
- Recurring appointment UI
- Buffer time settings
- Reminder configuration
- Cancellation flow

**Dependencies**: Phase 1, Phase 3

---

### Phase 5: AI & Automation (Priority: P3 - Future)
**Timeline**: TBD

**Features:**
- AI chatbot for scheduling
- Smart routing based on client needs
- Automated follow-ups
- Appointment suggestions

**Dependencies**: Phase 1-4, AI integration

**Key Files to Create:**

**Backend:**
- `crm/server/src/routes/calendar.ts` - Calendar API endpoints
- `crm/server/src/services/calendarService.ts` - Core calendar logic
- `crm/server/src/services/availabilityService.ts` - Availability management
- `crm/server/src/services/calendarSyncService.ts` - External calendar sync
- `crm/server/src/services/googleCalendarService.ts` - Google Calendar integration
- `crm/server/src/services/outlookCalendarService.ts` - Outlook integration
- `crm/server/src/services/bookingPageService.ts` - Booking page logic
- `crm/server/src/utils/timezone.ts` - Timezone utilities
- `crm/server/src/utils/conflictDetection.ts` - Conflict detection logic

**Frontend:**
- `crm/client/src/pages/CalendarPage.tsx` - Main calendar page with tab system
- `crm/client/src/pages/calendar/HomeTab.tsx` - Tab 1: Calendar view (month/week/day)
- `crm/client/src/pages/calendar/SettingsTab.tsx` - Tab 2: Settings (profile, availability, email settings, licenses)
- `crm/client/src/pages/calendar/IntegrationTab.tsx` - Tab 3: Integration (calendar sync, video conferencing, Zapier, SMS)
- `crm/client/src/pages/calendar/BookingPagesTab.tsx` - Tab 4: Booking pages management (event types, booking pages, master pages)
- `crm/client/src/components/calendar/CalendarView.tsx` - Calendar grid component
- `crm/client/src/components/calendar/AppointmentForm.tsx` - Appointment form
- `crm/client/src/components/calendar/AvailabilitySettings.tsx` - Availability management
- `crm/client/src/components/calendar/CalendarSyncSettings.tsx` - Sync configuration
- `crm/client/src/components/calendar/BookingPageBuilder.tsx` - Booking page builder
- `crm/client/src/components/calendar/EventTypesPanel.tsx` - Event types management panel
- `crm/client/src/components/calendar/BookingPagesPanel.tsx` - Booking pages list panel
- `crm/client/src/components/calendar/MasterPagesPanel.tsx` - Master pages panel
- `crm/client/src/pages/PublicBookingPage.tsx` - Public booking page (client-facing)
- `crm/client/src/hooks/useCalendar.ts` - Calendar data hook
- `crm/client/src/hooks/useAvailability.ts` - Availability hook

**Technical Decisions:**
- **Calendar Library**: FullCalendar (React wrapper) or react-big-calendar for calendar UI
- **Date/Time Library**: date-fns with date-fns-tz for timezone handling
- **Google Calendar**: googleapis npm package with OAuth 2.0
- **Outlook**: @azure/msal-browser and Microsoft Graph API
- **Token Storage**: Encrypt tokens in database using existing encryption utilities
- **Sync Strategy**: Two-way sync with conflict resolution (server wins for conflicts)
- **Timezone Handling**: Store all times in UTC, convert to user's timezone for display
- **Conflict Detection**: Check against existing appointments and external calendar events

**Security Considerations:**
- Encrypt OAuth tokens in database
- Validate timezone inputs to prevent injection
- Rate limit booking page endpoints
- CSRF protection for booking submissions
- Validate appointment times to prevent past bookings
- Sanitize booking page form inputs

**Dependencies:**
- Google Calendar API credentials (OAuth 2.0)
- Microsoft Graph API credentials (Azure AD)
- SendGrid for email confirmations/reminders
- Twilio for SMS reminders (optional)
- Database migration for new tables

**Estimated Timeline**: 7-8 weeks total
- Phase 1: 2 weeks
- Phase 2: 2 weeks
- Phase 3: 2 weeks
- Phase 4: 1-2 weeks
- Phase 5: TBD (Future)

**Success Criteria:**
- Agents can create, edit, and cancel appointments
- Agents can set recurring availability
- External calendars sync bidirectionally
- Clients can book appointments via public booking pages
- System prevents scheduling conflicts
- Timezone conversions work correctly
- Email confirmations and reminders sent automatically
- External systems can integrate with calendar via API keys
- API keys can be restricted to specific business lines or booking pages

**Recent Enhancements (December 2025):**

#### Calendar API System Implementation

**Feature**: Calendar API Key Management System  
**Status**: ‚úÖ **Complete**  
**Priority**: P1 (High)  
**Date Completed**: 2025-12-02

**Description**: Implemented a comprehensive API key management system for calendar booking endpoints, allowing external systems (marketing pages, client portals) to integrate with the calendar booking system. The system provides granular permission control through business line and booking page restrictions.

**Completed Components:**

1. **Backend API Key Management** (`/api/calendar/api-keys`):
   - ‚úÖ `GET /api/calendar/api-keys` - List all calendar API keys for authenticated user
   - ‚úÖ `POST /api/calendar/api-keys` - Create new calendar API key with permissions
   - ‚úÖ `PUT /api/calendar/api-keys/:id` - Update API key (name, active status, permissions)
   - ‚úÖ `DELETE /api/calendar/api-keys/:id` - Delete API key
   - ‚úÖ API key prefix: `vck_live_` (distinguishes from forms API keys `vsk_live_`)
   - ‚úÖ Secure key generation using `crypto.randomBytes(32).toString('base64url')`
   - ‚úÖ Bcrypt hashing for API key storage
   - ‚úÖ Permission-based access control (`allowCalendarBooking`, `allowedBusinessLines`, `allowedBookingPages`)
   - ‚úÖ Rate limiting support (default: 1000 requests)

2. **Public Booking API Endpoints** (`/api/booking/:slug`):
   - ‚úÖ `GET /api/booking/:slug` - Get booking page details (public, API key optional)
   - ‚úÖ `GET /api/booking/:slug/slots` - Get available time slots (public, API key optional)
   - ‚úÖ `POST /api/booking/:slug/book` - Book appointment (public, API key optional)
   - ‚úÖ API key authentication via `X-API-Key` header
   - ‚úÖ Permission validation middleware (`requireCalendarBookingPermission`, `requireBookingPageAccess`)

3. **Frontend Calendar API Tab** (`/settings/calendar` ‚Üí API tab):
   - ‚úÖ New "API" tab in calendar settings page
   - ‚úÖ API key list with masked keys (`vck_live_{id}...`)
   - ‚úÖ Create API key modal with business line and booking page selection
   - ‚úÖ MultiSelect components for business lines and booking pages
   - ‚úÖ Dynamic endpoint URL generation based on selected restrictions
   - ‚úÖ Copy-to-clipboard functionality for API keys
   - ‚úÖ Update/delete API key functionality
   - ‚úÖ Active/inactive toggle for API keys

4. **Permission System**:
   - ‚úÖ Business line restrictions (`allowedBusinessLines` array in permissions JSONB)
   - ‚úÖ Booking page restrictions (`allowedBookingPages` array in permissions JSONB)
   - ‚úÖ Calendar booking permission flag (`allowCalendarBooking: true`)
   - ‚úÖ Middleware validation for permission checks
   - ‚úÖ Graceful error handling for unauthorized access

5. **Database Integration**:
   - ‚úÖ Uses existing `api_keys` table with `permissions` JSONB column
   - ‚úÖ Calendar-specific permissions stored in `permissions->>'allowCalendarBooking'`
   - ‚úÖ Business lines stored in `permissions->>'allowedBusinessLines'`
   - ‚úÖ Booking pages stored in `permissions->>'allowedBookingPages'`
   - ‚úÖ API key hashing and secure storage

**Technical Implementation:**

- **Backend Files**:
  - `crm/server/src/routes/calendarApiKeys.ts` - Calendar API key CRUD routes
  - `crm/server/src/middleware/apiKeyAuth.ts` - API key validation and permission middleware
  - `crm/server/src/routes/calendar.ts` - Public booking endpoints (`publicBookingRouter`)

- **Frontend Files**:
  - `crm/client/src/pages/calendar/CalendarApiTab.tsx` - API key management UI
  - `crm/client/src/pages/CalendarPage.tsx` - Added API tab to calendar settings

- **Key Features**:
  - API keys prefixed with `vck_live_` to distinguish from forms API keys
  - Full key shown only once on creation (cannot be retrieved again)
  - Masked key display in list view for security
  - Business line and booking page MultiSelect for granular control
  - Dynamic endpoint URL generation based on restrictions
  - Permission validation at middleware level

**Issues Fixed:**

1. **Google Calendar Sync on Delete**:
   - **Issue**: Google Calendar events were not being deleted when appointments were cancelled in CRM
   - **Fix**: Added Google Calendar API delete call in appointment cancellation endpoint
   - **Status**: ‚úÖ Fixed

2. **Email Confirmations Not Sending**:
   - **Issue**: Confirmation emails were not being sent to clients or agents when appointments were created
   - **Root Cause**: SendGrid API key was incorrect or expired
   - **Fix**: Verified and updated SendGrid API key in environment variables
   - **Status**: ‚úÖ Fixed

3. **Email Content Issues**:
   - **Issue**: Email sender name showed "Versa insurance Agency" instead of "Versa Insurance"
   - **Fix**: Updated sender name in SendGrid email templates
   - **Issue**: Duplicate information in confirmation emails, "z" after AM/PM times
   - **Fix**: Removed description line, formatted times without "z", moved title above client info
   - **Issue**: Phone number formatting inconsistent
   - **Fix**: Standardized phone format to `(949) 222-2222` in all email notifications
   - **Status**: ‚úÖ Fixed

4. **Calendar Timezone Display Issues**:
   - **Issue**: Appointments created for one day were showing on the previous day in calendar filters
   - **Root Cause**: Timezone conversion issues in frontend date handling
   - **Fix**: Implemented proper timezone handling using `Intl.DateTimeFormat().resolvedOptions().timeZone` and `dayjs` with timezone support
   - **Files Updated**: `CalendarPage.tsx`, `HomeTab.tsx`, `UpcomingTab.tsx`, `ThisWeekTab.tsx`, `NextWeekTab.tsx`
   - **Status**: ‚úÖ Fixed

5. **Medicare Booking Page Event Type**:
   - **Issue**: Medicare booking page in client portal was not using Medicare event type
   - **Fix**: Updated booking page configuration to use Medicare event type
   - **Status**: ‚úÖ Fixed

6. **Client Impersonation Bug**:
   - **Issue**: Impersonating one client displayed another client's data
   - **Root Cause**: Session/authentication state not properly isolated during impersonation
   - **Fix**: Fixed authentication state management in client portal, ensuring proper user context isolation
   - **Status**: ‚úÖ Fixed

7. **Calendar Filter Enhancements**:
   - **Feature**: Added "Next Week" filter for calendar appointments
   - **Feature**: Redefined "Upcoming" filter to show appointments from next month and beyond
   - **Feature**: Filters automatically update as time progresses (appointments move between filters)
   - **Status**: ‚úÖ Complete

**API Endpoint Examples:**

```bash
# Get booking page details (public, no API key required)
GET /api/booking/medicare

# Get available slots (public, API key optional for rate limiting)
GET /api/booking/medicare/slots?startDate=2025-12-01&endDate=2025-12-31&timezone=America/Los_Angeles
Headers: X-API-Key: vck_live_...

# Book appointment (public, API key optional)
POST /api/booking/medicare/book
Headers: X-API-Key: vck_live_...
Body: {
  "slot": "2025-12-15T10:00:00-08:00",
  "clientName": "John Doe",
  "clientEmail": "john@example.com",
  "clientPhone": "(949) 555-1234",
  "answers": {...}
}
```

**Business Line Integration:**

- API keys can be restricted to specific business lines (Medicare, Health Insurance, Life Insurance, etc.)
- Business line restrictions are enforced at the middleware level
- If business lines are selected, only booking pages associated with those business lines are accessible
- If no business lines are selected, all booking pages are accessible (unless booking page restrictions are set)

**Booking Page Restrictions:**

- API keys can be restricted to specific booking page slugs
- Booking page restrictions take precedence over business line restrictions
- If specific booking pages are selected, only those pages are accessible
- If no booking pages are selected but business lines are, all pages for those business lines are accessible

**Security Considerations:**

- API keys are hashed using bcrypt before storage
- Full API key shown only once on creation (cannot be retrieved)
- Masked keys displayed in list view (`vck_live_{id}...`)
- Permission validation at middleware level prevents unauthorized access
- Rate limiting support (default: 1000 requests per key)
- CSRF protection on all calendar API routes

**Dependencies:**
- Existing `api_keys` table with `permissions` JSONB column
- Business lines API endpoint (`/api/business-lines`)
- Booking pages API endpoint (`/api/booking-pages`)
- `bcrypt` for API key hashing
- `crypto` for secure key generation

**Estimated Timeline**: 1 week (Completed)

---

## 7. Stories for Current Epic

### Current Epic: All Epics Complete

**Status**: ‚úÖ **All Core Epics Complete**  
**Priority**: All P0-P1 epics completed  
**Description**: All critical and high-priority epics have been successfully implemented and deployed to production.

**Recent Progress**: Epic 7 (Calendar Scheduling System) completed with full production deployment, issue resolution, and comprehensive testing. All core CRM functionality now operational.

### Previous Epic: Epic 8 - Georgia Health Insurance Data Collection

**Status**: ‚úÖ **Complete** (Data Collection, UI Integration, Filtering, PDF Processing, Metadata Enhancement)  
**Priority**: P1 (High)  
**Description**: Collect, store, and integrate Georgia On-Exchange health insurance plan data including carriers, plans, metal tiers, plan types, member services phone numbers, ZIP codes, FIPS codes, and Summary of Benefits PDFs.

**Completed Features:**
- ‚úÖ CMS Marketplace API integration for On-Exchange plans
- ‚úÖ HUD ZIP Code API integration for ZIP code and FIPS code mapping
- ‚úÖ Bulk download of Georgia ZIP codes with FIPS codes
- ‚úÖ Plan data collection (carriers, plan names, metal tiers, plan types)
- ‚úÖ Member services phone number extraction and formatting
- ‚úÖ Summary of Benefits PDF collection (Centene API, CMS API, scraping)
- ‚úÖ S3 storage for PDFs
- ‚úÖ Client portal document integration
- ‚úÖ Carrier filtering for contracted carriers (8 carriers: UnitedHealthcare, HealthNet, Oscar Health, Ambetter Health, Anthem Bluecross, Cigna Healthcare, CareSource, Kaiser Permanente)
- ‚úÖ Phone number auto-population in client form
- ‚úÖ Plan name field changed to creatable Select (allows custom plan names)
- ‚úÖ Plan filtering by metal tier and network type
- ‚úÖ PDF download and organization (238 Ambetter PDFs processed)
- ‚úÖ Metadata enhancement (matching 2024 CMS-synced plans to 2025 PDF-based plans)
- ‚úÖ Auto-update script for future PDF processing
- ‚úÖ Primary applicant auto-population (first name, last name, DOB)

**Deliverables:**
- ‚úÖ `sync-georgia-health-plans.ts` script (complete)
- ‚úÖ Georgia ZIP code and FIPS code mappings (complete)
- ‚úÖ On-Exchange plan database for Georgia (complete)
- ‚úÖ PDF collection and S3 storage system (complete)
- ‚úÖ Client portal document links (complete)
- ‚úÖ `check-georgia-carriers.ts` script (for carrier verification)
- ‚úÖ `check-georgia-carrier-phones.ts` script (for phone number verification)
- ‚úÖ `update-georgia-carrier-phones.ts` script (for phone number updates)
- ‚úÖ `add-missing-georgia-carriers.ts` script (for adding missing carriers)

**Dependencies:**
- ‚úÖ CMS Marketplace API key (configured)
- ‚úÖ HUD ZIP Code API key (configured)
- ‚úÖ S3 service (already configured)
- ‚úÖ Client documents system (already configured)

**Plan Document**: `crm/docs/GEORGIA_HEALTH_INSURANCE_PLAN.md`

**Estimated Timeline**: 5 days (Data collection complete, UI integration pending TypeError fix)

**Issues Encountered and Solutions:**

1. **Issue: DATABASE_URL not configured**
   - **Problem**: Script couldn't find environment variables
   - **Solution**: Enhanced environment variable loading to check `.env.local`, `.env`, and root `.env` files with proper override logic

2. **Issue: CMS API endpoint incorrect (404 errors, HTML responses)**
   - **Problem**: Using GET requests to wrong endpoint
   - **Solution**: Updated to correct base URL `https://marketplace.api.healthcare.gov/api/v1` and changed to POST requests with JSON body

3. **Issue: Invalid ZIP code or FIPS errors (400)**
   - **Problem**: Missing required fields in POST request body
   - **Solution**: Added all required fields: `countyfips` (5-digit format), `state`, and `zipcode`

4. **Issue: State not a valid marketplace state (400)**
   - **Problem**: CMS API only supports `year=2024` currently
   - **Solution**: Implemented fallback logic to query 2024 data but store plans for 2025 and 2026 by checking effective dates and creating duplicate entries for each target year

5. **Issue: PostgreSQL array insertion errors**
   - **Problem**: Incorrect array syntax in SQL queries
   - **Solution**: Corrected to pass arrays directly (e.g., `serviceArea.zipCodes`) instead of using `sql`${...}`` or `sql`NULL``

6. **Issue: Plans stored as 2024 instead of 2025/2026**
   - **Problem**: API only returns 2024 data
   - **Solution**: Enhanced `planYearToStore` logic to extract year from various date fields and create separate database entries for each target year with unique `api_plan_id`

7. **Issue: User feedback - "I don't see the carriers in the dropdown"**
   - **Problem**: Carriers not appearing in UI for Georgia
   - **Solution**: Removed CMS API dependency for Georgia carriers, implemented static `GEORGIA_CONTRACTED_CARRIERS` list with hardcoded phone numbers

8. **Issue: User feedback - "I only see oscar health plan of georgia"**
   - **Problem**: API returns different carrier names than contracted names
   - **Solution**: Implemented carrier name mapping to ensure exact contracted names appear in dropdown

9. **Issue: User feedback - "Carriers are not renamed, phone numbers don't populate, plan name should be a text box"**
   - **Problem**: Multiple UI issues
   - **Solution**: 
     - Fixed carrier names by ensuring `label` in Select component uses exact contracted names
     - Fixed phone auto-population by improving `setCarrierValue` to find carriers by ID or name and use `GEORGIA_CARRIER_PHONES` as fallback
     - Changed Plan Name fields from Select to TextInput
     - Changed Member Services Phone fields from Select to TextInput

10. **Issue: Persistent `TypeError: Cannot set properties of undefined (setting 'carrier')`**
    - **Problem**: Mantine's `useForm` trying to track field on undefined nested path
    - **Root Cause**: Mantine's Select component internally calls `setFieldValue` when `onOptionSubmit` is triggered, even if the nested structure doesn't exist yet. Mantine detects form context and automatically tracks fields.
    - **Fix**: 
      - Removed `error` prop that referenced form paths (triggers Mantine tracking)
      - Simplified Select rendering: Only render if structure exists (show loader if not)
      - Structure is guaranteed to exist before Select renders (initialized by toggle handler or useEffect)
      - Local state (`carrierSelectValues`) for Select `value` prop (prevents Mantine from tracking form path)
      - `setCarrierValue` called in both `onChange` and `onOptionSubmit` to ensure phone numbers populate
      - Improved Georgia phone lookup: Always checks `GEORGIA_CARRIER_PHONES` static list using carrier name
    - **Status**: ‚úÖ **Resolved** - Structure exists before Select renders, phone numbers auto-populate correctly

11. **Issue: Plans not appearing when selecting carrier**
    - **Problem**: Frontend was using index-based carrier IDs instead of real API IDs
    - **Solution**: Fixed `fetchPlansForCarrier` to correctly resolve Georgia carrier IDs from API, ensuring real API IDs are fetched and used for plan queries
    - **Status**: ‚úÖ **Resolved**

12. **Issue: Filtering by metal tier and network type not working**
    - **Problem**: Plans missing `metal_tier` and `network_type` metadata, filtering logic not implemented
    - **Solution**: 
      - Added `network_type` column to database
      - Implemented filtering logic in frontend (`PlanSelections.tsx`) and backend API (`health-insurance.ts`)
      - Created metadata enhancement scripts to populate missing metadata
    - **Status**: ‚úÖ **Resolved** - Filtering works for plans with metadata (10/50 plans enhanced)

13. **Issue: PDF download errors and missing PDFs**
    - **Problem**: PDFs not downloaded, HTTP 301 redirects not handled, missing PDFs for 2025/2026
    - **Solution**: 
      - Created `extract-plans-from-centene-pdfs.ts` script to download Centene SBC PDFs
      - Handled HTTP 301 redirects using `follow-redirects` package
      - Filtered out Spanish and non-English PDFs
      - Processed 238 Ambetter PDFs for 2025 and 2026
      - Created auto-update script (`auto-update-georgia-plans.ts`) for future processing
    - **Status**: ‚úÖ **Resolved** - 238 PDFs processed and stored in S3

14. **Issue: Plans missing metal tier and network type metadata**
    - **Problem**: Plans created from Centene PDFs (2025/2026) missing `metal_tier` and `network_type` fields
    - **Solution**: 
      - Created `sync-and-enhance-metadata.ts` script to match 2024 CMS-synced plans (with metadata) to 2025 PDF-based plans (without metadata)
      - Key insight: 2025 plans are dated 2024, so matching works across years by extracting 7-digit plan IDs from `api_plan_id`
      - Enhanced 10 plans with metadata (8 Bronze HMO, 2 Silver HMO)
      - Created diagnostic script (`diagnose-plan-matching.ts`) to inspect plan differences
    - **Status**: ‚úÖ **In Progress** - 10/50 plans enhanced, 40 plans still need metadata

15. **Issue: Primary applicant fields not auto-populating**
    - **Problem**: First name, last name, and DOB not auto-populating in primary applicant fields
    - **Solution**: 
      - Added `useEffect` in `ClientFormPage.tsx` to auto-populate primary applicant name and DOB from client data
      - Fixed last name truncation issue by using explicit `value` and `onChange` handlers instead of `form.getInputProps`
      - Fixed DOB formatting using `formatDateInput` utility
      - Used `requestAnimationFrame` and `setTimeout` for proper timing
    - **Status**: ‚úÖ **Resolved**

16. **Issue: CMS API not matching plan IDs from Centene PDFs**
    - **Problem**: Direct CMS API lookup (`enhance-plan-metadata.ts`) not finding matches for PDF-extracted plan IDs
    - **Solution**: 
      - Enhanced `getPlanDetailsFromCMS` to try multiple years (2025, 2026) and multiple matching strategies (full ID, last 7 digits, standard component ID, marketing name)
      - Created `sync-and-enhance-metadata.ts` as alternative approach (matching existing CMS-synced plans to PDF plans)
      - Matching strategy: Extract 7-digit plan ID from `api_plan_id` and match across years (since 2025 plans are from 2024 data)
    - **Status**: ‚úÖ **Working** - Matching script successfully enhanced 10 plans

**Technical Implementation Details:**

**Backend Scripts:**
- `sync-georgia-health-plans.ts`: Main sync script that:
  - Downloads Georgia ZIP codes with FIPS codes from HUD API
  - Queries CMS Marketplace API for each ZIP code
  - Filters plans by contracted carriers (8 carriers)
  - Extracts member services phone numbers from API response
  - Formats phone numbers to `(XXX) XXX-XXXX` format
  - Stores plans for 2025 and 2026 (even though API only returns 2024)
  - Downloads and stores Summary of Benefits PDFs in S3
  - Handles rate limiting and error recovery

- `check-georgia-carriers.ts`: Verifies which contracted carriers exist in CMS API
- `check-georgia-carrier-phones.ts`: Checks phone numbers in database
- `update-georgia-carrier-phones.ts`: Updates phone numbers based on web search results
- `add-missing-georgia-carriers.ts`: Adds missing carriers to database with phone numbers

**Frontend Changes:**
- `PlanSelections.tsx`: 
  - Removed CMS API dependency for Georgia carriers
  - Implemented `GEORGIA_CONTRACTED_CARRIERS` static list (8 carriers in alphabetical order)
  - Implemented `GEORGIA_CARRIER_PHONES` map for hardcoded phone numbers
  - Added `carrierSelectValues` local state to prevent Mantine tracking
  - Changed Plan Name fields from Select to TextInput
  - Changed Member Services Phone fields from Select to TextInput
  - Implemented phone number auto-population on carrier selection
  - Added dropdown auto-close on selection (`searchable`, `clearable={false}`)

**Database Schema:**
- `zip_code_mappings`: Stores ZIP codes with FIPS codes
- `health_carriers`: Stores carriers with `member_services_phone` field
- `health_plans`: Stores plan data with `plan_year`, `api_plan_id`, `plan_details_pdf_url`, `plan_details_pdf_s3_key`

**Current Status:**
- ‚úÖ **TypeError Resolved**: Structure guaranteed to exist before Select renders, local state prevents Mantine tracking
- ‚úÖ **Phone Number Auto-Population**: Working correctly - always checks static `GEORGIA_CARRIER_PHONES` list
- ‚úÖ **Plan Filtering**: Implemented and working for plans with metadata (metal tier and network type)
- ‚úÖ **PDF Processing**: 238 Ambetter PDFs processed and stored in S3
- ‚úÖ **Metadata Enhancement**: 10/50 plans enhanced with metal tier and network type
- ‚úÖ **Auto-Update Script**: Created for future PDF processing
- ‚úÖ **Primary Applicant Auto-Population**: Working correctly for first name, last name, and DOB
- üöß **Remaining Work**: 40 plans still need metadata (need to sync more 2024 plans from CMS API)

---

### Epic 9: After-Hours Booking Slots

**Status**: ‚è≥ **Future**  
**Priority**: P2 (Medium)  
**Description**: Add after-hours booking slots feature that provides clients with 3 guaranteed appointment slots when regular business hours are fully booked. This feature allows agents to offer premium booking options outside normal availability, with optional payment processing for revenue generation.

**Related Epics**: Depends on [[Epic 7: Calendar Scheduling System]]. Extends booking functionality with premium slots.

**Business Value:**
- **Revenue Opportunity**: Optional fee-based after-hours slots can generate additional revenue
- **Better Service**: Clients can always book appointments even when regular slots are full
- **Agent Control**: Agents can define when "after hours" are and how many slots are available
- **Predictable Scheduling**: Always 3 slots available, making it easier to manage capacity

**Planned Features:**
- ‚úÖ **After-Hours Configuration**: Per-booking-page settings for after-hours availability
  - Enable/disable after-hours slots
  - Define after-hours time window (start time, end time)
  - Set number of available slots (default: 3)
  - Optional fee amount (NULL = free, or set price like $35.00)
- ‚úÖ **Time Slot Generation**: Automatic generation of after-hours slots when regular slots are full
  - Slots generated based on event type duration
  - Clear visual distinction (badge/color) for after-hours slots
  - Only shown when no regular slots available
- ‚úÖ **Booking Flow**: Seamless booking experience for after-hours appointments
  - Payment processing (if fee required) via Stripe
  - Appointment creation with `is_after_hours` flag
  - No conflict detection needed (separate time window)
- ‚úÖ **Agent Calendar**: Visual indicators for after-hours appointments
  - Special badge/color in calendar view
  - Filter to show after-hours appointments only
  - Special notification email for agent

**Database Schema Changes:**
```sql
-- Add to booking_pages table
ALTER TABLE booking_pages ADD COLUMN IF NOT EXISTS after_hours_enabled BOOLEAN DEFAULT false;
ALTER TABLE booking_pages ADD COLUMN IF NOT EXISTS after_hours_start_time TIME; -- e.g., '17:00:00'
ALTER TABLE booking_pages ADD COLUMN IF NOT EXISTS after_hours_end_time TIME; -- e.g., '18:45:00'
ALTER TABLE booking_pages ADD COLUMN IF NOT EXISTS after_hours_slot_count INTEGER DEFAULT 3;
ALTER TABLE booking_pages ADD COLUMN IF NOT EXISTS after_hours_fee_amount DECIMAL(10, 2); -- NULL = free, or set price

-- Add to appointments table
ALTER TABLE appointments ADD COLUMN IF NOT EXISTS is_after_hours BOOLEAN DEFAULT false;
ALTER TABLE appointments ADD COLUMN IF NOT EXISTS after_hours_fee_amount DECIMAL(10, 2);
ALTER TABLE appointments ADD COLUMN IF NOT EXISTS after_hours_fee_paid BOOLEAN DEFAULT false;
ALTER TABLE appointments ADD COLUMN IF NOT EXISTS stripe_payment_intent_id VARCHAR(255);
```

**Implementation Phases:**

**Phase 1: Database Schema**
- Add columns to `booking_pages` table for after-hours configuration
- Add columns to `appointments` table for after-hours tracking
- Create migration script

**Phase 2: Backend API**
- Modify `/api/booking/:slug/slots` endpoint:
  - Check if regular slots are available
  - If not, check if after-hours enabled
  - Generate after-hours slots based on configuration
  - Mark slots with `isAfterHours: true`
  - Include fee amount if configured
- Create `/api/booking/:slug/priority/payment` endpoint (if fee required):
  - Create Stripe PaymentIntent
  - Return client secret for frontend
- Modify booking creation endpoint:
  - Accept `isAfterHours` parameter
  - Skip conflict detection for after-hours appointments
  - Store payment intent ID if payment processed

**Phase 3: Frontend Booking Page**
- Update `crm/client-portal/app/(portal)/booking/page.tsx`:
  - Show "After-Hours Appointments Available" message when no regular slots
  - Display after-hours slots with clear visual distinction
  - Show fee amount if configured
  - Integrate Stripe payment flow (if fee required)
  - Handle payment before appointment confirmation

**Phase 4: Agent Calendar & Management**
- Update calendar view to show after-hours appointments with special indicator
- Add filter for after-hours appointments
- Add after-hours configuration UI in booking page settings
- Send special notification email to agent for after-hours bookings

**Recommended Default Configuration:**
- **After-hours enabled**: `false` (opt-in per booking page)
- **Start time**: `17:00:00` (5:00 PM)
- **End time**: `18:45:00` (6:45 PM)
- **Slot count**: `3`
- **Fee**: `NULL` (free) or `$35.00` (if revenue desired)

**Why 5:00 PM - 6:45 PM?**
- After regular business hours (9 AM - 4:15 PM)
- 3 slots √ó 40 minutes = 2 hours total
- Still reasonable time for clients
- Agent can adjust per booking page

**Alternative Approaches Considered:**
1. **Priority Booking (Pay to Skip Queue)**: More flexible but complex, requires payment processing for all bookings
2. **After-Hours Slots**: Simpler, predictable, optional payment - **RECOMMENDED**

**Dependencies:**
- Stripe integration (already configured)
- Booking page system (already implemented)
- Time slot generation logic (already implemented)
- Payment processing infrastructure

**Deliverables:**
- Database migration for after-hours configuration
- Backend API endpoints for after-hours slot generation and booking
- Frontend booking page updates with after-hours slot display
- Payment integration (if fee required)
- Agent calendar indicators for after-hours appointments
- Booking page settings UI for after-hours configuration

**Estimated Timeline**: 2-3 weeks

**Technical Notes:**
- After-hours slots don't require conflict detection (separate time window)
- Payment is optional - can be free or fee-based per booking page
- Slots are always available when enabled (not subject to regular availability)
- Agent has full control over time window and slot count

---

### Epic 10: Mantis Design System Upgrade

**Status**: üöß **In Progress**  
**Priority**: P1 (High)  
**Description**: Upgrade the entire CRM UI/UX to match Mantis Dashboard's modern, responsive, and clean design principles. This is a page-by-page upgrade that maintains existing functionality while dramatically improving visual design, responsiveness, and user experience.

**Related Epics**: Depends on [[Epic 1: Core CRM Foundation]]. Upgrades UI across all existing epics including [[Epic 3: Client Portal]], [[Epic 7: Calendar Scheduling System]], and [[Epic 6: Review Management System]].

**‚ö†Ô∏è Important Note**: This epic uses a **design-inspired approach** (enhancing Mantine UI to match Mantis design principles). If the results are not satisfactory, a **full Mantis migration** (switching from Mantine to Material-UI/MUI) may be considered as an alternative approach.

**Business Value:**
- **Modern Appearance**: Professional, clean design that matches industry-leading admin dashboards
- **Better Responsiveness**: Mobile-first design that works seamlessly across all devices
- **Improved UX**: Enhanced spacing, typography, and visual hierarchy for better usability
- **Consistent Design Language**: Unified design system across all pages and components
- **Professional Image**: Elevates the CRM's perceived quality and professionalism

**Design Principles (Inspired by Mantis Dashboard):**
- **Clean & Modern**: Minimal clutter, clear visual hierarchy, ample whitespace
- **Responsive**: Mobile-first approach with breakpoints for tablet and desktop
- **Consistent Spacing**: 8px base unit spacing scale (xs, sm, md, lg, xl, 2xl, 3xl)
- **Enhanced Shadows**: Subtle, layered shadows for depth and elevation
- **Modern Typography**: Improved font weights, sizes, and line heights
- **Card-Based Layouts**: KPI cards, dashboard widgets, and content cards
- **Action-Oriented Headers**: Header with notifications, theme toggle, settings
- **Professional Sidebar**: Clean navigation with icons and labels

**Approach:**
- **Page-by-Page Upgrade**: Upgrade one page at a time to minimize risk
- **Component Reusability**: Create reusable Mantis-style components (e.g., `MantisKPICard`)
- **Theme Enhancement**: Enhance existing Mantine theme rather than switching libraries
- **Backward Compatible**: Maintain all existing functionality during upgrade
- **Incremental Progress**: Track progress per page/component

**Alternative Approach (If Needed):**
- **Full Mantis Migration**: Switch from Mantine UI to Material-UI (MUI) using the actual Mantis template
- **Library Migration**: Would require replacing Mantine components with MUI equivalents
- **Template Integration**: Use Mantis React admin template directly from GitHub
- **Trade-offs**: More work upfront but potentially better design consistency

---

## Mantine to Mantis CSS Architecture

**Current State (December 2024)**: **Hybrid Approach** - Production Stable
- **Architecture**: Mantine CSS (base styles) + Mantis overrides (design system)
- **Mantine Dependencies**: 203 imports across 95 files
- **Current Approach**: `mantis-overrides.css` and `mantis-theme.ts` to style Mantine components as Mantis
- **Mantine Packages**: `@mantine/core`, `@mantine/hooks`, `@mantine/form`, `@mantine/dates`, `@mantine/notifications`, `@mantine/spotlight`
- **Mantis CSS**: Already extracted and available in `mantis-overrides.css` with full design tokens
- **CSS Bundle**: ~249 KB (Mantine: 198KB + Custom: 51KB)

**Decision**: **Stay with Hybrid Approach**
- ‚úÖ **Chosen**: Hybrid approach (Mantine CSS + Mantis overrides)
- ‚úÖ **Rationale**: 
  - Lower risk - no breaking changes
  - Maintains current visual appearance
  - Easier maintenance - Mantine provides base, Mantis provides design
  - Production-ready and stable
  - Bundle size savings (200KB) not critical enough to justify migration risk
- ‚úÖ **Status**: Production-ready, stable, actively maintained
- ‚è≥ **Future Consideration**: Full Mantis CSS migration (optional, if requirements change)

**Why Hybrid Works:**
- Mantine CSS provides robust base styles (resets, typography, variables)
- Mantis overrides apply design system (colors, shadows, spacing)
- Best of both worlds: stability + design consistency
- Lower maintenance burden than pure Mantis
- No migration risk or downtime

---

### Migration Options (Future Reference Only)

**‚ö†Ô∏è NOTE**: The migration options below are documented for **future reference only**. Current decision is to **stay with hybrid approach**. This section preserves the analysis and options considered, but full migration is **not currently planned**.

**When to Reconsider Full Migration:**
- If bundle size becomes a critical performance issue
- If Mantine CSS updates cause significant conflicts
- If full Mantis component library becomes available
- If design system requirements change significantly
- If maintenance burden of hybrid approach increases

**Option A: Keep Mantine Components, Remove Mantine CSS** (Analyzed - Not Implemented)
- **Approach**: 
  - Keep Mantine component APIs (Card, Button, Input, etc.)
  - Remove Mantine CSS bundle from build
  - Use only Mantis CSS for all styling
  - Create wrapper components that apply Mantis classes to Mantine components
- **Pros**:
  - Lower risk - component APIs remain unchanged
  - Faster migration (estimated 40-60 hours)
  - Maintains existing functionality
  - Can be done incrementally
- **Cons**:
  - Still depends on Mantine JavaScript bundle
  - Some Mantine-specific features may need workarounds
- **Effort**: 40-60 hours (incremental, page-by-page)
- **Priority**: Medium
- **Risk**: Low

**Option B: Full Component Replacement** (Higher Risk, Cleaner Result)
- **Approach**:
  - Replace all Mantine components with custom components using pure Mantis CSS
  - Remove all Mantine dependencies
  - Build component library from scratch using Mantis design tokens
- **Pros**:
  - Complete independence from Mantine
  - Smaller bundle size (no Mantine JS)
  - Full control over component behavior
  - Cleaner codebase
- **Cons**:
  - Much higher risk and effort
  - Need to rebuild all component functionality
  - Potential for bugs and regressions
  - Longer timeline
- **Effort**: 120-160 hours (full rewrite)
- **Priority**: Low (future consideration)
- **Risk**: High

**‚ö†Ô∏è NOTE: Migration not planned - staying with hybrid approach**

### CSS-Only Migration (Simplified Approach) - Future Reference Only

**Can we just migrate CSS for now?** **Yes, absolutely!** This was analyzed as a potential first step, but **not implemented** - staying with hybrid approach.

**CSS-Only Migration Strategy:**
1. **Remove Mantine CSS from bundle** (4-8 hours)
   - Configure Vite to exclude Mantine CSS imports
   - Ensure Mantis CSS loads properly
   - Test that components still render (may look unstyled initially)

2. **Enhance `mantis-overrides.css`** (8-16 hours)
   - Expand existing overrides to cover all Mantine components
   - Add component-specific Mantis styling
   - Ensure full visual parity with current design

3. **Test and refine** (4-8 hours)
   - Visual regression testing
   - Fix any styling gaps
   - Verify dark/light mode compatibility

**Benefits of CSS-Only Approach:**
- ‚úÖ **Low Risk**: No component API changes
- ‚úÖ **Fast**: Can be done in 1-2 weeks
- ‚úÖ **Reversible**: Easy to rollback if issues arise
- ‚úÖ **Incremental**: Can test page-by-page
- ‚úÖ **Immediate Benefits**: Remove 200-300 KB of Mantine CSS
- ‚úÖ **Foundation**: Sets up for future wrapper component migration

**What This Achieves:**
- Removes Mantine CSS dependency (~200-300 KB bundle reduction)
- Pure Mantis styling across all components
- No breaking changes to existing code
- Can defer wrapper components to later phase

**What We Defer:**
- Wrapper component creation (can do later)
- Component API changes (not needed for CSS-only)
- Full component replacement (Option B - future consideration)

**Timeline**: 1-2 weeks (16-32 hours) - **Not implemented, staying with hybrid**

**Next Steps After CSS Migration (If Implemented):**
- Optionally create wrapper components for better organization
- Optionally migrate to full component replacement (Option B) if desired
- Or simply maintain CSS-only approach (perfectly valid long-term solution)

### Full Migration Phases (If Proceeding with Option A) - Future Reference Only

**‚ö†Ô∏è NOTE: These phases are documented for future reference only. Current decision is to stay with hybrid approach.**

**Phase 1: Foundation (Week 1)**
1. Create Mantis component wrappers (8 hours)
   - `MantisCard`, `MantisButton`, `MantisInput`, `MantisTable`
   - Wrappers apply Mantis CSS classes to Mantine components
2. Remove Mantine CSS from build (4 hours)
   - Configure Vite to exclude Mantine CSS
   - Ensure Mantis CSS loads properly
3. Test core pages (4 hours)
   - Dashboard, Clients, Calendar
   - Fix any styling regressions
**Total**: 16 hours

**Phase 2: Component Migration (Weeks 2-4)**
1. Migrate high-usage components (20 hours)
   - Card, Button, Input, Select, Table (used in 50+ files)
2. Migrate form components (12 hours)
   - TextInput, Textarea, NumberInput, DatePicker
3. Migrate layout components (8 hours)
   - Container, Stack, Group, Grid
4. Migrate feedback components (4 hours)
   - Alert, Notification, Modal, Tooltip
**Total**: 44 hours

**Phase 3: Page-by-Page Migration (Weeks 5-8)**
1. Core pages (16 hours)
   - Dashboard, Clients, Client Detail, Client Form
2. Calendar pages (12 hours)
   - Calendar, Event Types, Booking Pages
3. Settings pages (12 hours)
   - All settings pages
4. Marketing pages (16 hours)
   - All marketing pages
5. Other pages (8 hours)
   - Reviews, Inbox, etc.
**Total**: 64 hours

**Phase 4: Cleanup & Optimization (Week 9)**
1. Remove unused Mantine CSS references (4 hours)
2. Optimize Mantis CSS bundle (4 hours)
3. Update documentation (2 hours)
4. Final testing (6 hours)
**Total**: 16 hours

**Total Estimated Effort**: 140 hours (Full Option A Migration)

### Technical Implementation Details

**1. Mantine CSS Removal Process:**
- **Current**: Mantine CSS loaded via `@mantine/core` imports (~200-300 KB)
- **Target**: Remove Mantine CSS, keep only Mantis CSS
- **Method**: 
  - Configure Vite to exclude Mantine CSS from bundle
  - Use `vite.config.ts` to exclude CSS imports
  - Ensure Mantis CSS loads first, then component-specific overrides
- **Verification**: Bundle analyzer to confirm Mantine CSS removed

**2. Component Wrapper Architecture:**
```typescript
// Example: MantisCard wrapper
import { Card, CardProps } from '@mantine/core';
import './mantis-card.css'; // Pure Mantis CSS, no Mantine CSS

export function MantisCard(props: CardProps) {
  return (
    <Card 
      {...props}
      className={`mantis-card ${props.className || ''}`}
      // Mantine JS handles component logic
      // Mantis CSS handles all styling
    />
  );
}
```

**3. Component Mapping Strategy:**

| Mantine Component | Mantis Wrapper | CSS File | Priority |
|------------------|----------------|----------|----------|
| `Card` | `MantisCard` | `mantis-card.css` | High (50+ files) |
| `Button` | `MantisButton` | `mantis-button.css` | High (80+ files) |
| `TextInput` | `MantisInput` | `mantis-input.css` | High (60+ files) |
| `Select` | `MantisSelect` | `mantis-select.css` | High (40+ files) |
| `Table` | `MantisTable` | `mantis-table.css` | High (30+ files) |
| `Modal` | `MantisModal` | `mantis-modal.css` | Medium (20+ files) |
| `Tabs` | `MantisTabs` | `mantis-tabs.css` | Medium (25+ files) |
| `Alert` | `MantisAlert` | `mantis-alert.css` | Medium (15+ files) |
| `Badge` | `MantisBadge` | `mantis-badge.css` | Medium (20+ files) |
| `Stack` | `MantisStack` | `mantis-stack.css` | Low (layout only) |
| `Group` | `MantisGroup` | `mantis-group.css` | Low (layout only) |
| `Grid` | `MantisGrid` | `mantis-grid.css` | Low (layout only) |

**4. CSS Architecture:**
```
crm/client/src/
‚îú‚îÄ‚îÄ mantis-overrides.css          # Global Mantis design tokens (existing)
‚îú‚îÄ‚îÄ components/mantis/
‚îÇ   ‚îú‚îÄ‚îÄ mantis-card.css           # Card-specific Mantis styling
‚îÇ   ‚îú‚îÄ‚îÄ mantis-button.css         # Button-specific Mantis styling
‚îÇ   ‚îú‚îÄ‚îÄ mantis-input.css          # Input-specific Mantis styling
‚îÇ   ‚îú‚îÄ‚îÄ mantis-table.css          # Table-specific Mantis styling
‚îÇ   ‚îî‚îÄ‚îÄ ...                       # Other component CSS files
‚îî‚îÄ‚îÄ components/mantis/
    ‚îú‚îÄ‚îÄ MantisCard.tsx            # Card wrapper component
    ‚îú‚îÄ‚îÄ MantisButton.tsx          # Button wrapper component
    ‚îú‚îÄ‚îÄ MantisInput.tsx           # Input wrapper component
    ‚îî‚îÄ‚îÄ ...                       # Other wrapper components
```

**5. Vite Configuration Changes:**
```typescript
// vite.config.ts
export default defineConfig({
  // ... existing config
  build: {
    rollupOptions: {
      external: [], // Don't externalize, but exclude CSS
    },
  },
  css: {
    // Exclude Mantine CSS from bundle
    exclude: ['**/node_modules/@mantine/**/*.css'],
  },
  optimizeDeps: {
    exclude: ['@mantine/core', '@mantine/hooks'], // Keep JS, exclude CSS
  },
});
```

**6. Bundle Size Targets:**

| Metric | Before | Target | Reduction |
|--------|--------|--------|-----------|
| Total CSS | ~500 KB | ~300 KB | 200 KB |
| Mantine CSS | ~250 KB | 0 KB | 250 KB |
| Mantis CSS | ~50 KB | ~300 KB | +250 KB (but pure Mantis) |
| Net Reduction | - | - | ~200 KB |

**7. Risk Mitigation Strategies:**

**Risk 1: Styling Regressions**
- **Mitigation**: 
  - Create visual regression tests (screenshots)
  - Test each page after migration
  - Keep Mantine CSS available during transition (feature flag)
- **Rollback**: Revert to Mantine imports if issues found

**Risk 2: Component Behavior Changes**
- **Mitigation**:
  - Keep Mantine JS packages (component logic unchanged)
  - Only replace CSS, not component APIs
  - Test all interactive features thoroughly
- **Rollback**: Re-enable Mantine CSS if behavior breaks

**Risk 3: Missing Functionality**
- **Mitigation**:
  - Audit all Mantine component features used
  - Create feature parity checklist
  - Test edge cases and advanced features
- **Rollback**: Keep Mantine CSS for specific components if needed

**Risk 4: Performance Issues**
- **Mitigation**:
  - Monitor bundle size after each phase
  - Use bundle analyzer to verify CSS removal
  - Test page load times
- **Rollback**: Revert if bundle size increases unexpectedly

**8. Testing Strategy:**

**Unit Testing:**
- Test wrapper components render correctly
- Test props pass-through to Mantine components
- Test className merging

**Visual Testing:**
- Screenshot comparison (before/after)
- Visual regression testing
- Cross-browser testing (Chrome, Firefox, Safari, Edge)

**Functional Testing:**
- All forms submit correctly
- All modals open/close correctly
- All tables sort/filter correctly
- All navigation works
- All interactive features work

**Performance Testing:**
- Bundle size comparison
- Page load time comparison
- Runtime performance (no degradation)

**9. Rollback Procedure:**

If issues arise during migration:
1. **Immediate Rollback**: Revert last commit, re-enable Mantine CSS
2. **Partial Rollback**: Keep Mantis CSS for migrated pages, Mantine for others
3. **Component-Level Rollback**: Revert specific component wrappers if needed
4. **Feature Flag**: Use environment variable to toggle between Mantine/Mantis CSS

**10. Success Metrics:**
- ‚úÖ **Bundle Size**: Mantine CSS removed (verified via bundle analyzer)
- ‚úÖ **Visual Consistency**: All pages match Mantis design system
- ‚úÖ **Functionality**: All features work as before
- ‚úÖ **Performance**: No degradation in page load times
- ‚úÖ **Code Quality**: All 95 files migrated to Mantis wrappers (if doing full migration)
- ‚úÖ **Documentation**: Migration guide and component docs updated

**11. Long-Term Benefits:**
- **Maintainability**: Single design system (Mantis) instead of two (Mantine + Mantis)
- **Consistency**: All components follow Mantis design tokens
- **Performance**: Smaller bundle size, faster load times
- **Future-Proof**: No dependency on Mantine CSS updates
- **Flexibility**: Full control over styling with Mantis CSS
- **Developer Experience**: Clear component API, consistent styling

**12. Dependencies & Prerequisites:**

**Keep:**
- `@mantine/core` (JavaScript - component logic)
- `@mantine/hooks` (JavaScript - hooks)
- `@mantine/form` (JavaScript - form logic)
- `@mantine/dates` (JavaScript - date picker logic)
- `@mantine/notifications` (JavaScript - notification logic)

**Remove:**
- Mantine CSS bundle (~250 KB)
- Mantine theme CSS
- Mantine component CSS

**Add:**
- Mantis CSS files (component-specific)
- Mantis wrapper components (optional, for full migration)
- Mantis design token system (already exists)

**13. Timeline Summary:**

| Phase | Duration | Effort | Deliverable |
|-------|----------|--------|-------------|
| CSS-Only Migration | 1-2 weeks | 16-32 hours | Mantine CSS removed, Mantis CSS only |
| Phase 1: Foundation | Week 1 | 16 hours | Wrappers, CSS removal, core pages tested |
| Phase 2: Components | Weeks 2-4 | 44 hours | All components migrated |
| Phase 3: Pages | Weeks 5-8 | 64 hours | All pages migrated |
| Phase 4: Cleanup | Week 9 | 16 hours | Optimization, documentation |
| **Total (Full)** | **9 weeks** | **140 hours** | **Complete migration** |

**14. Alternative: Gradual Migration:**

If full migration is too risky, consider gradual approach:
- **Phase 1**: Migrate new pages/components to Mantis only
- **Phase 2**: Migrate high-traffic pages incrementally
- **Phase 3**: Migrate remaining pages over 6-12 months
- **Benefit**: Lower risk, can pause/resume as needed
- **Trade-off**: Longer timeline, maintain both systems temporarily

**Files to Create/Modify:**
- `crm/client/src/components/mantis/MantisCard.tsx` - Card wrapper (optional)
- `crm/client/src/components/mantis/MantisButton.tsx` - Button wrapper (optional)
- `crm/client/src/components/mantis/MantisInput.tsx` - Input wrapper (optional)
- `crm/client/src/components/mantis/MantisTable.tsx` - Table wrapper (optional)
- `crm/client/vite.config.ts` - Exclude Mantine CSS
- `crm/client/src/mantis-overrides.css` - Expand to full component coverage
- All 95 files using Mantine components - Replace imports with Mantis wrappers (if doing full migration)

**Dependencies:**
- Keep Mantine JavaScript packages (for component logic)
- Remove Mantine CSS from bundle
- Use only Mantis CSS for styling

**Success Criteria:**
- ‚úÖ Zero Mantine CSS in bundle
- ‚úÖ All components styled with Mantis CSS
- ‚úÖ All functionality maintained
- ‚úÖ Bundle size reduced by 200-300 KB
- ‚úÖ Visual consistency across all pages

---

**Completed Components:**
- ‚úÖ **Theme Enhancement** (`crm/client/src/theme.ts`):
  - Enhanced shadows (sm, md, lg, xl, 2xl)
  - Extended spacing scale (2xl, 3xl)
  - Refined typography (font weights, sizes, line heights)
  - Improved color palette for dark/light modes

- ‚úÖ **Layout Component** (`crm/client/src/components/Layout.tsx`):
  - Modernized header with action buttons (notifications, theme toggle, settings)
  - Improved spacing and visual hierarchy
  - Enhanced sidebar styling

- ‚úÖ **Dashboard Page** (`crm/client/src/pages/DashboardPage.tsx`):
  - Mantis-style KPI cards with real API data integration
  - Responsive grid layout for KPI cards
  - Business line details section with improved styling
  - Clean tab styling and typography

- ‚úÖ **MantisKPICard Component** (`crm/client/src/components/MantisKPICard.tsx`):
  - Reusable KPI card component with Mantis design
  - Supports trending indicators, percentages, and extra text

---

### 22.10.5 CSS Architecture Analysis & Upgrade Recommendations

**Current CSS Architecture Assessment** (December 2024)

**Current State:**
- **Hybrid Approach**: Mantine CSS (base) + Mantis overrides (styling)
- **Total CSS Files**: 3 files (1,977 lines total)
  - `index.css`: 1,312 lines (Tailwind CSS + custom theme)
  - `mantis-overrides.css`: 664 lines (Mantis design system overrides)
  - `App.css`: 1 line (minimal)
- **CSS Bundle Size**: ~249 KB (Mantine: 198KB + Custom: 51KB)
- **!important Usage**: 215 declarations in `mantis-overrides.css` (maintainability concern)
- **CSS Frameworks**: Mixing Tailwind CSS with Mantine CSS (potential conflicts)

**Current Architecture Strengths:**
‚úÖ Mantis design tokens well-defined (CSS variables)
‚úÖ Comprehensive component overrides (93 Mantine classes)
‚úÖ Dark/light theme support
‚úÖ Responsive design considerations
‚úÖ Material-UI elevation system implemented

**Current Architecture Weaknesses:**
‚ö†Ô∏è **High !important Usage** (215 instances) - Makes CSS hard to maintain and override
‚ö†Ô∏è **Monolithic Files** - Large CSS files (664+ lines) are hard to navigate
‚ö†Ô∏è **No CSS Modularity** - All styles in single files, no component-specific CSS
‚ö†Ô∏è **Framework Mixing** - Tailwind CSS + Mantine CSS may conflict
‚ö†Ô∏è **No CSS Linting** - No automated style validation
‚ö†Ô∏è **No CSS Organization** - No clear file structure or naming conventions
‚ö†Ô∏è **Limited Reusability** - Styles not organized for component reuse

**Upgrade Recommendations for Robustness:**

#### Recommendation 1: CSS Modularization (High Priority)

**Problem**: Monolithic CSS files are hard to maintain and navigate.

**Solution**: Split CSS into component-specific modules.

**Proposed Structure:**
```
crm/client/src/styles/
‚îú‚îÄ‚îÄ base/
‚îÇ   ‚îú‚îÄ‚îÄ reset.css              # CSS resets
‚îÇ   ‚îú‚îÄ‚îÄ variables.css          # Design tokens (Mantis variables)
‚îÇ   ‚îî‚îÄ‚îÄ typography.css         # Typography system
‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îú‚îÄ‚îÄ mantis-card.css        # Card component styles
‚îÇ   ‚îú‚îÄ‚îÄ mantis-button.css      # Button component styles
‚îÇ   ‚îú‚îÄ‚îÄ mantis-input.css       # Input component styles
‚îÇ   ‚îú‚îÄ‚îÄ mantis-table.css       # Table component styles
‚îÇ   ‚îú‚îÄ‚îÄ mantis-modal.css       # Modal component styles
‚îÇ   ‚îî‚îÄ‚îÄ ...                    # Other component styles
‚îú‚îÄ‚îÄ layout/
‚îÇ   ‚îú‚îÄ‚îÄ app-shell.css          # AppShell layout styles
‚îÇ   ‚îú‚îÄ‚îÄ navbar.css             # Navbar styles
‚îÇ   ‚îî‚îÄ‚îÄ header.css             # Header styles
‚îú‚îÄ‚îÄ utilities/
‚îÇ   ‚îú‚îÄ‚îÄ responsive.css         # Responsive utilities
‚îÇ   ‚îî‚îÄ‚îÄ animations.css         # Animation utilities
‚îî‚îÄ‚îÄ mantis-overrides.css       # Global overrides (legacy, to be phased out)
```

**Benefits:**
- ‚úÖ Easier to find and modify component styles
- ‚úÖ Better code organization
- ‚úÖ Easier to maintain and test
- ‚úÖ Enables component-level CSS optimization
- ‚úÖ Reduces merge conflicts

**Effort**: 8-12 hours
**Priority**: High
**Risk**: Low

#### Recommendation 2: Reduce !important Usage (High Priority)

**Problem**: 215 `!important` declarations make CSS hard to override and maintain.

**Solution**: Use CSS specificity and cascade properly.

**Strategies:**
1. **Increase Specificity Instead of !important**
   ```css
   /* Instead of: */
   .mantine-Card-root { background: #fff !important; }
   
   /* Use: */
   .mantine-AppShell-main .mantine-Card-root { background: #fff; }
   ```

2. **Use CSS Layers** (Modern browsers)
   ```css
   @layer mantis-overrides {
     .mantine-Card-root { background: #fff; }
   }
   ```

3. **Component-Specific Selectors**
   ```css
   /* More specific selectors naturally override */
   [data-mantine-color-scheme="light"] .mantine-Card-root { ... }
   ```

4. **CSS Custom Properties for Dynamic Values**
   ```css
   .mantine-Card-root {
     background: var(--mantis-card-bg, #fff);
   }
   ```

**Benefits:**
- ‚úÖ More maintainable CSS
- ‚úÖ Easier to override when needed
- ‚úÖ Better cascade behavior
- ‚úÖ Follows CSS best practices

**Effort**: 16-24 hours (gradual refactoring)
**Priority**: High
**Risk**: Medium (requires thorough testing)

#### Recommendation 3: CSS Linting & Validation (Medium Priority)

**Problem**: No automated CSS quality checks.

**Solution**: Add Stylelint with custom rules.

**Implementation:**
```json
// .stylelintrc.json
{
  "extends": ["stylelint-config-standard"],
  "rules": {
    "declaration-no-important": {
      "severity": "warning",
      "message": "Avoid !important. Use specificity instead."
    },
    "selector-max-specificity": "0,4,0",
    "max-nesting-depth": 3
  }
}
```

**Benefits:**
- ‚úÖ Catches CSS errors early
- ‚úÖ Enforces coding standards
- ‚úÖ Prevents !important abuse
- ‚úÖ Improves code quality

**Effort**: 2-4 hours
**Priority**: Medium
**Risk**: Low

#### Recommendation 4: Design Token System (Medium Priority)

**Problem**: Design tokens scattered across files.

**Solution**: Centralize all design tokens in a single source of truth.

**Proposed Structure:**
```css
/* styles/base/tokens.css */
:root {
  /* Mantis Color System */
  --mantis-primary-500: #2196f3;
  --mantis-primary-700: #1976d2;
  /* ... all color tokens ... */
  
  /* Mantis Spacing System */
  --mantis-spacing-xs: 4px;
  --mantis-spacing-sm: 8px;
  /* ... all spacing tokens ... */
  
  /* Mantis Typography System */
  --mantis-font-family: "Roboto", sans-serif;
  --mantis-font-size-base: 14px;
  /* ... all typography tokens ... */
  
  /* Mantis Shadow System */
  --mantis-shadow-1: 0px 2px 1px -1px rgba(0,0,0,0.2), ...;
  /* ... all shadow tokens ... */
}
```

**Benefits:**
- ‚úÖ Single source of truth for design values
- ‚úÖ Easy theme customization
- ‚úÖ Consistent design system
- ‚úÖ Can be exported to JS/TS for type safety

**Effort**: 4-6 hours
**Priority**: Medium
**Risk**: Low

#### Recommendation 5: CSS Performance Optimization (Low Priority)

**Problem**: Large CSS bundle, potential performance impact.

**Solutions:**
1. **CSS Purging** - Remove unused CSS
2. **Critical CSS** - Inline above-the-fold CSS
3. **CSS Code Splitting** - Load component CSS on demand
4. **CSS Minification** - Already done by Vite

**Benefits:**
- ‚úÖ Faster page loads
- ‚úÖ Smaller bundle size
- ‚úÖ Better Core Web Vitals

**Effort**: 4-8 hours
**Priority**: Low (already optimized by Vite)
**Risk**: Low

#### Recommendation 6: CSS-in-JS Consideration (Future)

**Problem**: CSS files separate from components, harder to co-locate.

**Future Consideration**: CSS Modules or CSS-in-JS for component-specific styles.

**Options:**
- **CSS Modules**: Scoped CSS per component
- **Styled Components**: CSS-in-JS with React
- **Emotion**: Lightweight CSS-in-JS

**Benefits:**
- ‚úÖ Component-scoped styles
- ‚úÖ No style conflicts
- ‚úÖ Better developer experience
- ‚úÖ Type-safe CSS

**Effort**: 40-60 hours (full migration)
**Priority**: Low (future consideration)
**Risk**: Medium (significant refactoring)

**Recommended Implementation Order:**

**Phase 1: Foundation (Week 1)**
1. ‚úÖ Reduce !important usage (16 hours)
2. ‚úÖ Add CSS linting (2 hours)
3. ‚úÖ Create design token system (4 hours)
**Total**: 22 hours

**Phase 2: Modularization (Week 2)**
1. ‚úÖ Split CSS into modules (8 hours)
2. ‚úÖ Organize component styles (4 hours)
3. ‚úÖ Update imports (2 hours)
**Total**: 14 hours

**Phase 3: Optimization (Week 3)**
1. ‚úÖ Performance optimization (4 hours)
2. ‚úÖ Documentation (2 hours)
3. ‚úÖ Testing (4 hours)
**Total**: 10 hours

**Total Estimated Effort**: 46 hours (3 weeks)

**Success Metrics:**
- ‚úÖ !important usage reduced by 80%+ (from 215 to <50)
- ‚úÖ CSS organized into logical modules
- ‚úÖ CSS linting passing with zero errors
- ‚úÖ Design tokens centralized
- ‚úÖ No visual regressions
- ‚úÖ Bundle size maintained or reduced

**Long-Term Benefits:**
- **Maintainability**: Easier to find and modify styles
- **Scalability**: Can add new components without CSS conflicts
- **Performance**: Optimized CSS loading
- **Developer Experience**: Better tooling and organization
- **Code Quality**: Automated validation and standards enforcement
  - Dark/light mode support
  - Hover effects and transitions

**Pages to Upgrade (Priority Order):**

**Tier 1: Core Pages (High Priority) - ‚úÖ COMPLETE**
1. ‚úÖ **Dashboard** (`crm/client/src/pages/DashboardPage.tsx`) - ‚úÖ Complete
2. ‚úÖ **Layout** (`crm/client/src/components/Layout.tsx`) - ‚úÖ Complete (header and sidebar upgraded)
3. ‚úÖ **Clients** (`crm/client/src/pages/ClientsPage.tsx`) - ‚úÖ Complete (Mantis-style table, filters, tabs)
4. ‚úÖ **Client Detail** (`crm/client/src/pages/ClientDetailPage.tsx`) - ‚úÖ Complete (Mantis-style cards, improved header)
5. ‚úÖ **Client Form** (`crm/client/src/pages/ClientFormPage.tsx`) - ‚úÖ Complete (Mantis-style cards, improved header)
6. ‚úÖ **Calendar** (`crm/client/src/pages/CalendarPage.tsx`) - ‚úÖ Complete (Mantis-style header and tabs)
7. ‚úÖ **Inbox** (`crm/client/src/pages/InboxPage.tsx`) - ‚úÖ Complete (Mantis-style header, tabs, and cards)

**Tier 2: Calendar System Pages (Medium Priority)**
8. ‚è≥ **Calendar Home Tab** (`crm/client/src/pages/calendar/HomeTab.tsx`) - Appointment list, filters
9. ‚è≥ **Event Types List** (`crm/client/src/pages/calendar/EventTypesList.tsx`) - Event type cards, actions
10. ‚è≥ **Event Type Manager** (`crm/client/src/pages/calendar/EventTypeManager.tsx`) - Form layout, tabs
11. ‚úÖ **Booking Pages Tab** (`crm/client/src/pages/calendar/BookingPagesTab.tsx`) - ‚úÖ Complete (Mantis-style header, tabs, cards, and tables)
12. ‚è≥ **Booking Page Manager** (`crm/client/src/pages/calendar/BookingPageManager.tsx`) - Form layout, settings
13. ‚úÖ **Calendar Settings Tab** (`crm/client/src/pages/calendar/SettingsTab.tsx`) - ‚úÖ Complete (Mantis-style header and AvailabilitySettings component)
14. ‚úÖ **Calendar Integration Tab** (`crm/client/src/pages/calendar/IntegrationTab.tsx`) - ‚úÖ Complete (Mantis-style header, cards, and sections)
15. ‚úÖ **Calendar API Tab** (`crm/client/src/pages/calendar/CalendarApiTab.tsx`) - ‚úÖ Complete (Mantis-style header, cards, and table)

**Tier 3: Settings Pages (Medium Priority)**
16. ‚è≥ **Settings** (`crm/client/src/pages/SettingsPage.tsx`) - Settings tabs, forms
17. ‚è≥ **Profile Settings** (`crm/client/src/pages/ProfileSettingsPage.tsx`) - Profile form, avatar
18. ‚è≥ **Security Settings** (`crm/client/src/pages/SecuritySettingsPage.tsx`) - Security options, 2FA
19. ‚è≥ **Portal Settings** (`crm/client/src/pages/PortalSettingsPage.tsx`) - Portal configuration
20. ‚è≥ **Carrier Settings** (`crm/client/src/pages/CarrierSettingsPage.tsx`) - Carrier list, cards
21. ‚è≥ **Commissions Settings** (`crm/client/src/pages/CommissionsSettingsPage.tsx`) - Commission tables
22. ‚è≥ **API Settings** (`crm/client/src/pages/ApiSettingsPage.tsx`) - API key management

**Tier 4: Marketing & Reviews (Lower Priority)**
23. ‚è≥ **Marketing** (`crm/client/src/pages/MarketingPage.tsx`) - Marketing dashboard
24. ‚è≥ **Medicare Marketing** (`crm/client/src/pages/marketing/MedicareMarketingPage.tsx`) - Marketing forms
25. ‚è≥ **Health Insurance Marketing** (`crm/client/src/pages/marketing/HealthInsuranceMarketingPage.tsx`) - Marketing forms
26. ‚è≥ **Life Insurance Marketing** (`crm/client/src/pages/marketing/LifeInsuranceMarketingPage.tsx`) - Marketing forms
27. ‚è≥ **Group Benefits Marketing** (`crm/client/src/pages/marketing/GroupHealthMarketingPage.tsx`) - Marketing forms
28. ‚è≥ **Commercial Marketing** (`crm/client/src/pages/marketing/CommercialMarketingPage.tsx`) - Marketing forms
29. ‚è≥ **Reviews Page** (`crm/client/src/pages/reviews/ReviewsPage.tsx`) - Reviews dashboard
30. ‚è≥ **Reviews Dashboard Tab** (`crm/client/src/pages/reviews/DashboardTab.tsx`) - Reviews metrics
31. ‚è≥ **Reviews Settings Tab** (`crm/client/src/pages/reviews/SettingsTab.tsx`) - Review settings
32. ‚è≥ **Reviews Get Reviews Tab** (`crm/client/src/pages/reviews/GetReviewsTab.tsx`) - Review collection
33. ‚è≥ **Reviews Integrations Tab** (`crm/client/src/pages/reviews/IntegrationsTab.tsx`) - Review integrations
34. ‚è≥ **Reviews Reports Tab** (`crm/client/src/pages/reviews/ReportsTab.tsx`) - Review reports
35. ‚è≥ **Reviews Widgets Tab** (`crm/client/src/pages/reviews/WidgetsTab.tsx`) - Review widgets
36. ‚è≥ **Reviews Custom Options Tab** (`crm/client/src/pages/reviews/CustomOptionsTab.tsx`) - Custom options
37. ‚è≥ **Reviews My Reviews Tab** (`crm/client/src/pages/reviews/MyReviewsTab.tsx`) - Review list
38. ‚è≥ **Reviews Private Feedback Tab** (`crm/client/src/pages/reviews/PrivateFeedbackTab.tsx`) - Private feedback
39. ‚è≥ **Review Submission** (`crm/client/src/pages/ReviewSubmissionPage.tsx`) - Review form

**Tier 5: Other Pages (Lower Priority)**
40. ‚è≥ **Profile** (`crm/client/src/pages/ProfilePage.tsx`) - Profile view
41. ‚è≥ **Booking Information** (`crm/client/src/pages/BookingInformationPage.tsx`) - Booking details
42. ‚è≥ **Public Booking** (`crm/client/src/pages/PublicBookingPage.tsx`) - Public booking interface
43. ‚è≥ **Simple Calendar** (`crm/client/src/pages/SimpleCalendarPage.tsx`) - Simple calendar view
44. ‚è≥ **Connectors** (`crm/client/src/pages/ConnectorsPage.tsx`) - Integration connectors
45. ‚è≥ **Manage Ads** (`crm/client/src/pages/ManageAdsPage.tsx`) - Ad management

**Components to Upgrade:**

**Core Components:**
1. ‚úÖ **MantisKPICard** (`crm/client/src/components/MantisKPICard.tsx`) - ‚úÖ Complete
2. ‚è≥ **Layout** (`crm/client/src/components/Layout.tsx`) - üöß Partial (header done, sidebar pending)
3. ‚è≥ **CalendarView** (`crm/client/src/components/calendar/CalendarView.tsx`) - Calendar grid, list view
4. ‚è≥ **AppointmentForm** (`crm/client/src/components/calendar/AppointmentForm.tsx`) - Form layout, fields
5. ‚è≥ **AvailabilitySettings** (`crm/client/src/components/calendar/AvailabilitySettings.tsx`) - Settings form
6. ‚è≥ **CallDrawer** (`crm/client/src/components/CallDrawer.tsx`) - Drawer layout, call interface
7. ‚è≥ **CallTranscriptionWindow** (`crm/client/src/components/CallTranscriptionWindow.tsx`) - Transcription UI
8. ‚è≥ **ChatWindow** (`crm/client/src/components/ChatWindow.tsx`) - Chat interface
9. ‚è≥ **ClientDocuments** (`crm/client/src/components/ClientDocuments.tsx`) - Document list, cards
10. ‚è≥ **ClientHealthInfoForm** (`crm/client/src/components/ClientHealthInfoForm.tsx`) - Health form
11. ‚è≥ **ConversationHistory** (`crm/client/src/components/ConversationHistory.tsx`) - History list
12. ‚è≥ **ConversationSummary** (`crm/client/src/components/ConversationSummary.tsx`) - Summary card
13. ‚è≥ **HouseholdPremium** (`crm/client/src/components/HouseholdPremium.tsx`) - Premium display
14. ‚è≥ **PlanSelections** (`crm/client/src/components/PlanSelections.tsx`) - Plan cards, selection
15. ‚è≥ **MarketingAnalytics** (`crm/client/src/components/MarketingAnalytics.tsx`) - Analytics charts
16. ‚è≥ **LeadEmailTemplateRow** (`crm/client/src/components/LeadEmailTemplateRow.tsx`) - Template row
17. ‚è≥ **CollapsibleSection** (`crm/client/src/components/shared/CollapsibleSection.tsx`) - Collapsible UI

**UI Components:**
18. ‚è≥ **Button** (`crm/client/src/components/ui/button.tsx`) - Button variants, styles
19. ‚è≥ **Card** (`crm/client/src/components/ui/card.tsx`) - Card variants, shadows
20. ‚è≥ **Input** (`crm/client/src/components/ui/input.tsx`) - Input styles, validation
21. ‚è≥ **Label** (`crm/client/src/components/ui/label.tsx`) - Label styles

**Design Patterns to Apply:**

**1. KPI Cards (Dashboard Style)**
- Large number with trend indicator
- Percentage badge (green/red)
- Icon or visual element
- Extra descriptive text
- Hover effects and transitions

**2. Data Tables**
- Clean borders and spacing
- Hover row highlighting
- Action buttons in rows
- Responsive mobile cards
- Pagination and filters

**3. Forms**
- Consistent spacing between fields
- Clear labels and help text
- Validation error styling
- Section grouping with cards
- Submit button placement

**4. Lists & Cards**
- Card-based layouts for items
- Consistent padding and margins
- Hover states and transitions
- Action buttons/icons
- Empty states

**5. Navigation**
- Clean sidebar with icons
- Active state indicators
- Collapsible sections
- Breadcrumbs for deep pages
- Header actions (notifications, theme, settings)

**6. Modals & Drawers**
- Consistent sizing and spacing
- Clear header and footer
- Action button placement
- Backdrop styling
- Responsive behavior

**Implementation Guidelines:**

**Theme Updates:**
- Use enhanced shadows: `theme.shadows.sm`, `theme.shadows.md`, `theme.shadows.lg`
- Use extended spacing: `theme.spacing.xl`, `theme.spacing['2xl']`, `theme.spacing['3xl']`
- Maintain dark/light mode consistency
- Use consistent border radius: `theme.radius.md` (default)

**Component Patterns:**
- Wrap content in `Card` components for visual grouping
- Use `Stack` with consistent `gap` values (xs, sm, md, lg)
- Use `Group` for horizontal layouts with `justify="space-between"`
- Apply hover effects: `transition: 'all 0.2s ease'`
- Use `Badge` components for status indicators

**Responsive Design:**
- Mobile-first approach
- Use Mantine's `Grid` for responsive layouts
- Breakpoints: `xs` (mobile), `sm` (tablet), `md` (desktop), `lg` (large desktop)
- Stack vertically on mobile, horizontal on desktop
- Hide/show elements based on screen size

**Progress Tracking:**

**Completed:**
- ‚úÖ Theme enhancement (shadows, spacing, typography)
- ‚úÖ Layout header modernization
- ‚úÖ Layout sidebar upgrade (Mantis-style navigation with improved styling)
- ‚úÖ Dashboard page redesign
- ‚úÖ Clients page upgrade (Mantis-style table, filters, tabs, improved spacing)
- ‚úÖ Client Detail page upgrade (Mantis-style cards, improved header with client name, better visual hierarchy)
- ‚úÖ Client Form page upgrade (Mantis-style cards, improved header, better visual hierarchy)
- ‚úÖ Calendar page upgrade (Mantis-style header and tabs)
- ‚úÖ Inbox page upgrade (Mantis-style header, tabs, and notification/voicemail cards)
- ‚úÖ MantisKPICard component
- ‚úÖ Applications page route and navigation (added route, back buttons on all application pages)

**In Progress:**
- ‚úÖ Layout sidebar upgrade (complete)
- ‚úÖ Calendar pages upgrade (complete)
- üöß Client Portal Theme Application (in progress - build error blocking deployment)

**Pending:**
- ‚è≥ All other pages and components (see lists above)

**Files Modified:**
- `crm/client/src/theme.ts` - Enhanced theme with Mantis-inspired design (replaced by `mantis-theme.ts`)
- `crm/client/src/mantis-theme.ts` - New comprehensive Mantis theme with Material-UI design tokens
- `crm/client/src/mantis-overrides.css` - Systematic CSS overrides to match Mantis design principles
- `crm/client/src/index.css` - Removed conflicting styles to allow Mantis overrides
- `crm/client/src/components/Layout.tsx` - Modernized header and sidebar (Mantis-style navigation, dark theme color fixes)
- `crm/client/src/pages/ClientsPage.tsx` - Upgraded with Mantis-style table, filters, tabs, and improved visual hierarchy
- `crm/client/src/pages/ClientDetailPage.tsx` - Upgraded with Mantis-style cards, improved header, and better visual hierarchy
- `crm/client/src/pages/ClientFormPage.tsx` - Upgraded with Mantis-style cards, improved header, and better visual hierarchy
- `crm/client/src/pages/CalendarPage.tsx` - Upgraded with Mantis-style header and tabs
- `crm/client/src/pages/InboxPage.tsx` - Upgraded with Mantis-style header, tabs, and cards
- `crm/client/src/pages/DashboardPage.tsx` - Redesigned with KPI cards
- `crm/client/src/components/MantisKPICard.tsx` - New reusable component
- `crm/client-portal/lib/mantis-theme.ts` - Client portal Mantis theme (copied from CRM)
- `crm/client-portal/app/mantis-overrides.css` - Client portal CSS overrides (copied from CRM)
- `crm/client-portal/app/globals.css` - Removed conflicting styles for client portal
- `crm/client-portal/app/(portal)/layout.tsx` - Applied Mantis theme, header action buttons, logo updates, dashboard spacing fixes
- `crm/client-portal/app/(portal)/dashboard/page.tsx` - Removed dashboard heading and welcome text

**Dependencies:**
- Existing Mantine UI library (no new dependencies)
- Existing theme system (enhanced, not replaced)
- All existing functionality (maintained during upgrade)

**Deliverables:**
- Enhanced Mantine theme with Mantis-inspired design principles
- Reusable Mantis-style components (KPI cards, etc.)
- Upgraded pages with modern, responsive design
- Consistent design language across entire CRM
- Mobile-first responsive layouts
- Professional, clean visual appearance

**Estimated Timeline**: 4-6 weeks (page-by-page approach)

**Technical Notes:**
- No library migration required - using existing Mantine UI
- Theme enhancement approach (not full replacement)
- Backward compatible - all existing functionality maintained
- Incremental progress - can deploy upgrades page by page
- Component reusability - create shared components for common patterns

**Success Criteria:**
- ‚úÖ All pages upgraded to Mantis design principles
- ‚úÖ Responsive design works on mobile, tablet, desktop
- ‚úÖ Consistent design language across all pages
- ‚úÖ All existing functionality maintained
- ‚úÖ Improved user experience and visual appeal
- ‚úÖ Professional, modern appearance

**Recent Work & Issues (December 2025):**

**Client Portal Theme Application:**
- ‚úÖ Applied Mantis theme to client portal (`crm/client-portal/`)
- ‚úÖ Created `mantis-theme.ts` and `mantis-overrides.css` for client portal
- ‚úÖ Added header action buttons (notifications, theme toggle, settings) matching CRM
- ‚úÖ Updated logo to use static files (`/logo.png`, `/logodark.png`)
- ‚úÖ Fixed header icon positioning (moved to right, next to avatar)
- ‚úÖ Removed dashboard heading and welcome text from client portal
- ‚úÖ Removed white line highlight from client portal header
- ‚úÖ Fixed logo sizing for dark mode (added `maxWidth: '237px'`)

**Issues Encountered:**
1. **CSS Conflicts**: Initial Mantis CSS overrides were not visible due to conflicting `!important` rules in `index.css` and `globals.css`
   - **Fix**: Removed conflicting styles from both files, allowing `mantis-overrides.css` to take precedence

2. **TypeScript Build Errors**: 
   - `lineHeight` type mismatch (number vs string) in `mantis-theme.ts`
   - Missing `Text` import in `CalendarPage.tsx`
   - `gap` prop type mismatch in `DashboardPage.tsx`
   - **Fix**: Fixed all TypeScript errors (changed `lineHeight` to strings, added imports, fixed `gap` prop)

3. **Dark Theme Color Issues**: User reported Mantis gray colors were not dark enough
   - **Fix**: Updated `mantisGray` palette to use darker values (`#1e1e1e` for gray-800, `#121212` for gray-900) matching Material-UI dark theme

4. **Client Portal Deployment Issues**:
   - Nginx was serving static files instead of proxying to Next.js server
   - **Fix**: Updated `/etc/nginx/sites-available/client-versainsuranceagency` to proxy to `http://127.0.0.1:5000`
   - Client portal was using wrong port (3000 instead of 5000)
   - **Fix**: Configured client portal to use port 5000

5. **Logo Sizing Issue**: Dark mode logo (`logodark.png` 461x136) was larger than light mode logo (`logo.png` 237x70)
   - **Fix**: Added `maxWidth: '237px'` to logo style in `crm/client-portal/app/(portal)/layout.tsx`

6. **Current Build Error** (Blocking Deployment):
   - **Error**: `Unexpected token AppShell. Expected jsx identifier` at line 557 in `crm/client-portal/app/(portal)/layout.tsx`
   - **Status**: üöß **In Progress** - Syntax error preventing client portal build
   - **Attempted Fixes**:
     - Added return type annotation (`: JSX.Element`)
     - Verified braces/parentheses are balanced
     - Verified all JSX elements are properly closed
     - Confirmed `AppShell` is properly imported
     - Checked all `useEffect` hooks are properly closed
   - **Next Steps**: Continue debugging syntax error (may require deeper investigation or alternative approach)

**API Key Safeguards (December 2025):**
- ‚úÖ Created `crm/scripts/sync-all-api-keys.sh` - Automatically syncs all API keys from root `.env` to `crm/.env`
- ‚úÖ Created `crm/scripts/validate-api-keys.sh` - Validates API keys are in sync
- ‚úÖ Created `crm/scripts/pre-start-check.sh` - Runs sync and validation before server starts
- ‚úÖ Updated `crm/server/package.json` to run pre-start check
- ‚úÖ Created `crm/docs/API_KEYS_SAFEGUARDS.md` - Documentation for API key management
- **Issue Fixed**: SendGrid "Unauthorized" error due to mismatched API keys between root `.env` and `crm/.env`
- **Prevention**: Automated sync ensures both files always have matching credentials

---

### Epic 11: Medicare SOA Automation

**Status**: üöß **In Progress**
**Priority**: P1 (High)
**Description**: Automate the Medicare Scope of Appointment (SOA) workflow to ensure compliance and streamline appointment booking. Automatically send SOA forms to Medicare leads from phone drawer and booking page, track signatures, and conditionally confirm appointments. Includes intelligent auto-population of form fields based on booking data and product selections.

**Related Epics**: Depends on [[Epic 1: Core CRM Foundation]], [[Epic 7: Calendar Scheduling System]], [[Epic 12: Docusend E-Signature System]]. Integrates with [[Epic 2: AI Agent Integration]] for intelligent form population.

**Business Value:**
- **Compliance**: Ensures SOA is obtained for all Medicare interactions before advice is given
- **Efficiency**: Automates repetitive tasks for agents (sending SOA, linking documents, follow-up emails)
- **Improved Client Experience**: Clearer communication on next steps, streamlined process
- **Data Integrity**: SOAs are automatically linked to client records

**Four Entry Points:**

**1. Phone Drawer Leads:**
- Flow: Save Lead ‚Üí Send SOA Immediately ‚Üí After SOA Signed ‚Üí Schedule Appointment
- Rationale: Lead is already engaged on phone, agent can explain SOA requirement verbally
- Implementation: Hook into `POST /api/clients` when `line_of_business === 'medicare'` and `status === 'call-manager'`

**2. Manual CRM Creation:**
- Flow: Create Lead Manually ‚Üí Send SOA Immediately ‚Üí After SOA Signed ‚Üí Schedule Appointment
- Rationale: Agent manually creates Medicare lead from CRM interface, consistent workflow across all lead creation methods
- Implementation: Hook into `POST /api/clients` when `line_of_business === 'medicare'` and `status !== 'call-manager'` and `status !== 'booking-lead'` and `lead_type !== 'form-lead'`

**3. Marketing Site Form Submissions:**
- Flow: Submit Form ‚Üí Create/Update Lead ‚Üí Send SOA Immediately ‚Üí After SOA Signed ‚Üí Schedule Appointment
- Rationale: Lead submits form on marketing website (versainsuranceagency.com/individuals/medicare), automatically send SOA immediately (similar to phone drawer)
- Implementation: Hook into `POST /api/public/forms/submit` or `POST /api/public/forms/medicare` when `businessLine === 'medicare'`

**4. Booking Page Appointments:**
- Flow: Book Appointment ‚Üí Create Lead ‚Üí Create Appointment (pending_soa) ‚Üí Send SOA to Client AND Agent (Email + SMS) ‚Üí Client Signs First ‚Üí Agent Signs Second ‚Üí Both Signed ‚Üí Confirm Appointment ‚Üí Send Confirmation Email
- Rationale: Lead is trying to book appointment from marketing site, need to create lead/client record first. Both parties (client and agent) must sign SOA for compliance.
- Implementation: Hook into `POST /api/booking/medicare/book` (public booking)

**Key Features:**
- ‚úÖ Automatic SOA envelope creation from template
- ‚úÖ **Sequential Signing**: Client signs first (signingOrder: 1), then Agent signs second (signingOrder: 2)
- ‚úÖ **Agent Signature**: Agent automatically added as second signer to all SOA envelopes
- ‚úÖ **Agent Notification**: Agent receives email notification when client signs, prompting agent to sign
- ‚úÖ Email + SMS reminders (24 hours before grace period expires)
- ‚úÖ 48-hour grace period with auto-cancellation
- ‚úÖ Automatic slot release when SOA not signed
- ‚úÖ SOA completion webhook handler (triggers only when BOTH parties signed)
- ‚úÖ Signed document linking to client records
- ‚úÖ **Appointment Confirmation Email**: Sent to client after BOTH parties sign SOA, includes appointment details (date, time, meeting type, location/video link)

**Database Schema Changes:**
- Add `soa_envelope_id`, `soa_status`, `soa_signed_at` to `clients` table
- Add `soa_envelope_id`, `soa_status`, `soa_signed_at`, `soa_grace_period_expires_at` to `appointments` table
- Add `pending_soa` status to appointments enum

**Service Functions:**
- `sendSOAToMedicareLead(clientId, userId)` - Send SOA to phone drawer lead (includes agent as second signer)
- `sendSOAToMedicareAppointment(appointmentId, userId)` - Send SOA to booking page lead (includes agent as second signer)
- `handleSOACompleted(envelopeId)` - Process SOA completion when BOTH parties signed, confirm appointments, send confirmation email
- `sendAgentSOANotificationEmail(envelopeId, agentEmail)` - Notify agent when client signs SOA
- `sendAppointmentConfirmationEmail(appointmentId, clientEmail)` - Send confirmation email to client after both parties sign
- `sendSOAReminder(envelopeId, reminderType)` - Send email/SMS reminders
- `cancelExpiredSOAAppointments()` - Auto-cancel expired appointments (runs hourly)

**Integration Points:**
- Client Creation (Phone Drawer/Manual CRM): `crm/server/src/routes/clients.ts` - If `line_of_business === 'medicare'` and `status !== 'booking-lead'` and `lead_type !== 'form-lead'`, call `sendSOAToMedicareLead()`
- Marketing Site Form Submissions: `crm/server/src/routes/public-forms.ts` - If `businessLine === 'medicare'`, call `sendSOAToMedicareLead()` after client created/updated
- Appointment Booking (Booking Page): `crm/server/src/routes/calendar.ts` - If `slug === 'medicare'`, create appointment with `status: 'pending_soa'`, call `sendSOAToMedicareAppointment()`
- SOA Completion Webhook: `crm/server/src/services/docusendService.ts` - In `submitSignature()` function, call `handleSOACompleted()` when envelope is completed
- Scheduler: `crm/server/src/services/docusendScheduler.ts` - Hourly `cancelExpiredSOAAppointments()` for grace period enforcement

**SMS Integration:**
- Uses existing Twilio SMS service (`reviewSmsService.ts` pattern)
- SMS reminders at 24 hours before grace period expires
- SMS confirmation after BOTH parties sign SOA (booking page only)

**Signing Workflow:**
- **Sequential Signing Order**: Client signs first (signingOrder: 1), Agent signs second (signingOrder: 2)
- **Envelope Status Flow**: `draft` ‚Üí `sent` ‚Üí `in_progress` (client signed) ‚Üí `completed` (both signed)
- **Agent Auto-Added**: Agent automatically added as second signer when creating SOA from template
- **Agent Email Lookup**: Agent email retrieved from `users` table using `userId`
- **Template Placeholder**: Templates use `{{agent_email}}` placeholder, replaced with actual agent email when creating envelope

**Grace Period & Auto-Cancellation:**
- **Grace Period**: 48 hours from appointment creation
- **Auto-Cancellation**: Runs hourly, cancels appointments where `status = 'pending_soa'`, `soa_grace_period_expires_at < NOW()`, `soa_signed_at IS NULL`
- **Slot Release**: Immediate (cancelled appointments excluded from conflict checks)

**Plan Document**: `crm/docs/MEDICARE_SOA_WORKFLOW.md`

**Estimated Timeline**: 1-2 weeks

**Dependencies:**
- Docusend e-signature system (Epic 12 - ‚úÖ Complete)
- Twilio SMS service (already configured)
- SendGrid email service (already configured)
- Calendar booking system (Epic 7 - already implemented)

**Recent Work & Fixes (2025-01-XX):**

**Issues Identified & Resolved:**

1. **SOA Form Field Auto-Population Issues:**
   - **Issue**: Product selection initials showing "true" instead of client initials (e.g., "MA" for Mario Alasu)
   - **Issue**: Beneficiary name not auto-populating from client data
   - **Issue**: Phone numbers not formatted as (XXX) XXX-XXXX
   - **Fix**: Updated `createEnvelopeFromTemplate` in `docusendService.ts` to:
     - Use `generateInitials(client.firstName, client.lastName)` for product selection fields
     - Auto-populate "Beneficiary Name" with client's full name
     - Apply `formatPhoneNumber()` helper to all phone fields (client and agent)

2. **Signer Status Not Updating to 'signed':**
   - **Issue**: Signers had `signed_at` timestamps but status remained `'viewed'`, preventing envelope completion
   - **Impact**: SOA completion handler not triggered, leads not appearing in CRM
   - **Fix**: Verified `submitSignature` correctly updates status to `'signed'` at line 742-752 in `docusendService.ts`
   - **Note**: Issue may be related to frontend not properly calling submit endpoint or race conditions

3. **Client Creation from Signer Information:**
   - **Issue**: Appointments created with `client_id: null`, preventing SOA completion from updating client status
   - **Impact**: Leads not appearing in CRM even after both parties signed SOA
   - **Fix**: Added fallback logic in `handleSOACompleted` (lines 622-707 in `medicareSOAService.ts`) to:
     - Query signers when no client_id exists
     - Extract client information from first signer (signing_order: 1)
     - Create client record with proper formatting (name, email, phone)
     - Update envelope and appointment with new client_id
     - Update client status to 'lead' after creation

4. **Phone Number Formatting Consistency:**
   - **Issue**: Phone numbers stored with `+1` prefix and inconsistent formatting
   - **Issue**: Phone matching logic not working correctly for existing clients
   - **Fix**: 
     - Implemented `formatPhoneNumber()` helper function in `docusendService.ts`
     - Applied phone formatting during client creation in booking route (`calendar.ts`)
     - Normalized phone numbers for matching (removes +1 prefix and non-digits)
     - Fixed appointment status bug where `pending_soa` was set for ALL bookings instead of only new clients

5. **Appointment Status Bug:**
   - **Issue**: All bookings (including existing clients) were set to `pending_soa` status
   - **Impact**: Existing clients couldn't access appointments until SOA signed
   - **Fix**: Moved `pending_soa` status logic inside `else` block (new client creation only) in `calendar.ts` line 4296-4302

6. **Confirmation Email Reliability:**
   - **Issue**: Confirmation emails not always sent after booking
   - **Fix**: Modified confirmation email logic to send unless explicitly disabled (`if (sendConfirmation !== false)`)
   - **Fix**: Improved logging in `appointmentReminders.ts` to track email sending success

**Files Modified:**
- `crm/server/src/services/docusendService.ts` - Auto-population and phone formatting
- `crm/server/src/services/medicareSOAService.ts` - Client creation fallback in `handleSOACompleted`
- `crm/server/src/routes/calendar.ts` - Phone formatting, appointment status fix, confirmation email logic
- `crm/server/src/services/appointmentReminders.ts` - Improved email logging

**Testing & Verification:**
- Created multiple test scripts to verify SOA completion workflow
- Fixed envelope 33 and 34 manually to verify client creation logic
- Verified phone matching logic works correctly for existing clients
- Confirmed leads appear in CRM after both parties sign SOA

**Outstanding Issues:**
- Signer status sometimes remains `'viewed'` instead of `'signed'` after signature submission (requires further investigation)
- Need to verify frontend signature submission flow is working correctly

---

### Epic 12: Docusend E-Signature System

**Status**: ‚úÖ **Complete**  
**Priority**: P1 (High)  
**Description**: Full-featured e-signature system (DocHub-style) for sending, signing, and managing documents. Includes PDF manipulation, signature field placement, envelope management, templates, and automated workflows.

**Business Value:**
- **Compliance**: Enables digital document signing for Medicare SOA and other compliance documents
- **Efficiency**: Automates document sending, tracking, and management
- **Professional Image**: Modern e-signature system matching industry standards
- **Integration Ready**: Foundation for Epic 11 (Medicare SOA Automation)

**Completed Features:**

**Core Functionality:**
- ‚úÖ Document upload and storage (S3 integration)
- ‚úÖ Envelope creation with multiple signers
- ‚úÖ Signature field placement (drag, resize, duplicate) with `react-pdf` canvas-based rendering
- ‚úÖ Multi-page PDF support with dynamic height calculation
- ‚úÖ Side resize handles (N, S, E, W) for independent width/height adjustment
- ‚úÖ Public signing page with token-based access
- ‚úÖ PDF manipulation and signature embedding (`pdf-lib`)
- ‚úÖ Signed document viewing and download
- ‚úÖ Envelope status tracking (draft, sent, completed, expired, cancelled)
- ‚úÖ Phone field type with automatic formatting `(XXX) XXX-XXXX`
- ‚úÖ Checkbox group validation ("must select 1" requirement)
- ‚úÖ Field alignment indicators (visual dot showing bottom-left alignment point)

**Envelope Management:**
- ‚úÖ Send envelopes via email
- ‚úÖ Resend envelopes to signers
- ‚úÖ Cancel envelopes
- ‚úÖ View envelope details and status
- ‚úÖ Track signer progress

**Templates:**
- ‚úÖ Create templates from envelopes
- ‚úÖ Send envelopes from templates
- ‚úÖ Template management (list, view, delete)
- ‚úÖ Template field preservation
- ‚úÖ Quick Load Templates dropdown (Medicare SOA, Scope of Sales Appointment)
- ‚úÖ Role-based signer assignment ("Client" and "Agent" options)
- ‚úÖ Signing order-based template mapping (1 = Client, 2 = Agent)
- ‚úÖ Auto-generated envelope titles based on document name and signers

**Activity Tracking:**
- ‚úÖ Activity log for all envelope actions
- ‚úÖ Signer activity tracking
- ‚úÖ Document access logging

**Automation:**
- ‚úÖ Automated reminder emails (configurable intervals)
- ‚úÖ Envelope expiration handling
- ‚úÖ Scheduled tasks via `docusendScheduler.ts`

**UI Components:**
- ‚úÖ Docusend settings page (`/settings/docusend`)
- ‚úÖ Documents tab (upload, view, delete)
- ‚úÖ Envelopes tab (create, send, manage)
- ‚úÖ Templates tab (create, send from template)
- ‚úÖ Activity tab (view all activity)
- ‚úÖ Signature field placer component (`SignatureFieldPlacer.tsx`)
- ‚úÖ Public signing page (`/sign/:token`)

**Technical Implementation:**

**Database Schema:**
- `docusend_documents` - Document storage metadata
- `docusend_envelopes` - Envelope management
- `docusend_signers` - Signer information and status
- `docusend_signature_fields` - Field placement and configuration
- `docusend_signed_documents` - Completed signature records
- `docusend_templates` - Template storage

**Backend Services:**
- `docusendService.ts` - Core business logic (document management, envelope creation, signer handling, templates, activity)
- `signatureService.ts` - PDF manipulation using `pdf-lib` (embedding signatures, text, dates, checkboxes)
- `docusendEmailService.ts` - Email notifications (signature requests, reminders)
- `docusendScheduler.ts` - Automated tasks (reminders, expiration checks)

**Backend Routes:**
- `POST /api/docusend/documents` - Upload document
- `GET /api/docusend/documents` - List documents
- `DELETE /api/docusend/documents/:id` - Delete document (hard delete with S3 cleanup)
- `POST /api/docusend/envelopes` - Create envelope
- `GET /api/docusend/envelopes` - List envelopes
- `GET /api/docusend/envelopes/:id` - Get envelope details
- `POST /api/docusend/envelopes/:id/send` - Send envelope
- `POST /api/docusend/envelopes/:id/resend` - Resend envelope
- `POST /api/docusend/envelopes/:id/cancel` - Cancel envelope
- `POST /api/docusend/envelopes/:id/remind` - Send manual reminder
- `POST /api/docusend/envelopes/:id/expire` - Manually expire envelope
- `POST /api/docusend/sign/:token` - Public signing endpoint
- `GET /api/docusend/templates` - List templates
- `POST /api/docusend/templates` - Create template from envelope
- `DELETE /api/docusend/templates/:id` - Delete template
- `POST /api/docusend/templates/:id/send` - Send envelope from template
- `GET /api/docusend/activity` - Get activity log

**Frontend Components:**
- `DocusendSettingsPage.tsx` - Main settings page with tabs
- `SignatureFieldPlacer.tsx` - Interactive field placement component
- `SignDocumentPage.tsx` - Public signing interface

**Issues Encountered & Fixes:**

**1. Field Positioning & Scrolling Issues:**
- **Issue**: Fields not sticking to PDF when scrolling, multiple scrollbars, glitchy movement
- **Root Cause**: Complex coordinate system with iframe, overlay, and container scroll synchronization
- **Solution**: Migrated from iframe-based rendering to `react-pdf` (canvas-based). Fields stored in PDF coordinate space (0-612 points width, 0-792 points height per page), converted to screen pixels using scale factors. Multi-page PDF support with dynamic height calculation.
- **Files Modified**: `crm/client/src/components/SignatureFieldPlacer.tsx`

**2. Field Interaction Issues:**
- **Issue**: Modal opening on single click during drag, preventing smooth field movement
- **Fix**: Changed to `onDoubleClick` for edit modal, added `e.preventDefault()` to drag start
- **Files Modified**: `SignatureFieldPlacer.tsx`

**3. Document View/Delete Functionality:**
- **Issue**: Eye and delete buttons not working in Documents table
- **Fix**: Added `onClick` handlers, implemented `handleDeleteDocument` with hard delete (DB + S3), added `downloadUrl` to document list response
- **Files Modified**: `DocusendSettingsPage.tsx`, `docusendService.ts`, `docusend.ts` (routes)

**4. Multiple Scrollbars:**
- **Issue**: Three scrollbars visible (modal, container, iframe)
- **Fix**: Set `overflow: 'hidden'` on modal content/inner, `overflow: 'auto'` only on modal body, added global CSS to hide iframe scrollbars
- **Files Modified**: `DocusendSettingsPage.tsx`, `crm/client/src/index.css`

**5. Checkbox Size Not Saving:**
- **Issue**: Resizing checkbox fields didn't persist
- **Fix**: Added interactive resize handles (corner drag), updated `handleSaveEdit` to call `onFieldsChange`
- **Files Modified**: `SignatureFieldPlacer.tsx`

**6. Field Duplication:**
- **Issue**: User requested right-click duplicate functionality
- **Fix**: Added `onContextMenu` handler, `handleDuplicateField` function with slight offset
- **Files Modified**: `SignatureFieldPlacer.tsx`

**7. PDF Coordinate System:**
- **Issue**: Fields positioned incorrectly due to PDF Y-axis being bottom-up
- **Fix**: Implemented proper coordinate conversion: `screenY = (792 - pdfY) * scaleY` for display, `pdfY = 792 - (screenY / scaleY)` for storage
- **Files Modified**: `SignatureFieldPlacer.tsx`

**8. PDF Rendering with react-pdf:**
- **Issue**: PDF not visible after migration from iframe to react-pdf, CORS errors with S3 PDFs and PDF.js worker
- **Root Cause**: Cross-origin restrictions when fetching PDFs from S3, PDF.js worker CDN issues
- **Solution**: 
  - Created backend proxy endpoint `/api/docusend/documents/:id/proxy` to stream PDFs from S3 with proper CORS headers
  - Updated PDF.js worker to use CDN (`unpkg.com`) with `.mjs` extension
  - Implemented local fallback for worker script in `public/` directory
  - Added `credentials: 'include'` to PDF fetch requests
- **Files Modified**: `crm/server/src/routes/docusend.ts`, `crm/client/src/components/SignatureFieldPlacer.tsx`, `crm/client/src/pages/DocusendSettingsPage.tsx`

**9. Field Resize Glitching:**
- **Issue**: Fields skipping/jumping when resizing, unable to move fields during resize
- **Root Cause**: Stale closures in event handlers, incorrect coordinate calculations during resize
- **Solution**: 
  - Implemented document-level `mousemove` and `mouseup` listeners
  - Used `useRef` for `dragOffsetRef` and `resizeStartRef` to avoid stale closures
  - Stored page-specific dimensions (`pageWidth`, `pageHeight`, `scale`) in resize start
  - Corrected resize calculations to anchor opposite edge (e.g., bottom edge fixed when resizing from top)
  - Added proper clamping logic for height when top edge is constrained
- **Files Modified**: `SignatureFieldPlacer.tsx`

**10. Side Resize Handles:**
- **Issue**: User requested ability to resize width and height independently (not just corners)
- **Fix**: Added side resize handles (N, S, E, W) for independent width/height adjustment
- **Files Modified**: `SignatureFieldPlacer.tsx`

**11. Phone Field Type:**
- **Issue**: User requested phone number field with automatic formatting `(XXX) XXX-XXXX`
- **Fix**: 
  - Added `'phone'` field type to frontend and backend interfaces
  - Implemented `formatPhoneNumber` utility in `SignDocumentPage.tsx`
  - Added phone input with automatic formatting and 14-character limit
- **Files Modified**: `SignatureFieldPlacer.tsx`, `SignDocumentPage.tsx`, `docusendService.ts`, `signatureService.ts`

**12. Template Field Loading:**
- **Issue**: "Quick Load Templates" dropdown not visible, fields not loading when selected
- **Root Cause**: `SignatureFieldPlacer` internal state not syncing with `existingFields` prop after initial mount
- **Solution**: 
  - Added `useEffect` hook to sync `existingFields` to internal `fields` state
  - Added "Quick Load Templates" dropdown in `DocusendSettingsPage.tsx`
  - Created `fieldPlacerHelper.ts` with pre-defined field templates (Medicare SOA, Scope of Sales Appointment)
- **Files Modified**: `SignatureFieldPlacer.tsx`, `DocusendSettingsPage.tsx`, `crm/client/src/utils/fieldPlacerHelper.ts`

**13. Checkbox Group Validation:**
- **Issue**: User requested "must select 1" validation for checkbox groups (e.g., "Select Products")
- **Fix**: 
  - Added `fieldGroup` property to `SignatureField` interface
  - Store `fieldGroup` in `metadata` JSONB column of `docusend_signature_fields`
  - Implemented validation logic in `SignDocumentPage.tsx` to check if at least one checkbox in a required group is selected
- **Files Modified**: `SignatureFieldPlacer.tsx`, `SignDocumentPage.tsx`, `fieldPlacerHelper.ts`, `docusendService.ts`, `docusend.ts`

**14. Auto-Generated Envelope Title:**
- **Issue**: User questioned why manual title input is required when it could be auto-generated
- **Fix**: 
  - Auto-generate `envelopeTitle` based on document name and signer names
  - Format: `"[Document Name] - [Signer Name(s)]"`
  - Updates automatically when document or signers change
- **Files Modified**: `DocusendSettingsPage.tsx`

**15. Signer Assignment for Templates:**
- **Issue**: User requested "Client" and "Agent" options instead of email addresses for field assignment
- **Root Cause**: Template mapping was using email addresses, which doesn't work well for reusable templates
- **Solution**: 
  - Updated dropdown to always show "Client" (signing order 1) and "Agent" (signing order 2) options
  - Store `signingOrder` in field metadata instead of relying on email addresses
  - Updated template mapping logic to use signing order (1 = Client, 2 = Agent) instead of email
  - Backend maps fields by signing order when creating envelopes from templates
- **Files Modified**: `SignatureFieldPlacer.tsx`, `DocusendSettingsPage.tsx`, `docusendService.ts`, `docusend.ts`

**16. Field Alignment Documentation:**
- **Issue**: User needed to know where text/signatures appear within field boundaries for proper alignment
- **Solution**: 
  - Documented that all content (text, signatures, phone numbers) appears at **bottom-left** corner of field
  - Added visual indicator (small dot) at bottom-left of each field showing alignment point
  - Added tooltip in edit modal explaining alignment behavior
  - Text font size is 80% of field height, wraps upward if needed
- **Files Modified**: `SignatureFieldPlacer.tsx`, `signatureService.ts` (documentation)

**Key Technical Decisions:**

1. **PDF Rendering**: Migrated from iframe to `react-pdf` (canvas-based) for better control and cross-origin compatibility
2. **PDF Library**: Used `pdf-lib` for PDF manipulation (embedding signatures, text, dates, checkboxes, phone numbers)
3. **Storage**: S3 for document storage, database for metadata
4. **Field Placement**: PDF coordinate space (points) stored, converted to screen pixels for display using page-specific scale factors
5. **Field Alignment**: All content (text, signatures, phone) appears at bottom-left corner of field boundaries
6. **Public Signing**: Token-based access for security
7. **Template System**: Store envelope structure for reuse with signing order-based mapping (1 = Client, 2 = Agent)
8. **Signer Assignment**: Role-based assignment ("Client" and "Agent") stored as `signingOrder` in metadata for template mapping
9. **CORS Handling**: Backend proxy endpoint for PDF streaming to bypass client-side CORS restrictions
10. **Automation**: `setInterval` scheduler for reminders and expiration (runs in `docusendScheduler.ts`)

**Files Created:**
- `crm/database-migrations/008-create-docusend-tables.sql`
- `crm/server/src/db/migrations/008-create-docusend-tables.ts`
- `crm/server/src/services/docusendService.ts`
- `crm/server/src/services/signatureService.ts`
- `crm/server/src/services/docusendEmailService.ts`
- `crm/server/src/services/docusendScheduler.ts`
- `crm/server/src/routes/docusend.ts`
- `crm/client/src/pages/DocusendSettingsPage.tsx`
- `crm/client/src/components/SignatureFieldPlacer.tsx`
- `crm/client/src/pages/SignDocumentPage.tsx`
- `crm/client/src/utils/fieldPlacerHelper.ts` - Pre-defined field templates (Medicare SOA, Scope of Sales Appointment)

**Files Modified:**
- `crm/server/src/index.ts` - Added docusend routes and scheduler
- `crm/server/src/db/init-db.ts` - Added migration 008
- `crm/client/src/App.tsx` - Added DocusendSettingsPage and SignDocumentPage routes
- `crm/client/src/pages/SettingsPage.tsx` - Added Docusend card
- `crm/client/src/pages/MarketingPage.tsx` - Added Autopilot card
- `crm/client/src/index.css` - Added scrollbar hiding rules
- `crm/server/src/routes/docusend.ts` - Added PDF proxy endpoint, `signingOrder` support
- `crm/server/src/services/docusendService.ts` - Added `signingOrder` storage in metadata, template mapping by signing order, "all signers" field retrieval
- `crm/server/src/services/signatureService.ts` - Added phone field type support
- `crm/client/src/components/SignatureFieldPlacer.tsx` - Migrated to react-pdf, added side resize handles, phone field type, field alignment indicators, role-based signer assignment
- `crm/client/src/pages/DocusendSettingsPage.tsx` - Added Quick Load Templates, auto-generated envelope titles, PDF proxy integration
- `crm/client/src/pages/SignDocumentPage.tsx` - Added phone field formatting, checkbox group validation

**Integration Points:**
- S3 Service: Document storage and retrieval
- SendGrid: Email notifications
- Database: Metadata and tracking
- Frontend: Settings page and public signing

**Estimated Timeline**: 2-3 weeks (Actual: Completed)

**Dependencies:**
- S3 service (already configured)
- SendGrid email service (already configured)
- Database (Neon PostgreSQL)
- `pdf-lib` npm package

**Success Criteria:**
- ‚úÖ Document upload and storage working
- ‚úÖ Envelope creation and sending functional
- ‚úÖ Signature field placement interactive and accurate
- ‚úÖ Public signing page accessible and functional
- ‚úÖ Signed documents viewable and downloadable
- ‚úÖ Templates system operational
- ‚úÖ Activity tracking complete
- ‚úÖ All UI issues resolved

**Recent Updates (2025-12-12):**

**17. Template Editing Functionality:**
- **Issue**: User unable to edit templates after creation
- **Root Cause**: No edit button or endpoint for template editing
- **Solution**: 
  - Added `GET /api/docusend/templates/:id` endpoint to retrieve template with document and fields
  - Added `PUT /api/docusend/templates/:id` endpoint to update template metadata
  - Added "Edit" button in templates table
  - Implemented `handleOpenEditTemplate` function that loads template data and opens field placer
  - Auto-displays PDF and fields when template data is loaded
- **Files Modified**: `crm/server/src/routes/docusend.ts`, `crm/server/src/services/docusendService.ts`, `crm/client/src/pages/DocusendSettingsPage.tsx`

**18. Field Property Persistence (isRequired):**
- **Issue**: `isRequired` setting not persisting when editing template fields
- **Root Cause**: Template field loading checked `field.is_required` (snake_case) while saved data used `field.isRequired` (camelCase). Default logic `field.is_required !== false` incorrectly set `isRequired` to `true` if `is_required` was `undefined` or `null`
- **Solution**: 
  - Updated template field loading to check both `field.isRequired` and `field.is_required`
  - Fixed default logic to correctly handle `undefined`/`null` values
- **Files Modified**: `crm/client/src/pages/DocusendSettingsPage.tsx`

**19. Field Group Validation for Initial Fields:**
- **Issue**: "Must select 1" validation only worked for checkbox fields, not initial fields
- **Root Cause**: `fieldGroup` validation was only implemented for `checkbox` fields, and fields in a group were still being individually validated as required
- **Solution**: 
  - Updated `SignatureFieldPlacer.tsx` to allow `fieldGroup` for `initial` fields
  - Extended `fieldGroup` validation to `initial` fields in `SignDocumentPage.tsx` and `SignPublicPowerFormPage.tsx`
  - Skipped individual `isRequired` validation for fields within a `fieldGroup`
- **Files Modified**: `crm/client/src/components/SignatureFieldPlacer.tsx`, `crm/client/src/pages/SignDocumentPage.tsx`, `crm/client/src/pages/SignPublicPowerFormPage.tsx`

**20. Double-Click Field Movement Glitch:**
- **Issue**: Double-clicking a field to edit it caused the field to move from its placed location
- **Root Cause**: The initial `onMouseDown` event of a double-click was triggering a drag operation before the edit modal could open
- **Solution**: 
  - Implemented `lastClickRef` to detect double-clicks within a 300ms window
  - Modified `handleFieldDragStart` to prevent drag from starting if a double-click is detected
- **Files Modified**: `crm/client/src/components/SignatureFieldPlacer.tsx`

**21. Template Field Type Mapping:**
- **Issue**: `createEnvelopeFromTemplate` was not correctly mapping `fieldType` from template metadata
- **Root Cause**: Template fields stored `fieldType` in camelCase, but `addSignatureField` expected snake_case or camelCase
- **Solution**: 
  - Updated `createEnvelopeFromTemplate` to correctly retrieve `fieldType` by checking both camelCase and snake_case properties
  - Ensured `fieldGroup` and `signingOrder` are correctly stored in `metadata` JSONB column
- **Files Modified**: `crm/server/src/services/docusendService.ts`

**22. Email Click Tracking Disabled:**
- **Issue**: SendGrid's click tracking was wrapping signing URLs, causing button URLs to differ from direct signing URLs
- **Root Cause**: SendGrid's default `clickTracking` feature wraps all links in emails
- **Solution**: 
  - Disabled `clickTracking` in `sendSignatureRequestEmail` and `sendReminderEmail` functions
  - Ensures direct signing URLs are used in email buttons
- **Files Modified**: `crm/server/src/services/docusendEmailService.ts`

**23. Email Logo Integration:**
- **Issue**: Email templates hardcoded "Versa Insurance" as text heading
- **Root Cause**: No dynamic logo integration in email templates
- **Solution**: 
  - Added logic to fetch `logoUrl` from `portal_config.branding_config`
  - Dynamically embed logo as `<img>` tag in email HTML
  - Fallback to text heading if no logo configured
  - Convert relative logo URLs to absolute URLs for email compatibility
- **Files Modified**: `crm/server/src/services/docusendEmailService.ts`

**24. Reminder System with Booking Restriction Cutoff:**
- **Issue**: Reminders were being sent indefinitely, even after appointment booking restriction cutoff
- **Root Cause**: Reminder system didn't check `min_advance_booking_days` setting
- **Solution**: 
  - Updated `sendReminderEmails` to join with `appointments` and `users` tables
  - Added `WHERE` clause to stop sending reminders if `NOW() >= (appointment_start_time - INTERVAL '1 day' * min_advance_booking_days)`
  - SOA envelopes send 1 reminder per day, other envelopes send 1 reminder every 3 days
- **Files Modified**: `crm/server/src/services/docusendService.ts`

**25. Client Status Update After SOA Completion:**
- **Issue**: Client status was not updating from `booking-lead` to `lead` after SOA completion
- **Root Cause**: `handleSOACompleted` was not updating client status
- **Solution**: 
  - Updated `handleSOACompleted` to change client `status` from `'booking-lead'` to `'lead'` after both parties sign SOA
  - Changed `document_type` from `'enrollment_form'` to `'scope_of_appointment'` when linking signed SOA documents
- **Files Modified**: `crm/server/src/services/medicareSOAService.ts`

**26. Calendar Lead Type Addition:**
- **Issue**: Need to distinguish calendar booking leads from other lead types
- **Solution**: 
  - Added `'calendar-lead'` as a new lead type
  - Updated client creation from calendar bookings to set `lead_type='calendar-lead'`
  - Updated frontend dropdowns and type definitions
- **Files Modified**: `crm/server/src/routes/calendar.ts`, `crm/client/src/pages/ClientFormPage.tsx`, `crm/client/src/pages/ClientDetailPage.tsx`, `crm/client/src/lib/api.ts`, `crm/client/src/pages/ClientsPage.tsx`, `crm/client/src/components/CallDrawer.tsx`

**27. Client Portal SOA Document Display:**
- **Issue**: Signed SOA documents not appearing in Medicare client portal documents page
- **Root Cause**: 
  - Client portal documents API was filtering out `docusend/` S3 keys
  - API route was selecting non-existent columns (`file_type`, `file_path`)
- **Solution**: 
  - Updated backend API to include `OR s3_key LIKE 'docusend/%'` in document query
  - Removed non-existent columns from API query
  - Updated client portal frontend to display SOA document in dedicated "Scope of Appointment" card
  - Implemented clickable title linking to signed PDF
  - Smaller card design with horizontal layout
- **Files Modified**: `crm/server/src/routes/client-portal.ts`, `crm/client-portal/app/(portal)/documents/page.tsx`, `crm/client/src/components/ClientDocuments.tsx`

**28. Docusend Tab Refactoring:**
- **Issue**: "Envelopes" section was being used for both field creation and sign requests, which was inefficient
- **Solution**: 
  - Refactored Docusend page into multiple tabs: "Dashboard", "Documents", "Templates", "Send Requests", "Sent Requests", "PowerForms", "Activity", "Settings"
  - "Templates" tab: Create and manage templates (field placement)
  - "Send Requests" tab: Create and send signature requests from templates
  - "Sent Requests" tab: Track and manage sent envelopes
  - "PowerForms" tab: Create public signing links
  - "Activity" tab: View all Docusend activity
- **Files Modified**: `crm/client/src/pages/DocusendSettingsPage.tsx`

**29. PowerForms (Public Signing Links):**
- **Issue**: Need ability to create public signing links for documents
- **Solution**: 
  - Added PowerForms tab to Docusend page
  - Implemented `createPowerForm`, `getPowerFormByToken`, `deletePowerForm` functions
  - Created public signing page `/sign/powerform/:token` for PowerForms
  - PowerForms generate unique tokens for public access without authentication
- **Files Modified**: `crm/server/src/services/docusendService.ts`, `crm/server/src/routes/docusend.ts`, `crm/client/src/pages/DocusendSettingsPage.tsx`, `crm/client/src/pages/SignPublicPowerFormPage.tsx`

**30. Dashboard Tab:**
- **Issue**: Docusend page needed a central overview
- **Solution**: 
  - Added Dashboard tab as default landing page
  - Displays key metrics: total documents, templates, sent requests, completed envelopes
  - Shows recent activity and quick actions
- **Files Modified**: `crm/client/src/pages/DocusendSettingsPage.tsx`

**31. Field Deletion:**
- **Issue**: User requested ability to delete fields from PDF
- **Solution**: 
  - Added delete button in field edit modal
  - Added keyboard support (Delete key) for field deletion
  - Implemented `handleDeleteField` function
- **Files Modified**: `crm/client/src/components/SignatureFieldPlacer.tsx`

**32. Edit Draft Envelopes:**
- **Issue**: User requested ability to edit draft envelopes
- **Solution**: 
  - Added `updateEnvelope` function in `docusendService.ts`
  - Added `PUT /api/docusend/envelopes/:id` endpoint
  - Added "Edit" button in draft envelopes table
  - Implemented edit modal for draft envelopes
- **Files Modified**: `crm/server/src/services/docusendService.ts`, `crm/server/src/routes/docusend.ts`, `crm/client/src/pages/DocusendSettingsPage.tsx`

**33. CORS Issues with PDF Rendering:**
- **Issue**: PDF not loading in template editing modal due to CORS errors
- **Root Cause**: Direct S3 PDF access blocked by CORS policy
- **Solution**: 
  - Updated template editing flow to use proxy endpoint `/api/docusend/documents/:id/proxy`
  - Updated create template flow to use proxy endpoint
  - Ensures PDFs load correctly in all contexts
- **Files Modified**: `crm/client/src/pages/DocusendSettingsPage.tsx`

**34. Medicare Booking Page Integration:**
- **Issue**: Need to automatically send SOA when Medicare appointment is booked
- **Solution**: 
  - Updated `POST /api/booking/:slug/book` endpoint to automatically send SOA for Medicare bookings
  - Creates client with `status='booking-lead'` and `lead_type='calendar-lead'`
  - Creates appointment with `status='pending_soa'`
  - Automatically calls `sendSOAToMedicareAppointment` after appointment creation
  - Both client and agent receive SOA for signing
- **Files Modified**: `crm/server/src/routes/calendar.ts`, `crm/server/src/services/medicareSOAService.ts`

**35. Documentation Created:**
- `crm/docs/SOA_FIELD_ASSIGNMENT_GUIDE.md` - Field assignments for Medicare SOA (Client vs Agent)
- `crm/docs/SOA_SIGNING_PAGE_FIXES.md` - Issues identified with SOA signing page
- `crm/docs/MEDICARE_BOOKING_FLOW_AND_DOCUSEND_SETUP.md` - Complete booking flow and Docusend setup guide
- `crm/docs/MARKETING_SITE_BOOKING_IMPLEMENTATION.md` - Marketing site agent implementation guide
- `crm/docs/MARKETING_SITE_BOOKING_CORRECTIONS.md` - Required fixes for marketing site
- `crm/docs/DOCUSEND_REMINDER_BOOKING_RESTRICTION.md` - Reminder cutoff logic documentation
- `crm/docs/MEDICARE_BOOKING_PAGE_SETUP_GUIDE.md` - CRM agent setup guide for booking pages

**36. Test Scripts Created:**
- `crm/server/src/scripts/test-soa-complete.ts` - Comprehensive SOA workflow test
- `crm/server/src/scripts/test-calendar-appointment-soa.ts` - Calendar appointment and SOA test
- `crm/server/src/scripts/test-calendar-lead-soa-pdf.ts` - Calendar lead creation with PDF verification
- `crm/server/src/scripts/create-test-client-portal-access.ts` - Generate magic link for client portal testing
- `crm/server/src/scripts/check-client-document.ts` - Verify client document existence
- `crm/server/src/scripts/test-client-portal-api.ts` - Test client portal API response

**37. Reminder Email Timing Bug:**
- **Issue**: Reminder emails were being sent 8 minutes after initial signature request instead of waiting for `reminder_days` interval
- **Root Cause**: Reminder query checked `last_reminder_sent_at IS NULL` OR `last_reminder_sent_at < NOW() - INTERVAL '1 day' * reminder_days`, which would send a reminder immediately if `last_reminder_sent_at` was NULL, without checking if `reminder_days` had passed since `email_sent_at`
- **Solution**: 
  - Added condition to ensure `email_sent_at < NOW() - INTERVAL '1 day' * reminder_days` before sending first reminder
  - Ensures at least `reminder_days` have passed since initial email before first reminder is sent
  - SOA envelopes send 1 reminder per day, other envelopes send 1 reminder every 3 days
- **Files Modified**: `crm/server/src/services/docusendService.ts`

**38. Client Visibility Before SOA Signing:**
- **Issue**: Leads created from Medicare booking page were appearing in CRM immediately, even before SOA was signed
- **Root Cause**: Clients were created with `status='booking-lead'` which was visible in CRM, and CRM's client listing API didn't filter out pending SOA clients
- **Solution**: 
  - Changed initial client status from `'booking-lead'` to `'pending-soa'` when Medicare appointment is booked
  - Updated `handleSOACompleted` to change client status from `'pending-soa'` to `'lead'` (or `'booking-lead'` to `'lead'` for backward compatibility) only after both parties sign SOA
  - Updated CRM client listing API (`GET /api/clients`) to filter out clients with `status='pending-soa'` from default view
  - Ensured manual client creation doesn't trigger automatic SOA sending if status is `pending-soa`
- **Files Modified**: `crm/server/src/routes/calendar.ts`, `crm/server/src/routes/clients.ts`, `crm/server/src/services/medicareSOAService.ts`

**39. Booking Page Network Issues:**
- **Issue**: Client portal booking page experiencing "Failed to fetch" errors and timeouts when loading availability schedule and time slots
- **Root Cause**: No timeout handling, no retry logic, and potential network instability
- **Solution**: 
  - Implemented `AbortController` with 15-second timeout for all fetch calls
  - Added retry logic with exponential backoff (initial attempt + 2 retries, with 1s and 2s delays)
  - Added explicit `Accept` and `Content-Type` headers
  - Implemented logic to retry on network errors and 5xx HTTP status codes
  - Improved error logging with specific error types (timeout vs. network error vs. HTTP error)
- **Files Modified**: `crm/client-portal/app/(portal)/booking/page.tsx`

**40. Favicon Route Error:**
- **Issue**: Client portal returning 502 Bad Gateway error due to favicon route returning 204 status code
- **Root Cause**: Next.js `Response` constructor doesn't accept 204 status code, causing application crash
- **Solution**: Changed favicon route to return `200` status with empty response instead of `204`
- **Files Modified**: `crm/client-portal/app/favicon.ico/route.ts`

**41. Availability Schedule Loading:**
- **Issue**: Booking page not receiving availability schedule data, causing "No availability schedule loaded yet" errors
- **Root Cause**: API endpoint was returning early with empty `availability` array if requested dates didn't meet `min_advance_booking_days` requirement, preventing frontend from receiving full availability schedule needed for calendar display
- **Solution**: Modified API endpoint to always query and return the `availability` schedule, even if requested dates don't meet advance booking requirement. The `slots` array is still empty in such cases, but availability data is consistently provided
- **Files Modified**: `crm/server/src/routes/calendar.ts`

**42. Template Field Normalization:**
- **Issue**: Template fields not correctly preserving `signingOrder` and `fieldGroup` when creating envelopes from templates
- **Root Cause**: `signingOrder` and `fieldGroup` were stored in template metadata but not correctly mapped when creating envelopes
- **Solution**: 
  - Updated `createEnvelopeFromTemplate` to correctly map `fieldType` from template metadata (handling both camelCase and snake_case)
  - Ensured `signingOrder` and `fieldGroup` are preserved when adding fields to new envelope
  - Updated `addSignatureField` to correctly store `signingOrder` and `fieldGroup` in `metadata` JSONB column
  - Normalized fields when creating/updating templates to move `signingOrder` and `fieldGroup` into metadata object
- **Files Modified**: `crm/server/src/services/docusendService.ts`, `crm/server/src/routes/docusend.ts`, `crm/client/src/pages/DocusendSettingsPage.tsx`

**43. A2P 10DLC Registration Setup:**
- **Issue**: Twilio phone number (949) 531-7651 requires A2P 10DLC registration before sending SMS to US phone numbers
- **Root Cause**: A2P 10DLC (Application-to-Person 10-Digit Long Code) registration is mandatory for all US SMS messaging via Twilio to ensure compliance with carrier regulations
- **Solution**: 
  - Created setup script `setup-a2p-10dlc.ts` to check phone number status, list registered brands/campaigns, and provide registration instructions
  - Created comprehensive documentation `A2P_10DLC_REGISTRATION.md` with step-by-step registration guide
  - Script checks Twilio API for existing brand and campaign registrations
  - Provides detailed instructions for manual registration process in Twilio Console
  - Registration process: Brand registration (1-2 days) ‚Üí Campaign creation (2-3 weeks approval) ‚Üí Phone number association
- **Files Created**: 
  - `crm/server/src/scripts/setup-a2p-10dlc.ts` - Setup and status check script
  - `crm/docs/A2P_10DLC_REGISTRATION.md` - Complete registration guide
- **Registration Requirements**:
  - Brand registration with business information (Legal Name, Tax ID, Address)
  - Campaign creation with use case: "Appointment Reminders & Confirmations"
  - Messaging Service creation and phone number association
  - Total timeline: ~3-4 weeks (brand: 1-2 days, campaign: 2-3 weeks)
- **Note**: Registration must be completed manually in Twilio Console. Script provides status checking and instructions.

**44. Email Logo Replacement:**
- **Issue**: "Document Signed Successfully" email template displayed "Versa Insurance" as text heading instead of logo
- **Root Cause**: Email template hardcoded text heading, no logo integration
- **Solution**: 
  - Updated `sendSignatureCompletedEmail` to fetch logo from `portal_config.branding_config`
  - Dynamically embed logo as `<img>` tag in email HTML (similar to signature request email)
  - Fallback to text heading if no logo configured
  - Convert relative logo URLs to absolute URLs for email compatibility
- **Files Modified**: `crm/server/src/services/docusendEmailService.ts`

**45. Signed Document PDF Viewing:**
- **Issue**: "View Signed Document" button in email didn't display PDF when clicked
- **Root Cause**: 
  - Email button linked to envelope detail page which only showed download button
  - No embedded PDF viewer in envelope detail modal
  - S3 URLs blocked by CORS when used in iframes
- **Solution**: 
  - Created proxy endpoint `/api/docusend/envelopes/:id/signed-document` to stream PDF from S3 with proper CORS headers
  - Updated `getEnvelope` function to include both `downloadUrl` (for downloads) and `proxyUrl` (for iframe embedding)
  - Added embedded PDF viewer in envelope detail modal using iframe with proxy URL
  - Added "Open in New Tab" button as fallback option
  - Email button now links directly to signed document proxy URL for immediate viewing
- **Files Modified**: `crm/server/src/routes/docusend.ts`, `crm/server/src/services/docusendService.ts`, `crm/client/src/pages/DocusendSettingsPage.tsx`

**46. Email Signer Names Display:**
- **Issue**: Email template said "signed by all signers" instead of showing actual signer names
- **Root Cause**: Email template used generic "all signers" text instead of querying actual signer names
- **Solution**: 
  - Updated `sendSignatureCompletedEmail` to query database for all signers who signed (status = 'signed')
  - Format signer names properly:
    - 1 signer: "John Doe"
    - 2 signers: "John Doe and Jane Smith"
    - 3+ signers: "John Doe, Jane Smith, and Bob Johnson"
  - Replace "all signers" with actual names in both HTML and plain text email versions
- **Files Modified**: `crm/server/src/services/docusendEmailService.ts`

**47. Product Initial Fields Filtering:**
- **Issue**: All 5 product initial fields were shown to clients, even if only specific products were selected during booking
- **Root Cause**: All initial fields from template were created and displayed, regardless of product selection
- **Solution**: 
  - Updated `createEnvelopeFromTemplate` in `docusendService.ts` to filter initial fields based on `productType`
  - Only create initial fields that match the selected product type (Part D, Medicare Advantage, Supplement, etc.)
  - Skip initial fields that don't match the product type during envelope creation
  - Frontend logic remains as fallback (hides uninitialed fields after any field is filled)
- **Files Modified**: `crm/server/src/services/docusendService.ts`

**48. Medicare Welcome Email Implementation:**
- **Issue**: Medicare clients didn't receive welcome email when created as client or converted from lead to client
- **Root Cause**: Only health insurance clients received onboarding welcome emails
- **Solution**: 
  - Created `sendMedicareOnboardingEmail()` function in `portalEmailService.ts` with Medicare-specific wording
  - Created Medicare onboarding email template HTML and plain text versions
  - Added email triggers in three locations:
    - Client creation (POST /api/clients): When Medicare client created with `status = 'client'`
    - Status update (PUT /api/clients/:id): When Medicare client status changes to `'client'`
    - Lead conversion (POST /api/clients/:id/convert): When Medicare lead converted to `'client'` or `'draft'`
  - Email includes magic link for client portal access, broker information, and Medicare-specific messaging
  - Footer shows "Medicare Specialists" instead of "Health Insurance Specialists"
  - Supports SendGrid dynamic templates or inline HTML fallback
  - Configurable via portal settings: `medicareOnboardingTemplateId`, `medicareOnboardingFromName`, `medicareOnboardingSubject`, `medicareOnboardingBody`
- **Files Modified**: `crm/server/src/services/portalEmailService.ts`, `crm/server/src/routes/clients.ts`

**49. Client Completion Email Not Sent:**
- **Issue**: Clients (signers) were not receiving completion emails when documents were fully signed, only the agent received emails
- **Root Cause**: Completion email logic only sent emails to the agent (`envelopeData.user_email`), not to all signers
- **Solution**: 
  - Updated `submitSignature` in `docusendService.ts` to send completion emails to ALL signers when envelope is completed
  - Generate signed PDF download URL (7-day expiry) once and share with all signers
  - Each signer receives personalized email with their name in greeting
  - Email includes direct download link to signed PDF
  - Updated `sendSignatureCompletedEmail` to accept `recipientName` and `signedDocumentUrl` parameters
  - Email button text changes to "Download Signed Document" when direct download URL is available
- **Files Modified**: `crm/server/src/services/docusendService.ts`, `crm/server/src/services/docusendEmailService.ts`

**50. PDF Font Size Too Large:**
- **Issue**: Text in signed PDFs exceeded template field boundaries, making documents look unprofessional
- **Root Cause**: Font size calculation used `height * 0.8` which was too large for many template fields
- **Solution**: 
  - Reduced base font size ratio from `0.8` to `0.5` for all text rendering functions
  - Added width-based font size calculation to ensure text fits within field width (95% margin)
  - Added maximum font size cap at `height * 0.65` to prevent overflow
  - Applied to all field types: signatures, initials, dates, text fields, checkboxes
  - Text now properly fits within template field boundaries
- **Files Modified**: `crm/server/src/services/signatureService.ts`

**51. Initial Field Product Name Detection:**
- **Issue**: Initial fields were displaying product names (e.g., "Medicare Advantage") instead of initials (e.g., "MA")
- **Root Cause**: When product names were stored in `fieldValue`, the PDF rendering logic didn't detect and extract initials from product names
- **Solution**: 
  - Added product name detection logic in `signatureService.ts` to identify when `fieldValue` contains product keywords
  - If product name detected (contains "medicare", "advantage", "supplement", etc., or length > 10), extract initials from signer name instead
  - Added debug logging to show field values being processed
  - Initial fields now correctly show initials instead of full product names
- **Files Modified**: `crm/server/src/services/signatureService.ts`

**52. Thank You Page After Document Signing:**
- **Issue**: Users were redirected to dashboard after signing documents, but they aren't clients yet and shouldn't have dashboard access
- **Root Cause**: Signing flow redirected to `/dashboard` which requires authentication and client status
- **Solution**: 
  - Created new `ThankYouPage.tsx` component with simple confirmation message
  - Added route `/sign/thank-you` in `App.tsx`
  - Updated `SignDocumentPage.tsx` and `SignPublicPowerFormPage.tsx` to redirect to `/sign/thank-you` after successful signing
  - Page displays "Thank You!" message, confirms successful signing, and mentions confirmation email
  - No navigation buttons or dashboard links (users aren't clients yet)
- **Files Created**: `crm/client/src/pages/ThankYouPage.tsx`
- **Files Modified**: `crm/client/src/App.tsx`, `crm/client/src/pages/SignDocumentPage.tsx`, `crm/client/src/pages/SignPublicPowerFormPage.tsx`

**53. Multi-Timezone Signature PDF Date Display:**
- **Issue**: Signature dates in PDFs were showing incorrect dates for clients in different timezones (e.g., NYC client signing Dec 17 saw Dec 18 due to server UTC time)
- **Root Cause**: Signature service was formatting dates using server time (UTC) instead of client's local timezone
- **Business Context**: Marketing site detects client timezone via IP address, stores in `appointments.timezone` column (e.g., `'America/New_York'` for NYC, `'America/Los_Angeles'` for Pacific)
- **Legal Concern**: ESIGN Act requires accurate signature dates - must show the date the client actually signed in their local timezone
- **Solution**: 
  - Added `timezone` property to `SignatureData` interface in `signatureService.ts`
  - Modified `addDateField` to accept `timezone` parameter (defaults to Pacific Time)
  - Updated `submitSignature` in `docusendService.ts` to fetch client's timezone from most recent appointment
  - Pass timezone to `embedSignatureIntoPDF` for proper date formatting
  - NYC client signing Dec 17 now correctly shows "December 17, 2025" (not Dec 18)
  - Maintains full audit trail in database with UTC timestamps for legal compliance
- **Files Modified**: `crm/server/src/services/signatureService.ts`, `crm/server/src/services/docusendService.ts`
- **Legal Compliance**: ‚úÖ Meets ESIGN Act requirements for accurate timestamping

**54. Multi-Timezone Appointment Confirmation Emails:**
- **Issue**: Appointment confirmation emails showed only Pacific Time, causing confusion for clients in other timezones
- **Business Context**: Agent works in Pacific Time (California), but clients can be in different timezones (NYC = Eastern, etc.)
- **UX Problem**: NYC client booking 9:00 AM EST appointment would see "6:00 AM PST" in confirmation, creating confusion
- **Solution**: 
  - Implemented timezone-specific email formatting in `appointmentReminders.ts`
  - **Client Email**: Shows appointment time in their local timezone (e.g., "9:00 AM EST" for NYC client)
  - **Agent Email**: Shows appointment time in Pacific Time (e.g., "6:00 AM PST" for agent)
  - **Agent Email Bonus**: Includes client's timezone location and their local time for reference
  - Added timezone abbreviation detection using `dayjs.tz().format('z')` (e.g., "EST", "PST")
  - Added client location extraction from timezone (e.g., "New York" from "America/New_York")
  - Agent email shows: "Date & Time: December 22, 2025 at 6:00 AM PST (9:00 AM EST client time)"
- **Email Templates**:
  - Client: `"Date & Time: ${clientStartTime} - ${clientEndTime} ${clientTzAbbr}"`
  - Agent: `"Date & Time: ${agentStartTime} - ${agentEndTime} ${agentTzAbbr}${isDifferentTimezone ? ' (client time: clientStartTime clientTzAbbr)' : ''}"`
- **Files Modified**: `crm/server/src/services/appointmentReminders.ts`, `crm/server/src/services/medicareSOAService.ts`
- **UX Benefit**: Clients see times in their local timezone, agent sees all times in Pacific Time (consistent with calendar)

**55. Marketing Site Duplicate Check API & Database Security:**
- **Issue**: Marketing site needed ability to check for duplicate clients before form submission, discovered shared database security concern
- **Business Context**: Marketing site submits forms to CRM, needed real-time duplicate detection to prevent duplicate leads
- **Database Discovery**: During implementation, discovered CRM database contained 24 marketing site tables (booking pages, CMS pages, marketing campaigns, etc.)
- **Security Analysis**: 
  - Confirmed databases are actually **separate** (marketing on `ep-icy-voice-afl8wbfi-pooler`, CRM on `ep-small-thunder-afvxv0vi-pooler`)
  - 9 "marketing" tables in CRM database are actually **active CRM features** (booking system, marketing tools, CMS content)
  - No cleanup needed - all tables are properly owned by CRM
- **Solution**: 
  - Created dedicated API endpoint: `POST /api/public/forms/check-duplicate`
  - Checks for duplicate clients based on email (case-insensitive) and/or phone number (exact match)
  - Returns client details if duplicate found, including which field matched
  - Scoped to user's clients (multi-tenant safe)
  - Rate-limited and authenticated via API key
  - **Permission Model**: Added `public-forms:check-duplicate` permission alongside `public-forms:submit`
  - **API Key Strategy**: Updated all 5 existing business line API keys to include both permissions
    - Main Site, Health Insurance, Homeowners, Medicare 65+, Life Insurance keys all updated
    - Same API key can be used for both duplicate checking AND form submission
    - Simpler key management - one key per business line handles both operations
- **Documentation Created**:
  - `MARKETING_SITE_DUPLICATE_CHECK_INTEGRATION.md` - Complete integration guide with 4 implementation examples
  - `FOR_MARKETING_AGENT.md` - Database separation details and integration instructions
  - `.ai/DATABASE_ARCHITECTURE.md` - Single source of truth for database architecture
  - `.cursor/rules/900-database-verification.mdc` - Automated rule to prevent future confusion
  - `PREVENTION_MEASURES.md` - Complete prevention system guide
- **Prevention System Implemented**:
  - Documentation layer with architecture doc
  - Automated verification rule
  - `verify-database-connection.ts` script for one-command verification
  - Checklist and red flags guide
- **Script Created**: `add-duplicate-check-permission.ts` - Bulk-updates API keys with new permission
- **Files Modified**: 
  - `crm/server/src/routes/public-forms.ts` - Added duplicate check endpoint
  - `crm/server/src/scripts/add-duplicate-check-permission.ts` - Created
  - `MARKETING_SITE_DUPLICATE_CHECK_INTEGRATION.md` - Created
  - `FOR_MARKETING_AGENT.md` - Created
  - `.ai/DATABASE_ARCHITECTURE.md` - Created
  - `.cursor/rules/900-database-verification.mdc` - Created
  - `PREVENTION_MEASURES.md` - Created
- **API Response Format**:
  ```json
  {
    "exists": true,
    "duplicate": {
      "field": "email",
      "clientId": 123,
      "firstName": "John",
      "lastName": "Doe",
      "email": "john@example.com",
      "phone": "1234567890",
      "businessLine": "health-insurance"
    }
  }
  ```
- **Security Benefits**: 
  - Prevents duplicate client records
  - Provides immediate feedback to users
  - Maintains data integrity
  - Multi-tenant safe (user-scoped queries)
- **UX Benefit**: Marketing site can now show "This email/phone is already registered" message before submission

**Next Steps:**
- ‚úÖ Epic 11 (Medicare SOA Automation) integration complete
- ‚úÖ Calendar booking integration complete
- ‚úÖ Client portal document display complete
- ‚úÖ Email improvements complete (logo, PDF viewing, signer names)
- ‚úÖ Product field filtering complete
- ‚úÖ Medicare welcome email complete
- Can be extended for other document signing workflows

---

### Epic 13: Autopilot Lead Outreach App

**Status**: ‚è≥ **Future**  
**Priority**: P2 (Medium)  
**Description**: AI-powered automated SMS marketing and prospect nurturing system that imports prospects from Facebook Ads, LinkedIn Ads, and Google Ads, warms them up through SMS campaigns, and converts them to leads when they book appointments or fill out forms. Enables intelligent automated follow-up messaging with script-based templates, AI personalization, and automated response handling. Full TCPA & 10DLC compliance with A2P 10DLC campaign registration.

**‚ö†Ô∏è CRITICAL REQUIREMENT**: Compliance protection mechanisms (Phase 0) MUST be built BEFORE any SMS sending functionality to prevent $500-$10,000 fines per violation. See Section 6.1 for details.

**Related Epics**: Depends on [[Epic 1: Core CRM Foundation]], [[Epic 2: AI Agent Integration]], [[Epic 7: Calendar Scheduling System]]. Integrates with [[Epic 14: Facebook Ads Integration]], [[Epic 15: LinkedIn Ads Integration]], [[Epic 16: Google Ads Integration]] for prospect import.

**Business Value:**
- **Prospect-to-Lead Conversion**: Automated nurturing of cold prospects from Facebook/LinkedIn/Google ads increases conversion rates
- **Time Savings**: Reduces manual outreach effort for agents (AI handles routine responses)
- **Scalability**: Handle high volumes of prospects from paid advertising campaigns automatically
- **‚ö†Ô∏è Compliance Protection**: Prevents $500-$10,000 fines through opt-out checks, STOP keyword handling, and consent verification (Phase 0 - MUST BUILD FIRST)
- **Compliance**: Full TCPA & 10DLC compliance with proper opt-in mechanisms, A2P 10DLC registration, and comprehensive protection mechanisms
- **Intelligence**: AI-powered personalization and response handling improves engagement rates

**Planned Features:**

**1. Prospect Import & Nurturing (Business Line-Aware):**
- Import prospects from Facebook Ads, LinkedIn Ads, and Google Ads
- **Important**: Imported contacts are **prospects/contacts** (NOT leads) - they need to be warmed up through SMS campaigns
- **Business Line Assignment**: Automatically assign prospects to business line based on ad campaign, form data, or manual selection
- **Business Line Filtering**: Filter prospects by business line in all views and reports
- Prospect capture forms with SMS consent checkboxes
- Database storage of consent records (`sms_consent`, `consent_source`, `consent_timestamp`, `ip_address`)
- Prospect filtering: Only send to prospects with `sms_consent = true`
- Prospect status tracking (new, contacted, warmed, converted, opted-out) per business line
- Source attribution tracking (which ad platform generated each prospect)
- **SMS Campaign Nurturing**: Use SMS campaigns to warm up cold prospects and convert them to hot leads
- **Conversion to Lead**: Prospects become "leads" only when they:
  - **Book an appointment** (triggers SOA for Medicare), OR
  - **Fill out a lead form** (website form submission)
- **Business Line-Specific Status Workflows**:
  - **Medicare**: 
    - Imported as `status = 'draft'` or `'prospect'` (NOT 'lead')
    - SMS campaigns warm up prospects
    - **When prospect books appointment**: Status changes to `'pending_soa'` ‚Üí SOA sent automatically
    - **After SOA signed (both parties)**: Status changes to `'lead'` ‚Üí Lead appears in CRM
    - **Before booking/appointment**: Prospect does NOT appear in CRM ClientsPage (filtered out)
  - **Other Business Lines**: 
    - Imported as `status = 'draft'` or `'prospect'` (NOT 'lead')
    - SMS campaigns warm up prospects
    - **When prospect books appointment or fills form**: Status changes to `'lead'` ‚Üí Lead appears in CRM immediately

**2. SMS Campaign Management:**
- **Script Library**: Pre-written message templates organized by business line and scenario
- **AI-Powered Personalization**: AI selects and customizes scripts based on lead data
- **Message Templates**: Create and manage SMS message templates with variable placeholders
- **Personalized Messaging**: AI personalizes messages with lead data (name, product interest, ad source)
- **Scheduled Messaging**: Immediate, scheduled, and drip campaigns
- **Message Tracking**: Sent, delivered, read, clicked status tracking
- **Opt-Out Handling**: STOP keyword support with automatic opt-out processing

**3. A2P 10DLC Campaign Registration:**
- **Separate Marketing Campaign**: Register second A2P 10DLC campaign for marketing/promotional use
- **Campaign Type**: "Mixed" or "Marketing" (separate from transactional campaign)
- **Use Case**: Lead nurturing, promotional outreach, follow-up communications
- **Phone Number**: Use same phone number (949) 531-7651 for both campaigns
- **Campaign Description**: Marketing messages to leads who opted in through Facebook/LinkedIn ads

**4. Landing Page Integration:**
- Landing pages for Facebook/LinkedIn ad traffic
- Clear disclosure language: "By providing your phone number, you agree to receive text messages from Versa Insurance Agency. Message and data rates may apply. Reply STOP to opt-out."
- Explicit SMS consent checkbox (unchecked by default, cannot be pre-checked)
- Consent cannot be required to submit form
- Lead capture form with name, email, phone, product interest

**5. AI-Powered Automation (Business Line-Aware):**
- **Hybrid AI + Scripts Approach**: Combines pre-written scripts with AI personalization
- **Script Library**: Organized by business line (Medicare, Health, Life, Group, Commercial) and scenario
- **Business Line-Specific AI Rules**: Each business line has its own AI automation rules
  - **Medicare AI Rules**: Handles Medicare-specific questions (enrollment periods, Part A/B/D, SOA requirements)
  - **Health Insurance AI Rules**: Handles health insurance-specific questions (open enrollment, special enrollment periods, marketplace)
  - **Life Insurance AI Rules**: Handles life insurance-specific questions (coverage types, beneficiaries, premiums)
  - **Group Plans AI Rules**: Handles group benefits-specific questions (employer plans, enrollment, benefits)
  - **Commercial AI Rules**: Handles commercial insurance-specific questions (business coverage, liability, workers comp)
- **AI Message Generation**: AI selects best script based on business line and personalizes with prospect/lead data
- **Automated Responses**: AI responds to common questions automatically (business line-specific responses)
- **Smart Escalation**: AI escalates complex questions to human agents (business line-aware escalation rules)
- **Intent Detection**: AI analyzes prospect/lead responses to determine interest level and next steps (business line context)
- **Sentiment Analysis**: AI detects positive/negative sentiment and adjusts messaging (business line-specific tone)
- **Learning System**: AI learns from agent responses per business line to improve automation over time

**6. Script Management:**
- **Script Categories**: Welcome scripts, follow-up scripts, response scripts, conversion scripts, re-engagement scripts
- **Script Editor**: Rich text editor with variable insertion buttons
- **Variable Library**: `{FirstName}`, `{LastName}`, `{ProductInterest}`, `{AgentName}`, `{CompanyName}`, `{AdSource}`, `{Link}`, etc.
- **Script Templates**: Pre-built templates for common scenarios
- **A/B Testing**: Create variants of scripts and test performance
- **Performance Metrics**: Track which scripts convert best
- **Business Line Scripts**: Separate script libraries for each business line (5-10 templates each)

**7. Autopilot Workflow (Business Line-Aware):**
- Automatic prospect import from ad platforms (Facebook, LinkedIn, Google Ads API integration or manual CSV upload)
- **Business Line Assignment**: Prospects automatically assigned to business line based on:
  - Ad campaign name/keywords
  - Form submission data
  - Manual assignment
  - AI detection from prospect data
- Prospect filtering: Only process prospects with `sms_consent = true` (filterable by business line)
- **SMS Campaign Nurturing**: Send welcome messages, educational content, engagement campaigns to warm up cold prospects
- **AI-Powered First Message**: AI selects appropriate script based on business line and personalizes: "Hi [FirstName]! This is [AgentName] from Versa Insurance. I saw you were interested in [Product/Service] from our [AdSource] ad. I'd love to help you find the right coverage. When's a good time to chat? Reply STOP to opt-out."
- **Prospect-to-Lead Conversion**: Prospects become leads when they:
  - **Book an appointment** (triggers SOA for Medicare), OR
  - **Fill out a lead form** (website form submission)
- **Business Line-Specific Workflows**:
  - **Medicare**: 
    - Prospects imported as `status = 'draft'` or `'prospect'` (NOT 'lead')
    - SMS campaigns warm up prospects
    - **When prospect books appointment**: Status changes to `'pending_soa'` ‚Üí SOA sent automatically
    - **After SOA signed (both parties)**: Status changes to `'lead'` ‚Üí Lead appears in CRM
  - **Health Insurance**: 
    - Prospects imported as `status = 'draft'` or `'prospect'` (NOT 'lead')
    - SMS campaigns warm up prospects
    - **When prospect books appointment or fills form**: Status changes to `'lead'` ‚Üí Lead appears in CRM
  - **Life Insurance**: Same as Health Insurance
  - **Group Plans**: Same as Health Insurance
  - **Commercial**: Same as Health Insurance
- Follow-up message sequences (drip campaigns with AI-optimized timing, business line-specific)
- **AI Response Handling**: AI responds to common questions automatically (business line-specific responses), escalates complex questions to agents
- **Conversation Threading**: All SMS messages (AI + human) appear in existing CRM conversation threads (business line context preserved)
- Conversion tracking (prospect ‚Üí lead ‚Üí client ‚Üí appointment with source attribution, filterable by business line)

**6. TCPA & 10DLC Compliance (CRITICAL PROTECTION MECHANISMS):**
- **‚ö†Ô∏è MUST BE BUILT BEFORE ANY SMS SENDING** - Prevents $500-$10,000 fines per violation
- **Prior Express Written Consent**: Required before sending any marketing messages
- **Opt-In Mechanisms**: Website forms, landing pages, text-to-join (future)
- **Opt-Out Instructions**: Included in every message ("Reply STOP to opt-out")
- **Consent Records**: Stored with prospect/lead record (timestamp, source, IP address)
- **Opt-Out Handling**: Immediate opt-out processing, honor all STOP requests
- **Message Frequency Disclosure**: Clear disclosure of expected message frequency
- **Content Disclosure**: Clear disclosure of message content types

**6.1 10DLC Compliance Protection Mechanisms (CRITICAL):**

**‚úÖ IMPLEMENTED (2025-01-27):** All Phase 0 compliance protection mechanisms are now active across all SMS services.

**Implementation Status:**
- ‚úÖ **Compliance Service**: Centralized compliance logic in `complianceService.ts`
- ‚úÖ **Opt-Out Verification**: All SMS services check opt-out status before sending
- ‚úÖ **Consent Verification**: All SMS services verify explicit consent before sending
- ‚úÖ **Opt-Out Instructions**: Automatically added to all SMS messages
- ‚úÖ **STOP Keyword Handler**: Incoming SMS webhook processes STOP keywords (`/api/sms/incoming`)
- ‚úÖ **START Keyword Handler**: Handles resubscription requests
- ‚úÖ **Service Integration**: All 4 SMS services protected (appointmentSmsService, reviewSmsService, medicareSOAService, sinchSmsService)

**Protected Services:**
- ‚úÖ Appointment SMS notifications
- ‚úÖ Review invitation SMS
- ‚úÖ Medicare SOA SMS reminders
- ‚úÖ Sinch SMS service (all messages)

**Compliance Files:**
- `crm/server/src/services/complianceService.ts` - Centralized compliance logic
- `crm/server/src/routes/sms.ts` - SMS webhook handler
- `crm/docs/10DLC_COMPLIANCE_GUIDE.md` - Complete compliance guide
- `crm/docs/COMPLIANCE_IMPLEMENTATION_PRIORITY.md` - Implementation plan
- `crm/docs/10DLC_FEES_EXPLAINED.md` - Fee breakdown

**Related Work**: See [[CODE_UPGRADE_PROJECT.md#2025-01-27---10dlc-compliance-protection-mechanisms-implemented]] for detailed implementation notes.
- **Opt-Out Check Before Sending**: Block SMS if recipient has opted out (prevents $10,000 Content Violation fine)
- **STOP Keyword Handler**: Automatic opt-out processing when user replies STOP, STOPALL, UNSUBSCRIBE, QUIT (prevents $10,000 fine)
- **Opt-Out Database**: `sms_opt_outs` table tracks all opt-outs (phone number, timestamp, source)
- **Consent Verification**: Check `sms_consent = true` before sending (prevents $10,000 fine)
- **Opt-Out Instructions**: Every message must include "Reply STOP to opt-out" (prevents $500-$1,000 fine)
- **Incoming SMS Webhook**: `/api/sms/incoming` endpoint to handle STOP keywords and replies
- **Compliance Monitoring**: Dashboard to track opt-out rate, consent rate, compliance status
- **10DLC Registration**: Separate marketing campaign registered with Sinch (already complete)
- **Carrier Fee Tracking**: Monitor per-message carrier fees ($0.0025-$0.0040 per SMS)

**Penalty Prevention:**
- **Content Violation**: $10,000 fine - Prevented by opt-out checks and consent verification
- **Tier 1-3 Violations**: $500-$5,000 fine - Prevented by STOP keyword handler and opt-out honoring
- **Grey Route**: $50 per message - Prevented by using Sinch API (not direct carrier routing)
- **Non-Usage Fee**: $250 per campaign - Prevented by sending at least 1 message per 60 days

**Implementation Priority:**
- **Phase 0 (CRITICAL)**: Build compliance protection mechanisms BEFORE any SMS sending
  - Opt-out check function
  - STOP keyword handler webhook
  - Opt-out instructions injection
  - Consent verification
- **Phase 1**: Build SMS sending features (with compliance checks built-in)
- **Phase 2+**: Build advanced features (campaigns, analytics, etc.)

**Compliance Files:**
- `crm/docs/10DLC_COMPLIANCE_GUIDE.md` - Complete compliance guide
- `crm/docs/COMPLIANCE_IMPLEMENTATION_PRIORITY.md` - Implementation plan
- `crm/docs/10DLC_FEES_EXPLAINED.md` - Fee breakdown

**9. Database Schema:**
```sql
-- Add to leads/clients table
ALTER TABLE clients ADD COLUMN IF NOT EXISTS sms_consent BOOLEAN DEFAULT false;
ALTER TABLE clients ADD COLUMN IF NOT EXISTS consent_source VARCHAR(100); -- 'facebook_ad', 'linkedin_ad', 'website_booking', 'website_form'
ALTER TABLE clients ADD COLUMN IF NOT EXISTS consent_timestamp TIMESTAMP WITH TIME ZONE;
ALTER TABLE clients ADD COLUMN IF NOT EXISTS consent_ip_address VARCHAR(45);
ALTER TABLE clients ADD COLUMN IF NOT EXISTS sms_opted_out BOOLEAN DEFAULT false;
ALTER TABLE clients ADD COLUMN IF NOT EXISTS sms_opted_out_at TIMESTAMP WITH TIME ZONE;

-- SMS campaign tracking
CREATE TABLE IF NOT EXISTS sms_campaigns (
  id SERIAL PRIMARY KEY,
  name VARCHAR(255) NOT NULL,
  message_template TEXT NOT NULL,
  campaign_type VARCHAR(50) NOT NULL, -- 'immediate', 'scheduled', 'drip'
  status VARCHAR(50) DEFAULT 'draft', -- 'draft', 'active', 'paused', 'completed'
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS sms_messages (
  id SERIAL PRIMARY KEY,
  campaign_id INTEGER REFERENCES sms_campaigns(id),
  client_id INTEGER REFERENCES clients(id),
  phone_number VARCHAR(20) NOT NULL,
  message_body TEXT NOT NULL,
  status VARCHAR(50) DEFAULT 'pending', -- 'pending', 'sent', 'delivered', 'failed', 'opted_out'
  twilio_message_sid VARCHAR(255),
  sent_at TIMESTAMP WITH TIME ZONE,
  delivered_at TIMESTAMP WITH TIME ZONE,
  error_message TEXT,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE TABLE IF NOT EXISTS sms_opt_outs (
  id SERIAL PRIMARY KEY,
  phone_number VARCHAR(20) NOT NULL UNIQUE,
  client_id INTEGER REFERENCES clients(id),
  opted_out_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  source VARCHAR(50) -- 'stop_keyword', 'manual', 'api'
);
```

**8. API Endpoints:**
- `POST /api/autopilot/prospects/import` - Import prospects from CSV or API
- `GET /api/autopilot/prospects` - List prospects with SMS consent
- `PUT /api/autopilot/prospects/:id/convert-to-lead` - Manually convert prospect to lead
- `POST /api/autopilot/prospects/:id/book-appointment` - Prospect books appointment (triggers conversion)
- `POST /api/autopilot/prospects/:id/submit-form` - Prospect fills form (triggers conversion)
- `GET /api/autopilot/leads` - List converted leads (status = 'lead' or 'pending_soa')
- `POST /api/autopilot/campaigns` - Create SMS campaign
- `GET /api/autopilot/campaigns` - List campaigns
- `POST /api/autopilot/campaigns/:id/send` - Send campaign
- `GET /api/autopilot/messages` - List sent messages
- `POST /api/autopilot/opt-out` - Handle opt-out requests
- `GET /api/autopilot/analytics` - Campaign analytics

**11. Frontend Components (Business Line-Aware):**
- **Business Line Selector**: Toggle between business lines in all views
- Autopilot dashboard (`/marketing/autopilot`) with real-time metrics (filterable by business line)
  - **Business Line Tabs**: Separate tabs for each business line (Medicare, Health, Life, Group, Commercial)
  - **Business Line-Specific KPIs**: Metrics per business line
  - **Business Line Comparison**: Compare performance across business lines
- Lead import interface (CSV upload, Facebook/LinkedIn/Google Ads API integration)
  - **Business Line Assignment**: Assign leads to business line during import
  - **Business Line Filtering**: Filter imported leads by business line
- Campaign builder (script selection, AI personalization, scheduling)
  - **Business Line Selection**: Required field - each campaign belongs to one business line
  - **Business Line-Specific Scripts**: Only shows scripts for selected business line
  - **Business Line-Specific Settings**: Different defaults per business line
- **Script Library Manager**: Create, edit, organize, and test scripts
  - **Business Line Filtering**: View/edit scripts by business line
  - **Business Line-Specific Variables**: Shows available variables for selected business line
  - **Business Line Templates**: Pre-built templates per business line
- Message tracking (sent, delivered, responses, AI vs human)
  - **Business Line Filtering**: Filter messages by business line
  - **Business Line-Specific Statuses**: Different status workflows per business line
- Analytics dashboard (prospect-to-lead conversion rates, opt-out rates, script performance)
  - **Business Line Breakdown**: Analytics per business line
  - **Business Line Comparison**: Compare performance across business lines
  - **Business Line-Specific Metrics**: Different metrics per business line (e.g., Medicare tracks SOA completion)
  - **Prospect-to-Lead Funnel**: Shows conversion from prospects ‚Üí leads
  - **Engagement Metrics**: Track prospect engagement (replies, clicks, booking rate)
- **AI Response Dashboard**: Monitor AI responses, review escalations, adjust automation rules
  - **Business Line Filtering**: Filter AI responses by business line
  - **Business Line-Specific AI Rules**: Configure AI automation rules per business line
- **Business Line Settings Page**: Configure settings per business line
  - Default scripts
  - AI automation rules
  - Send time preferences
  - Rate limits
  - Compliance rules

**12. Integration Points:**
- **Facebook Ads API**: Import leads from Facebook ad campaigns with SMS consent tracking
- **LinkedIn Ads API**: Import leads from LinkedIn ad campaigns with SMS consent tracking
- **Google Ads API**: Import leads from Google Ads campaigns with SMS consent tracking
- **Twilio SMS**: Send messages via existing Twilio integration
- **A2P 10DLC**: Use registered marketing campaign for message delivery
- **CRM Integration**: 
  - **Prospects/Leads Integration**: Autopilot prospects and leads ARE CRM clients (same `clients` table)
    - **Prospects**: Have `status = 'draft'` or `'prospect'`, `sms_consent = true`, `consent_source = 'facebook_ad'` (or similar), `lead_type = 'facebook-autopilot'` (or similar)
    - **Leads**: Have `status = 'lead'` or `'pending_soa'` (after conversion from prospect)
    - **Prospects do NOT appear in CRM ClientsPage** (filtered out - status is 'draft'/'prospect')
    - **Leads appear in existing CRM ClientsPage** (filterable by `lead_type` or `consent_source`)
    - No separate prospects/leads table needed - single source of truth
  - **Conversations Integration**: SMS messages appear in existing conversation threads
  - **Appointments Integration**: Use existing CRM calendar system for appointments
- **Calendar Integration**: 
  - **Use Existing CRM Calendar**: When leads convert and want to schedule, use existing `/api/calendar/appointments` endpoint
  - **No Separate Calendar**: All appointments in existing `appointments` table
  - **Google Calendar Sync**: Automatically works (existing feature)
  - **AI Auto-Scheduling**: AI can automatically create appointments via existing calendar API
- **Campaign/Message Scheduling**: 
  - **NOT Calendar Events**: Campaign scheduling is a job queue system (not calendar events)
  - **Job Scheduler**: Use `node-cron` or similar for scheduled sends
  - **Storage**: Store scheduled times in `sms_campaigns.scheduled_send_time` or `sms_messages.scheduled_send_time`
  - **Purpose**: Schedule when to send messages (different from appointment scheduling)

**A2P 10DLC Campaign Registration Details:**

**Campaign Description:**
```
This campaign sends marketing and promotional SMS messages to prospective leads who have explicitly opted in to receive marketing communications. Messages include: (1) Insurance product information and updates, (2) Special offers and promotions, (3) Educational content about Medicare and health insurance, (4) Event invitations and webinars, and (5) Follow-up communications for leads who have expressed interest through Facebook ads, LinkedIn ads, or other marketing channels but not yet booked appointments. All recipients have provided prior express written consent through website forms, landing pages, or other explicit opt-in mechanisms. Users can opt-out at any time by replying STOP to any message.

### Epic 14: Facebook Ads Integration

**Status**: ‚úÖ **Complete**  
**Priority**: P0 (High)  
**Description**: Comprehensive Facebook Marketing API integration enabling full campaign management, ad creation, lead import, analytics, and direct media upload capabilities within the CRM.

**Business Value**:
- **Centralized Campaign Management**: Manage all Facebook ad campaigns directly from CRM
- **Lead Import Automation**: Automatic import of Facebook leads with business line categorization
- **Performance Analytics**: Real-time campaign performance metrics and insights
- **Creative Management**: Full ad creation with image/video upload capabilities
- **Autopilot Integration**: Support for Medicare leads with `pending_soa` status for autopilot app

**Key Features Implemented**:

**1. OAuth Connection & Account Management:**
- Facebook OAuth 2.0 integration for secure account connection
- Access token management with automatic refresh
- Account selection and connection status tracking
- Disconnect functionality with token cleanup

**2. Campaign Management:**
- Full CRUD operations for campaigns (Create, Read, Update, Delete)
- Campaign status management (Active, Paused, Archived)
- Campaign objective configuration (OUTCOME_LEADS, OUTCOME_AWARENESS, etc.)
- Budget management (daily and lifetime budgets)
- Special ad categories support (HOUSING, EMPLOYMENT, CREDIT)
- Campaign performance metrics (impressions, clicks, spend, CTR, CPC, leads, conversions)
- Search and filter functionality
- Bulk operations (pause, activate, delete, export)
- Expandable rows showing ad sets and ads

**3. Ad Set Management:**
- Full CRUD operations for ad sets
- Budget configuration (daily budget with validation)
- Targeting configuration (demographics, interests, behaviors)
- Billing event and optimization goal configuration
- Bid strategy management (LOWEST_COST_WITHOUT_CAP, COST_CAP, etc.)
- Start/end date scheduling
- Performance metrics per ad set
- Expandable rows showing ads within ad sets

**4. Ad Management:**
- Full CRUD operations for ads
- **Comprehensive Ad Creation Form** (Facebook Ads Manager-style):
  - Direct image/video upload to Facebook (automatic hash/ID retrieval)
  - Manual image hash/video ID entry option
  - Headline, primary text, link URL fields
  - Call-to-action button selection (10+ options: Learn More, Sign Up, Get Quote, etc.)
  - Page ID configuration
  - Image preview after upload
  - Upload progress indicators
- Ad creative management (automatic creative creation from form data)
- Ad status management (Active, Paused)
- Performance metrics per ad
- Edit functionality for existing ads

**5. Lead Management:**
- Lead form listing and selection
- Lead import with business line categorization (5 business lines: Medicare, Health, Life, Group Health, Commercial)
- Automatic client creation from leads
- Lead data mapping and storage
- Autopilot mode support (Medicare leads with `pending_soa` status)
- Lead filtering and search

**6. Analytics Dashboard:**
- Performance metrics dashboard with charts and trends
- Campaign-level analytics
- Ad set-level analytics
- Ad-level analytics
- Date range filtering
- Metric comparison (impressions, clicks, spend, CTR, CPC, leads, conversions)
- Visual charts using recharts library (Line charts, Bar charts, Pie charts)

**7. Settings Tab:**
- Facebook account connection status
- Account information display
- Token expiration tracking
- Disconnect functionality

**8. Rate Limiting & Performance:**
- Exponential backoff retry logic for Facebook API rate limits
- Sequential API request processing with delays
- Frontend queue system for ad set loading
- Debouncing and request throttling
- Graceful error handling for rate limit errors
- User notifications for rate limit issues

**Technical Implementation**:

**Backend Services:**
- `crm/server/src/services/facebookMarketingService.ts`:
  - OAuth flow implementation
  - Campaign, ad set, ad CRUD operations
  - Lead form and lead data retrieval
  - Insights/analytics fetching
  - Image/video upload to Facebook (`uploadFacebookImage`, `uploadFacebookVideo`)
  - Ad creative creation (`createFacebookAdCreative`)
  - Rate limiting with exponential backoff
  - Business line categorization logic

**Backend Routes:**
- `crm/server/src/routes/marketing.ts`:
  - OAuth authorization and callback endpoints
  - Account management endpoints
  - Campaign CRUD endpoints
  - Ad set CRUD endpoints
  - Ad CRUD endpoints
  - Lead form and lead import endpoints
  - Analytics/insights endpoints
  - Media upload endpoint (`/api/marketing/facebook/upload-media`)
  - Settings endpoints

**Frontend Components:**
- `crm/client/src/pages/marketing/FacebookAdsPage.tsx`:
  - 7-tab navigation: Dashboard, Campaigns, Ads, Leads, Analytics, Connection, Settings
  - Campaign table with expandable rows
  - Ad set table with expandable rows
  - Ad table with full CRUD operations
  - Lead import interface
  - Analytics dashboard with charts
  - Connection status display
  - Settings configuration
  - Comprehensive ad creation modal with file upload

**Issues Fixed During Implementation**:

**1. OAuth Configuration:**
- Fixed "Facebook App ID not configured" error
- Added FACEBOOK_APP_ID and FACEBOOK_APP_SECRET environment variables
- Configured OAuth redirect URIs
- Fixed invalid scope errors (removed `leads_retrieval`, used `ads_management`, `ads_read`, `business_management`)
- Fixed domain configuration for callback URLs

**2. Campaign Creation Errors:**
- Fixed deprecated `LEAD_GENERATION` objective ‚Üí `OUTCOME_LEADS`
- Added `special_ad_categories` field for housing/employment/credit ads
- Fixed `is_adset_budget_sharing_enabled` requirement
- Added proper billing event and optimization goal validation
- Fixed bid strategy validation (`LOWEST_COST_WITHOUT_CAP`, `COST_CAP`, etc.)
- Added budget validation (must be > $0)

**3. Ad Set Creation Errors:**
- Fixed missing required fields (`start_time`, `end_time`, `targeting`, `bid_amount`)
- Fixed billing event and optimization goal compatibility
- Added proper bid strategy configuration
- Fixed budget sharing configuration

**4. Ad Creation & Display:**
- Fixed "Creative is required" error by implementing creative creation flow
- Added automatic creative creation from form data
- Fixed ad not appearing after creation (refresh delays, force reload)
- Implemented creative reuse from existing ads
- Added comprehensive ad creation form with all Facebook Ads Manager options

**5. Rate Limiting Issues:**
- Implemented exponential backoff (2s, 4s, 8s delays) for rate limit errors
- Added sequential processing with delays (500ms between campaigns, 300ms between ad sets)
- Implemented frontend queue system for ad set loading
- Added debouncing (300ms) and request throttling (800ms between calls)
- Added `rateLimitHit` flag to stop processing when limits hit
- Improved error handling to gracefully return empty arrays on rate limits

**6. UI/UX Improvements:**
- Moved status icon to front of campaign/ad set name (green/red circles)
- Removed status column to save space
- Added search and filter functionality
- Added bulk operations (pause, activate, delete, export)
- Improved table layouts and spacing
- Added performance metrics columns
- Added expandable rows for hierarchical display
- Added loading states and error messages
- Added image preview for uploaded media

**7. Ad Set Display Issues:**
- Fixed ad sets not appearing after creation (force refresh, campaign expansion)
- Added automatic campaign expansion when ad set created
- Added 1-second delay for Facebook API propagation

**8. TypeScript & Build Errors:**
- Fixed duplicate variable declarations
- Fixed `NodeJS.Timeout` type issues (changed to `number` for browser)
- Fixed missing icon imports (`IconSettings`)
- Fixed TypeScript type errors for API responses

**9. Media Upload Implementation:**
- Added `form-data` package for multipart uploads
- Implemented image upload to Facebook (`/adimages` endpoint)
- Implemented video upload to Facebook (`/advideos` endpoint)
- Added file validation (image/video types, 100MB limit)
- Added upload progress indicators
- Added image preview after upload
- Added manual entry fallback for image hash/video ID

**Database Schema:**
- `facebook_accounts` table: Stores OAuth tokens and account information
- Integration with existing `clients` table for lead import
- Business line categorization stored in client records

**API Integration:**
- Facebook Marketing API v24.0
- OAuth 2.0 for authentication
- Graph API endpoints for all operations
- Multipart form data for media uploads

**Files Created/Modified**:
- `crm/server/src/services/facebookMarketingService.ts` - Core Facebook API service
- `crm/server/src/routes/marketing.ts` - API routes
- `crm/client/src/pages/marketing/FacebookAdsPage.tsx` - Main UI component
- `crm/docs/FACEBOOK_APP_SETUP.md` - Facebook app configuration guide
- `crm/docs/FACEBOOK_LEAD_FORM_SETUP.md` - Lead form setup guide
- `crm/docs/FACEBOOK_AUTOPILOT_INTEGRATION.md` - Autopilot integration guide

**Success Criteria:**
- ‚úÖ Facebook account connection via OAuth
- ‚úÖ Campaign CRUD operations working
- ‚úÖ Ad set CRUD operations working
- ‚úÖ Ad CRUD operations working with full creative options
- ‚úÖ Lead import with business line categorization
- ‚úÖ Analytics dashboard with performance metrics
- ‚úÖ Direct image/video upload to Facebook
- ‚úÖ Rate limiting handled gracefully
- ‚úÖ All UI/UX improvements implemented
- ‚úÖ Production-ready and tested

**Deliverables:**
- Complete Facebook Ads management interface
- OAuth integration for secure account connection
- Full campaign, ad set, and ad management
- Lead import system with autopilot support
- Analytics dashboard with visualizations
- Media upload functionality
- Comprehensive error handling and rate limiting
- Production deployment ready
```

**Opt-In Description:**
```
End-users opt-in to receive SMS messages through multiple channels: (1) Landing pages for Facebook/LinkedIn advertisements where users provide their phone number and check a box consenting to SMS communications with clear disclosure language stating "By providing your phone number, you agree to receive text messages from Versa Insurance Agency. Message and data rates may apply. Reply STOP to opt-out." (2) Website lead capture forms with explicit SMS consent checkboxes (unchecked by default, cannot be pre-checked). (3) Text-to-join keywords (future implementation). All opt-in checkboxes are optional and unchecked by default, requiring users to actively opt-in. Consent is stored in our database with timestamp, source, and IP address. Users can opt-out at any time by replying STOP to any message, and we honor all opt-out requests immediately.
```

**Sample Messages:**
1. "Hi [FirstName]! This is [AgentName] from Versa Insurance. I saw you were interested in [Product/Service] from our [Facebook/LinkedIn] ad. I'd love to help you find the right coverage. When's a good time to chat? Reply STOP to opt-out."
2. "Hi [FirstName]! Thanks for your interest in Versa Insurance. We have special rates available for [Product/Service]. Would you like to schedule a free consultation? Reply STOP to opt-out."
3. "Hi [FirstName]! We noticed you were interested in Medicare plans. Our licensed agents can help you find the best coverage. Schedule a call: [Link]. Reply STOP to opt-out."
4. "Hi [FirstName]! Don't miss out on our limited-time offer for [Product/Service]. Get a free quote today: [Link]. Reply STOP to opt-out."
5. "Hi [FirstName]! We'd love to help you find the perfect insurance plan. Our team is available to answer your questions. Reply STOP to opt-out."

**Message Contents:**
- ‚úÖ Messages will include embedded links (for scheduling, quotes, product pages)
- ‚ùå Messages will include phone numbers (not included)
- ‚ùå Messages include content related to direct lending (not applicable)
- ‚ùå Messages include age-gated content (not applicable)

**Opt-In Keywords:** (Leave blank - text opt-in not initially supported)

**Opt-In Message:** (Leave blank - text opt-in not initially supported)

**Dependencies:**
- A2P 10DLC marketing campaign registration (separate from transactional campaign)
- Twilio SMS service (already configured)
- Facebook Ads API integration (or CSV import)
- LinkedIn Ads API integration (or CSV import)
- Google Ads API integration (or CSV import)
- OpenAI/Gemini API for AI-powered personalization and response handling
- Landing page infrastructure
- Prospect capture forms with consent checkboxes
- Script library system for message templates

**Deliverables:**
- Database schema for SMS campaigns and message tracking
- Lead import functionality (CSV and API)
- Campaign management interface
- Message template system
- Opt-out handling (STOP keyword)
- Analytics dashboard
- A2P 10DLC marketing campaign registration
- Landing pages with proper consent mechanisms
- Integration with existing CRM and calendar systems

**Estimated Timeline**: 4-6 weeks

**Technical Notes:**
- Must register separate A2P 10DLC campaign for marketing use (cannot use transactional campaign)
- Same phone number (949) 531-7651 can be used for both campaigns
- Full TCPA compliance required (prior express written consent, opt-out handling, consent records)
- Landing pages must have proper disclosure language and unchecked consent checkboxes
- All messages must include opt-out instructions
- Opt-out requests must be honored immediately
- Consent records must be stored with timestamp, source, and IP address

**Success Criteria:**
- ‚úÖ Prospect import from Facebook/LinkedIn/Google Ads working
- ‚úÖ Prospect-to-lead conversion tracking (prospects become leads when booking appointment or filling form)
- ‚úÖ SMS campaign nurturing warming up cold prospects
- ‚úÖ SMS campaigns sending successfully via A2P 10DLC marketing campaign
- ‚úÖ Script library system functional with templates for all business lines
- ‚úÖ AI-powered personalization working (AI selects and customizes scripts)
- ‚úÖ AI automated responses functional (common questions handled automatically)
- ‚úÖ Smart escalation working (complex questions routed to agents)
- ‚úÖ Opt-out handling (STOP keyword) functional with automatic processing
- ‚úÖ Consent records stored and tracked with source attribution
- ‚úÖ Landing pages with proper disclosure and consent mechanisms (all ad platforms)
- ‚úÖ Analytics dashboard showing campaign performance and script metrics
- ‚úÖ Conversation integration working (SMS in conversation threads)
- ‚úÖ Full TCPA compliance verified

---

### Previous Epic: Epic 3 - Client Portal

**Epic Status**: ‚úÖ Complete  
**Completed**: Full client portal with Next.js frontend, authentication, dashboard, plan summaries, documents, and broker information. All core features implemented and functional.

#### Story 3.1: Client Portal Foundation
**Status**: ‚è≥ Not Started  
**Priority**: P1  
**Description**: Set up Next.js project structure, configure Mantine UI, and integrate with existing backend API. Note: Magic link authentication backend is already implemented.

**Acceptance Criteria:**
- [ ] Next.js 14+ project created with App Router
- [ ] Mantine UI configured and styled (consistent with CRM)
- [ ] Magic link authentication frontend implemented (backend API exists at `/api/client-auth/magic-link/*`)
- [ ] Basic login page created (email input ‚Üí magic link request)
- [ ] Token verification page created (handles magic link callback)
- [ ] Integration with existing client portal API endpoints
- [ ] Environment configuration for API URLs

**Estimated Effort**: 1 week  
**Dependencies**: None (backend API already complete)

---

#### Story 3.2: Plan Summary Dashboard
**Status**: ‚è≥ Not Started  
**Priority**: P1  
**Description**: Create the main dashboard page showing plan summaries for Health, Dental, and Vision plans with enrolled members and PCP information.

**Acceptance Criteria:**
- [ ] Dashboard page layout created
- [ ] Health Plan card component with all fields:
  - Enrolled Carrier
  - Plan Type (HMO, PPO, etc.)
  - Metal Tier
  - Member Services Phone
  - Effective Date
  - Covered CA Case # (if applicable)
  - Premium information (Gross, Subsidy, Net)
- [ ] Dental Plan card component
- [ ] Vision Plan card component
- [ ] Enrolled Members section
- [ ] Primary Care Physician section
- [ ] Broker Information section
- [ ] Responsive design (mobile-friendly)

**Estimated Effort**: 1 week  
**Dependencies**: Story 3.1 (Database schema and authentication)

---

#### Story 3.3: Document Management
**Status**: ‚è≥ Not Started  
**Priority**: P1  
**Description**: Implement document upload, storage, viewing, and download functionality for client documents.

**Acceptance Criteria:**
- [ ] Document upload functionality
- [ ] Document list view with filtering
- [ ] Document download functionality
- [ ] File storage integration (S3 or local)
- [ ] Document type categorization
- [ ] File size and type validation
- [ ] Secure file access (clients can only access their own documents)

**Estimated Effort**: 1 week  
**Dependencies**: Story 3.1 (Database schema)

---

#### Story 3.4: Scheduling Integration
**Status**: ‚è≥ Not Started  
**Priority**: P2  
**Description**: Integrate scheduling widget (ScheduleOnce/OnceHub) for appointment booking.

**Acceptance Criteria:**
- [ ] Scheduling widget embedded in portal
- [ ] Direct appointment booking functionality
- [ ] Calendar integration
- [ ] Appointment confirmation emails
- [ ] Appointment history display

**Estimated Effort**: 3-5 days  
**Dependencies**: Story 3.2 (Dashboard)

---

#### Story 3.5: Benefits & Coverage Page
**Status**: ‚è≥ Not Started  
**Priority**: P2  
**Description**: Create benefits and coverage page showing formulary information, network providers, and coverage details.

**Acceptance Criteria:**
- [ ] Benefits & Coverage page created
- [ ] Formulary information display
- [ ] Network provider search
- [ ] Coverage details by plan
- [ ] Cost estimates and projections

**Estimated Effort**: 1 week  
**Dependencies**: Story 3.2 (Dashboard), Plan data integration

---

#### Story 3.6: Polish & Testing
**Status**: ‚è≥ Not Started  
**Priority**: P1  
**Description**: Final polish, mobile responsiveness, error handling, loading states, security audit, and performance optimization.

**Acceptance Criteria:**
- [ ] Mobile responsiveness verified
- [ ] Error handling implemented
- [ ] Loading states for all async operations
- [ ] Security audit completed
- [ ] Performance optimization (page load < 2 seconds)
- [ ] Accessibility audit (WCAG 2.1 AA)
- [ ] Cross-browser testing
- [ ] User acceptance testing

**Estimated Effort**: 1 week  
**Dependencies**: All previous stories

---

## 8. Dependencies

### 8.1 External Dependencies
- **Neon PostgreSQL**: Database hosting (currently active)
- **Twilio**: Voice call integration (configured)
- **OpenAI/Gemini**: AI services (configured)
- **SendGrid**: Email service (configured)
- **DigitalOcean**: Server hosting (configured)
- **Stripe**: Payment processing (future - Epic 4)

### 8.2 Internal Dependencies
- **Epic 1 ‚Üí Epic 2**: AI integration depends on core CRM
- **Epic 1 & 2 ‚Üí Epic 3**: Client portal depends on client data structure
- **Epic 3 ‚Üí Epic 4**: Multi-tenant depends on client portal foundation
- **Epic 1-4 ‚Üí Epic 5**: Advanced features depend on core systems

### 8.3 Technical Dependencies
- **Database Schema**: Must be finalized before client portal
- **API Endpoints**: Must be stable before frontend development
- **Authentication**: Must be secure before client portal
- **File Storage**: Must be configured before document management

---

## 9. Risks & Mitigation

### 9.1 Technical Risks

#### Risk: AI Extraction Accuracy
**Probability**: Medium  
**Impact**: High  
**Mitigation**: 
- Use multi-provider strategy (Gemini + OpenAI fallback)
- Continuous accuracy monitoring (currently 91.8%+)
- Agent can always correct AI extractions
- Regular prompt optimization

#### Risk: Database Performance at Scale
**Probability**: Low  
**Impact**: High  
**Mitigation**:
- Use Neon PostgreSQL (cloud, auto-scaling)
- Implement proper indexing
- Query optimization
- Database connection pooling
- Monitor performance metrics

#### Risk: HIPAA Compliance Issues
**Probability**: Medium  
**Impact**: Critical  
**Mitigation**:
- Encryption at rest and in transit
- Audit logging for all PHI access
- Strict access controls
- Regular security audits
- Data isolation (3-database architecture)

### 9.2 Business Risks

#### Risk: User Adoption
**Probability**: Low  
**Impact**: Medium  
**Mitigation**:
- Intuitive interface (no training required)
- Real-time AI assistance (clear value)
- Gradual rollout with feedback
- User training and support

#### Risk: Cost Overruns (AI API Costs)
**Probability**: Medium  
**Impact**: Medium  
**Mitigation**:
- Use Gemini 2.5 Flash (50% cost savings)
- OpenAI fallback only when needed
- Response caching
- Usage monitoring and alerts
- Cost optimization strategies

### 9.3 Timeline Risks

#### Risk: Feature Scope Creep
**Probability**: Medium  
**Impact**: Medium  
**Mitigation**:
- Strict PRD adherence
- Epic prioritization
- Story approval process
- Regular scope reviews

#### Risk: Integration Delays
**Probability**: Low  
**Impact**: Medium  
**Mitigation**:
- Early API testing
- Staged integration approach
- Fallback plans for external services
- Regular integration testing

---

## 10. Technical Decision Log

This section documents key architectural and technical decisions made during development, including rationale, alternatives considered, and related epics. This helps agents understand the "why" behind implementation choices and prevents repeating past mistakes.

### Decision Format

Each decision follows this structure:
- **Decision**: What was decided
- **Context**: Why this decision was needed
- **Alternatives Considered**: Other options evaluated
- **Rationale**: Why this option was chosen
- **Related Epics**: Which epics this decision affects
- **Date**: When decision was made
- **Status**: Active, Deprecated, or Replaced

---

### TD-001: Direct SQL Queries (No ORM)

**Decision**: Use direct Neon SQL queries instead of ORM (Drizzle, Prisma, etc.)

**Context**: Storage layer needs reliable database access without ORM complexity. Initial attempts with Drizzle ORM caused `TypeError` errors when importing schema types.

**Alternatives Considered**:
- Drizzle ORM (caused import errors)
- Prisma (added complexity, migration overhead)
- TypeORM (heavyweight, not needed)

**Rationale**:
- Direct SQL provides better control and performance
- Simpler dependency management
- Neon serverless client works perfectly with template literals
- Easier debugging (can see exact SQL queries)
- No ORM abstraction layer to maintain

**Related Epics**: [[Epic 1: Core CRM Foundation]], [[Epic 2: AI Agent Integration]], [[Epic 7: Calendar Scheduling System]]

**Date**: 2025-01-13  
**Status**: ‚úÖ Active

**Implementation Pattern**:
```typescript
import { neon } from '@neondatabase/serverless';
const sql = neon(process.env.DATABASE_URL!);
const users = await sql`SELECT * FROM users WHERE id = ${id}`;
```

---

### TD-002: Multi-Provider AI Strategy (Gemini Primary, OpenAI Fallback)

**Decision**: Use Google Gemini 2.5 Flash as primary AI provider with OpenAI GPT-4o-mini as fallback.

**Context**: Need reliable AI service with cost optimization and redundancy.

**Alternatives Considered**:
- OpenAI only (higher cost)
- Gemini only (no fallback)
- Anthropic Claude (higher cost, slower)

**Rationale**:
- **Cost Savings**: Gemini 2.5 Flash is ~50% cheaper than OpenAI
- **Performance**: Gemini 2.5 Flash is faster for extraction tasks
- **Reliability**: Fallback ensures service availability
- **Quality**: Both providers achieve 91.8%+ extraction accuracy

**Related Epics**: [[Epic 2: AI Agent Integration]]

**Date**: 2025-01-13  
**Status**: ‚úÖ Active

**Implementation**: `crm/server/src/services/aiService.ts` - Automatic fallback on errors

---

### TD-003: 3-Database Multi-Tenant Architecture

**Decision**: Use 3 separate Neon PostgreSQL databases for multi-tenant architecture.

**Context**: Need HIPAA-compliant data isolation for multi-tenant SaaS platform.

**Alternatives Considered**:
- Single database with tenant_id columns (less secure)
- Row-level security (PostgreSQL RLS - complex)
- Schema-per-tenant (PostgreSQL limitation)

**Rationale**:
- **HIPAA Compliance**: Complete data isolation between tenants
- **Security**: No risk of cross-tenant data leaks
- **Scalability**: Each database can scale independently
- **Simplicity**: Clear separation, easier to reason about

**Related Epics**: [[Epic 4: Multi-Tenant SaaS Platform]]

**Date**: 2025-01-13  
**Status**: ‚è≥ Planned (not yet implemented)

**Database Structure**:
- Database 1: Agencies (tenant metadata)
- Database 2: Multi-tenant clients (shared client data)
- Database 3: Current agency (single-tenant data)

---

### TD-004: Mantine UI for Both CRM and Client Portal

**Decision**: Use Mantine UI library for both CRM (React) and Client Portal (Next.js).

**Context**: Need consistent design system across both applications.

**Alternatives Considered**:
- Material-UI (MUI) - Different design language
- Ant Design - Different component patterns
- Custom components - Too much work
- Different libraries per app - Inconsistent UX

**Rationale**:
- **Consistency**: Same components and styling across both apps
- **Developer Experience**: Familiar API for both teams
- **Maintenance**: Single library to maintain
- **Design System**: Can create shared theme configuration

**Related Epics**: [[Epic 1: Core CRM Foundation]], [[Epic 3: Client Portal]], [[Epic 10: Mantis Design System Upgrade]]

**Date**: 2025-01-13  
**Status**: ‚úÖ Active

**Note**: Epic 10 explores enhancing Mantine to match Mantis design principles, with full Mantis migration as alternative if needed.

---

### TD-005: Next.js for Client Portal (Separate from CRM)

**Decision**: Build client portal as separate Next.js application instead of React SPA.

**Context**: Client portal needs better SEO, server-side rendering, and different deployment requirements.

**Alternatives Considered**:
- React SPA (same as CRM) - Poor SEO, slower initial load
- Same app with route protection - Security concerns, mixed concerns
- Static site generator - Not suitable for authenticated content

**Rationale**:
- **SEO**: Server-side rendering improves search engine visibility
- **Performance**: Faster initial page loads with Next.js
- **Deployment**: Can deploy separately from CRM (different domains)
- **Security**: Complete separation of client-facing and agent-facing apps

**Related Epics**: [[Epic 3: Client Portal]]

**Date**: 2025-01-13  
**Status**: ‚úÖ Active

**Location**: `crm/client-portal/` (separate Next.js app)

---

### TD-006: Design-Inspired Approach for Mantis Design System (Epic 10)

**Decision**: Enhance existing Mantine UI to match Mantis design principles rather than migrating to Material-UI.

**Context**: Want modern Mantis-style UI without full library migration.

**Alternatives Considered**:
- Full Mantis migration (Mantine ‚Üí MUI) - More work, potential breaking changes
- Keep current Mantine - Doesn't achieve desired design
- Hybrid approach - Too complex

**Rationale**:
- **Lower Risk**: Incremental enhancement vs full migration
- **Faster**: Can upgrade page-by-page
- **Backward Compatible**: Existing functionality preserved
- **Flexible**: Can switch to full migration later if needed

**Related Epics**: [[Epic 10: Mantis Design System Upgrade]]

**Date**: 2025-01-15  
**Status**: üöß In Progress

**Note**: If results unsatisfactory, full Mantis migration (Mantine ‚Üí MUI) remains an option.

---

### TD-007: Two-Level Connector Organization Pattern

**Decision**: Organize connectors/integrations into two levels: System-wide (`/connectors`) and app-specific (within app settings).

**Context**: Need clear organization for external service integrations.

**Alternatives Considered**:
- All connectors in one place - Too cluttered
- All connectors in app settings - Hard to find system-level ones
- Separate page per connector type - Too many pages

**Rationale**:
- **Clarity**: Clear distinction between system and app connectors
- **Discoverability**: System connectors easy to find
- **Organization**: App-specific config stays with app
- **Scalability**: Pattern works as more connectors added

**Related Epics**: [[Epic 1: Core CRM Foundation]], All integration epics

**Date**: 2025-01-20  
**Status**: ‚úÖ Active

**Decision Rule**:
- **Connectors Page** (`/connectors`): If connector used by 2+ apps OR infrastructure-level
- **App Integrations**: If connector primarily for one app

**Examples**:
- ‚úÖ Twilio: Both (system status in Connectors, webhooks in Call Manager)
- ‚úÖ SendGrid: Only Connectors (used by multiple apps)
- ‚úÖ Google Ads OAuth: Only Marketing Ads Connection tab

---

### TD-008: Sequential Signing for Medicare SOA (Client First, Agent Second)

**Decision**: Medicare SOA envelopes require client to sign first (signingOrder: 1), then agent signs second (signingOrder: 2).

**Context**: Medicare compliance requires both parties to sign SOA, but order matters for workflow.

**Alternatives Considered**:
- Parallel signing (both at once) - Doesn't match workflow
- Agent first - Client might not understand what they're signing
- Single signature (client only) - Not compliant

**Rationale**:
- **Compliance**: Both parties must sign for Medicare compliance
- **Workflow**: Client engagement first, then agent confirmation
- **Clarity**: Client sees document first, agent confirms after
- **Audit Trail**: Clear sequence in DocuSend system

**Related Epics**: [[Epic 11: Medicare SOA Automation]], [[Epic 12: Docusend E-Signature System]]

**Date**: 2025-01-15  
**Status**: ‚úÖ Active

**Implementation**: `crm/server/src/services/medicareSOAService.ts` - Auto-adds agent as second signer

---

### TD-009: Business Line-Aware Architecture for Autopilot

**Decision**: Make Autopilot Lead Outreach App fully business line-aware with separate settings, scripts, and workflows per business line.

**Context**: Each insurance line (Medicare, Health, Life, Group, Commercial) has different messaging, compliance, and workflows.

**Alternatives Considered**:
- Single workflow for all - Doesn't account for differences
- Business line as optional filter - Not enough separation
- Separate apps per business line - Too much duplication

**Rationale**:
- **Specialization**: Each business line has unique needs
- **Compliance**: Different regulations per line
- **Messaging**: Different scripts and templates needed
- **Workflow**: Different conversion processes
- **Scalability**: Can optimize each line independently

**Related Epics**: [[Epic 13: Autopilot Lead Outreach App]]

**Date**: 2025-12-19  
**Status**: ‚è≥ Planned

**Architecture**: Each business line has separate:
- Script libraries (5-10 templates each)
- AI automation rules
- Campaign settings
- Lead workflows
- Conversion processes

---

### TD-010: Hybrid AI + Scripts Approach for Autopilot

**Decision**: Combine pre-written scripts with AI personalization for Autopilot messaging.

**Context**: Need consistent, compliant messaging at scale with personalization.

**Alternatives Considered**:
- AI-only messaging - Risk of non-compliant language
- Scripts-only - No personalization, less engaging
- Human-only - Doesn't scale

**Rationale**:
- **Compliance**: Scripts ensure TCPA-compliant language
- **Consistency**: Pre-written templates maintain brand voice
- **Personalization**: AI customizes scripts with lead data
- **Scale**: Handles 1000+ leads automatically
- **Control**: You can edit scripts based on performance

**Related Epics**: [[Epic 13: Autopilot Lead Outreach App]], [[Epic 2: AI Agent Integration]]

**Date**: 2025-12-19  
**Status**: ‚è≥ Planned

**Workflow**: AI selects best script ‚Üí Personalizes with lead data ‚Üí Sends or escalates

---

### TD-011: Port Management (3000 Backend, 5000 Frontend)

**Decision**: Use fixed ports for all services: Backend 3000, Frontend 5000.

**Context**: Need consistent ports for development and to avoid conflicts.

**Alternatives Considered**:
- Auto-select ports - Causes confusion when ports change
- Environment-based ports - Too complex
- Random ports - Impossible to document

**Rationale**:
- **Consistency**: Same ports every time
- **Documentation**: Easy to document and remember
- **Integration**: Frontend knows backend URL
- **Troubleshooting**: Easier to debug with fixed ports

**Related Epics**: [[Epic 1: Core CRM Foundation]]

**Date**: 2025-01-13  
**Status**: ‚úÖ Active

**Ports**:
- Backend: 3000
- Frontend: 5000
- Browser Tools MCP: 3025

---

### TD-012: Storage Layer Direct Neon SQL (No ORM Imports)

**Decision**: Storage layer (`storage.ts`) must use direct Neon SQL, never import from `@shared/schema`.

**Context**: ORM imports cause `TypeError` errors and break quotes page access.

**Alternatives Considered**:
- Fix ORM imports - Complex, error-prone
- Use ORM in other files - Inconsistent approach
- Hybrid approach - Confusing

**Rationale**:
- **Reliability**: Direct SQL always works
- **Simplicity**: No ORM abstraction layer
- **Performance**: Direct queries are faster
- **Debugging**: Can see exact SQL

**Related Epics**: [[Epic 1: Core CRM Foundation]]

**Date**: 2025-01-20  
**Status**: ‚úÖ Active

**Critical Rule**: `storage.ts` must NEVER import from `@shared/schema` or use Drizzle ORM functions.

---

## 11. Database Schema Reference

This section provides a comprehensive reference to the CRM database schema, linking tables to epics and documenting relationships. This helps agents understand data structure, find relevant tables for features, and maintain data integrity.

### Schema Overview

**Database**: Neon PostgreSQL (ep-small-thunder-afvxv0vi-pooler)  
**Total Tables**: ~81 tables  
**Primary Database**: CRM System (separate from Marketing DB with 22 tables)  
**See Also**: `.ai/DATABASE_ARCHITECTURE.md` for complete architecture details

### Table Organization by Functional Area

---

### Core CRM Tables

#### Client Management

| Table | Purpose | Key Fields | Related Epics |
|-------|---------|------------|---------------|
| `clients` | Primary client records | `id`, `user_id`, `first_name`, `last_name`, `phone`, `email`, `line_of_business`, `state`, `status` | [[Epic 1: Core CRM Foundation]] |
| `client_enrollments` | Plan enrollment tracking | `id`, `client_id`, `line_of_business`, `carrier_name`, `plan_name`, `effective_date`, `policy_number` | [[Epic 3: Client Portal]] |
| `client_family_members` | Enrolled family members | `id`, `client_id`, `enrollment_id`, `relationship`, `first_name`, `last_name`, `date_of_birth`, `member_id` | [[Epic 3: Client Portal]] |
| `client_documents` | Document storage metadata | `id`, `client_id`, `document_type`, `file_path`, `uploaded_at` | [[Epic 3: Client Portal]], [[Epic 12: Docusend E-Signature System]] |
| `client_health_info` | Health information | `id`, `client_id`, `health_conditions`, `medications` | [[Epic 3: Client Portal]] |
| `client_primary_care_physicians` | PCP assignments | `id`, `client_id`, `physician_name`, `npi`, `facility_name` | [[Epic 3: Client Portal]] |
| `client_broker_assignments` | Broker-client relationships | `id`, `client_id`, `broker_id`, `assigned_at` | [[Epic 3: Client Portal]] |
| `client_response_patterns` | AI learning patterns | `id`, `client_id`, `pattern_type`, `pattern_data` | [[Epic 2: AI Agent Integration]] |
| `client_portal_preferences` | Portal user settings | `id`, `client_id`, `preferences_json` | [[Epic 3: Client Portal]] |
| `client_magic_link_tokens` | Passwordless login tokens | `id`, `client_id`, `token`, `expires_at` | [[Epic 3: Client Portal]] |
| `client_sessions` | Portal session tracking | `id`, `client_id`, `session_token`, `expires_at` | [[Epic 3: Client Portal]] |

**Key Relationships**:
- `clients` ‚Üí `client_enrollments` (1:many)
- `client_enrollments` ‚Üí `client_family_members` (1:many)
- `clients` ‚Üí `client_broker_assignments` ‚Üí `brokers` (many:many)

---

#### User/Agent Management

| Table | Purpose | Key Fields | Related Epics |
|-------|---------|------------|---------------|
| `users` | CRM users/agents | `id`, `email`, `password_hash`, `first_name`, `last_name`, `role` | [[Epic 1: Core CRM Foundation]] |
| `user_ai_preferences` | AI agent settings | `id`, `user_id`, `preferences_json` | [[Epic 2: AI Agent Integration]] |
| `user_contracted_carriers` | Agent carrier contracts | `id`, `user_id`, `carrier_name`, `contract_status` | [[Epic 1: Core CRM Foundation]] |
| `password_reset_tokens` | Password recovery | `id`, `user_id`, `token`, `expires_at` | [[Epic 1: Core CRM Foundation]] |
| `refresh_tokens` | Auth token management | `id`, `user_id`, `token`, `expires_at` | [[Epic 1: Core CRM Foundation]] |

**Key Relationships**:
- `users` ‚Üí `clients` (1:many via `user_id`)
- `users` ‚Üí `appointments` (1:many)

---

#### Appointments & Calendar

| Table | Purpose | Key Fields | Related Epics |
|-------|---------|------------|---------------|
| `appointments` | Appointment records | `id`, `user_id`, `client_id`, `title`, `start_time`, `end_time`, `status`, `meeting_type`, `video_link` | [[Epic 7: Calendar Scheduling System]] |
| `agent_availability` | Recurring schedules | `id`, `user_id`, `day_of_week`, `start_time`, `end_time`, `timezone` | [[Epic 7: Calendar Scheduling System]] |
| `availability_overrides` | Schedule exceptions | `id`, `user_id`, `date`, `override_type`, `start_time`, `end_time` | [[Epic 7: Calendar Scheduling System]] |
| `calendar_sync` | External calendar integration | `id`, `user_id`, `provider`, `sync_token`, `last_sync_at` | [[Epic 7: Calendar Scheduling System]] |

**Key Relationships**:
- `users` ‚Üí `appointments` (1:many)
- `clients` ‚Üí `appointments` (1:many)
- `users` ‚Üí `agent_availability` (1:many)

---

#### Communications

| Table | Purpose | Key Fields | Related Epics |
|-------|---------|------------|---------------|
| `conversations` | Conversation threads | `id`, `client_id`, `user_id`, `call_id`, `title`, `started_at`, `ended_at` | [[Epic 1: Core CRM Foundation]], [[Epic 2: AI Agent Integration]] |
| `conversation_messages` | Message history | `id`, `conversation_id`, `sender`, `message`, `ai_generated`, `timestamp` | [[Epic 1: Core CRM Foundation]], [[Epic 2: AI Agent Integration]] |
| `conversation_embeddings` | AI embeddings for search | `id`, `conversation_id`, `embedding_vector` | [[Epic 2: AI Agent Integration]] |
| `conversation_outcomes` | Conversation results | `id`, `conversation_id`, `outcome_type`, `outcome_data` | [[Epic 2: AI Agent Integration]] |
| `conversation_patterns` | AI learning patterns | `id`, `pattern_type`, `pattern_data` | [[Epic 2: AI Agent Integration]] |
| `calls` | Call records | `id`, `client_id`, `user_id`, `phone_number`, `direction`, `duration`, `status`, `recording_url` | [[Epic 1: Core CRM Foundation]] |
| `call_availability` | Call scheduling | `id`, `user_id`, `available_hours` | [[Epic 1: Core CRM Foundation]] |
| `voicemails` | Voicemail storage | `id`, `client_id`, `user_id`, `phone_number`, `business_line`, `transcription`, `audio_url`, `duration` | [[Epic 1: Core CRM Foundation]] |
| `voicemail_greetings` | Greeting audio files | `id`, `user_id`, `business_line`, `audio_url` | [[Epic 1: Core CRM Foundation]] |
| `twilio_phone_numbers` | Phone number inventory | `id`, `phone_number`, `user_id`, `business_line`, `status` | [[Epic 1: Core CRM Foundation]] |

**Key Relationships**:
- `clients` ‚Üí `conversations` (1:many)
- `conversations` ‚Üí `conversation_messages` (1:many)
- `calls` ‚Üí `conversations` (1:1 via `call_id`)
- `clients` ‚Üí `voicemails` (1:many)

---

#### Financial

| Table | Purpose | Key Fields | Related Epics |
|-------|---------|------------|---------------|
| `commissions` | Commission tracking | `id`, `user_id`, `client_id`, `line_of_business`, `amount`, `commission_date`, `status`, `policy_number` | [[Epic 1: Core CRM Foundation]] |
| `commission_rates` | Commission rules | `id`, `user_id`, `line_of_business`, `carrier_name`, `rate_percentage` | [[Epic 1: Core CRM Foundation]] |

**Key Relationships**:
- `users` ‚Üí `commissions` (1:many)
- `clients` ‚Üí `commissions` (1:many)

---

### Client Portal Tables

| Table | Purpose | Key Fields | Related Epics |
|-------|---------|------------|---------------|
| `brokers` | Broker directory | `id`, `name`, `email`, `phone`, `license_number` | [[Epic 3: Client Portal]] |
| `client_portal_preferences` | Portal settings | `id`, `client_id`, `preferences_json` | [[Epic 3: Client Portal]] |
| `client_magic_link_tokens` | Passwordless auth | `id`, `client_id`, `token`, `expires_at` | [[Epic 3: Client Portal]] |
| `client_sessions` | Portal sessions | `id`, `client_id`, `session_token`, `expires_at` | [[Epic 3: Client Portal]] |

---

### Calendar & Booking System Tables

| Table | Purpose | Key Fields | Related Epics |
|-------|---------|------------|---------------|
| `booking_pages` | CRM booking pages | `id`, `user_id`, `name`, `slug`, `business_line`, `timezone` | [[Epic 7: Calendar Scheduling System]] |
| `booking_page_event_types` | Page event types | `id`, `booking_page_id`, `event_type_id` | [[Epic 7: Calendar Scheduling System]] |
| `booking_page_questions` | Custom questions | `id`, `booking_page_id`, `question_text`, `question_type` | [[Epic 7: Calendar Scheduling System]] |
| `master_pages` | Page templates | `id`, `user_id`, `name`, `template_data` | [[Epic 7: Calendar Scheduling System]] |
| `master_page_event_types` | Template events | `id`, `master_page_id`, `event_type_id` | [[Epic 7: Calendar Scheduling System]] |
| `event_types` | Event definitions | `id`, `user_id`, `name`, `duration_minutes`, `business_line` | [[Epic 7: Calendar Scheduling System]] |
| `event_type_users` | User assignments | `id`, `event_type_id`, `user_id` | [[Epic 7: Calendar Scheduling System]] |

**Key Relationships**:
- `booking_pages` ‚Üí `booking_page_event_types` ‚Üí `event_types` (many:many)
- `event_types` ‚Üí `event_type_users` ‚Üí `users` (many:many)

---

### Docusend E-Signature Tables

| Table | Purpose | Key Fields | Related Epics |
|-------|---------|------------|---------------|
| `docusend_documents` | Document storage | `id`, `client_id`, `user_id`, `document_type`, `file_path`, `docusend_document_id` | [[Epic 12: Docusend E-Signature System]] |
| `docusend_envelopes` | Signature envelopes | `id`, `document_id`, `client_id`, `envelope_id`, `status`, `signing_order` | [[Epic 11: Medicare SOA Automation]], [[Epic 12: Docusend E-Signature System]] |
| `docusend_signers` | Signer information | `id`, `envelope_id`, `signer_type`, `signer_order`, `email`, `name`, `signed_at` | [[Epic 11: Medicare SOA Automation]], [[Epic 12: Docusend E-Signature System]] |
| `docusend_signature_fields` | Form fields | `id`, `envelope_id`, `field_type`, `field_name`, `field_value` | [[Epic 12: Docusend E-Signature System]] |
| `docusend_signed_documents` | Completed documents | `id`, `envelope_id`, `signed_pdf_url`, `signed_at` | [[Epic 12: Docusend E-Signature System]] |
| `docusend_templates` | Document templates | `id`, `user_id`, `template_name`, `template_data` | [[Epic 12: Docusend E-Signature System]] |

**Key Relationships**:
- `docusend_documents` ‚Üí `docusend_envelopes` (1:many)
- `docusend_envelopes` ‚Üí `docusend_signers` (1:many)
- `docusend_envelopes` ‚Üí `docusend_signature_fields` (1:many)

**Note**: Medicare SOA requires sequential signing (client first, agent second) - see [[TD-008]].

---

### Autopilot Lead Outreach Tables

| Table | Purpose | Key Fields | Related Epics |
|-------|---------|------------|---------------|
| `autopilot_campaigns` | Campaign management | `id`, `user_id`, `business_line`, `campaign_name`, `status` | [[Epic 13: Autopilot Lead Outreach App]] |
| `autopilot_scripts` | Script library | `id`, `user_id`, `business_line`, `script_name`, `script_content` | [[Epic 13: Autopilot Lead Outreach App]] |
| `autopilot_leads` | Lead tracking | `id`, `campaign_id`, `client_id`, `phone_number`, `status`, `last_contacted_at` | [[Epic 13: Autopilot Lead Outreach App]] |
| `autopilot_messages` | Message history | `id`, `lead_id`, `message_type`, `message_content`, `sent_at` | [[Epic 13: Autopilot Lead Outreach App]] |
| `autopilot_sms_templates` | SMS templates | `id`, `user_id`, `business_line`, `template_name`, `template_content` | [[Epic 13: Autopilot Lead Outreach App]] |

**Key Relationships**:
- `autopilot_campaigns` ‚Üí `autopilot_leads` (1:many)
- `autopilot_leads` ‚Üí `autopilot_messages` (1:many)
- `autopilot_leads` ‚Üí `clients` (many:1)

**Note**: Fully business line-aware - see [[TD-009]] and [[TD-010]].

---

### Marketing Ads Integration Tables

| Table | Purpose | Key Fields | Related Epics |
|-------|---------|------------|---------------|
| `google_ads_accounts` | Google Ads accounts | `id`, `user_id`, `account_id`, `account_name`, `oauth_token` | [[Epic 16: Google Ads Integration]] |
| `linkedin_accounts` | LinkedIn accounts | `id`, `user_id`, `account_id`, `account_name`, `oauth_token` | [[Epic 17: LinkedIn Ads Integration]] |
| `facebook_ads_accounts` | Facebook Ads accounts | `id`, `user_id`, `account_id`, `account_name`, `oauth_token` | [[Epic 18: Facebook Ads Integration]] |
| `tiktok_ads_accounts` | TikTok Ads accounts | `id`, `user_id`, `account_id`, `account_name`, `oauth_token` | [[Epic 19: TikTok Ads Integration]] |
| `twitter_ads_accounts` | Twitter Ads accounts | `id`, `user_id`, `account_id`, `account_name`, `oauth_token` | [[Epic 20: Twitter Ads Integration]] |
| `reddit_ads_accounts` | Reddit Ads accounts | `id`, `user_id`, `account_id`, `account_name`, `oauth_token` | [[Epic 20: Reddit Ads Integration]] |
| `pinterest_ads_accounts` | Pinterest Ads accounts | `id`, `user_id`, `account_id`, `account_name`, `oauth_token` | [[Epic 21: Pinterest Ads Integration]] |
| `bing_ads_accounts` | Bing Ads accounts | `id`, `user_id`, `account_id`, `account_name`, `oauth_token` | [[Epic 22: Bing Ads Integration]] |

**Key Relationships**:
- `users` ‚Üí `*_ads_accounts` (1:many for each platform)

**Note**: All ads integrations follow OAuth 2.0 pattern - see [[TD-007]] for connector organization.

---

### Health/Insurance Data Tables

| Table | Purpose | Key Fields | Related Epics |
|-------|---------|------------|---------------|
| `health_plans` | Health plan catalog | `id`, `carrier_name`, `plan_name`, `plan_type`, `metal_tier`, `state`, `zip_code` | [[Epic 8: Georgia Health Insurance Data Collection]] |
| `health_carriers` | Carrier information | `id`, `carrier_name`, `state`, `contact_info` | [[Epic 8: Georgia Health Insurance Data Collection]] |
| `health_facilities` | Provider directory | `id`, `facility_name`, `npi`, `address`, `specialties` | [[Epic 8: Georgia Health Insurance Data Collection]] |
| `medicare_plans` | Medicare plan catalog | `id`, `carrier_name`, `plan_name`, `plan_type`, `county`, `zip_code` | [[Epic 1: Core CRM Foundation]] |
| `medicare_carriers` | Medicare carrier info | `id`, `carrier_name`, `contact_info` | [[Epic 1: Core CRM Foundation]] |
| `medicare_providers` | Provider directory | `id`, `provider_name`, `npi`, `address`, `specialties` | [[Epic 1: Core CRM Foundation]] |
| `drug_formularies` | Drug coverage data | `id`, `plan_id`, `formulary_name` | [[Epic 1: Core CRM Foundation]] |
| `formulary_drugs` | Drug details | `id`, `formulary_id`, `drug_name`, `tier`, `coverage_status` | [[Epic 1: Core CRM Foundation]] |
| `plan_documents` | Plan materials | `id`, `plan_id`, `document_type`, `file_path` | [[Epic 1: Core CRM Foundation]] |
| `plan_recommendations` | AI recommendations | `id`, `client_id`, `plan_id`, `recommendation_score` | [[Epic 2: AI Agent Integration]] |
| `zip_code_mappings` | Geographic data | `id`, `zip_code`, `county`, `state`, `fips_code` | [[Epic 8: Georgia Health Insurance Data Collection]] |

**Key Relationships**:
- `health_plans` ‚Üí `health_carriers` (many:1)
- `health_plans` ‚Üí `plan_documents` (1:many)
- `drug_formularies` ‚Üí `formulary_drugs` (1:many)

---

### System & Configuration Tables

| Table | Purpose | Key Fields | Related Epics |
|-------|---------|------------|---------------|
| `api_keys` | API authentication | `id`, `key_name`, `key_value`, `service_name` | [[Epic 1: Core CRM Foundation]] |
| `portal_config` | CRM configuration | `id`, `config_key`, `config_value` | [[Epic 1: Core CRM Foundation]] |
| `portal_ads` | Portal advertising | `id`, `ad_type`, `ad_content`, `display_location` | [[Epic 1: Core CRM Foundation]] |
| `audit_logs` | Security audit trail | `id`, `user_id`, `action`, `resource_type`, `resource_id`, `timestamp` | [[Epic 1: Core CRM Foundation]] |
| `notifications` | User notifications | `id`, `user_id`, `client_id`, `notification_type`, `message`, `read_at` | [[Epic 1: Core CRM Foundation]] |
| `marketing_campaigns` | CRM campaigns | `id`, `user_id`, `campaign_name`, `status` | [[Epic 1: Core CRM Foundation]] |
| `marketing_settings` | Campaign config | `id`, `user_id`, `settings_json` | [[Epic 1: Core CRM Foundation]] |
| `cms_regulations` | Compliance rules | `id`, `regulation_type`, `regulation_data` | [[Epic 1: Core CRM Foundation]] |
| `cms_rules` | Business rules | `id`, `rule_type`, `rule_data` | [[Epic 1: Core CRM Foundation]] |

---

### AI & Learning Tables

| Table | Purpose | Key Fields | Related Epics |
|-------|---------|------------|---------------|
| `knowledge_detection_patterns` | AI patterns | `id`, `pattern_type`, `pattern_data`, `confidence_score` | [[Epic 2: AI Agent Integration]] |
| `knowledge_detection_pattern_history` | Pattern history | `id`, `pattern_id`, `detected_at`, `context` | [[Epic 2: AI Agent Integration]] |
| `knowledge_source_feedback` | Feedback tracking | `id`, `source_id`, `feedback_type`, `feedback_data` | [[Epic 2: AI Agent Integration]] |
| `ai_suggestions` | AI recommendations | `id`, `client_id`, `suggestion_type`, `suggestion_data` | [[Epic 2: AI Agent Integration]] |
| `ai_suggestion_feedback` | Feedback on suggestions | `id`, `suggestion_id`, `feedback_type`, `feedback_data` | [[Epic 2: AI Agent Integration]] |
| `ai_performance_metrics` | AI metrics | `id`, `metric_type`, `metric_value`, `recorded_at` | [[Epic 2: AI Agent Integration]] |

---

### Analytics & Tracking Tables

| Table | Purpose | Key Fields | Related Epics |
|-------|---------|------------|---------------|
| `ad_clicks` | Ad click tracking | `id`, `ad_id`, `clicked_at`, `user_agent` | [[Epic 16: Google Ads Integration]] - [[Epic 22: Bing Ads Integration]] |
| `ad_impressions` | Ad impression tracking | `id`, `ad_id`, `impressed_at` | [[Epic 16: Google Ads Integration]] - [[Epic 22: Bing Ads Integration]] |
| `mail_logs` | Email logs | `id`, `recipient_email`, `subject`, `sent_at`, `status` | [[Epic 1: Core CRM Foundation]] |
| `data_update_logs` | Data update tracking | `id`, `table_name`, `update_type`, `updated_at` | [[Epic 8: Georgia Health Insurance Data Collection]] |

---

### Key Relationships Summary

**Primary Relationships**:
- `users` ‚Üí `clients` (agents manage clients)
- `clients` ‚Üí `conversations` ‚Üí `conversation_messages` (communication flow)
- `clients` ‚Üí `appointments` (scheduling)
- `clients` ‚Üí `client_enrollments` ‚Üí `client_family_members` (enrollment tracking)
- `clients` ‚Üí `docusend_envelopes` ‚Üí `docusend_signers` (e-signature flow)
- `users` ‚Üí `*_ads_accounts` (marketing integrations)

**Business Line Awareness**:
- `clients.line_of_business` - Primary business line classification
- `voicemails.business_line` - Voicemail categorization
- `booking_pages.business_line` - Booking page filtering
- `autopilot_campaigns.business_line` - Campaign targeting
- `event_types.business_line` - Event type filtering

**Multi-Tenant Architecture** (Planned - [[TD-003]]):
- Database 1: Agencies (tenant metadata)
- Database 2: Multi-tenant clients (shared data)
- Database 3: Current agency (single-tenant data)

---

### Quick Reference by Epic

**[[Epic 1: Core CRM Foundation]]**:
- `users`, `clients`, `conversations`, `conversation_messages`, `calls`, `voicemails`, `commissions`, `api_keys`, `notifications`

**[[Epic 2: AI Agent Integration]]**:
- `conversation_embeddings`, `conversation_outcomes`, `conversation_patterns`, `ai_suggestions`, `knowledge_detection_patterns`, `user_ai_preferences`

**[[Epic 3: Client Portal]]**:
- `client_enrollments`, `client_family_members`, `client_documents`, `client_health_info`, `client_primary_care_physicians`, `client_portal_preferences`, `client_magic_link_tokens`, `brokers`, `client_broker_assignments`

**[[Epic 7: Calendar Scheduling System]]**:
- `appointments`, `agent_availability`, `availability_overrides`, `calendar_sync`, `booking_pages`, `event_types`, `booking_page_event_types`

**[[Epic 8: Georgia Health Insurance Data Collection]]**:
- `health_plans`, `health_carriers`, `health_facilities`, `zip_code_mappings`, `data_update_logs`

**[[Epic 11: Medicare SOA Automation]]**:
- `docusend_envelopes`, `docusend_signers` (sequential signing pattern)

**[[Epic 12: Docusend E-Signature System]]**:
- `docusend_documents`, `docusend_envelopes`, `docusend_signers`, `docusend_signature_fields`, `docusend_signed_documents`, `docusend_templates`

**[[Epic 13: Autopilot Lead Outreach App]]**:
- `autopilot_campaigns`, `autopilot_scripts`, `autopilot_leads`, `autopilot_messages`, `autopilot_sms_templates`

**[[Epic 16: Google Ads Integration]]** - **[[Epic 22: Bing Ads Integration]]**:
- `google_ads_accounts`, `linkedin_accounts`, `facebook_ads_accounts`, `tiktok_ads_accounts`, `twitter_ads_accounts`, `reddit_ads_accounts`, `pinterest_ads_accounts`, `bing_ads_accounts`, `ad_clicks`, `ad_impressions`

**[[Epic 23: Lob Direct Mail System]]**:
- `direct_mail_campaigns`, `direct_mail_mailings`, `direct_mail_templates`, `direct_mail_settings`

---

### Database Verification

**Before making schema changes, always verify**:
1. Which database you're connected to (Marketing: ~22 tables, CRM: ~81 tables)
2. Table ownership (see `.ai/DATABASE_ARCHITECTURE.md`)
3. Related epics and dependencies
4. No other agent is using the table

**See**: `.ai/DATABASE_ARCHITECTURE.md` for complete database separation details and verification commands.

---

## 12. API Endpoint Index

This section provides a comprehensive index of all API endpoints, organized by functional area, with authentication requirements, HTTP methods, and epic links. This helps agents understand the API structure, find endpoints for features, and maintain API consistency.

### API Overview

**Base URL**: `/api`  
**Authentication**: Most endpoints require JWT authentication via `authenticate` middleware  
**CSRF Protection**: State-changing routes (POST, PUT, DELETE, PATCH) require CSRF tokens  
**Rate Limiting**: Applied to most endpoints (varies by route)  
**API Key Auth**: Some public/booking endpoints use API key authentication

### Endpoint Organization

---

### Authentication & Authorization

| Method | Endpoint | Auth | Description | Related Epics |
|--------|----------|------|-------------|---------------|
| `POST` | `/api/auth/register` | None | User registration | [[Epic 1: Core CRM Foundation]] |
| `POST` | `/api/auth/login` | None | User login (password) | [[Epic 1: Core CRM Foundation]] |
| `POST` | `/api/auth/login/password` | None | Password-based login | [[Epic 1: Core CRM Foundation]] |
| `POST` | `/api/auth/logout` | JWT | User logout | [[Epic 1: Core CRM Foundation]] |
| `POST` | `/api/auth/refresh` | JWT | Refresh access token | [[Epic 1: Core CRM Foundation]] |
| `POST` | `/api/auth/forgot-password` | None | Request password reset | [[Epic 1: Core CRM Foundation]] |
| `POST` | `/api/auth/reset-password` | None | Reset password with token | [[Epic 1: Core CRM Foundation]] |
| `GET` | `/api/auth/verify-2fa` | JWT | Verify 2FA setup | [[Epic 1: Core CRM Foundation]] |
| `POST` | `/api/auth/setup-2fa` | JWT | Setup 2FA | [[Epic 1: Core CRM Foundation]] |
| `POST` | `/api/auth/verify-2fa-code` | JWT | Verify 2FA code | [[Epic 1: Core CRM Foundation]] |
| `GET` | `/api/auth/me` | JWT | Get current user info | [[Epic 1: Core CRM Foundation]] |
| `GET` | `/api/csrf-token` | None | Get CSRF token | [[Epic 1: Core CRM Foundation]] |

---

### Client Management

| Method | Endpoint | Auth | Description | Related Epics |
|--------|----------|------|-------------|---------------|
| `GET` | `/api/clients` | JWT | List all clients (with filters) | [[Epic 1: Core CRM Foundation]] |
| `GET` | `/api/clients/:id` | JWT | Get client by ID | [[Epic 1: Core CRM Foundation]] |
| `POST` | `/api/clients` | JWT | Create new client | [[Epic 1: Core CRM Foundation]] |
| `PUT` | `/api/clients/:id` | JWT | Update client | [[Epic 1: Core CRM Foundation]] |
| `DELETE` | `/api/clients/:id` | JWT | Delete client | [[Epic 1: Core CRM Foundation]] |
| `GET` | `/api/clients/:id/commissions` | JWT | Get client commissions | [[Epic 1: Core CRM Foundation]] |
| `POST` | `/api/clients/check-duplicate` | JWT | Check for duplicate clients | [[Epic 1: Core CRM Foundation]] |
| `GET` | `/api/clients/:id/documents` | JWT | Get client documents | [[Epic 3: Client Portal]] |
| `POST` | `/api/clients/:id/documents` | JWT | Upload client document | [[Epic 3: Client Portal]] |
| `DELETE` | `/api/clients/:id/documents/:docId` | JWT | Delete client document | [[Epic 3: Client Portal]] |

**Query Parameters**:
- `line_of_business` - Filter by business line
- `status` - Filter by status (active, inactive, pending-soa)
- `page` - Pagination page number
- `limit` - Results per page
- `search` - Search by name, phone, email

---

### Conversations & AI

| Method | Endpoint | Auth | Description | Related Epics |
|--------|----------|------|-------------|---------------|
| `POST` | `/api/conversations/clients/:clientId` | JWT | Get or create conversation | [[Epic 1: Core CRM Foundation]] |
| `GET` | `/api/conversations/clients/:clientId` | JWT | Get all conversations for client | [[Epic 1: Core CRM Foundation]] |
| `GET` | `/api/conversations/:id` | JWT | Get conversation by ID | [[Epic 1: Core CRM Foundation]] |
| `POST` | `/api/conversations/:id/messages` | JWT | Send message in conversation | [[Epic 1: Core CRM Foundation]], [[Epic 2: AI Agent Integration]] |
| `GET` | `/api/conversations/:id/messages` | JWT | Get conversation messages | [[Epic 1: Core CRM Foundation]] |
| `POST` | `/api/conversations/:id/end` | JWT | End conversation | [[Epic 1: Core CRM Foundation]] |
| `POST` | `/api/ai/generate-message` | JWT | Generate AI message | [[Epic 2: AI Agent Integration]] |
| `POST` | `/api/ai/extract-client-info` | JWT | Extract client info from text | [[Epic 2: AI Agent Integration]] |
| `POST` | `/api/ai/feedback` | JWT | Submit AI feedback | [[Epic 2: AI Agent Integration]] |
| `POST` | `/api/ai/outcomes` | JWT | Record conversation outcome | [[Epic 2: AI Agent Integration]] |
| `GET` | `/api/ai/performance` | JWT | Get AI performance metrics | [[Epic 2: AI Agent Integration]] |

---

### Calendar & Scheduling

| Method | Endpoint | Auth | Description | Related Epics |
|--------|----------|------|-------------|---------------|
| `GET` | `/api/calendar/appointments` | JWT | List appointments | [[Epic 7: Calendar Scheduling System]] |
| `POST` | `/api/calendar/appointments` | JWT | Create appointment | [[Epic 7: Calendar Scheduling System]] |
| `PUT` | `/api/calendar/appointments/:id` | JWT | Update appointment | [[Epic 7: Calendar Scheduling System]] |
| `DELETE` | `/api/calendar/appointments/:id` | JWT | Delete appointment | [[Epic 7: Calendar Scheduling System]] |
| `GET` | `/api/calendar/availability` | JWT | Get agent availability | [[Epic 7: Calendar Scheduling System]] |
| `POST` | `/api/calendar/availability` | JWT | Set availability | [[Epic 7: Calendar Scheduling System]] |
| `PUT` | `/api/calendar/availability/:id` | JWT | Update availability | [[Epic 7: Calendar Scheduling System]] |
| `DELETE` | `/api/calendar/availability/:id` | JWT | Delete availability | [[Epic 7: Calendar Scheduling System]] |
| `GET` | `/api/calendar/availability/overrides` | JWT | Get availability overrides | [[Epic 7: Calendar Scheduling System]] |
| `POST` | `/api/calendar/availability/overrides` | JWT | Create availability override | [[Epic 7: Calendar Scheduling System]] |
| `GET` | `/api/calendar/sync/google/callback` | None | Google OAuth callback | [[Epic 7: Calendar Scheduling System]] |
| `GET` | `/api/calendar/sync/outlook/callback` | None | Outlook OAuth callback | [[Epic 7: Calendar Scheduling System]] |
| `POST` | `/api/calendar/sync/google/disconnect` | JWT | Disconnect Google Calendar | [[Epic 7: Calendar Scheduling System]] |
| `POST` | `/api/calendar/sync/outlook/disconnect` | JWT | Disconnect Outlook Calendar | [[Epic 7: Calendar Scheduling System]] |
| `POST` | `/api/calendar/sync/google/sync` | JWT | Sync to Google Calendar | [[Epic 7: Calendar Scheduling System]] |
| `POST` | `/api/calendar/sync/outlook/sync` | JWT | Sync to Outlook Calendar | [[Epic 7: Calendar Scheduling System]] |
| `GET` | `/api/calendar/api-keys` | JWT | List calendar API keys | [[Epic 7: Calendar Scheduling System]] |
| `POST` | `/api/calendar/api-keys` | JWT | Create calendar API key | [[Epic 7: Calendar Scheduling System]] |
| `DELETE` | `/api/calendar/api-keys/:id` | JWT | Delete calendar API key | [[Epic 7: Calendar Scheduling System]] |

**Public Booking Endpoints** (API Key Auth):
| Method | Endpoint | Auth | Description | Related Epics |
|--------|----------|------|-------------|---------------|
| `GET` | `/api/booking/:slug` | API Key | Get booking page | [[Epic 7: Calendar Scheduling System]] |
| `POST` | `/api/booking/:slug/book` | API Key | Create booking | [[Epic 7: Calendar Scheduling System]] |
| `GET` | `/api/calendar/events/:apiKey` | API Key | Get calendar events (sync) | [[Epic 7: Calendar Scheduling System]] |
| `POST` | `/api/calendar/events/:apiKey` | API Key | Create calendar event (sync) | [[Epic 7: Calendar Scheduling System]] |
| `PUT` | `/api/calendar/events/:apiKey/:eventId` | API Key | Update calendar event (sync) | [[Epic 7: Calendar Scheduling System]] |
| `DELETE` | `/api/calendar/events/:apiKey/:eventId` | API Key | Delete calendar event (sync) | [[Epic 7: Calendar Scheduling System]] |

---

### Booking Pages & Event Types

| Method | Endpoint | Auth | Description | Related Epics |
|--------|----------|------|-------------|---------------|
| `GET` | `/api/booking-pages` | JWT | List booking pages | [[Epic 7: Calendar Scheduling System]] |
| `POST` | `/api/booking-pages` | JWT | Create booking page | [[Epic 7: Calendar Scheduling System]] |
| `GET` | `/api/booking-pages/:id` | JWT | Get booking page | [[Epic 7: Calendar Scheduling System]] |
| `PUT` | `/api/booking-pages/:id` | JWT | Update booking page | [[Epic 7: Calendar Scheduling System]] |
| `DELETE` | `/api/booking-pages/:id` | JWT | Delete booking page | [[Epic 7: Calendar Scheduling System]] |
| `GET` | `/api/event-types` | JWT | List event types | [[Epic 7: Calendar Scheduling System]] |
| `POST` | `/api/event-types` | JWT | Create event type | [[Epic 7: Calendar Scheduling System]] |
| `PUT` | `/api/event-types/:id` | JWT | Update event type | [[Epic 7: Calendar Scheduling System]] |
| `DELETE` | `/api/event-types/:id` | JWT | Delete event type | [[Epic 7: Calendar Scheduling System]] |

---

### Calls & Voicemail

| Method | Endpoint | Auth | Description | Related Epics |
|--------|----------|------|-------------|---------------|
| `GET` | `/api/calls/token` | JWT | Get Twilio access token | [[Epic 1: Core CRM Foundation]] |
| `POST` | `/api/calls/test-webhook` | None | Test webhook endpoint | [[Epic 1: Core CRM Foundation]] |
| `POST` | `/api/calls/incoming` | None | Twilio incoming call webhook | [[Epic 1: Core CRM Foundation]] |
| `POST` | `/api/calls/status` | None | Twilio call status webhook | [[Epic 1: Core CRM Foundation]] |
| `GET` | `/api/calls` | JWT | List calls | [[Epic 1: Core CRM Foundation]] |
| `GET` | `/api/calls/:id` | JWT | Get call by ID | [[Epic 1: Core CRM Foundation]] |
| `GET` | `/api/voicemail-audio/:id` | JWT | Get voicemail audio URL | [[Epic 1: Core CRM Foundation]] |
| `POST` | `/api/calls/voicemail/transcription` | None | Twilio voicemail transcription webhook | [[Epic 1: Core CRM Foundation]] |

---

### Client Portal

| Method | Endpoint | Auth | Description | Related Epics |
|--------|----------|------|-------------|---------------|
| `POST` | `/api/client-auth/magic-link` | None | Request magic link | [[Epic 3: Client Portal]] |
| `GET` | `/api/client-auth/verify/:token` | None | Verify magic link token | [[Epic 3: Client Portal]] |
| `POST` | `/api/client-auth/logout` | Client Session | Client logout | [[Epic 3: Client Portal]] |
| `GET` | `/api/client-portal/me` | Client Session | Get client profile | [[Epic 3: Client Portal]] |
| `GET` | `/api/client-portal/enrollments` | Client Session | Get client enrollments | [[Epic 3: Client Portal]] |
| `GET` | `/api/client-portal/family-members` | Client Session | Get family members | [[Epic 3: Client Portal]] |
| `GET` | `/api/client-portal/documents` | Client Session | Get client documents | [[Epic 3: Client Portal]] |
| `GET` | `/api/client-portal/health-info` | Client Session | Get health information | [[Epic 3: Client Portal]] |
| `PUT` | `/api/client-portal/health-info` | Client Session | Update health information | [[Epic 3: Client Portal]] |
| `GET` | `/api/client-portal/primary-care-physician` | Client Session | Get PCP | [[Epic 3: Client Portal]] |
| `PUT` | `/api/client-portal/primary-care-physician` | Client Session | Update PCP | [[Epic 3: Client Portal]] |
| `GET` | `/api/client-portal/broker` | Client Session | Get assigned broker | [[Epic 3: Client Portal]] |
| `GET` | `/api/health-info` | JWT | Get client health info (agent view) | [[Epic 3: Client Portal]] |
| `PUT` | `/api/health-info` | JWT | Update client health info (agent view) | [[Epic 3: Client Portal]] |

---

### Docusend E-Signature

| Method | Endpoint | Auth | Description | Related Epics |
|--------|----------|------|-------------|---------------|
| `GET` | `/api/docusend/documents` | JWT | List documents | [[Epic 12: Docusend E-Signature System]] |
| `POST` | `/api/docusend/documents` | JWT | Upload document | [[Epic 12: Docusend E-Signature System]] |
| `GET` | `/api/docusend/documents/:id` | JWT | Get document | [[Epic 12: Docusend E-Signature System]] |
| `DELETE` | `/api/docusend/documents/:id` | JWT | Delete document | [[Epic 12: Docusend E-Signature System]] |
| `POST` | `/api/docusend/envelopes` | JWT | Create envelope | [[Epic 11: Medicare SOA Automation]], [[Epic 12: Docusend E-Signature System]] |
| `GET` | `/api/docusend/envelopes` | JWT | List envelopes | [[Epic 12: Docusend E-Signature System]] |
| `GET` | `/api/docusend/envelopes/:id` | JWT | Get envelope | [[Epic 12: Docusend E-Signature System]] |
| `PUT` | `/api/docusend/envelopes/:id` | JWT | Update envelope | [[Epic 12: Docusend E-Signature System]] |
| `POST` | `/api/docusend/envelopes/:id/signers` | JWT | Add signer to envelope | [[Epic 12: Docusend E-Signature System]] |
| `POST` | `/api/docusend/envelopes/:id/signature-fields` | JWT | Add signature field | [[Epic 12: Docusend E-Signature System]] |
| `POST` | `/api/docusend/envelopes/:id/send` | JWT | Send envelope | [[Epic 11: Medicare SOA Automation]], [[Epic 12: Docusend E-Signature System]] |
| `POST` | `/api/docusend/envelopes/:id/resend` | JWT | Resend envelope | [[Epic 12: Docusend E-Signature System]] |
| `POST` | `/api/docusend/envelopes/:id/cancel` | JWT | Cancel envelope | [[Epic 12: Docusend E-Signature System]] |
| `GET` | `/api/docusend/signers/:token` | None | Get signer by token (public) | [[Epic 12: Docusend E-Signature System]] |
| `POST` | `/api/docusend/signers/:token/sign` | None | Submit signature (public) | [[Epic 12: Docusend E-Signature System]] |
| `GET` | `/api/docusend/templates` | JWT | List templates | [[Epic 12: Docusend E-Signature System]] |
| `POST` | `/api/docusend/templates` | JWT | Create template | [[Epic 12: Docusend E-Signature System]] |
| `GET` | `/api/docusend/settings` | JWT | Get Docusend settings | [[Epic 12: Docusend E-Signature System]] |
| `PUT` | `/api/docusend/settings` | JWT | Update Docusend settings | [[Epic 12: Docusend E-Signature System]] |

---

### Marketing Ads Integration

| Method | Endpoint | Auth | Description | Related Epics |
|--------|----------|------|-------------|---------------|
| `GET` | `/api/marketing/google-ads/accounts` | JWT | List Google Ads accounts | [[Epic 16: Google Ads Integration]] |
| `POST` | `/api/marketing/google-ads/connect` | JWT | Connect Google Ads account | [[Epic 16: Google Ads Integration]] |
| `GET` | `/api/marketing/google-ads/campaigns` | JWT | List campaigns | [[Epic 16: Google Ads Integration]] |
| `GET` | `/api/marketing/linkedin/accounts` | JWT | List LinkedIn accounts | [[Epic 17: LinkedIn Ads Integration]] |
| `POST` | `/api/marketing/linkedin/connect` | JWT | Connect LinkedIn account | [[Epic 17: LinkedIn Ads Integration]] |
| `GET` | `/api/marketing/linkedin/campaigns` | JWT | List campaigns | [[Epic 17: LinkedIn Ads Integration]] |
| `GET` | `/api/marketing/facebook/accounts` | JWT | List Facebook accounts | [[Epic 18: Facebook Ads Integration]] |
| `POST` | `/api/marketing/facebook/connect` | JWT | Connect Facebook account | [[Epic 18: Facebook Ads Integration]] |
| `GET` | `/api/marketing/tiktok/accounts` | JWT | List TikTok accounts | [[Epic 19: TikTok Ads Integration]] |
| `POST` | `/api/marketing/tiktok/connect` | JWT | Connect TikTok account | [[Epic 19: TikTok Ads Integration]] |
| `GET` | `/api/marketing/twitter/accounts` | JWT | List Twitter accounts | [[Epic 20: Twitter Ads Integration]] |
| `POST` | `/api/marketing/twitter/connect` | JWT | Connect Twitter account | [[Epic 20: Twitter Ads Integration]] |
| `GET` | `/api/marketing/reddit/accounts` | JWT | List Reddit accounts | [[Epic 20: Reddit Ads Integration]] |
| `POST` | `/api/marketing/reddit/connect` | JWT | Connect Reddit account | [[Epic 20: Reddit Ads Integration]] |
| `GET` | `/api/marketing/pinterest/accounts` | JWT | List Pinterest accounts | [[Epic 21: Pinterest Ads Integration]] |
| `POST` | `/api/marketing/pinterest/connect` | JWT | Connect Pinterest account | [[Epic 21: Pinterest Ads Integration]] |
| `GET` | `/api/marketing/bing/accounts` | JWT | List Bing accounts | [[Epic 22: Bing Ads Integration]] |
| `POST` | `/api/marketing/bing/connect` | JWT | Connect Bing account | [[Epic 22: Bing Ads Integration]] |

**Note**: All ads integrations follow OAuth 2.0 pattern - see [[TD-007]] for connector organization.

---

### Health Insurance Data

| Method | Endpoint | Auth | Description | Related Epics |
|--------|----------|------|-------------|---------------|
| `GET` | `/api/health-insurance/carriers` | JWT | List health carriers | [[Epic 8: Georgia Health Insurance Data Collection]] |
| `GET` | `/api/health-insurance/plans` | JWT | List health plans | [[Epic 8: Georgia Health Insurance Data Collection]] |
| `GET` | `/api/health-insurance/plans/:id` | JWT | Get plan details | [[Epic 8: Georgia Health Insurance Data Collection]] |
| `GET` | `/api/carriers/available` | JWT | Get available carriers | [[Epic 1: Core CRM Foundation]] |
| `GET` | `/api/carriers/contracted` | JWT | Get user's contracted carriers | [[Epic 1: Core CRM Foundation]] |
| `PUT` | `/api/carriers/contracted/:id` | JWT | Toggle carrier contract | [[Epic 1: Core CRM Foundation]] |

---

### Business Lines

| Method | Endpoint | Auth | Description | Related Epics |
|--------|----------|------|-------------|---------------|
| `GET` | `/api/business-lines` | JWT | List business lines | [[Epic 1: Core CRM Foundation]] |
| `GET` | `/api/business-lines/enabled` | JWT | Get enabled business lines | [[Epic 1: Core CRM Foundation]] |
| `PUT` | `/api/business-lines/enable` | JWT | Enable business line | [[Epic 1: Core CRM Foundation]] |
| `PUT` | `/api/business-lines/disable` | JWT | Disable business line | [[Epic 1: Core CRM Foundation]] |

---

### Commissions

| Method | Endpoint | Auth | Description | Related Epics |
|--------|----------|------|-------------|---------------|
| `GET` | `/api/commissions` | JWT | List commissions | [[Epic 1: Core CRM Foundation]] |
| `POST` | `/api/commissions` | JWT | Create commission | [[Epic 1: Core CRM Foundation]] |
| `PUT` | `/api/commissions/:id` | JWT | Update commission | [[Epic 1: Core CRM Foundation]] |
| `GET` | `/api/commissions/rates` | JWT | Get commission rates | [[Epic 1: Core CRM Foundation]] |
| `POST` | `/api/commissions/rates` | JWT | Set commission rate | [[Epic 1: Core CRM Foundation]] |

---

### Connectors & Integrations

| Method | Endpoint | Auth | Description | Related Epics |
|--------|----------|------|-------------|---------------|
| `GET` | `/api/connectors` | JWT | List all connectors | [[Epic 1: Core CRM Foundation]] |
| `GET` | `/api/connectors/:service` | JWT | Get connector status | [[Epic 1: Core CRM Foundation]] |
| `POST` | `/api/connectors/:service/test` | JWT | Test connector | [[Epic 1: Core CRM Foundation]] |

**Connectors**: SendGrid, Stripe, CMS API, AWS S3, PostGrid, Twilio, OpenAI, Gemini

---

### API Keys Management

| Method | Endpoint | Auth | Description | Related Epics |
|--------|----------|------|-------------|---------------|
| `GET` | `/api/api-keys` | JWT | List API keys | [[Epic 1: Core CRM Foundation]] |
| `POST` | `/api/api-keys` | JWT | Create API key | [[Epic 1: Core CRM Foundation]] |
| `DELETE` | `/api/api-keys/:id` | JWT | Delete API key | [[Epic 1: Core CRM Foundation]] |

---

### Data Updates

| Method | Endpoint | Auth | Description | Related Epics |
|--------|----------|------|-------------|---------------|
| `GET` | `/api/data-updates/check` | JWT (Admin) | Check if update needed | [[Epic 8: Georgia Health Insurance Data Collection]] |
| `POST` | `/api/data-updates/update-all` | JWT (Admin) | Trigger data update | [[Epic 8: Georgia Health Insurance Data Collection]] |
| `POST` | `/api/data-updates/update-cms-rules` | JWT (Admin) | Update CMS rules | [[Epic 8: Georgia Health Insurance Data Collection]] |
| `POST` | `/api/data-updates/update-carriers-plans` | JWT (Admin) | Update carriers & plans | [[Epic 8: Georgia Health Insurance Data Collection]] |
| `POST` | `/api/data-updates/update-formularies` | JWT (Admin) | Update formularies | [[Epic 8: Georgia Health Insurance Data Collection]] |

---

### Dashboard & Analytics

| Method | Endpoint | Auth | Description | Related Epics |
|--------|----------|------|-------------|---------------|
| `GET` | `/api/dashboard/stats` | JWT | Get dashboard statistics | [[Epic 1: Core CRM Foundation]] |
| `GET` | `/api/dashboard/recent-activity` | JWT | Get recent activity | [[Epic 1: Core CRM Foundation]] |

---

### Notifications

| Method | Endpoint | Auth | Description | Related Epics |
|--------|----------|------|-------------|---------------|
| `GET` | `/api/notifications` | JWT | List notifications | [[Epic 1: Core CRM Foundation]] |
| `PUT` | `/api/notifications/:id/read` | JWT | Mark notification as read | [[Epic 1: Core CRM Foundation]] |
| `PUT` | `/api/notifications/read-all` | JWT | Mark all as read | [[Epic 1: Core CRM Foundation]] |

---

### Profile Management

| Method | Endpoint | Auth | Description | Related Epics |
|--------|----------|------|-------------|---------------|
| `GET` | `/api/profile` | JWT | Get user profile | [[Epic 1: Core CRM Foundation]] |
| `PUT` | `/api/profile` | JWT | Update user profile | [[Epic 1: Core CRM Foundation]] |
| `PUT` | `/api/profile/password` | JWT | Change password | [[Epic 1: Core CRM Foundation]] |

---

### Portal Configuration

| Method | Endpoint | Auth | Description | Related Epics |
|--------|----------|------|-------------|---------------|
| `GET` | `/api/portal/config` | JWT | Get portal config | [[Epic 1: Core CRM Foundation]] |
| `PUT` | `/api/portal/config` | JWT | Update portal config | [[Epic 1: Core CRM Foundation]] |
| `GET` | `/api/portal/ads` | JWT | Get portal ads | [[Epic 1: Core CRM Foundation]] |
| `POST` | `/api/portal/ads` | JWT | Create portal ad | [[Epic 1: Core CRM Foundation]] |

---

### Reviews Management

| Method | Endpoint | Auth | Description | Related Epics |
|--------|----------|------|-------------|---------------|
| `GET` | `/api/reviews` | JWT | List reviews | [[Epic 6: Review Management System]] |
| `POST` | `/api/reviews` | JWT | Create review request | [[Epic 6: Review Management System]] |
| `GET` | `/api/reviews/templates` | JWT | List review templates | [[Epic 6: Review Management System]] |
| `POST` | `/api/reviews/templates` | JWT | Create review template | [[Epic 6: Review Management System]] |

---

### Public Forms

| Method | Endpoint | Auth | Description | Related Epics |
|--------|----------|------|-------------|---------------|
| `POST` | `/api/public/forms/health-insurance` | None | Submit health insurance form | [[Epic 1: Core CRM Foundation]] |
| `POST` | `/api/public/forms/1095-a` | API Key | Submit 1095-A form with Covered California Consumer Delegation | [[Epic 1: Core CRM Foundation]] |
| `POST` | `/api/public/forms/contact` | None | Submit contact form | [[Epic 1: Core CRM Foundation]] |

---

### Email Tracking

| Method | Endpoint | Auth | Description | Related Epics |
|--------|----------|------|-------------|---------------|
| `GET` | `/api/email/track/open/:trackingId` | None | Track email open | [[Epic 1: Core CRM Foundation]] |
| `GET` | `/api/email/track/click/:trackingId/:linkId` | None | Track email click | [[Epic 1: Core CRM Foundation]] |

---

### System Endpoints

| Method | Endpoint | Auth | Description | Related Epics |
|--------|----------|------|-------------|---------------|
| `GET` | `/api/health` | None | Health check | [[Epic 1: Core CRM Foundation]] |
| `GET` | `/api/services/health` | None | Service health check | [[Epic 1: Core CRM Foundation]] |
| `GET` | `/api/test-db` | None | Test database connection | [[Epic 1: Core CRM Foundation]] |
| `GET` | `/api/portal-logos/:filename` | None | Get portal logo | [[Epic 3: Client Portal]] |

---

### Quick Reference by Epic

**[[Epic 1: Core CRM Foundation]]**:
- `/api/auth/*` - Authentication
- `/api/clients/*` - Client management
- `/api/conversations/*` - Conversations
- `/api/calls/*` - Call management
- `/api/dashboard/*` - Dashboard
- `/api/notifications/*` - Notifications
- `/api/profile/*` - Profile
- `/api/connectors/*` - Integrations
- `/api/api-keys/*` - API keys
- `/api/commissions/*` - Commissions
- `/api/business-lines/*` - Business lines
- `/api/carriers/*` - Carriers
- `/api/portal/*` - Portal config

**[[Epic 2: AI Agent Integration]]**:
- `/api/ai/*` - AI services
- `/api/ai/feedback/*` - AI feedback
- `/api/conversations/*` - AI-powered conversations

**[[Epic 3: Client Portal]]**:
- `/api/client-auth/*` - Client authentication
- `/api/client-portal/*` - Client portal data
- `/api/health-info/*` - Health information

**[[Epic 7: Calendar Scheduling System]]**:
- `/api/calendar/*` - Calendar operations
- `/api/booking-pages/*` - Booking pages
- `/api/event-types/*` - Event types
- `/api/booking/*` - Public booking (API key auth)

**[[Epic 8: Georgia Health Insurance Data Collection]]**:
- `/api/health-insurance/*` - Health insurance data
- `/api/data-updates/*` - Data update management

**[[Epic 11: Medicare SOA Automation]]**:
- `/api/docusend/envelopes/*` - SOA envelope creation

**[[Epic 12: Docusend E-Signature System]]**:
- `/api/docusend/*` - E-signature operations

**[[Epic 16: Google Ads Integration]]** - **[[Epic 22: Bing Ads Integration]]**:
- `/api/marketing/*` - Ads platform integrations

**[[Epic 6: Review Management System]]**:
- `/api/reviews/*` - Review management

---

### Authentication Patterns

**JWT Authentication**:
- Most endpoints require `Authorization: Bearer <token>` header
- Token obtained via `/api/auth/login`
- Token expires, use `/api/auth/refresh` to renew

**CSRF Protection**:
- State-changing routes (POST, PUT, DELETE, PATCH) require CSRF token
- Get token from `/api/csrf-token`
- Include in `X-CSRF-Token` header

**API Key Authentication**:
- Public booking endpoints use API key
- Include in `X-API-Key` header or query parameter
- Created via `/api/calendar/api-keys`

**Client Session Authentication**:
- Client portal endpoints use session cookies
- Session created via magic link verification
- No JWT required for client portal routes

---

### Rate Limiting

Most endpoints have rate limiting applied:
- **Auth endpoints**: Stricter limits (password reset, login)
- **API endpoints**: 100 requests per 15 minutes (default)
- **Public endpoints**: More lenient limits
- **Webhook endpoints**: No rate limiting (external services)

---

### Error Responses

All endpoints return consistent error format:
```json
{
  "error": "Error message",
  "code": "ERROR_CODE" // Optional
}
```

**Common HTTP Status Codes**:
- `200` - Success
- `201` - Created
- `400` - Bad Request
- `401` - Unauthorized
- `403` - Forbidden
- `404` - Not Found
- `500` - Internal Server Error

---

## 13. Business Line Feature Matrix

This section documents which features support which business lines, helping agents understand feature scope and business line-specific capabilities. This is critical because the CRM is fully business-line-aware with specialized workflows per line.

### Business Lines Overview

The CRM supports **5 business lines**:

1. **Medicare** (`medicare`) - Medicare 65+ plans
2. **Health Insurance** (`health-insurance`) - Individual & Family Plans (IFP)
3. **Life Insurance** (`life-insurance`) - Life insurance policies
4. **Group Plans** (`group-plans`) - Group health benefits
5. **Commercial** (`commercial`) - Commercial insurance

### Feature Matrix

| Feature/Epic | Medicare | Health Insurance | Life Insurance | Group Plans | Commercial | Notes |
|--------------|----------|------------------|----------------|-------------|------------|-------|
| **Core CRM Features** |
| [[Epic 1: Core CRM Foundation]] | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | Full support for all business lines |
| Client Management | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | `clients.line_of_business` field |
| Conversations | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | Business line context in conversations |
| Call Management | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | Business line routing for voicemails |
| Voicemail System | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | `voicemails.business_line` field |
| Commissions Tracking | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | `commissions.line_of_business` field |
| Dashboard | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | Business line filtering available |
| **Client Portal** |
| [[Epic 3: Client Portal]] | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | Multi-business line portal support |
| Enrollment Tracking | ‚úÖ | ‚úÖ | ‚ö†Ô∏è | ‚ö†Ô∏è | ‚ö†Ô∏è | Primary: Medicare & Health |
| Plan Documents | ‚úÖ | ‚úÖ | ‚ö†Ô∏è | ‚ö†Ô∏è | ‚ö†Ô∏è | Primary: Medicare & Health |
| Family Members | ‚úÖ | ‚úÖ | ‚ö†Ô∏è | ‚ö†Ô∏è | ‚ö†Ô∏è | Primary: Medicare & Health |
| **Calendar & Booking** |
| [[Epic 7: Calendar Scheduling System]] | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | Business line categories for booking pages |
| Appointment Scheduling | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | All business lines supported |
| Booking Pages | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | 14 pre-configured business line pages |
| Event Types | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | `event_types.business_line` field |
| API Key Restrictions | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | Can restrict by business line |
| **AI Features** |
| [[Epic 2: AI Agent Integration]] | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | Business line-aware AI responses |
| AI Message Generation | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | Context-aware per business line |
| Client Info Extraction | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | Business line-specific fields |
| **Health Insurance Data** |
| [[Epic 8: Georgia Health Insurance Data Collection]] | ‚ùå | ‚úÖ | ‚ùå | ‚ùå | ‚ùå | Health Insurance only (state-specific) |
| Health Plan Catalog | ‚ùå | ‚úÖ | ‚ùå | ‚ùå | ‚ùå | Health plans database |
| Carrier Information | ‚ùå | ‚úÖ | ‚ùå | ‚ùå | ‚ùå | Health carriers only |
| Provider Directory | ‚ùå | ‚úÖ | ‚ùå | ‚ùå | ‚ùå | Health providers |
| **Medicare SOA** |
| [[Epic 11: Medicare SOA Automation]] | ‚úÖ | ‚ùå | ‚ùå | ‚ùå | ‚ùå | Medicare-specific compliance |
| SOA Envelope Creation | ‚úÖ | ‚ùå | ‚ùå | ‚ùå | ‚ùå | Sequential signing (client ‚Üí agent) |
| SOA Status Tracking | ‚úÖ | ‚ùå | ‚ùå | ‚ùå | ‚ùå | `clients.status = 'pending_soa'` |
| **E-Signature** |
| [[Epic 12: Docusend E-Signature System]] | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | All business lines supported |
| Document Signing | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | Generic e-signature system |
| **Autopilot Lead Outreach** |
| [[Epic 13: Autopilot Lead Outreach App]] | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | **Fully business line-aware** |
| Campaign Management | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | Separate campaigns per business line |
| Script Library | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | Business line-specific scripts |
| AI Automation | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | Business line-specific rules |
| Lead Import | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | Business line assignment on import |
| Analytics | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | Business line breakdown |
| **Marketing Ads Integration** |
| [[Epic 16: Google Ads Integration]] | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | Business line targeting |
| [[Epic 17: LinkedIn Ads Integration]] | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | Business line targeting |
| [[Epic 18: Facebook Ads Integration]] | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | Business line targeting |
| [[Epic 19: TikTok Ads Integration]] | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | Business line targeting |
| [[Epic 20: Twitter Ads Integration]] | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | Business line targeting |
| [[Epic 20: Reddit Ads Integration]] | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | Business line targeting |
| [[Epic 21: Pinterest Ads Integration]] | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | Business line targeting |
| [[Epic 22: Bing Ads Integration]] | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | Business line targeting |
| Campaign Creation | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | Business line-specific campaigns |
| Ad Targeting | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | Business line filters |
| **Review Management** |
| [[Epic 6: Review Management System]] | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | All business lines supported |
| Review Requests | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | Business line-specific templates |
| **Multi-Tenant** |
| [[Epic 4: Multi-Tenant SaaS Platform]] | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | Business line enablement per tenant |
| Business Line Enablement | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ | `agencies.enabled_business_lines` array |

### Legend

- ‚úÖ **Full Support** - Feature fully supports this business line
- ‚ö†Ô∏è **Partial Support** - Feature works but optimized for other business lines
- ‚ùå **Not Supported** - Feature does not support this business line

### Business Line-Specific Features

#### Medicare-Specific Features

- **SOA (Scope of Appointment) Workflow** - Required compliance workflow
- **Enrollment Period Tracking** - AEP, SEP, OEP tracking
- **Part A/B/D References** - Medicare-specific plan components
- **Medicare Plan Catalog** - `medicare_plans` table
- **Medicare Carriers** - `medicare_carriers` table
- **Medicare Providers** - `medicare_providers` table
- **Status: `pending_soa`** - Special status for SOA workflow

**Related Epics**: [[Epic 1: Core CRM Foundation]], [[Epic 11: Medicare SOA Automation]]

#### Health Insurance-Specific Features

- **Marketplace Eligibility** - On-Exchange vs Off-Exchange
- **Open Enrollment Tracking** - Annual enrollment periods
- **Special Enrollment Period (SEP)** - Qualifying events
- **Health Plan Catalog** - `health_plans` table (Georgia-specific)
- **Health Carriers** - `health_carriers` table
- **Health Facilities** - `health_facilities` table
- **ZIP Code Mappings** - Geographic data for health plans
- **1095-A Form Integration** - Covered California Consumer Delegation with HIPAA-compliant consent capture
- **Lead Type: 1095-A Lead** - Special lead type for 1095-A form retrieval requests

**Related Epics**: [[Epic 8: Georgia Health Insurance Data Collection]], [[Epic 1: Core CRM Foundation]]

#### Life Insurance-Specific Features

- **Coverage Amount Tracking** - Policy coverage amounts
- **Beneficiary Information** - Beneficiary management
- **Policy Type References** - Term, Whole, Universal, etc.
- **Life Insurance Categories** - `life_insurance_categories` table

**Related Epics**: [[Epic 1: Core CRM Foundation]]

#### Group Plans-Specific Features

- **Employer Information** - Company details
- **Group Size Tracking** - Employee count
- **Benefits Package References** - Group benefits structure

**Related Epics**: [[Epic 1: Core CRM Foundation]]

#### Commercial-Specific Features

- **Business Type Tracking** - Industry classification
- **Employee Count Tracking** - Business size
- **Commercial Insurance Types** - Various commercial policies

**Related Epics**: [[Epic 1: Core CRM Foundation]]

### Business Line Awareness Patterns

#### Database Pattern

Most business-line-aware tables include:
- `line_of_business VARCHAR(50)` - Business line classification
- `business_line VARCHAR(50)` - Alternative field name (some tables)
- Index on business line field for filtering

**Example**:
```sql
SELECT * FROM clients WHERE line_of_business = 'medicare';
SELECT * FROM voicemails WHERE business_line = 'health-insurance';
```

#### API Pattern

Most endpoints support business line filtering:
- Query parameter: `?line_of_business=medicare`
- Query parameter: `?business_line=health-insurance`
- Filter in WHERE clause: `WHERE line_of_business = ${lineOfBusiness}`

**Example**:
```
GET /api/clients?line_of_business=medicare
GET /api/autopilot/campaigns?business_line=health-insurance
```

#### UI Pattern

Business line selector appears in:
- Dashboard filters
- Client list filters
- Campaign builders
- Booking page configuration
- Autopilot settings

**Pattern**: Dropdown or tabs with business line options

### Fully Business Line-Aware Epics

These epics have **complete business line separation**:

1. **[[Epic 13: Autopilot Lead Outreach App]]**
   - Separate campaigns per business line
   - Separate script libraries per business line
   - Separate AI automation rules per business line
   - Separate analytics per business line
   - See [[TD-009]] and [[TD-010]]

2. **[[Epic 7: Calendar Scheduling System]]**
   - Business line categories for booking pages
   - Business line-specific event types
   - API key restrictions by business line

3. **[[Epic 1: Core CRM Foundation]]**
   - Business line filtering throughout
   - Business line enablement per user
   - Business line-specific voicemail routing

### Business Line Enablement

**User-Level Enablement**:
- Users can enable/disable business lines
- `user_contracted_carriers` table tracks carrier access
- Business line access checked before feature access

**Agency-Level Enablement** (Multi-Tenant - Planned):
- `agencies.enabled_business_lines` array
- Controls which business lines are available per agency
- See [[Epic 4: Multi-Tenant SaaS Platform]]

### Quick Reference by Business Line

**Medicare**:
- ‚úÖ All core features
- ‚úÖ SOA workflow (unique)
- ‚úÖ Medicare plan catalog
- ‚úÖ Enrollment period tracking
- ‚úÖ Autopilot with `pending_soa` status

**Health Insurance**:
- ‚úÖ All core features
- ‚úÖ Health plan catalog (Georgia)
- ‚úÖ Marketplace eligibility
- ‚úÖ Enrollment period tracking
- ‚úÖ Provider directory

**Life Insurance**:
- ‚úÖ All core features
- ‚úÖ Coverage amount tracking
- ‚úÖ Beneficiary management
- ‚ö†Ô∏è Limited enrollment tracking

**Group Plans**:
- ‚úÖ All core features
- ‚úÖ Employer information
- ‚úÖ Group size tracking
- ‚ö†Ô∏è Limited enrollment tracking

**Commercial**:
- ‚úÖ All core features
- ‚úÖ Business type tracking
- ‚úÖ Industry classification
- ‚ö†Ô∏è Limited enrollment tracking

---

## 14. Integration Points Map

This section documents all external service integrations, their purpose, configuration, and epic relationships. This helps agents understand system dependencies, integration patterns, and where to find connector configurations.

### Integration Overview

The CRM integrates with **20+ external services** across multiple categories:
- **Communication**: Twilio (Voice, SMS), SendGrid (Email)
- **AI Services**: OpenAI, Google Gemini
- **Payment**: Stripe
- **E-Signature**: Docusend
- **Calendar**: Google Calendar, Outlook Calendar
- **Marketing Ads**: Facebook, LinkedIn, Google, Bing, TikTok, Twitter, Reddit, Pinterest
- **Data Services**: CMS API, Vericred API
- **Storage**: AWS S3
- **Postal Mail**: PostGrid

### Integration Categories

#### Communication Services

| Service | Purpose | Configuration | Status | Related Epics |
|---------|---------|---------------|--------|---------------|
| **Twilio Voice** | Incoming/outgoing calls, voicemail | `TWILIO_ACCOUNT_SID`, `TWILIO_AUTH_TOKEN`, `TWILIO_PHONE_NUMBER` | ‚úÖ Active | [[Epic 1: Core CRM Foundation]] |
| **Twilio SMS** | SMS messaging for Autopilot, reviews | `TWILIO_ACCOUNT_SID`, `TWILIO_AUTH_TOKEN`, `TWILIO_PHONE_NUMBER` | ‚úÖ Active | [[Epic 6: Review Management System]], [[Epic 13: Autopilot Lead Outreach App]] |
| **SendGrid** | Email notifications, review invitations | `SENDGRID_API_KEY`, `SENDGRID_FROM_EMAIL` | ‚úÖ Active | [[Epic 1: Core CRM Foundation]], [[Epic 6: Review Management System]] |

**Integration Pattern**: See [[TD-007]] for connector organization (system-wide vs app-specific)

**Webhooks**:
- Twilio Voice: `/api/calls/incoming`, `/api/calls/incoming-fallback`
- Twilio SMS: `/api/calls/sms-webhook` (for Autopilot)
- Twilio Voicemail: `/api/calls/voicemail-status`, `/api/calls/voicemail-transcription`

#### AI Services

| Service | Purpose | Configuration | Status | Related Epics |
|---------|---------|---------------|--------|---------------|
| **Google Gemini 2.5 Flash** | Primary AI for conversations, message generation | `GEMINI_API_KEY` | ‚úÖ Active | [[Epic 2: AI Agent Integration]] |
| **OpenAI GPT-4o-mini** | Fallback AI, Whisper (speech-to-text) | `OPENAI_API_KEY` | ‚úÖ Active | [[Epic 2: AI Agent Integration]] |
| **OpenAI Whisper** | Speech-to-text for voicemail transcription | `OPENAI_API_KEY` | ‚úÖ Active | [[Epic 1: Core CRM Foundation]] |

**Integration Pattern**: See [[TD-002]] for multi-provider AI strategy (50% cost savings with Gemini primary)

**Usage**:
- Primary: Gemini for all AI operations (conversations, client info extraction, message generation)
- Fallback: OpenAI when Gemini unavailable
- Whisper: Voicemail transcription only

#### Payment Services

| Service | Purpose | Configuration | Status | Related Epics |
|---------|---------|---------------|--------|---------------|
| **Stripe** | Payment processing, subscriptions | `STRIPE_SECRET_KEY`, `STRIPE_WEBHOOK_SECRET` | ‚úÖ Active | [[Epic 4: Multi-Tenant SaaS Platform]] |

**Integration Pattern**: Webhook-based subscription management

**Webhooks**:
- Stripe: `/api/stripe/webhook` (subscription events, payment confirmations)

#### E-Signature Services

| Service | Purpose | Configuration | Status | Related Epics |
|---------|---------|---------------|--------|---------------|
| **Docusend** | E-signature for SOA, documents | `DOCUSEND_API_KEY`, `DOCUSEND_API_SECRET` | ‚úÖ Active | [[Epic 12: Docusend E-Signature System]], [[Epic 11: Medicare SOA Automation]] |

**Integration Pattern**: API-based document creation and signing workflow

**Usage**:
- Medicare SOA: Sequential signing (client first, agent second) - See [[TD-008]]
- Generic documents: Parallel or sequential signing as needed

#### Calendar Services

| Service | Purpose | Configuration | Status | Related Epics |
|---------|---------|---------------|--------|---------------|
| **Google Calendar** | Calendar sync, appointment management | OAuth (stored in `google_calendar_tokens` table) | ‚úÖ Active | [[Epic 7: Calendar Scheduling System]] |
| **Outlook Calendar** | Calendar sync, appointment management | OAuth (stored in `outlook_calendar_tokens` table) | ‚úÖ Active | [[Epic 7: Calendar Scheduling System]] |

**Integration Pattern**: OAuth 2.0 with token refresh

**API Endpoints**:
- Google: `/api/calendar/sync/google/authorize`, `/api/calendar/sync/google/callback`
- Outlook: `/api/calendar/sync/outlook/authorize`, `/api/calendar/sync/outlook/callback`

#### Marketing Ads Platforms

| Service | Purpose | Configuration | Status | Related Epics |
|---------|---------|---------------|--------|---------------|
| **Facebook Ads** | Lead import, campaign management | OAuth (stored in `facebook_ads_tokens` table) | ‚úÖ Active | [[Epic 14: Facebook Ads Integration]] |
| **LinkedIn Ads** | Lead import, campaign management | OAuth (stored in `linkedin_ads_tokens` table) | ‚úÖ Active | [[Epic 15: LinkedIn Ads Integration]] |
| **Google Ads** | Lead import, campaign management | OAuth (stored in `google_ads_tokens` table) | ‚úÖ Active | [[Epic 16: Google Ads Integration]] |
| **Bing Ads** | Lead import, campaign management | OAuth (stored in `bing_ads_tokens` table) | ‚úÖ Active | [[Epic 17: Bing Ads Integration]] |
| **TikTok Ads** | Lead import, campaign management | OAuth (stored in `tiktok_ads_tokens` table) | ‚úÖ Active | [[Epic 18: TikTok Ads Integration]] |
| **Twitter Ads** | Lead import, campaign management | OAuth (stored in `twitter_ads_tokens` table) | ‚úÖ Active | [[Epic 19: Twitter Ads Integration]] |
| **Reddit Ads** | Lead import, campaign management | OAuth (stored in `reddit_ads_tokens` table) | ‚úÖ Active | [[Epic 20: Reddit Ads Integration]] |
| **Pinterest Ads** | Lead import, campaign management | OAuth (stored in `pinterest_ads_tokens` table) | ‚úÖ Active | [[Epic 21: Pinterest Ads Integration]] |

**Integration Pattern**: OAuth 2.0 for all platforms, unified connector pattern

**Usage**:
- Lead import: All platforms import prospects/leads into `clients` table
- Campaign management: Create and manage ad campaigns
- Business line targeting: All platforms support business line filtering
- See [[Epic 13: Autopilot Lead Outreach App]] for prospect-to-lead workflow

#### Data Services

| Service | Purpose | Configuration | Status | Related Epics |
|---------|---------|---------------|--------|---------------|
| **CMS API** | Federal marketplace health plan data (TX, FL, AZ) | `CMS_API_KEY` | ‚úÖ Active | [[Epic 8: Georgia Health Insurance Data Collection]] |
| **Vericred API** | California marketplace health plan data | `VERICRED_API_KEY` | ‚ö†Ô∏è Optional | [[Epic 8: Georgia Health Insurance Data Collection]] |

**Integration Pattern**: API key authentication, fallback to mock data if unavailable

**Usage**:
- CMS API: Federal marketplace states (TX, FL, AZ, etc.)
- Vericred API: California-specific (optional, uses mock data if not configured)
- Mock data: Used when API keys unavailable (development/testing)

#### Storage Services

| Service | Purpose | Configuration | Status | Related Epics |
|---------|---------|---------------|--------|---------------|
| **AWS S3** | File storage for documents, voicemail recordings | `AWS_ACCESS_KEY_ID`, `AWS_SECRET_ACCESS_KEY`, `AWS_S3_BUCKET` | ‚úÖ Active | [[Epic 1: Core CRM Foundation]], [[Epic 3: Client Portal]] |

**Integration Pattern**: Direct S3 upload/download via AWS SDK

**Usage**:
- Client documents: Uploaded to S3, URLs stored in database
- Voicemail recordings: Stored in S3, URLs in `voicemails.recording_url`

#### Postal Mail Services

| Service | Purpose | Configuration | Status | Related Epics |
|---------|---------|---------------|--------|---------------|
| **PostGrid** | Postal mail sending (future) | `POSTGRID_API_KEY` | ‚è≥ Planned | Future Epic |

**Integration Pattern**: API-based mail sending

### Connector Organization Pattern

See [[TD-007]] for the two-level connector organization:

**System-Wide Connectors** (`/connectors` page):
- Twilio (Voice, SMS)
- SendGrid (Email)
- OpenAI/Gemini (AI)
- Stripe (Payments)
- AWS S3 (Storage)
- Google Calendar (Calendar)
- Outlook Calendar (Calendar)

**App-Specific Connectors** (within app settings):
- Facebook Ads OAuth (Marketing Ads Connection tab)
- LinkedIn Ads OAuth (Marketing Ads Connection tab)
- Google Ads OAuth (Marketing Ads Connection tab)
- All other ads platforms (Marketing Ads Connection tab)
- Docusend (Docusend Settings page)

### Integration Status by Epic

**[[Epic 1: Core CRM Foundation]]**:
- ‚úÖ Twilio Voice (calls, voicemail)
- ‚úÖ SendGrid (email notifications)
- ‚úÖ OpenAI/Gemini (AI conversations)
- ‚úÖ AWS S3 (document storage)

**[[Epic 2: AI Agent Integration]]**:
- ‚úÖ Google Gemini 2.5 Flash (primary AI)
- ‚úÖ OpenAI GPT-4o-mini (fallback)
- ‚úÖ OpenAI Whisper (speech-to-text)

**[[Epic 3: Client Portal]]**:
- ‚úÖ AWS S3 (document storage)
- ‚úÖ SendGrid (portal emails)

**[[Epic 4: Multi-Tenant SaaS Platform]]**:
- ‚úÖ Stripe (subscription management)

**[[Epic 6: Review Management System]]**:
- ‚úÖ SendGrid (review invitation emails)
- ‚úÖ Twilio SMS (review invitation SMS)

**[[Epic 7: Calendar Scheduling System]]**:
- ‚úÖ Google Calendar (OAuth sync)
- ‚úÖ Outlook Calendar (OAuth sync)

**[[Epic 8: Georgia Health Insurance Data Collection]]**:
- ‚úÖ CMS API (federal marketplace)
- ‚ö†Ô∏è Vericred API (California, optional)

**[[Epic 11: Medicare SOA Automation]]**:
- ‚úÖ Docusend (SOA e-signature)

**[[Epic 12: Docusend E-Signature System]]**:
- ‚úÖ Docusend (generic e-signature)

**[[Epic 13: Autopilot Lead Outreach App]]**:
- ‚úÖ Twilio SMS (message sending)
- ‚úÖ Facebook Ads API (lead import)
- ‚úÖ LinkedIn Ads API (lead import)
- ‚úÖ Google Ads API (lead import)

**[[Epic 14-21: Marketing Ads Integrations]]**:
- ‚úÖ Facebook Ads API
- ‚úÖ LinkedIn Ads API
- ‚úÖ Google Ads API
- ‚úÖ Bing Ads API
- ‚úÖ TikTok Ads API
- ‚úÖ Twitter Ads API
- ‚úÖ Reddit Ads API
- ‚úÖ Pinterest Ads API

### Webhook Endpoints

**Twilio Webhooks**:
- `POST /api/calls/incoming` - Incoming call handler
- `POST /api/calls/incoming-fallback` - Fallback handler
- `POST /api/calls/voicemail-status` - Voicemail recording status
- `POST /api/calls/voicemail-transcription` - Voicemail transcription
- `POST /api/calls/sms-webhook` - SMS webhook (Autopilot)

**Stripe Webhooks**:
- `POST /api/stripe/webhook` - Subscription events, payments

**Docusend Webhooks**:
- `POST /api/docusend/webhook` - Document signing status updates

### Environment Variables Reference

**Required for Production**:
```bash
# Communication
TWILIO_ACCOUNT_SID=AC...
TWILIO_AUTH_TOKEN=...
TWILIO_PHONE_NUMBER=+1...
SENDGRID_API_KEY=SG...
SENDGRID_FROM_EMAIL=noreply@versainsuranceagency.com

# AI Services
GEMINI_API_KEY=...
OPENAI_API_KEY=...

# Payment
STRIPE_SECRET_KEY=sk_live_...
STRIPE_WEBHOOK_SECRET=whsec_...

# E-Signature
DOCUSEND_API_KEY=...
DOCUSEND_API_SECRET=...

# Storage
AWS_ACCESS_KEY_ID=...
AWS_SECRET_ACCESS_KEY=...
AWS_S3_BUCKET=...

# Data Services
CMS_API_KEY=... # For federal marketplace states
VERICRED_API_KEY=... # Optional, for California
```

**OAuth Tokens** (stored in database, not environment):
- Google Calendar: `google_calendar_tokens` table
- Outlook Calendar: `outlook_calendar_tokens` table
- All ads platforms: `{platform}_ads_tokens` tables

### Integration Testing

**Test Endpoints**:
- Health check: `GET /api/health` (includes integration status)
- Integration status: `GET /api/reviews/integrations` (review system integrations)
- Connector status: `GET /api/connectors/status` (all connectors)

**Common Issues**:
- OAuth token expiration: Tokens auto-refresh, but manual refresh available in Connectors page
- API key missing: System falls back to mock data or disables feature
- Webhook failures: Fallback handlers prevent service disruption

---

## 15. Component Library Index

This section documents reusable React components, their purpose, props, and epic origins. This helps agents understand component structure, find reusable UI elements, and maintain component consistency.

### Component Overview

The CRM frontend uses **Mantine UI** as the base design system with custom components built on top. Components are organized by functional area and reusability level.

### Core Layout Components

| Component | File | Purpose | Props | Related Epics |
|-----------|------|---------|-------|---------------|
| **Layout** | `components/Layout.tsx` | Main application layout with navigation, sidebar, call drawer | None (uses context) | [[Epic 1: Core CRM Foundation]] |
| **ProtectedRoute** | `components/ProtectedRoute.tsx` | Route protection wrapper | `children: ReactNode` | [[Epic 1: Core CRM Foundation]] |

### Communication Components

| Component | File | Purpose | Props | Related Epics |
|-----------|------|---------|-------|---------------|
| **ChatWindow** | `components/ChatWindow.tsx` | AI conversation interface | `client: Client`, `conversationId?: number`, `onConversationCreated?: (id: number) => void` | [[Epic 2: AI Agent Integration]] |
| **ConversationSummary** | `components/ConversationSummary.tsx` | Displays conversation summary | `conversationId: number` | [[Epic 2: AI Agent Integration]] |
| **ConversationHistory** | `components/ConversationHistory.tsx` | Shows conversation message history | `clientId: number` | [[Epic 2: AI Agent Integration]] |
| **CallDrawer** | `components/CallDrawer.tsx` | Call management drawer (incoming/outgoing) | `opened: boolean`, `onClose: () => void`, `callData: CallData`, `onCallEnd: () => void`, `manualMode?: boolean` | [[Epic 1: Core CRM Foundation]] |
| **CallTranscriptionWindow** | `components/CallTranscriptionWindow.tsx` | Displays call transcription and form | `callId: number`, `active: boolean`, `formData: any`, `clientId?: number` | [[Epic 1: Core CRM Foundation]] |

### Client Management Components

| Component | File | Purpose | Props | Related Epics |
|-----------|------|---------|-------|---------------|
| **ClientDocuments** | `components/ClientDocuments.tsx` | Document management for clients | `clientId: number`, `client: Client` | [[Epic 3: Client Portal]] |
| **ClientHealthInfoForm** | `components/ClientHealthInfoForm.tsx` | Health information form | `clientId: number` | [[Epic 1: Core CRM Foundation]] |
| **HouseholdPremium** | `components/HouseholdPremium.tsx` | Premium calculation display | `form: UseFormReturn`, `selectedState: string` | [[Epic 1: Core CRM Foundation]] |
| **PlanSelections** | `components/PlanSelections.tsx` | Plan selection interface | `form: UseFormReturn`, `familyInfo: any`, `clientId: number` | [[Epic 1: Core CRM Foundation]] |

### Calendar Components

| Component | File | Purpose | Props | Related Epics |
|-----------|------|---------|-------|---------------|
| **CalendarView** | `components/calendar/CalendarView.tsx` | Main calendar display | `viewMode?: 'month' \| 'week' \| 'day'` | [[Epic 7: Calendar Scheduling System]] |
| **AppointmentForm** | `components/calendar/AppointmentForm.tsx` | Create/edit appointment form | `appointmentId?: number`, `onSave: () => void`, `onCancel: () => void` | [[Epic 7: Calendar Scheduling System]] |
| **AvailabilitySettings** | `components/calendar/AvailabilitySettings.tsx` | Agent availability configuration | None | [[Epic 7: Calendar Scheduling System]] |

### Marketing Components

| Component | File | Purpose | Props | Related Epics |
|-----------|------|---------|-------|---------------|
| **MarketingAnalytics** | `components/MarketingAnalytics.tsx` | Marketing analytics dashboard | `lineOfBusiness?: string` | [[Epic 13: Autopilot Lead Outreach App]] |
| **LeadEmailTemplateRow** | `components/LeadEmailTemplateRow.tsx` | Email template row for leads | `template: EmailTemplate`, `onEdit: () => void`, `onDelete: () => void` | [[Epic 1: Core CRM Foundation]] |

### E-Signature Components

| Component | File | Purpose | Props | Related Epics |
|-----------|------|---------|-------|---------------|
| **SignatureFieldPlacer** | `components/SignatureFieldPlacer.tsx` | Place signature fields on PDF | `documentUrl: string`, `onFieldsPlaced: (fields: SignatureField[]) => void` | [[Epic 12: Docusend E-Signature System]] |

### Shared/Utility Components

| Component | File | Purpose | Props | Related Epics |
|-----------|------|---------|-------|---------------|
| **CollapsibleSection** | `components/shared/CollapsibleSection.tsx` | Collapsible content section | `title: string`, `children: ReactNode`, `defaultOpen?: boolean` | [[Epic 3: Client Portal]] |
| **MantisKPICard** | `components/MantisKPICard.tsx` | KPI card with Mantis styling | `title: string`, `value: string \| number`, `icon?: ReactNode`, `trend?: 'up' \| 'down'` | [[Epic 10: Mantis Design System Upgrade]] |

### UI Components (Mantine Extensions)

| Component | File | Purpose | Props | Related Epics |
|-----------|------|---------|-------|---------------|
| **Button** | `components/ui/button.tsx` | Extended Mantine Button | Mantine Button props + custom variants | [[Epic 10: Mantis Design System Upgrade]] |
| **Card** | `components/ui/card.tsx` | Extended Mantine Card | Mantine Card props + custom styling | [[Epic 10: Mantis Design System Upgrade]] |
| **Input** | `components/ui/input.tsx` | Extended Mantine Input | Mantine Input props + custom variants | [[Epic 10: Mantis Design System Upgrade]] |
| **Label** | `components/ui/label.tsx` | Extended Mantine Label | Mantine Label props + custom styling | [[Epic 10: Mantis Design System Upgrade]] |

### Component Usage Patterns

#### Communication Components

**ChatWindow** - Used in:
- `pages/ClientDetailPage.tsx` - Client conversation view
- `pages/ClientFormPage.tsx` - Client form with AI assistance

**CallDrawer** - Used in:
- `components/Layout.tsx` - Global call management

#### Client Management Components

**ClientDocuments** - Used in:
- `pages/ClientDetailPage.tsx` - Client document management
- `pages/ClientFormPage.tsx` - Document upload during client creation

**PlanSelections** - Used in:
- `pages/ClientFormPage.tsx` - Plan selection during enrollment

#### Calendar Components

**CalendarView** - Used in:
- `pages/CalendarPage.tsx` - Main calendar page
- `pages/SimpleCalendarPage.tsx` - Simplified calendar view

**AppointmentForm** - Used in:
- `pages/CalendarPage.tsx` - Create/edit appointments
- `components/calendar/CalendarView.tsx` - Inline appointment creation

### Component Dependencies

**Mantine UI** (Base):
- All components built on Mantine primitives
- Theme: `mantis-theme.ts` (custom theme configuration)
- Overrides: `mantis-overrides.css` (global CSS overrides)

**React Router**:
- `ProtectedRoute` uses `useNavigate`, `useLocation`
- Layout uses `useLocation` for active route detection

**Context Providers**:
- `CallProvider` (CallContext) - Used by CallDrawer, CallTranscriptionWindow
- `MantineProvider` - Global Mantine configuration

### Component Organization

**File Structure**:
```
components/
‚îú‚îÄ‚îÄ Layout.tsx                    # Main layout
‚îú‚îÄ‚îÄ ProtectedRoute.tsx            # Route protection
‚îú‚îÄ‚îÄ ChatWindow.tsx                # AI conversations
‚îú‚îÄ‚îÄ CallDrawer.tsx                # Call management
‚îú‚îÄ‚îÄ ClientDocuments.tsx            # Document management
‚îú‚îÄ‚îÄ calendar/                     # Calendar components
‚îÇ   ‚îú‚îÄ‚îÄ CalendarView.tsx
‚îÇ   ‚îú‚îÄ‚îÄ AppointmentForm.tsx
‚îÇ   ‚îî‚îÄ‚îÄ AvailabilitySettings.tsx
‚îú‚îÄ‚îÄ shared/                       # Shared utilities
‚îÇ   ‚îî‚îÄ‚îÄ CollapsibleSection.tsx
‚îî‚îÄ‚îÄ ui/                           # Mantine extensions
    ‚îú‚îÄ‚îÄ button.tsx
    ‚îú‚îÄ‚îÄ card.tsx
    ‚îú‚îÄ‚îÄ input.tsx
    ‚îî‚îÄ‚îÄ label.tsx
```

### Quick Reference by Epic

**[[Epic 1: Core CRM Foundation]]**:
- Layout, ProtectedRoute, CallDrawer, CallTranscriptionWindow
- ClientHealthInfoForm, HouseholdPremium, PlanSelections
- LeadEmailTemplateRow

**[[Epic 2: AI Agent Integration]]**:
- ChatWindow, ConversationSummary, ConversationHistory

**[[Epic 3: Client Portal]]**:
- ClientDocuments, CollapsibleSection

**[[Epic 7: Calendar Scheduling System]]**:
- CalendarView, AppointmentForm, AvailabilitySettings

**[[Epic 10: Mantis Design System Upgrade]]**:
- MantisKPICard, ui/button, ui/card, ui/input, ui/label

**[[Epic 12: Docusend E-Signature System]]**:
- SignatureFieldPlacer

**[[Epic 13: Autopilot Lead Outreach App]]**:
- MarketingAnalytics

### Component Development Guidelines

**When Creating New Components**:
1. Use Mantine UI primitives as base
2. Follow existing component patterns
3. Add TypeScript interfaces for all props
4. Document component purpose and usage
5. Link to related epic in component comments
6. Use shared components when possible (CollapsibleSection, etc.)

**Component Naming**:
- PascalCase for component files
- Descriptive names (e.g., `ClientDocuments`, not `Documents`)
- Match component name to file name

**Props Interface Pattern**:
```typescript
interface ComponentNameProps {
  requiredProp: string;
  optionalProp?: number;
  callback?: (value: any) => void;
}

export default function ComponentName({ 
  requiredProp, 
  optionalProp, 
  callback 
}: ComponentNameProps) {
  // Component implementation
}
```

---

## 16. Status & Approval

### 16.1 Current Status
**PRD Status**: `draft`  
**Last Updated**: 2025-12-25 (Comprehensive Codebase Analysis & Future Improvements)
**Version**: 1.36

### 16.2 Approval Status
- [ ] **Product Owner Review**: Pending
- [ ] **Technical Review**: Pending
- [ ] **Stakeholder Approval**: Pending

### 14.3 Next Steps
1. **Review PRD**: Product owner reviews and provides feedback
2. **Approve PRD**: Set status to `approved` when ready
3. **Create ARCH**: After PRD approval, create `.ai/arch.md`
4. **Begin Epic 3**: Start client portal development

### 16.4 Change Log

#### üéØ Major Milestones
| Date | Milestone | Impact |
|------|-----------|---------|
| 2025-01-13 | Initial PRD Created | Project planning and epic definition |
| 2025-01-15 | Client Portal Auth Fixed | Resolved impersonation flow and token management |
| 2025-01-28 | Server Stability Achieved | Fixed 502 errors across 20+ files |
| 2025-01-28 | Georgia Health Data Plan | State-specific data collection strategy |
| 2025-11-27 | Calendar System Complete | Full scheduling system deployed to production |
| 2025-11-27 | All Epics Complete | Multi-line insurance CRM fully operational |

#### üìã Detailed Change History

**2025-01-27 - Connector Multi-Tenancy & UI Consistency Improvements**

- **Test/Live API Key Management**: Implemented environment switching for connectors with separate test and live API keys
  - Added `environment` column to `connector_api_keys` table to store keys per environment
  - Created `connector_environment_settings` table to track active environment per connector/agency
  - Backend endpoints updated to handle environment-specific key retrieval and storage
  - Frontend UI added environment toggle switches for all connectors
  - Users can now switch between test and live environments and manage keys separately
- **Applications Page UI Improvements**:
  - Removed back button from Applications page header (not needed on main pages)
  - Added `IconApps` icon to Applications page header to match other main pages
  - Fixed header spacing consistency across Marketing, Settings, and Applications pages
  - All main pages now have consistent header styling with icons and subtitle spacing
- **Server Stability Fix**:
  - Fixed 502 Bad Gateway errors caused by duplicate variable declarations in `connectors.ts`
  - Removed duplicate `activeEnv` and `envSetting` variable declarations
  - Added `activeEnvironment` to all API key response objects for consistency
  - Server now running successfully with all endpoints responding
- **Related Epics**: [[Epic 1: Core CRM Foundation]], [[Epic 4: Multi-Tenant SaaS]]
- **Files**: `connectors.ts`, `init-db.ts`, `ConnectorsPage.tsx`, `ApplicationsPage.tsx`, `MarketingPage.tsx`, `SettingsPage.tsx`

**2025-01-27 - Epic 24: Brevo Email Campaign Integration Complete**
- **Comprehensive Brevo API Integration**: Full email campaign management system with campaigns, templates, contact lists, and analytics
- **Backend Service Layer**: Created `brevoMarketingService.ts` with 10+ functions for Brevo API interactions
- **API Routes**: Implemented 13+ API endpoints for campaign CRUD, sending, scheduling, templates, lists, contacts, and analytics
- **Frontend Page**: Created `EmailCampaignPage.tsx` with 5 tabs (Dashboard, Campaigns, Templates, Contact Lists, Analytics)
- **Error Handling**: Fixed 500 Internal Server Errors by wrapping all `getBrevoHeaders()` calls in try-catch blocks
- **Production Deployment**: Built frontend for production, fixed nginx redirect loop, deployed successfully
- **Component Cleanup**: Removed old `BrevoEmailCampaignPage.tsx` component that was causing conflicts
- **Issues Fixed**:
  - Tabs not visible: Removed Card wrapper and inline styles hiding tabs
  - 500 errors: All Brevo API functions now return 400 errors with clear messages when API key missing
  - Production build missing: Built frontend, created `dist/` directory
  - Nginx redirect loop: Fixed by ensuring `dist/index.html` exists
- **Related Epic**: [[Epic 24: Brevo Email Campaign Integration]]
- **Files**: `brevoMarketingService.ts`, `marketing.ts` routes, `EmailCampaignPage.tsx`, production build configuration

**2025-01-27 - Carrier Management Refactor - Business Line Separation**

- **Carrier Management Architecture Refactor**: Refactored single tabbed carrier settings page into five separate dedicated pages, one for each business line
  - Created shared constants file (`crm/client/src/pages/carriers/constants.ts`) with business line definitions, health exchanges, and US states
  - Created five new carrier management pages:
    - `CarriersMedicarePage.tsx` - Medicare 65+ carrier management
    - `CarriersHealthInsurancePage.tsx` - Health Insurance carrier management (with on-exchange/off-exchange logic)
    - `CarriersLifeInsurancePage.tsx` - Life Insurance carrier management
    - `CarriersGroupHealthPage.tsx` - Group Benefits carrier management
    - `CarriersCommercialPage.tsx` - Commercial carrier management
  - Each page is self-contained with its own state management, API calls, and UI
  - Health Insurance page retains full exchange/state selection logic (federal and state marketplaces)
  - Updated `SettingsPage.tsx` to display five separate carrier cards instead of single "Carriers" card
  - Updated `App.tsx` routing to include five new routes and remove old single carrier route
  - All pages follow consistent header pattern with back button, title, icon, and descriptive text
- **Benefits**:
  - Direct navigation to specific business line carrier management
  - Improved code organization and maintainability
  - Each business line has dedicated, focused interface
  - Health Insurance complexity isolated to its own page
- **Related Epic**: [[Epic 1: Core CRM Foundation]]
- **Files**: `SettingsPage.tsx`, `App.tsx`, `carriers/constants.ts`, `carriers/CarriersMedicarePage.tsx`, `carriers/CarriersHealthInsurancePage.tsx`, `carriers/CarriersLifeInsurancePage.tsx`, `carriers/CarriersGroupHealthPage.tsx`, `carriers/CarriersCommercialPage.tsx`

**2025-01-27 - Epic 23: Lob Direct Mail System - Advanced Features Implementation**

**Status**: ‚úÖ Complete

**Related Epic**: [[Epic 23: Lob Direct Mail System]]

**Overview**:
Implemented all high and medium priority Lob API features, expanding the direct mail system from basic letters/postcards/checks to a comprehensive mail marketing platform with 6 mail types, advanced tracking, cost management, and template versioning.

**New Features Implemented**:

1. **Address Autocomplete** ‚úÖ
   - Real-time address suggestions using Lob's `/v1/us_autocompletions` API
   - Integrated into Direct Mail address verification form
   - Integrated into client/lead creation forms (`ClientFormPage.tsx`, `CallDrawer.tsx`)
   - Debounced API calls (300ms) for performance
   - Auto-populates city, state, ZIP upon selection
   - Reduces address entry errors and speeds up data entry

2. **QR Code Generation** ‚úÖ
   - Generate QR codes via Lob API for any URL
   - Insert QR codes into mail templates (letters, postcards, self mailers, snap packs, booklets)
   - QR code modal with URL input and preview
   - Useful for tracking mail engagement and driving digital interactions

3. **Cost Estimation** ‚úÖ
   - Real-time cost calculation before sending campaigns
   - Shows total cost, cost per piece, and detailed breakdown
   - Displayed in campaign creation modal
   - Prevents cost surprises and improves budgeting

4. **Self Mailers** ‚úÖ
   - New mail type: Folded mail pieces (brochures, flyers)
   - Template editor with front/back/inside/outside content fields
   - Support for bifold sizes (6x18, 11x9, 12x9)
   - Full template preview and variable replacement

5. **URL Shortener** ‚úÖ
   - Create trackable short links via Lob's `/v1/links` API
   - Insert short links into mail templates
   - Click tracking and analytics support
   - Custom domain support (optional)
   - Copy and insert functionality in template editor

6. **Template Versions** ‚úÖ
   - Version control for direct mail templates
   - Save current template state as new version with notes
   - View version history with timestamps
   - Restore previous versions (automatically saves current state first)
   - New database table: `direct_mail_template_versions`
   - Version history modal with comparison view

7. **Cancellation Windows** ‚úÖ
   - Cancel pending mailings within 4-hour window after submission
   - Check cancellation status before attempting cancellation
   - Cancel button with time remaining tooltip in mailings table
   - Updated mailing status to include 'cancelled'
   - Prevents accidental sends and enables error correction

8. **Billing Groups** ‚úÖ
   - Organize costs by department, client, or project
   - Create and manage billing groups via Lob API
   - Assign billing groups to campaigns
   - All mailings in campaign inherit billing group assignment
   - Billing group selector in campaign creation modal
   - Billing group creation modal with name and description

9. **Snap Packs** ‚úÖ
   - New mail type: Self-mailers with tear-off reply cards
   - Template editor with front/back/inside content fields
   - Useful for surveys, response tracking, and engagement campaigns
   - Full template preview and variable replacement

10. **Booklets** ‚úÖ
    - New mail type: Multi-page mail pieces (8-32 pages)
    - Template editor with front/back covers and pages JSON array
    - Pages stored as JSON array: `["page1", "page2", "page3"]`
    - Useful for catalogs, product information, and detailed marketing materials
    - Full template preview and variable replacement

11. **Dashboard Tab** ‚úÖ
    - New default landing tab for Direct Mail app
    - Overview of key metrics (Total Campaigns, Total Mailings, Total Cost, Delivery Rate)
    - Recent campaigns list with quick actions
    - Quick action buttons for common tasks
    - Scrollable tabs to ensure all tabs visible

12. **CSV Export** ‚úÖ
    - Export campaigns to CSV with filtered data
    - Export mailings to CSV with filtered data
    - Export analytics data to CSV
    - Enhanced data analysis capabilities

**Technical Implementation**:

**Backend Services**:
- `crm/server/src/services/lobService.ts` - Added functions:
  - `autocompleteAddress()` - Address autocomplete
  - `generateQRCode()` - QR code generation
  - `estimateMailCost()` - Cost estimation
  - `sendSelfMailer()` - Self mailer sending
  - `sendSnapPack()` - Snap pack sending
  - `sendBooklet()` - Booklet sending
  - `createShortLink()` - URL shortening
  - `getShortLinkAnalytics()` - Short link analytics
  - `checkCancellationWindow()` - Cancellation window check
  - `cancelMailing()` - Mailing cancellation
  - `listBillingGroups()` - List billing groups
  - `createBillingGroup()` - Create billing group
  - `getBillingGroup()` - Get billing group

**Backend Routes** (`crm/server/src/routes/marketing.ts`):
- `POST /api/marketing/direct-mail/autocomplete-address` - Address autocomplete
- `POST /api/marketing/direct-mail/generate-qr-code` - QR code generation
- `POST /api/marketing/direct-mail/estimate-cost` - Cost estimation
- `POST /api/marketing/direct-mail/create-short-link` - URL shortening
- `GET /api/marketing/direct-mail/short-link-analytics/:linkId` - Short link analytics
- `GET /api/marketing/direct-mail/templates/:id/versions` - List template versions
- `POST /api/marketing/direct-mail/templates/:id/versions` - Create template version
- `GET /api/marketing/direct-mail/templates/:id/versions/:versionId` - Get template version
- `POST /api/marketing/direct-mail/templates/:id/versions/:versionId/restore` - Restore template version
- `GET /api/marketing/direct-mail/mailings/:id/cancellation-status` - Check cancellation status
- `POST /api/marketing/direct-mail/mailings/:id/cancel` - Cancel mailing
- `GET /api/marketing/direct-mail/billing-groups` - List billing groups
- `POST /api/marketing/direct-mail/billing-groups` - Create billing group
- `GET /api/marketing/direct-mail/billing-groups/:id` - Get billing group

**Database Schema Updates** (`crm/server/src/db/init-db.ts`):
- Added `direct_mail_template_versions` table for version control
- Updated `mail_type` constraints to include 'self_mailer', 'snap_pack', 'booklet'
- Updated `status` constraint in `direct_mail_mailings` to include 'cancelled'
- Added `billing_group_id` column to `direct_mail_campaigns` table

**Frontend Updates** (`crm/client/src/pages/marketing/DirectMailPage.tsx`):
- Added Dashboard tab as default landing page
- Added Address Autocomplete to address verification form
- Added QR code generation UI in template editor
- Added cost estimation display in campaign creation modal
- Added self_mailer, snap_pack, booklet mail type support
- Added short link creation and insertion in template editor
- Added template version history modal
- Added cancellation status check and cancel button for pending mailings
- Added billing group selector in campaign creation modal
- Added billing group creation modal
- Added CSV export functionality
- Made tabs scrollable for better UX
- Updated all mail type filters and selectors

**Integration Points**:
- **Client/Lead Forms**: Address autocomplete integrated into `ClientFormPage.tsx` and `CallDrawer.tsx`
- **Lob API**: Full integration for all new features
- **Template System**: Enhanced with version control and QR code/short link insertion
- **Campaign System**: Enhanced with billing groups and cost estimation

**Key Issues Resolved**:
- ‚úÖ **Template Editor UI**: Added missing self_mailer template editor UI
- ‚úÖ **Snap Pack Template Editor**: Added snap_pack template editor with front/back/content fields
- ‚úÖ **Booklet Template Editor**: Added booklet template editor with front/back covers and pages JSON array
- ‚úÖ **Mail Type Constraints**: Updated all database constraints to support new mail types
- ‚úÖ **Scheduler Support**: Updated `directMailScheduler.ts` to handle all new mail types
- ‚úÖ **Cost Estimation**: Integrated real-time cost calculation into campaign creation flow
- ‚úÖ **Cancellation Status**: Added real-time cancellation window checking for pending mailings
- ‚úÖ **Billing Group Assignment**: All mail sending functions now support billing_group_id
- ‚úÖ **Dashboard Default**: Fixed URL parameter handling to default to dashboard tab

**Files Created/Modified**:
- `crm/server/src/services/lobService.ts` (MODIFIED) - Added all new service functions
- `crm/server/src/routes/marketing.ts` (MODIFIED) - Added all new API endpoints
- `crm/server/src/services/directMailScheduler.ts` (MODIFIED) - Added support for new mail types
- `crm/server/src/db/init-db.ts` (MODIFIED) - Updated schema for new mail types and features
- `crm/client/src/pages/marketing/DirectMailPage.tsx` (MODIFIED) - Added all new UI features
- `crm/client/src/pages/ClientFormPage.tsx` (MODIFIED) - Added address autocomplete
- `crm/client/src/components/CallDrawer.tsx` (MODIFIED) - Added address autocomplete

**Next Steps** (Future Enhancements):
- Reverse Geocode Lookup (Get address from coordinates)
- Identity Validation (Verify person identity)
- Informed Delivery Campaign API (USPS integration)
- Campaigns API (BETA) (Use Lob's native campaign management)

**Related Epic**: [[Epic 23: Lob Direct Mail System]]

---

**2025-12-25 - 1095-A Form Integration: Covered California Consumer Delegation**

**Status**: ‚úÖ Complete

**Related Epic**: [[Epic 1: Core CRM Foundation]]

**Overview**:
Implemented comprehensive 1095-A form integration for Covered California Consumer Delegation, enabling marketing sites to submit health insurance leads with detailed consent capture, HIPAA-compliant audit trails, and ESIGN Act compliance. Includes full CRM integration with inbox notifications, duplicate prevention, and client portal filtering.

**New Features Implemented**:

1. **1095-A Form Endpoint** ‚úÖ
   - New API endpoint: `POST /api/public/forms/1095-a`
   - Requires API key with `health-insurance` business line access
   - Accepts form submission data including delegation consents, signature, and tax preparer information
   - Auto-populates broker information from API key owner
   - Implements duplicate lead prevention (email and phone checks)
   - Creates inbox notifications for new leads
   - Stores detailed consent data with IP address, timestamp, and user agent for audit trail

2. **Covered California Consumer Delegation Section** ‚úÖ
   - New section in ClientDetailPage for 1095-A leads
   - Displays four delegation consent checkboxes with granted/not granted status
   - Shows consent timestamps and IP addresses for compliance
   - Displays signature (type, draw, or upload) with signature type badge
   - Only visible for `lead_type === '1095-a-lead'` and `line_of_business === 'health-insurance'`
   - Positioned above Classification section as requested

3. **HIPAA-Compliant Consent Capture** ‚úÖ
   - Stores detailed consent objects with:
     - `granted` status (boolean)
     - `timestamp` (ISO string)
     - `ipAddress` (from request headers)
     - `userAgent` (browser/client information)
   - Creates audit log entries using `logPHIAccess` service
   - All consent data stored in `form_submission_data` JSONB field
   - Full audit trail for compliance and legal protection

4. **ESIGN Act Compliance** ‚úÖ
   - `esignConsent` field stored with same audit trail structure
   - Explicit consent to conduct business electronically
   - Signature capture with three format options (type, draw, upload)
   - Security analysis completed - recommends "type only" for maximum security
   - Signature stored with type and submission timestamp

5. **API Key Management Enhancement** ‚úÖ
   - Added edit functionality to API Settings page
   - Users can now update API key names and business line permissions
   - Edit modal with MultiSelect for `allowedBusinessLines`
   - Supports updating commercial and life insurance categories
   - Endpoint URLs automatically updated when business lines change
   - Includes `/api/public/forms/1095-a` in endpoint list when health-insurance is selected

6. **Client Portal Plan Filtering** ‚úÖ
   - 1095-A leads without plans: No plan information displayed
   - 1095-A leads with plans added later: Plans display correctly
   - `hasHealthInsurance` set to `false` for 1095-A leads without plans
   - `hasHealthInsurance` set to `true` if plans are added later
   - Prevents "Ambetter Health" or other default plan displays for form-only leads
   - Smart filtering based on actual plan data existence

7. **Client Deletion Cascade** ‚úÖ
   - Deletes related notifications when client is deleted
   - Deletes related appointments when client is deleted
   - Ensures inbox is automatically updated when leads are removed
   - Prevents orphaned records in notifications and appointments tables
   - Error handling ensures deletion continues even if one step fails

**Technical Implementation**:

**Backend Routes** (`crm/server/src/routes/public-forms.ts`):
- `POST /api/public/forms/1095-a` - 1095-A form submission endpoint
  - Validates API key with `health-insurance` business line access
  - Implements duplicate checking (email and phone)
  - Stores consent data with full audit trail
  - Auto-populates broker information
  - Creates inbox notifications
  - Returns `409 Conflict` for duplicate leads with existing client details

**Backend Routes** (`crm/server/src/routes/clients.ts`):
- `DELETE /api/clients/:id` - Enhanced to cascade delete notifications and appointments

**Backend Routes** (`crm/server/src/routes/client-portal.ts`):
- `GET /api/client-portal/health-insurance` - Enhanced to filter 1095-A leads without plans
- Checks for actual plan data existence before displaying
- Sets `hasHealthInsurance: false` for 1095-A leads without plans

**Backend Routes** (`crm/server/src/routes/api-keys.ts`):
- `PUT /api/api-keys/:id` - Update API key with edit functionality

**Frontend Updates** (`crm/client/src/pages/ClientDetailPage.tsx`):
- Added "Covered California Consumer Delegation" section
- Conditional rendering based on `lead_type === '1095-a-lead'`
- Displays consent checkboxes with status and timestamps
- Shows signature with type badge
- Positioned above Classification section

**Frontend Updates** (`crm/client/src/pages/ApiSettingsPage.tsx`):
- Added Edit button and modal for API keys
- Edit functionality for key name and business line permissions
- Updated `getEndpointUrls` to include 1095-A endpoint

**Frontend Updates** (`crm/client/src/lib/api.ts`):
- Updated `Client` interface to include `'1095-a-lead'` as valid `lead_type`

**Database Schema**:
- Uses existing `clients` table with `form_submission_data` JSONB field
- Stores consent data structure:
  ```json
  {
    "1095-a-retrieval": {
      "formType": "1095-a-retrieval",
      "delegationConsents": {
        "consent1_accessPII": { "granted": true, "timestamp": "...", "ipAddress": "...", "userAgent": "..." },
        "consent2_endPartnership": { ... },
        "consent3_paymentInfo": { ... },
        "consent4_agentOfRecord": { ... }
      },
      "esignConsent": { "granted": true, "timestamp": "...", "ipAddress": "...", "userAgent": "..." },
      "signature": "...",
      "signatureType": "type|draw|upload",
      "submittedAt": "...",
      "planSelections": { "broker": { ... } }
    }
  }
  ```

**Integration Points**:
- **Marketing Site Forms**: 1095-A form submissions via API endpoint
- **CRM Inbox**: New lead notifications for 1095-A leads
- **Client Detail Page**: Covered California Consumer Delegation section display
- **Client Portal**: Plan filtering for 1095-A leads
- **API Key Management**: Edit functionality for business line permissions
- **Audit Logging**: HIPAA-compliant PHI access logging

**Key Issues Resolved**:
- ‚úÖ **404 Error for 1095-A Endpoint**: Added `requireBusinessLineAccess('health-insurance')` middleware
- ‚úÖ **API Key Edit Missing**: Implemented edit functionality in ApiSettingsPage
- ‚úÖ **Covered California Section Not Showing**: Fixed data structure mismatch (backend stores nested under '1095-a-retrieval' key)
- ‚úÖ **Frontend Build Errors**: Fixed TypeScript error in DirectMailPage.tsx (missing ternary else clause)
- ‚úÖ **Client Portal Showing Default Plans**: Added filtering to prevent "Ambetter Health" display for 1095-A leads without plans
- ‚úÖ **Client Deletion Not Cleaning Inbox**: Added cascade deletion for notifications and appointments

**Files Created/Modified**:
- `crm/server/src/routes/public-forms.ts` (MODIFIED) - Added 1095-A endpoint with consent capture
- `crm/server/src/routes/clients.ts` (MODIFIED) - Added cascade deletion for notifications and appointments
- `crm/server/src/routes/client-portal.ts` (MODIFIED) - Added 1095-A lead filtering for plan display
- `crm/server/src/routes/api-keys.ts` (MODIFIED) - Added PUT endpoint for API key updates
- `crm/client/src/pages/ClientDetailPage.tsx` (MODIFIED) - Added Covered California Consumer Delegation section
- `crm/client/src/pages/ApiSettingsPage.tsx` (MODIFIED) - Added edit functionality for API keys
- `crm/client/src/lib/api.ts` (MODIFIED) - Added '1095-a-lead' to Client interface
- `crm/client/src/pages/marketing/DirectMailPage.tsx` (MODIFIED) - Fixed TypeScript ternary error
- `crm/docs/1095-A_FORM_INTEGRATION.md` (CREATED) - Marketing agent integration guide (see [[1095-A Form Integration Documentation]])
- `crm/docs/1095-A_SIGNATURE_SECURITY.md` (CREATED) - Signature format security analysis (see [[1095-A Signature Security Analysis]])
- `crm/server/src/scripts/check-api-key-permissions.ts` (MODIFIED) - Enhanced to check health-insurance business line access
- `crm/server/src/scripts/update-health-insurance-api-key.ts` (CREATED) - Script to update API keys with health-insurance permission
- `crm/server/src/scripts/test-1095-a-endpoint.ts` (CREATED) - Testing script for 1095-A endpoint
- `crm/client/src/pages/marketing/BrevoEmailCampaignPage.tsx` (CREATED) - Brevo email campaign placeholder page (future integration)
- `crm/client/src/pages/marketing/MailchimpEmailCampaignPage.tsx` (CREATED) - Mailchimp email campaign placeholder page (future integration)
- `crm/client/src/App.tsx` (MODIFIED) - Added routes for Brevo and Mailchimp email campaign pages

**Documentation**:
- Created comprehensive integration guide for marketing agents
- Documented API endpoint, request format, and response handling
- Included duplicate error response format for marketing site handling
- Security analysis of signature formats with recommendations

**Related Epic**: [[Epic 1: Core CRM Foundation]]

---

**2025-12-23 - Epic 23: Lob Direct Mail System Complete**

**Status**: ‚úÖ Complete

**Related Epic**: [[Epic 23: Lob Direct Mail System]]

**Overview**:
Comprehensive direct mail campaign management system fully implemented and production-ready. Enables insurance agents to create, schedule, and track physical mail campaigns (letters, postcards, checks) using Lob.com API integration.

**Key Features Implemented**:

1. **Campaign Management**:
   - Full CRUD operations for campaigns
   - Campaign scheduling with automatic processing
   - Client selection (multi-select from CRM)
   - Template association for reusable content
   - Check amount support for check mailings
   - Status tracking (draft ‚Üí scheduled ‚Üí sending ‚Üí completed/cancelled)

2. **Template System**:
   - Create/edit/delete reusable HTML templates
   - Support for letters, postcards, and checks
   - Template variable replacement (`{{variable}}` and `{variable}` formats)
   - Template preview with sample data
   - Template selection during campaign creation

3. **Address Verification**:
   - Single address verification via Lob API
   - Bulk address verification (CSV upload or manual entry)
   - Address standardization and deliverability checking
   - Results export functionality

4. **Mailing Management**:
   - Individual mailing CRUD (edit/delete draft mailings)
   - Automatic mailing creation from selected clients
   - Status tracking (draft ‚Üí pending ‚Üí in_transit ‚Üí delivered ‚Üí returned/failed)
   - Cost tracking per mailing
   - Tracking number support

5. **Response Tracking**:
   - Mark delivered mailings as responded
   - Response date tracking
   - Response rate calculation in analytics
   - Campaign response count aggregation

6. **Webhook Integration**:
   - Lob webhook endpoint for delivery status updates
   - Signature verification for security
   - Automatic status updates (rendered, in_transit, delivered, returned, failed)
   - Comprehensive logging

7. **Analytics Dashboard**:
   - Total sent, delivered, returned, failed counts
   - Delivery rate calculation
   - Response rate calculation
   - Cost tracking (total and average per mail)
   - Performance metrics by mail type

8. **Settings Management**:
   - User-specific direct mail preferences
   - Auto-verify addresses toggle
   - Default mail type selection
   - Default from address configuration
   - Cost alert threshold
   - Tracking and response tracking toggles

**Issues Resolved**:

1. **400 Errors on Read-Only Endpoints**:
   - **Issue**: GET endpoints for campaigns, mailings, and analytics returned 400 errors when Lob API not configured
   - **Fix**: Removed `checkLobConfigured()` guard from read-only endpoints, allowing users to view existing data even without full Lob configuration
   - **Impact**: Users can now view campaigns and mailings even if Lob API keys are not set up

2. **Template Variable Replacement**:
   - **Issue**: Templates needed variable replacement for dynamic content
   - **Fix**: Implemented `replaceTemplateVariables` function supporting both `{{variable}}` and `{variable}` formats
   - **Impact**: Templates can now use dynamic data (firstName, lastName, agentName, companyName, etc.)

3. **Check Amount Validation**:
   - **Issue**: Check mailings required amount but validation was missing
   - **Fix**: Added validation in campaign creation and sending endpoints to ensure check amounts are positive
   - **Impact**: Prevents sending checks without amounts

4. **Campaign Status Management**:
   - **Issue**: Campaign status transitions needed proper handling
   - **Fix**: Implemented proper status flow (draft ‚Üí scheduled ‚Üí sending ‚Üí completed/cancelled) with scheduler integration
   - **Impact**: Campaigns automatically process when scheduled_date arrives

5. **Webhook Signature Verification**:
   - **Issue**: Webhook endpoint needed security verification
   - **Fix**: Implemented Lob webhook signature verification using `LOB_WEBHOOK_SECRET`
   - **Impact**: Only legitimate Lob webhooks are processed

6. **Response Rate Calculation**:
   - **Issue**: Analytics response_rate was undefined
   - **Fix**: Updated analytics query to include `total_responded` and calculate `response_rate = (total_responded / total_delivered) * 100`
   - **Impact**: Accurate response rate tracking in analytics dashboard

**Technical Decisions**:

- **Direct SQL Approach**: Used direct Neon SQL queries (no ORM) for database operations, consistent with [[TD-001: Direct SQL Queries (No ORM)]]
- **Scheduler Pattern**: Implemented background scheduler (`directMailScheduler.ts`) that runs every 5 minutes to process scheduled campaigns
- **Template Processing**: Server-side template variable replacement using `templateProcessor.ts` service
- **Webhook Security**: Lob webhook signature verification for all incoming webhook requests
- **Status Tracking**: Comprehensive status tracking for both campaigns and individual mailings

**Database Schema**:

- `direct_mail_campaigns`: Campaign metadata, status, scheduling, template association
- `direct_mail_mailings`: Individual mailing records with recipient info, status, tracking, costs
- `direct_mail_templates`: Reusable HTML templates with variable support
- `direct_mail_settings`: User-specific preferences and configuration

**Files Created/Modified**:

- `crm/server/src/services/lobService.ts` (NEW) - Lob API integration service
- `crm/server/src/routes/marketing.ts` (MODIFIED) - Added direct mail API endpoints
- `crm/server/src/services/directMailScheduler.ts` (NEW) - Campaign scheduler
- `crm/server/src/db/init-db.ts` (MODIFIED) - Added direct mail tables
- `crm/client/src/pages/marketing/DirectMailPage.tsx` (NEW) - Full UI implementation
- `crm/client/src/pages/MarketingPage.tsx` (MODIFIED) - Added "Lob Direct Mail" card
- `crm/client/src/App.tsx` (MODIFIED) - Added route for direct mail page
- `.env.local` (MODIFIED) - Added Lob API keys

**Integration Points**:

- **Lob.com API**: Full integration for address verification, sending mailings, and webhook handling
- **CRM Clients**: Integration with client data for recipient selection
- **Template Processor**: Reuses existing template variable replacement service

**UI/UX Documentation:**
- Comprehensive UI/UX features documented in Epic 23 section
- All tab interfaces, modals, filters, and user interactions detailed
- Search, filtering, and bulk operations fully documented

**Next Steps** (Future Enhancements):

- Template preview improvements (live preview with actual client data)
- Export functionality (CSV export for mailings and analytics)
- Cost estimation before sending
- Campaign performance insights and visualizations
- A/B testing for templates

**Related Epic**: [[Epic 23: Lob Direct Mail System]]

---

**2025-01-27 - PRD Supercharged: Comprehensive Documentation Enhancements**

**Status**: ‚úÖ Complete

**Overview**:
Major PRD enhancements to improve navigation, understanding, and agent usability. Added 8 comprehensive sections covering epic dependencies, technical decisions, database schema, API endpoints, business line features, integrations, and component library.

**Key Additions**:

1. **Epic Dependency Graph** (Executive Summary):
   - Visual Mermaid diagram showing relationships between all 22 epics
   - Color-coded by status (Complete, In Progress, Future)
   - Solid/dashed arrows for dependencies
   - Quick Status Overview table with dependency links

2. **Foam Wikilinks Integration** (Throughout PRD):
   - Added wikilinks (`[[Epic N: Title]]`) to all epic references
   - "Related Epics" sections added to all epic definitions
   - Story files updated with epic wikilinks
   - Cross-references between stories and epics
   - Created `.ai/.foam/templates/story-template.md` for future stories
   - Updated rules to enforce wikilink usage

3. **Technical Decision Log** (Section 10):
   - 12 key architectural decisions documented
   - Each decision includes: Context, Alternatives, Rationale, Related Epics, Date, Status
   - Decisions: Direct SQL (no ORM), Multi-provider AI, 3-Database Architecture, Mantine UI, Next.js Portal, Two-Level Connectors, Sequential SOA Signing, Business Line-Aware Architecture, Hybrid AI+Scripts, etc.

4. **Database Schema Reference** (Section 11):
   - 81 tables cataloged and organized by functional area
   - Each table includes: Purpose, Key Fields, Related Epics
   - Functional areas: Client Management, User/Agent, Appointments, Communications, Financial, Client Portal, Calendar/Booking, Docusend, Autopilot, Marketing Ads, Health/Insurance, System/Config, AI/Learning, Analytics/Tracking
   - Key relationships summary, business line awareness, multi-tenant architecture notes

5. **API Endpoint Index** (Section 12):
   - 100+ API endpoints documented
   - Organized by functional area (Authentication, Client Management, Conversations & AI, Calendar, Client Portal, Docusend, Marketing Ads, Health Insurance, Business Lines, Commissions, Connectors, API Keys, Data Updates, Dashboard, Notifications, Profile, Portal Config, Reviews, Public Forms, Email Tracking, System)
   - Each endpoint includes: HTTP Method, Full Path, Authentication Requirements, Description, Related Epics
   - Quick reference by epic, authentication patterns, rate limiting, error responses

6. **Business Line Feature Matrix** (Section 13):
   - 5 business lines mapped to 30+ features
   - Feature matrix table showing support level (‚úÖ Full, ‚ö†Ô∏è Partial, ‚ùå Not Supported)
   - Business line-specific features documented (Medicare SOA, Health Insurance data, etc.)
   - Business line awareness patterns (database, API, UI)
   - Fully business line-aware epics identified
   - Quick reference by business line

7. **Integration Points Map** (Section 14):
   - 20+ external service integrations documented
   - Organized by category: Communication (Twilio, SendGrid), AI Services (OpenAI, Gemini), Payment (Stripe), E-Signature (Docusend), Calendar (Google, Outlook), Marketing Ads (8 platforms), Data Services (CMS API, Vericred), Storage (AWS S3), Postal Mail (PostGrid)
   - Each integration includes: Purpose, Configuration, Status, Related Epics
   - Webhook endpoints documented
   - Environment variables reference
   - Integration status by epic

8. **Component Library Index** (Section 15):
   - 20+ reusable React components documented
   - Organized by functional area: Layout, Communication, Client Management, Calendar, Marketing, E-Signature, Shared/Utility, UI Extensions
   - Each component includes: File Path, Purpose, Props Interface, Related Epics
   - Component usage patterns, dependencies, organization structure
   - Development guidelines for creating new components

**Files Modified**:
- `.ai/prd.md` - Added 8 major sections, updated version to 1.33
- `.ai/epic-3/story-3.1.story.md` - Added Foam wikilinks
- `.ai/epic-3/story-3.2.story.md` - Added Foam wikilinks
- `.ai/autopilot-*.md` - Updated epic references to wikilinks
- `.cursor/rules/100-prd-editing.mdc` - Updated to require Foam wikilinks
- `.cursor/rules/801-workflow-agile.mdc` - Updated story creation to use wikilinks
- `.cursor/rules/100-foam-wikilinks.mdc` - New rule file for wikilink enforcement
- `.ai/.foam/templates/story-template.md` - New template with wikilink patterns

**Impact**:
- ‚úÖ PRD now serves as comprehensive reference for AI agents
- ‚úÖ Improved navigation with Foam wikilinks and graph view
- ‚úÖ Complete system documentation in one place
- ‚úÖ Better understanding of dependencies and relationships
- ‚úÖ Easier discovery of components, APIs, and integrations

**Related Epics**: All epics (documentation enhancement affects entire system)

---

**2025-01-27 - Inbox UI/UX Improvements - Navigation, Leads Table, Voicemail Actions**

**Status**: ‚úÖ Complete

**Overview**:
Comprehensive improvements to the Inbox page including navigation bar styling fixes, leads table enhancements, and voicemail action buttons for better user experience and workflow efficiency.

**Key Changes**:

1. **Navigation Bar Improvements**:
   - Fixed active NavLink text color in light theme (changed from white to dark #1a1a1a for better contrast)
   - Fixed Inbox counter badge visibility and text color when selected
   - Badge now hidden when navigation drawer is collapsed
   - Badge text color set to white when Inbox link is active for better contrast
   - Updated CSS overrides in `index.css` and `mantis-overrides.css` to handle "mantine to mantis" class translation
   - Added comprehensive CSS rules with `!important` flags for robust styling

2. **Leads Table Enhancements**:
   - Changed "Source" column header to "Lead Type"
   - Removed "Email" column
   - Added "State" column (fetched from clients table)
   - Updated table columns: First Name, Last Name, Phone, State, Lead Type, Status, Actions
   - Added phone icon (green `IconPhoneCall`) in Actions column for dialing out
   - Status badge now shows actual client status (lead/active/inactive) instead of hardcoded "LEAD"
   - Updated backend API to fetch `phone`, `state`, and `status` from clients table

3. **Voicemail Table Improvements**:
   - Added voicemail icon (blue `IconVolume`) for playing voicemail recordings
   - Added phone icon (green `IconPhoneCall`) for calling leads from voicemails
   - Icons open Call Manager with pre-filled phone number and client data
   - Removed clickable row behavior - only action icons are clickable
   - Badge counter hidden when navigation drawer is collapsed
   - Improved visual feedback with tooltips on action icons

4. **Backend Updates**:
   - Updated `/api/notifications` endpoint to include `phone`, `state`, and `status` fields from clients table
   - Enhanced `openCallManager` event handling in Layout component to accept phone number and client ID
   - Call Manager now pre-fills with voicemail/lead phone numbers when opened from inbox

**Files Modified**:
- `crm/client/src/components/Layout.tsx` - Navigation styling and Call Manager integration
- `crm/client/src/pages/InboxPage.tsx` - Leads and voicemail table improvements
- `crm/client/src/index.css` - CSS overrides for NavLink and badge styling
- `crm/client/src/mantis-overrides.css` - Mantis design system overrides
- `crm/server/src/routes/notifications.ts` - Backend API to include additional client fields

**Issues Fixed**:
- ‚úÖ Active NavLink text unreadable in light theme (white on light blue)
- ‚úÖ Inbox counter badge number not visible when selected
- ‚úÖ Badge showing when navigation drawer collapsed
- ‚úÖ Leads table missing state information
- ‚úÖ No quick action to call leads from inbox
- ‚úÖ No quick action to play voicemails from inbox
- ‚úÖ Voicemail rows too clickable (opened recording on any click)

**Technical Details**:
- Used Mantine `ActionIcon` and `Tooltip` components for action buttons
- Implemented `useCallContext` hook for Call Manager integration
- Enhanced event system for passing phone numbers and client IDs to Call Manager
- CSS specificity improvements with attribute selectors for robust class matching
- TypeScript interface updates to include new client fields

**2025-12-21 - Applications Page Route Fix & Back Navigation Buttons**
- Fixed blank applications page by adding missing route in App.tsx
- Added `/applications` route for ApplicationsPage component
- Added `/applications/call-manager` route for CallManagerSettingsPage
- Added "Back to Applications" navigation buttons to all application pages:
  * Call Manager Settings (`/applications/call-manager`)
  * Docusend Settings (`/settings/docusend`)
  * Calendar (`/settings/calendar`)
  * API Settings (`/settings/api`)
  * Portal Settings (`/settings/portal`)
- Fixed TypeScript build errors in LinkedInAdsPage:
  * Added missing `loadMediaAssets` function
  * Removed duplicate `toggleAdSetExpansion` function
  * Added `Image` component import from Mantine
  * Added `type` property to `LinkedInAdSet` interface
  * Fixed ternary expression syntax error
- All changes committed and deployed to both dev and main branches

**2025-01-13 - Project Foundation**
- Initial PRD created with all 10 sections
- Epics defined based on current project state
- Stories created for Epic 3 (Client Portal)
- Fixed plan recommendations status (Section 4.1) - marked as partial, not complete
- Updated technology stack (Section 5.1) - removed React Query, React Hook Form; confirmed Mantine Form
- Fixed API endpoints (Section 5.3) - corrected AI endpoints to match actual implementation
- Added baseline metrics note (Section 1.3) - marked metrics as aspirational with current accuracy noted
- Added "Complete" definition clarification (Section 6) - clarified what "Complete" means for epics
- Updated Epic 3 status to "Partial" - backend API complete, frontend pending

**2025-01-15 - Client Portal Authentication Fixes**
- Fixed 401 Unauthorized errors during impersonation flow
- Root cause: Stale tokens in localStorage from previous sessions not existing in database
- Added token storage verification before URL cleanup
- Added automatic token clearing on 401 errors with token-related messages
- Improved token monitoring to check localStorage directly (not URL) to avoid race conditions
- Fixed navigation redirects - prevents redirects to login when navigating between portal pages
- Added authState ref tracking to avoid closure issues in timeout callbacks
- Enhanced error logging for better debugging of authentication failures
- Token monitoring interval increased from 500ms to 1000ms to reduce race conditions
- Redirect logic now respects authState and impersonation tokens in URL

**2025-01-28 - Server Stability Fixes (502 Bad Gateway Resolution)**
- Fixed duplicate code blocks causing server crashes across 20+ files
- Removed duplicate function definitions in routes, services, utils, and middleware
- Fixed JSDoc comment blocks missing opening `/**` tags in multiple files
- Fixed dayjs plugin imports to include `.js` extensions for ES modules
- Added missing `publicBookingRouter` export in calendar.ts
- Server now running successfully with health endpoint responding
- Files fixed: index.ts, connection.ts, init-db.ts, csrf.ts, auth.ts, clients.ts, calls.ts, ai.ts, apiKeys.ts, calendar.ts, commissions.ts, conversations.ts, profile.ts, utils/auth.ts, services/adminSessionService.ts, services/callService.ts, services/conflictDetection.ts, services/recurringAppointments.ts, services/appointmentReminders.ts

**2025-01-28 - Georgia Health Insurance Data Collection Plan**
- Created comprehensive plan for Georgia On-Exchange health insurance data collection
- Plan includes: carriers, plan names, metal tiers, plan types, member services phone numbers
- ZIP code and FIPS code mapping using HUD API (bulk download, API as updater)
- Summary of Benefits PDF collection (API first, then scrape from carriers or georgiaaccess.gov)
- S3 storage and client portal document integration
- Plan document: `crm/docs/GEORGIA_HEALTH_INSURANCE_PLAN.md`
- Uses CMS Marketplace API key for On-Exchange plans
- Uses HUD ZIP Code API key for ZIP code and FIPS code mapping
- Focus: On-Exchange plans only for initial implementation

**Recent Developments (Documented in `.ai/CHANGELOG.md`)**
- API key security enhancements
- Client portal impersonation fixes
- Portal logo CORS fixes
- Email template configuration improvements
- Portal settings UI improvements
- Broker page and profile enhancements
- CSRF protection improvements
- GiveMe5.ai integration
- Health insurance onboarding email functionality

**Marketing Page Redesign**
- Replaced insurance line-of-business cards (Medicare, Health Insurance, Life Insurance, Group Benefits, Commercial) with marketing channel cards
- Added 12 marketing channel cards: Google Ads, Facebook Ads, Email Campaign, SEO, Social Media, Reviews, Content Marketing, Referral Program, Direct Mail, Retargeting, YouTube Ads, LinkedIn Ads
- Updated page description to reflect marketing channel focus instead of product focus

**Connectors Page Enhancement**
- Added all external API providers to Connectors page (11 new providers + existing GiveMe5.ai)
- Providers added: SendGrid (Email), Stripe (Payments), Twilio (Phone/SMS), CMS API (Federal Marketplace), AWS S3 (Storage), ElevenLabs (Voice AI), OpenAI (AI Fallback), Google Gemini (AI Primary), PostGrid (Direct Mail), Healthcare.gov (Marketplace API)
- Created backend endpoint `/api/connectors/status` to check API configuration status
- Each provider section displays: configuration status (Configured/Not Configured), service description, required environment variables, and setup notes
- Removed Vericred API (not used)

**2025-12-19 - Facebook Ads Integration Complete (Epic 14)**
- **Comprehensive Facebook Marketing API Integration**: Full OAuth connection, campaign/ad set/ad management, lead import, analytics dashboard
- **OAuth & Account Management**: Secure Facebook account connection via OAuth 2.0, token management with auto-refresh, account selection
- **Campaign Management**: Full CRUD operations, status management, budget configuration, performance metrics, search/filter, bulk operations
- **Ad Set Management**: Full CRUD operations, targeting configuration, billing events, optimization goals, bid strategies, scheduling
- **Ad Management**: Full CRUD operations, comprehensive ad creation form (Facebook Ads Manager-style), direct image/video upload, creative management
- **Lead Import**: Automatic lead import with business line categorization (5 business lines), autopilot mode support (Medicare `pending_soa` status)
- **Analytics Dashboard**: Performance metrics with charts (Line, Bar, Pie), date range filtering, campaign/ad set/ad level analytics
- **Media Upload**: Direct image/video upload to Facebook with automatic hash/ID retrieval, image preview, upload progress indicators
- **Rate Limiting**: Exponential backoff retry logic, sequential API processing, frontend queue system, graceful error handling
- **UI/UX Improvements**: Status icons (green/red circles), expandable rows, search/filter, bulk operations, performance metrics columns
- **Issues Fixed**: OAuth configuration, campaign/ad set creation errors, ad creative requirements, rate limiting, ad set display, TypeScript errors
- **Production Deployment**: All features tested and working in production environment
- **Files**: `facebookMarketingService.ts`, `marketing.ts` routes, `FacebookAdsPage.tsx`, documentation files

**2025-11-27 - Calendar Scheduling System Complete (Epic 7)**
- **Production Deployment & Issue Resolution**: Complete calendar scheduling system deployed to production
- **Database Schema Completion**: All required tables created (booking_page_questions, booking_page_event_types, master_pages, master_page_event_types)
- **Backend API Fixes**: Corrected column name mismatches (bp.name ‚Üí bp.title, duration ‚Üí default_duration_minutes)
- **Authentication Integration**: Added authenticate middleware to all calendar API routes
- **CSRF Protection**: Implemented CSRF token validation for all calendar operations
- **Frontend State Management**: Fixed form state isolation preventing duration changes affecting all event types
- **Event Type Management**: Complete CRUD operations with proper field mapping and validation
- **Booking Pages System**: Full booking page management with client-facing access
- **Master Pages Support**: Administrative page templates for booking organization
- **Error Resolution**: Fixed 500 errors, database relationship issues, and frontend API integration
- **Production Testing**: All calendar features verified working in production environment

---

## Appendix
  - Fixed 401 Unauthorized errors during impersonation flow
  - Root cause: Stale tokens in localStorage from previous sessions not existing in database
  - Added token storage verification before URL cleanup
  - Added automatic token clearing on 401 errors with token-related messages
  - Improved token monitoring to check localStorage directly (not URL) to avoid race conditions
  - Fixed navigation redirects - prevents redirects to login when navigating between portal pages
  - Added authState ref tracking to avoid closure issues in timeout callbacks
  - Enhanced error logging for better debugging of authentication failures
  - Token monitoring interval increased from 500ms to 1000ms to reduce race conditions
  - Redirect logic now respects authState and impersonation tokens in URL
- **2025-01-28**: Server Stability Fixes - Resolved 502 Bad Gateway Errors:
  - Fixed duplicate code blocks causing server crashes across 20+ files
  - Removed duplicate function definitions in routes, services, utils, and middleware
  - Fixed JSDoc comment blocks missing opening `/**` tags in multiple files
  - Fixed dayjs plugin imports to include `.js` extensions for ES modules
  - Added missing `publicBookingRouter` export in calendar.ts
  - Server now running successfully with health endpoint responding
  - Files fixed: index.ts, connection.ts, init-db.ts, csrf.ts, auth.ts, clients.ts, calls.ts, ai.ts, apiKeys.ts, calendar.ts, commissions.ts, conversations.ts, profile.ts, utils/auth.ts, services/adminSessionService.ts, services/callService.ts, services/conflictDetection.ts, services/recurringAppointments.ts, services/appointmentReminders.ts
- **2025-01-28**: Georgia Health Insurance Data Collection Plan:
  - Created comprehensive plan for Georgia On-Exchange health insurance data collection
  - Plan includes: carriers, plan names, metal tiers, plan types, member services phone numbers
  - ZIP code and FIPS code mapping using HUD API (bulk download, API as updater)
  - Summary of Benefits PDF collection (API first, then scrape from carriers or georgiaaccess.gov)
  - S3 storage and client portal document integration
  - Plan document: `crm/docs/GEORGIA_HEALTH_INSURANCE_PLAN.md`
  - Uses CMS Marketplace API key for On-Exchange plans
  - Uses HUD ZIP Code API key for ZIP code and FIPS code mapping
  - Focus: On-Exchange plans only for initial implementation
- **2025-01-XX**: Recent work documented in `.ai/CHANGELOG.md` including:
  - API key security enhancements
  - Client portal impersonation fixes
  - Portal logo CORS fixes
  - Email template configuration improvements
  - Portal settings UI improvements
  - Broker page and profile enhancements
  - CSRF protection improvements
  - GiveMe5.ai integration
  - Health insurance onboarding email functionality
- **2025-01-XX**: Marketing Page Redesign:
  - Replaced insurance line-of-business cards (Medicare, Health Insurance, Life Insurance, Group Benefits, Commercial) with marketing channel cards
  - Added 12 marketing channel cards: Google Ads, Facebook Ads, Email Campaign, SEO, Social Media, Reviews, Content Marketing, Referral Program, Direct Mail, Retargeting, YouTube Ads, LinkedIn Ads
  - Updated page description to reflect marketing channel focus instead of product focus
- **2025-01-XX**: Connectors Page Enhancement:
  - Added all external API providers to Connectors page (11 new providers + existing GiveMe5.ai)
  - Providers added: SendGrid (Email), Stripe (Payments), Twilio (Phone/SMS), CMS API (Federal Marketplace), AWS S3 (Storage), ElevenLabs (Voice AI), OpenAI (AI Fallback), Google Gemini (AI Primary), PostGrid (Direct Mail), Healthcare.gov (Marketplace API)
  - Created backend endpoint `/api/connectors/status` to check API configuration status
  - Each provider section displays: configuration status (Configured/Not Configured), service description, required environment variables, and setup notes
  - Removed Vericred API (not used)
  - All providers show read-only status (configured via environment variables, not UI)
- **2025-01-XX**: Marketing Form Lead Email Automation:
  - Added automatic email sending for health insurance form submissions with "Form Lead" lead type
  - When a lead is submitted through the marketing form with `leadType: 'Form Lead'`, the system automatically sends the Marketing Form Lead email template
  - Email is sent after client record is created/updated in the database
  - Uses template-specific `healthInsuranceLeadFromName` if configured, otherwise falls back to global fromName
  - Only sends if template ID is configured (portal config or environment variable)
  - Email sending failures do not block form submission (graceful error handling)
  - Comprehensive logging added for debugging email sending process
- **2025-01-XX**: Client Portal Broker Information Update:
  - Removed "Referral Source" field from client portal broker information section
  - Referral source is still stored in database and visible in CRM admin interface
  - Client portal now only displays: Broker Name, Company Name, Email, Phone, NPN, License Number, License State
  - Improves client-facing UI by hiding internal tracking information
- **2025-01-XX**: Review Management System Implementation (Epic 6):
  - Complete custom review management system implemented to replace GiveMe5.ai
  - Phase 1: Core sending infrastructure (email/SMS services, template processing)
  - Phase 2: API endpoints for review requests, templates, configuration, statistics, integrations
  - Phase 3: Public review submission page with token-based access
  - Phase 4: Automation triggers for client creation/status changes, background scheduler
  - Phase 5: Frontend integration (6 tabs: Dashboard, My Reviews, Private Feedback, Get Reviews, Integrations, Settings)
  - Fixed 12+ issues during implementation including SQL query errors, CSP blocking, URL persistence, toggle state, integration status display
  - All features tested and working in production
  - System fully operational for sending review invitations, tracking submissions, and managing review requests
- **2025-01-20**: Calendar Scheduling System Plan (Epic 7):
  - Deep analysis of OnceHub calendar scheduling features completed
  - Comprehensive implementation plan created with 5 phases
  - Database schema designed (5 tables: appointments, agent_availability, availability_overrides, calendar_sync, booking_pages)
  - API endpoints defined (20+ endpoints for calendar management, availability, sync, and booking pages)
  - Technical stack selected (FullCalendar/react-big-calendar, date-fns, googleapis, Microsoft Graph API)
  - Security considerations documented (token encryption, CSRF protection, rate limiting)
  - Estimated timeline: 7-8 weeks total across 5 phases
  - Ready for implementation when prioritized
- **2025-01-28**: Calendar Scheduling System Implementation (Epic 7 - Phases 1-3 Complete):
  - **Phase 1: Core Calendar Infrastructure** ‚úÖ Complete
    - Database tables created: `appointments`, `agent_availability`, `availability_overrides`, `calendar_sync`, `booking_pages`, `event_types`
    - Appointment CRUD endpoints implemented (`GET/POST/PUT/DELETE /api/calendar/appointments`)
    - Availability management endpoints (`GET/POST/PUT/DELETE /api/calendar/availability`)
    - Conflict detection service implemented (`checkConflicts`, `getBufferTime`)
    - Timezone handling utilities added
    - Frontend: 4-tab navigation system (Home, Settings, Integration, Booking Pages)
    - Frontend: Calendar UI components (CalendarView, AppointmentForm, AvailabilitySettings)
    - Frontend: Home tab with calendar view and appointment management
    - Frontend: Settings tab structure (profile, availability, email, licenses sections)
    - Frontend: Integration tab structure (calendar sync, video conferencing, Zapier, SMS sections)
    - Frontend: Booking Pages tab with three-panel layout (Event Types, Booking Pages, Master Pages)
  - **Phase 2: External Calendar Integration** ‚úÖ Complete
    - Google Calendar OAuth integration implemented (`/api/calendar/sync/google/authorize`, `/api/calendar/sync/google/callback`)
    - Outlook/Exchange OAuth integration implemented (`/api/calendar/sync/outlook/authorize`, `/api/calendar/sync/outlook/callback`)
    - Calendar sync service created (`googleCalendarService.ts`, `outlookCalendarService.ts`)
    - Two-way sync endpoints (`GET/POST /api/calendar/sync/status`, `POST /api/calendar/sync/:id/sync-now`)
    - Sync status tracking and management
    - Frontend: Integration tab with OAuth buttons and sync status display
    - Frontend: Manual sync trigger functionality
  - **Phase 3: Booking Pages & Client Access** ‚úÖ Complete
    - Booking page CRUD endpoints (`GET/POST/PUT/DELETE /api/calendar/booking-pages`)
    - Event types management (`GET/POST/PUT/DELETE /api/calendar/event-types`)
    - Public booking page endpoints (`GET /api/booking/:slug`, `POST /api/booking/:slug/book`)
    - Available slot calculation service
    - Lead qualification form processing
    - Email confirmations and reminders service (`appointmentReminders.ts`)
    - Recurring appointments service (`recurringAppointments.ts`)
    - Frontend: Event types management panel
    - Frontend: Booking pages list panel with create/edit/delete/duplicate
    - Frontend: Master pages panel
    - Frontend: Public booking page component (`PublicBookingPage.tsx`)
    - Frontend: Booking page builder UI
  - **Issues Fixed During Implementation**:
    - Fixed duplicate query line in availability endpoints
    - Added error handling for missing database tables
    - Fixed UPDATE queries to handle undefined values properly
    - Added migration to init-db for calendar tables
    - Created test scripts for calendar functionality
    - Fixed conflict detection edge cases
    - Improved timezone handling for recurring appointments
    - Fixed OAuth callback error handling
    - Enhanced appointment form validation
    - Fixed availability override logic
  - **Services Created**:
    - `conflictDetection.ts` - Conflict detection and buffer time logic
    - `recurringAppointments.ts` - Recurring appointment series management
    - `appointmentReminders.ts` - Email confirmations, reminders, and cancellations
    - Enhanced `googleCalendarService.ts` - Google Calendar OAuth and sync
    - Enhanced `outlookCalendarService.ts` - Outlook OAuth and sync
  - **Database Migrations**:
    - Created all calendar-related tables in `init-db.ts`
    - Added indexes for performance optimization
    - Added foreign key constraints for data integrity
  - **Status**: Phases 1-3 complete, Phase 4 (Advanced Features) and Phase 5 (AI & Automation) pending
- **2025-01-28**: Security Enhancements and Fixes:
  - **CSRF Protection Implementation**:
    - Implemented double-submit cookie pattern for CSRF protection
    - Added `csrfTokenMiddleware` and `csrfProtection` middleware
    - CSRF tokens required for all state-changing operations (POST, PUT, DELETE, PATCH)
    - API key requests excluded from CSRF (external API calls)
    - Token generation on GET requests, validation on state-changing requests
    - Frontend integration: `GET /api/csrf-token` endpoint for token retrieval
  - **API Key Security**:
    - API keys now hashed using bcrypt before storage (same security as passwords)
    - Plain text API keys never stored (only shown on creation)
    - Secure validation by comparing hashes
    - Migration script created for existing API keys (`migrate-api-keys-to-hash.ts`)
    - Prevents API key exposure if database is compromised
  - **Security Audit Fixes**:
    - Comprehensive security audit completed (November 2025)
    - Identified 8 critical issues, 5 high-priority issues, 12 medium-priority recommendations
    - Risk assessment document created (`SECURITY_FIXES_RISK_ASSESSMENT.md`)
    - Security audit report created (`SECURITY_AUDIT_REPORT.md`)
    - Prioritized fixes by risk level (High/Medium/Low)
    - Implementation plan created with phased approach
  - **Database Connection Improvements**:
    - Enhanced database connection handling in `connection.ts`
    - Improved error handling and retry logic
    - Better connection pool management
  - **Request ID Tracking**:
    - Added request ID middleware for error correlation
    - Request IDs included in logs and error responses
    - Improves debugging and error tracking
  - **Enhanced Authentication**:
    - Improved auth utility functions (`utils/auth.ts`)
    - Better token validation and error handling
    - Enhanced session management
  - **File Validation Improvements**:
    - Enhanced file validation utilities
    - Better MIME type checking
    - Improved file size validation
- **2025-01-28**: Client Portal Enhancements:
  - **Database Migrations**:
    - Created client portal tables migration (`003-create-client-portal-tables.sql`)
    - Added broker fields to users table (`004-add-broker-fields-to-users.sql`)
    - Added address fields migration (`003-add-address-fields.ts`)
  - **Component Updates**:
    - Enhanced `BrokerInfo.tsx` component
    - Updated `DentalPlanCard.tsx`, `VisionPlanCard.tsx`, `HealthPlanCard.tsx`
    - Improved `EnrolledMembers.tsx` component
    - Enhanced `CollapsibleSection.tsx` and `AdsPanel.tsx` components
  - **Authentication Improvements**:
    - Updated `LoginForm.tsx` and `VerifyToken.tsx` components
    - Enhanced authentication flow
    - Improved error handling and user feedback
- **2025-01-28**: Service and Route Enhancements:
  - **Calendar Services**:
    - Enhanced `googleCalendarService.ts` with OAuth and sync functionality
    - Enhanced `outlookCalendarService.ts` with OAuth and sync functionality
    - Created `conflictDetection.ts` service for appointment conflicts
    - Created `recurringAppointments.ts` service for recurring appointment series
    - Created `appointmentReminders.ts` service for email notifications
  - **Call Service Improvements**:
    - Enhanced `callService.ts` with better error handling
    - Improved call management functionality
  - **Commission Route Enhancements**:
    - Enhanced commission calculation and tracking
    - Improved commission reporting
  - **Client Route Improvements**:
    - Enhanced client management endpoints
    - Improved client search and filtering
  - **Conversation Route Updates**:
    - Enhanced conversation management
    - Improved conversation context handling
  - **Profile Route Enhancements**:
    - Enhanced profile management endpoints
    - Improved user profile updates
  - **AI Route Improvements**:
    - Enhanced AI service integration
    - Improved prompt optimization (`promptOptimizer.ts`)
    - Better error handling and retry logic
  - **Business Line Query Service**:
    - Enhanced `businessLineQueryService.ts` with better query handling
    - Improved multi-business line support
  - **Data Update Service**:
    - Enhanced `dataUpdateService.ts` with better validation
    - Improved data update handling
  - **S3 Service Improvements**:
    - Enhanced `s3Service.ts` with better error handling
    - Improved file upload and storage
  - **PostGrid Service Enhancements**:
    - Enhanced `postgridService.ts` with better integration
    - Improved direct mail functionality
  - **Portal Email Service**:
    - Enhanced `portalEmailService.ts` with better template handling
    - Improved email sending functionality
  - **Zip Code Mapping Service**:
    - Enhanced `zipCodeMappingService.ts` with better validation
    - Improved ZIP code mapping accuracy
- **2025-01-28**: Frontend Component Updates:
  - **Calendar Components**:
    - Enhanced `AppointmentForm.tsx` with better validation and error handling
    - Updated `AvailabilitySettings.tsx` with improved UI
    - Enhanced `CalendarView.tsx` with better display options
  - **Review Components**:
    - Updated `CustomOptionsTab.tsx`, `ReportsTab.tsx`, `WidgetsTab.tsx`
    - Improved review management UI
  - **Plan Selections**:
    - Enhanced `PlanSelections.tsx` component
    - Improved plan selection UI
  - **Calendar Pages**:
    - Updated `CalendarPage.tsx`, `HomeTab.tsx`, `IntegrationTab.tsx`, `BookingPagesTab.tsx`
    - Enhanced `PublicBookingPage.tsx` with better booking flow
  - **Manage Ads Page**:
    - Updated `ManageAdsPage.tsx` with improved functionality
- **2025-01-28**: Database and Migration Updates:
  - **Knowledge Source Feedback**:
    - Added Phase 22 knowledge feedback migration (`022-phase22-knowledge-feedback.ts`)
    - Enhanced knowledge source tracking
  - **Database Initialization**:
    - Enhanced `init-db.ts` with calendar table creation
    - Improved database initialization process
    - Better error handling for missing tables
  - **Connection Management**:
    - Enhanced database connection handling
    - Improved connection pool management
    - Better retry logic for connection failures
- **2025-01-29**: Epic 8 - Georgia Health Insurance Data Collection Implementation:
  - **Data Collection Complete**:
    - Implemented `sync-georgia-health-plans.ts` script for bulk plan data collection
    - Integrated CMS Marketplace API for On-Exchange plans
    - Integrated HUD ZIP Code API for ZIP code and FIPS code mapping
    - Implemented carrier filtering for 8 contracted carriers
    - Extracted and formatted member services phone numbers
    - Implemented PDF download and S3 storage for Summary of Benefits documents
    - Created helper scripts for carrier verification and phone number management
  - **UI Integration Updates**:
    - Removed CMS API dependency for Georgia carriers in frontend
    - Implemented static carrier list with hardcoded phone numbers
    - Changed Plan Name and Member Services Phone fields to text inputs
    - Implemented phone number auto-population on carrier selection
    - Added dropdown auto-close functionality
    - **TypeError Fix (Attempt 9 - 2025-01-29)**:
      - Removed `error` prop from Select components (was triggering Mantine form tracking)
      - Simplified Select rendering: Only render if structure exists (show loader if not)
      - Structure guaranteed to exist before Select renders (initialized by toggle handler)
      - Local state (`carrierSelectValues`) for Select `value` prop to prevent Mantine tracking
      - Enhanced phone number lookup: Always checks `GEORGIA_CARRIER_PHONES` static list using carrier name
      - `setCarrierValue` called in both `onChange` and `onOptionSubmit` to ensure phone numbers populate
    - Status: Testing latest fix - structure exists before Select renders, phone numbers auto-populate
  - **Files Modified**:
    - `crm/server/src/scripts/sync-georgia-health-plans.ts` (main sync script)
    - `crm/server/src/scripts/check-georgia-carriers.ts` (carrier verification)
    - `crm/server/src/scripts/check-georgia-carrier-phones.ts` (phone verification)
    - `crm/server/src/scripts/update-georgia-carrier-phones.ts` (phone updates)
    - `crm/server/src/scripts/add-missing-georgia-carriers.ts` (add missing carriers)
    - `crm/client/src/components/PlanSelections.tsx` (UI integration)
  - **Issues Fixed**:
    - Environment variable loading (DATABASE_URL not configured)
    - CMS API endpoint and request format (404 errors, HTML responses)
    - Invalid ZIP/FIPS errors (missing required fields)
    - Year handling (API only supports 2024, storing for 2025/2026)
    - PostgreSQL array insertion syntax
    - Carrier name mapping (API names vs contracted names)
    - Phone number formatting and auto-population
    - Plan name and member services phone field types
    - Dropdown closing behavior
    - Plans not appearing when selecting carrier (fixed carrier ID resolution)
    - Filtering by metal tier and network type (added database column, implemented filtering logic)
    - PDF download errors (handled HTTP 301 redirects, filtered non-English PDFs)
    - Missing metadata (created enhancement scripts, matched 2024 plans to 2025 plans)
    - Primary applicant auto-population (fixed last name truncation, DOB formatting)
- **2025-11-20**: Epic 8 - Georgia Plan Filtering, PDF Processing, and Metadata Enhancement:
  - **Plan Filtering Implementation**:
    - Added `network_type` column to `health_plans` table
    - Implemented filtering logic in frontend (`PlanSelections.tsx`) and backend API (`health-insurance.ts`)
    - Filtering works by metal tier (Bronze, Silver, Gold, Platinum) and network type (HMO, PPO, EPO, POS)
    - Filtering test script created (`test-georgia-plan-filtering.ts`) to verify logic
  - **PDF Processing**:
    - Created `extract-plans-from-centene-pdfs.ts` script to download Centene SBC PDFs for 2025 and 2026
    - Handled HTTP 301 redirects using `follow-redirects` package
    - Filtered out Spanish and non-English PDFs (comprehensive regex for 40+ language variants)
    - Processed 238 Ambetter PDFs and stored in S3
    - Created auto-update script (`auto-update-georgia-plans.ts`) for future processing
    - Created cron setup script (`setup-georgia-plans-cron.sh`) for scheduled updates
  - **Metadata Enhancement**:
    - Created `sync-and-enhance-metadata.ts` script to match 2024 CMS-synced plans (with metadata) to 2025 PDF-based plans (without metadata)
    - Key insight: 2025 plans are dated 2024, so matching works across years by extracting 7-digit plan IDs from `api_plan_id`
    - Enhanced 10 plans with metadata (8 Bronze HMO, 2 Silver HMO)
    - Created diagnostic script (`diagnose-plan-matching.ts`) to inspect plan differences
    - Created `enhance-plan-metadata.ts` script for direct CMS API lookup (not working - API doesn't match PDF plan IDs)
    - Created `sync-and-enhance-metadata.ts` as working alternative (matches existing CMS-synced plans)
  - **Primary Applicant Auto-Population**:
    - Added `useEffect` in `ClientFormPage.tsx` to auto-populate primary applicant name and DOB from client data
    - Fixed last name truncation by using explicit `value` and `onChange` handlers instead of `form.getInputProps`
    - Fixed DOB formatting using `formatDateInput` utility
    - Used `requestAnimationFrame` and `setTimeout` for proper timing
  - **Files Created**:
    - `crm/server/src/scripts/extract-plans-from-centene-pdfs.ts` - Centene PDF download and processing
    - `crm/server/src/scripts/auto-update-georgia-plans.ts` - Auto-update script for future PDFs
    - `crm/server/src/scripts/setup-georgia-plans-cron.sh` - Cron setup script
    - `crm/server/src/scripts/test-georgia-plan-filtering.ts` - Filtering test script
    - `crm/server/src/scripts/enhance-plan-metadata.ts` - Direct CMS API lookup (not working)
    - `crm/server/src/scripts/sync-and-enhance-metadata.ts` - Matching script (working)
    - `crm/server/src/scripts/diagnose-plan-matching.ts` - Diagnostic script
    - `crm/docs/GEORGIA_PLANS_AUTO_UPDATE.md` - Auto-update documentation
    - `crm/docs/GEORGIA_METADATA_ENHANCEMENT.md` - Metadata enhancement documentation
  - **Database Changes**:
    - Added `network_type` column to `health_plans` table
    - Updated queries in `health-insurance.ts` to include `network_type` in responses
  - **Status**: Epic 8 Complete - All core features implemented, 40 plans still need metadata (future enhancement)

---

## Appendix

### A. Current System Status

#### Completed Features (Epic 1 & 2)
- ‚úÖ Authentication & Security (JWT, refresh tokens, 14 security fixes)
- ‚úÖ Client Management (Full CRUD, phone search, dashboard)
- ‚úÖ Multi-Business Line Support (Medicare, Health Insurance, Life, Group Health, Commercial)
- ‚úÖ AI Field Extraction (28+ fields, 91.8%+ accuracy)
- ‚úÖ Real-Time Conversation Processing
- ‚úÖ Call Integration (Twilio)
- ‚úÖ AI Message Generation
- ‚úÖ Conversation Tracking

#### In Progress
- Calendar Scheduling System (Epic 7) - Phases 1-3 complete, Phase 4-5 pending
- Georgia Health Insurance Data Collection (Epic 8) - Data collection complete, UI integration blocked by TypeError

#### Planned
- Client Portal (Epic 3) - Backend complete, frontend in progress
- Multi-Tenant SaaS (Epic 4)
- Advanced Features (Epic 5)
- Calendar Scheduling System Phase 4-5 (Epic 7) - Advanced features and AI automation

### B. Key Documents
- **Architecture Overview**: `crm/ARCHITECTURE_OVERVIEW.md`
- **Project Build Guide**: `docs/PROJECT-BUILD.md`
- **Project Scope**: `docs/project-scope.md`
- **Client Portal Plan**: `client-portal-plan.md`
- **Multi-Tenant Plan**: `crm/MULTI_TENANT_IMPLEMENTATION_PLAN.md`
- **Review Management System Plan**: `.ai/review-management-system-plan.md`
- **Quick Reference**: `.ai/QUICK-REFERENCE.md`
- **Changelog**: `.ai/CHANGELOG.md`
- **Project Status**: `.ai/PROJECT-STATUS.md`
- **Legacy AI Setup**: `crm/AI_SETUP.md` (being consolidated)

### C. Technology Decisions

See [[Technical Decision Log]] (Section 10) for detailed decisions with rationale and alternatives.

**Quick Reference**:
- **No ORM**: Direct SQL queries ([[TD-001]])
- **3-Database Architecture**: Multi-tenant HIPAA compliance ([[TD-003]])
- **Gemini Primary**: 50% cost savings vs OpenAI ([[TD-002]])
- **Mantine UI**: Consistent design system ([[TD-004]])
- **Next.js for Portal**: Better SEO and performance ([[TD-005]])

### D. Navigation & Connectors Pattern

**Two-Level Connector Organization:**

1. **Connectors** (`/connectors` - Left Nav Link):
   - **Purpose**: System-wide infrastructure connectors used by multiple apps
   - **Examples**: SendGrid (email), Stripe (payments), CMS API (health insurance), AWS, PostGrid
   - **Location**: Left navigation ‚Üí "Connectors" link
   - **Use Case**: Account-level status checks, system configuration

2. **App-Specific Integrations** (Within App Settings):
   - **Purpose**: Connectors primarily used by one app, with app-specific configuration
   - **Examples**: 
     - Call Manager ‚Üí Integrations tab (Twilio webhooks, ElevenLabs for voicemail, AI providers)
     - Calendar ‚Üí Integration tab (Google Calendar, Outlook)
     - Marketing Ads ‚Üí Connection tab (OAuth for each platform)
   - **Location**: Within each app's settings page (e.g., `/applications/call-manager` ‚Üí Integrations tab)
   - **Use Case**: App-specific configuration, webhooks, OAuth setup

**Decision Rule:**
- **Connectors Page**: If connector is used by 2+ apps OR is infrastructure-level ‚Üí Add to `/connectors` page
- **App Integrations**: If connector is primarily for one app ‚Üí Add to that app's settings page

**Examples:**
- ‚úÖ Twilio: In both (system status in Connectors, webhooks in Call Manager Integrations)
- ‚úÖ SendGrid: Only in Connectors (used by multiple apps)
- ‚úÖ ElevenLabs: Only in Call Manager Integrations (only used for voicemail)
- ‚úÖ Google Ads OAuth: Only in Marketing Ads Connection tab (app-specific)


### Epic 22: IVR (Interactive Voice Response) System

**Status**: ‚è≥ **Future**  
**Priority**: P2 (Medium)  
**Business Value**: Automate call routing and business line selection for new callers, improving caller experience and reducing manual routing overhead

**Description**: Implement a comprehensive IVR (Interactive Voice Response) system that allows callers to select their desired business line (Medicare, Health Insurance, Life, etc.) by pressing a number on their phone. This system will automatically route calls to the appropriate business line and agent, improving caller experience and reducing manual routing overhead.

**Current State:**

‚úÖ **Frontend UI**: IVR settings page with greeting, menu options, timeout, max attempts (tab persistence, dark theme support)  
‚úÖ **Backend API**: GET/POST `/api/calls/ivr/settings` endpoints implemented  
‚úÖ **Database**: `call_settings` table created for IVR and AI chat settings storage  
‚úÖ **Documentation**: IVR implementation plan, Twilio credentials setup, OpenAI API setup guides created  
‚ùå **Missing**: IVR logic in incoming call handler (`/api/calls/incoming` modification)

**Proposed IVR Flow Options:**

#### Option 1: IVR for Unknown Callers (Recommended)

**When IVR Triggers:**
- Caller is NOT a known client (new/unknown phone number)
- IVR is enabled in settings

**Flow:**
1. Call comes in ‚Üí Check if caller is known client
2. If **unknown caller** + **IVR enabled**:
   - Play IVR greeting: "Thank you for calling Versa Insurance. For Medicare, press 1. For Health Insurance, press 2..."
   - Use `<Gather>` to collect digit input
   - Route to selected business line
3. If **known client**:
   - Skip IVR, route directly based on client's business line

**Benefits:**
- Only interrupts new callers
- Existing clients get direct routing
- Helps categorize new leads automatically

#### Option 2: IVR for All Callers When User Unavailable

**When IVR Triggers:**
- User is NOT available for the phone number's business line
- IVR is enabled

**Flow:**
1. Call comes in ‚Üí Check user availability
2. If **user unavailable** + **IVR enabled**:
   - Play IVR menu
   - Allow caller to select different business line
   - Check if user is available for selected line
   - Route accordingly
3. If **user available**:
   - Skip IVR, route directly

**Benefits:**
- Gives callers options when primary line unavailable
- Can route to available business lines

#### Option 3: IVR for All Callers (Always)

**When IVR Triggers:**
- IVR is enabled
- Applies to ALL callers (known and unknown)

**Flow:**
1. Call comes in
2. If **IVR enabled**:
   - Always play IVR menu
   - Collect digit selection
   - Route to selected business line
3. Skip direct routing

**Benefits:**
- Consistent experience for all callers
- Callers can always change their selection

**Recommended Approach: Option 1 (IVR for Unknown Callers)**

**Why:**
- Best user experience (existing clients don't wait through menu)
- Helps categorize new leads automatically
- Reduces friction for repeat callers

**Implementation Requirements:**

1. **New Endpoint: `/api/calls/ivr-menu`**
   - **Purpose**: Handle digit input from IVR `<Gather>` action
   - **Flow**:
     1. Receive digit pressed (1, 2, 3, etc.)
     2. Look up menu option for that digit
     3. Get business line from menu option
     4. Route call to that business line:
        - Check if user available for selected line
        - If available ‚Üí Route to browser
        - If unavailable ‚Üí Route to voicemail for that line

2. **Modify `/api/calls/incoming`**
   - Add IVR logic to check if caller is known client
   - If unknown caller + IVR enabled ‚Üí Show IVR menu
   - If known client or IVR disabled ‚Üí Normal routing

3. **IVR Menu TwiML Structure**
   - Use `<Gather>` verb to collect digit input
   - Configure timeout and max attempts from settings
   - Route to `/api/calls/ivr-menu` on digit press
   - Handle timeout/max attempts with default routing

4. **IVR Menu Handler**
   - Get digit pressed from Twilio webhook
   - Look up menu option for digit
   - Get business line from menu option
   - Update call record with selected business line
   - Route call based on user availability

**Key Features:**

1. **IVR Settings Management**
   - Enable/disable IVR per user
   - Customizable greeting message
   - Configurable menu options (up to 9 options, digits 1-9)
   - Timeout settings (5-30 seconds)
   - Max attempts (1-5)

2. **Menu Options Configuration**
   - Each option maps a digit (1-9) to a business line
   - Optional description for each option
   - Business lines: Medicare, Health Insurance, Life, Group Benefits, Commercial

3. **Call Routing Logic**
   - Route based on digit selection
   - Check user availability for selected business line
   - Fallback to voicemail if user unavailable
   - Handle timeout and max attempts

4. **Error Handling**
   - Invalid digit handling
   - Timeout handling
   - Max attempts exceeded handling
   - Default routing fallback

**Questions to Decide (Before Implementation):**

1. **When should IVR trigger?**
   - [ ] Only for unknown callers (Option 1 - Recommended)
   - [ ] When user unavailable (Option 2)
   - [ ] Always for all callers (Option 3)

2. **What happens if caller doesn't press a digit?**
   - [ ] Route to default business line (phone number's line)
   - [ ] Route to voicemail for default line
   - [ ] Repeat menu (up to max attempts)

3. **What happens if caller presses invalid digit?**
   - [ ] Repeat menu
   - [ ] Route to default
   - [ ] Play error message then repeat

4. **Should IVR work with multiple phone numbers?**
   - [ ] Yes - Each phone number can have its own IVR settings
   - [ ] No - Global IVR settings for all numbers

**Files to Create/Modify:**

**Backend:**
- ‚úÖ `crm/server/src/routes/calls.ts` - GET/POST `/api/calls/ivr/settings` and `/api/calls/ai-chat/settings` endpoints implemented
- ‚ùå `crm/server/src/routes/calls.ts` - Still need: Add IVR logic to `/api/calls/incoming` and create `/api/calls/ivr-menu` endpoint
- ‚ùå `crm/server/src/services/callService.ts` - Still need: Add IVR helper functions (getIvrSettings, generateIvrMenuTwiml)

**Frontend:**
- ‚úÖ `crm/client/src/pages/CallManagerSettingsPage.tsx` - IVR settings UI complete with tab persistence and dark theme support

**Database:**
- ‚úÖ `crm/server/src/db/init-db.ts` - `call_settings` table created for IVR and AI chat settings storage

**Documentation:**
- ‚úÖ `crm/docs/IVR_IMPLEMENTATION_PLAN.md` - Detailed IVR implementation plan with flow options
- ‚úÖ `crm/docs/TWILIO_CREDENTIALS_SETUP.md` - Complete guide for Twilio API key setup
- ‚úÖ `crm/docs/OPENAI_API_KEY_SETUP.md` - Guide for OpenAI API key configuration (fallback AI provider)

**Deliverables:**
- IVR menu system for incoming calls
- Business line routing based on digit selection
- IVR settings management (already implemented)
- Timeout and max attempts handling
- Error handling for invalid inputs

**Estimated Timeline**: 2-3 weeks

**Dependencies:**
- Call Manager System (already implemented)
- Twilio integration (already implemented)
- Business line system (already implemented)

**Success Criteria:**
- Unknown callers can select business line via IVR menu
- Calls route correctly based on digit selection
- Timeout and max attempts work as configured
- Known clients skip IVR menu
- Invalid digit handling works correctly


---



---

--







**End of PRD**
    - Two-way sync endpoints (`GET/POST /api/calendar/sync/status`, `POST /api/calendar/sync/:id/sync-now`)
    - Sync status tracking and management
    - Frontend: Integration tab with OAuth buttons and sync status display
    - Frontend: Manual sync trigger functionality
  - **Phase 3: Booking Pages & Client Access** ‚úÖ Complete
    - Booking page CRUD endpoints (`GET/POST/PUT/DELETE /api/calendar/booking-pages`)
    - Event types management (`GET/POST/PUT/DELETE /api/calendar/event-types`)
    - Public booking page endpoints (`GET /api/booking/:slug`, `POST /api/booking/:slug/book`)
    - Available slot calculation service
    - Lead qualification form processing
    - Email confirmations and reminders service (`appointmentReminders.ts`)
    - Recurring appointments service (`recurringAppointments.ts`)
    - Frontend: Event types management panel
    - Frontend: Booking pages list panel with create/edit/delete/duplicate
    - Frontend: Master pages panel
    - Frontend: Public booking page component (`PublicBookingPage.tsx`)
    - Frontend: Booking page builder UI
  - **Issues Fixed During Implementation**:
    - Fixed duplicate query line in availability endpoints
    - Added error handling for missing database tables
    - Fixed UPDATE queries to handle undefined values properly
    - Added migration to init-db for calendar tables
    - Created test scripts for calendar functionality
    - Fixed conflict detection edge cases
    - Improved timezone handling for recurring appointments
    - Fixed OAuth callback error handling
    - Enhanced appointment form validation
    - Fixed availability override logic
  - **Services Created**:
    - `conflictDetection.ts` - Conflict detection and buffer time logic
    - `recurringAppointments.ts` - Recurring appointment series management
    - `appointmentReminders.ts` - Email confirmations, reminders, and cancellations
    - Enhanced `googleCalendarService.ts` - Google Calendar OAuth and sync
    - Enhanced `outlookCalendarService.ts` - Outlook OAuth and sync
  - **Database Migrations**:
    - Created all calendar-related tables in `init-db.ts`
    - Added indexes for performance optimization
    - Added foreign key constraints for data integrity
  - **Status**: Phases 1-3 complete, Phase 4 (Advanced Features) and Phase 5 (AI & Automation) pending
- **2025-01-28**: Security Enhancements and Fixes:
  - **CSRF Protection Implementation**:
    - Implemented double-submit cookie pattern for CSRF protection
    - Added `csrfTokenMiddleware` and `csrfProtection` middleware
    - CSRF tokens required for all state-changing operations (POST, PUT, DELETE, PATCH)
    - API key requests excluded from CSRF (external API calls)
    - Token generation on GET requests, validation on state-changing requests
    - Frontend integration: `GET /api/csrf-token` endpoint for token retrieval
  - **API Key Security**:
    - API keys now hashed using bcrypt before storage (same security as passwords)
    - Plain text API keys never stored (only shown on creation)
    - Secure validation by comparing hashes
    - Migration script created for existing API keys (`migrate-api-keys-to-hash.ts`)
    - Prevents API key exposure if database is compromised
  - **Security Audit Fixes**:
    - Comprehensive security audit completed (November 2025)
    - Identified 8 critical issues, 5 high-priority issues, 12 medium-priority recommendations
    - Risk assessment document created (`SECURITY_FIXES_RISK_ASSESSMENT.md`)
    - Security audit report created (`SECURITY_AUDIT_REPORT.md`)
    - Prioritized fixes by risk level (High/Medium/Low)
    - Implementation plan created with phased approach
  - **Database Connection Improvements**:
    - Enhanced database connection handling in `connection.ts`
    - Improved error handling and retry logic
    - Better connection pool management
  - **Request ID Tracking**:
    - Added request ID middleware for error correlation
    - Request IDs included in logs and error responses
    - Improves debugging and error tracking
  - **Enhanced Authentication**:
    - Improved auth utility functions (`utils/auth.ts`)
    - Better token validation and error handling
    - Enhanced session management
  - **File Validation Improvements**:
    - Enhanced file validation utilities
    - Better MIME type checking
    - Improved file size validation
- **2025-01-28**: Client Portal Enhancements:
  - **Database Migrations**:
    - Created client portal tables migration (`003-create-client-portal-tables.sql`)
    - Added broker fields to users table (`004-add-broker-fields-to-users.sql`)
    - Added address fields migration (`003-add-address-fields.ts`)
  - **Component Updates**:
    - Enhanced `BrokerInfo.tsx` component
    - Updated `DentalPlanCard.tsx`, `VisionPlanCard.tsx`, `HealthPlanCard.tsx`
    - Improved `EnrolledMembers.tsx` component
    - Enhanced `CollapsibleSection.tsx` and `AdsPanel.tsx` components
  - **Authentication Improvements**:
    - Updated `LoginForm.tsx` and `VerifyToken.tsx` components
    - Enhanced authentication flow
    - Improved error handling and user feedback
- **2025-01-28**: Service and Route Enhancements:
  - **Calendar Services**:
    - Enhanced `googleCalendarService.ts` with OAuth and sync functionality
    - Enhanced `outlookCalendarService.ts` with OAuth and sync functionality
    - Created `conflictDetection.ts` service for appointment conflicts
    - Created `recurringAppointments.ts` service for recurring appointment series
    - Created `appointmentReminders.ts` service for email notifications
  - **Call Service Improvements**:
    - Enhanced `callService.ts` with better error handling
    - Improved call management functionality
  - **Commission Route Enhancements**:
    - Enhanced commission calculation and tracking
    - Improved commission reporting
  - **Client Route Improvements**:
    - Enhanced client management endpoints
    - Improved client search and filtering
  - **Conversation Route Updates**:
    - Enhanced conversation management
    - Improved conversation context handling
  - **Profile Route Enhancements**:
    - Enhanced profile management endpoints
    - Improved user profile updates
  - **AI Route Improvements**:
    - Enhanced AI service integration
    - Improved prompt optimization (`promptOptimizer.ts`)
    - Better error handling and retry logic
  - **Business Line Query Service**:
    - Enhanced `businessLineQueryService.ts` with better query handling
    - Improved multi-business line support
  - **Data Update Service**:
    - Enhanced `dataUpdateService.ts` with better validation
    - Improved data update handling
  - **S3 Service Improvements**:
    - Enhanced `s3Service.ts` with better error handling
    - Improved file upload and storage
  - **PostGrid Service Enhancements**:
    - Enhanced `postgridService.ts` with better integration
    - Improved direct mail functionality
  - **Portal Email Service**:
    - Enhanced `portalEmailService.ts` with better template handling
    - Improved email sending functionality
  - **Zip Code Mapping Service**:
    - Enhanced `zipCodeMappingService.ts` with better validation
    - Improved ZIP code mapping accuracy
- **2025-01-28**: Frontend Component Updates:
  - **Calendar Components**:
    - Enhanced `AppointmentForm.tsx` with better validation and error handling
    - Updated `AvailabilitySettings.tsx` with improved UI
    - Enhanced `CalendarView.tsx` with better display options
  - **Review Components**:
    - Updated `CustomOptionsTab.tsx`, `ReportsTab.tsx`, `WidgetsTab.tsx`
    - Improved review management UI
  - **Plan Selections**:
    - Enhanced `PlanSelections.tsx` component
    - Improved plan selection UI
  - **Calendar Pages**:
    - Updated `CalendarPage.tsx`, `HomeTab.tsx`, `IntegrationTab.tsx`, `BookingPagesTab.tsx`
    - Enhanced `PublicBookingPage.tsx` with better booking flow
  - **Manage Ads Page**:
    - Updated `ManageAdsPage.tsx` with improved functionality
- **2025-01-28**: Database and Migration Updates:
  - **Knowledge Source Feedback**:
    - Added Phase 22 knowledge feedback migration (`022-phase22-knowledge-feedback.ts`)
    - Enhanced knowledge source tracking
  - **Database Initialization**:
    - Enhanced `init-db.ts` with calendar table creation
    - Improved database initialization process
    - Better error handling for missing tables
  - **Connection Management**:
    - Enhanced database connection handling
    - Improved connection pool management
    - Better retry logic for connection failures
- **2025-01-29**: Epic 8 - Georgia Health Insurance Data Collection Implementation:
  - **Data Collection Complete**:
    - Implemented `sync-georgia-health-plans.ts` script for bulk plan data collection
    - Integrated CMS Marketplace API for On-Exchange plans
    - Integrated HUD ZIP Code API for ZIP code and FIPS code mapping
    - Implemented carrier filtering for 8 contracted carriers
    - Extracted and formatted member services phone numbers
    - Implemented PDF download and S3 storage for Summary of Benefits documents
    - Created helper scripts for carrier verification and phone number management
  - **UI Integration Updates**:
    - Removed CMS API dependency for Georgia carriers in frontend
    - Implemented static carrier list with hardcoded phone numbers
    - Changed Plan Name and Member Services Phone fields to text inputs
    - Implemented phone number auto-population on carrier selection
    - Added dropdown auto-close functionality
    - **TypeError Fix (Attempt 9 - 2025-01-29)**:
      - Removed `error` prop from Select components (was triggering Mantine form tracking)
      - Simplified Select rendering: Only render if structure exists (show loader if not)
      - Structure guaranteed to exist before Select renders (initialized by toggle handler)
      - Local state (`carrierSelectValues`) for Select `value` prop to prevent Mantine tracking
      - Enhanced phone number lookup: Always checks `GEORGIA_CARRIER_PHONES` static list using carrier name
      - `setCarrierValue` called in both `onChange` and `onOptionSubmit` to ensure phone numbers populate
    - Status: Testing latest fix - structure exists before Select renders, phone numbers auto-populate
  - **Files Modified**:
    - `crm/server/src/scripts/sync-georgia-health-plans.ts` (main sync script)
    - `crm/server/src/scripts/check-georgia-carriers.ts` (carrier verification)
    - `crm/server/src/scripts/check-georgia-carrier-phones.ts` (phone verification)
    - `crm/server/src/scripts/update-georgia-carrier-phones.ts` (phone updates)
    - `crm/server/src/scripts/add-missing-georgia-carriers.ts` (add missing carriers)
    - `crm/client/src/components/PlanSelections.tsx` (UI integration)
  - **Issues Fixed**:
    - Environment variable loading (DATABASE_URL not configured)
    - CMS API endpoint and request format (404 errors, HTML responses)
    - Invalid ZIP/FIPS errors (missing required fields)
    - Year handling (API only supports 2024, storing for 2025/2026)
    - PostgreSQL array insertion syntax
    - Carrier name mapping (API names vs contracted names)
    - Phone number formatting and auto-population
    - Plan name and member services phone field types
    - Dropdown closing behavior
    - Plans not appearing when selecting carrier (fixed carrier ID resolution)
    - Filtering by metal tier and network type (added database column, implemented filtering logic)
    - PDF download errors (handled HTTP 301 redirects, filtered non-English PDFs)
    - Missing metadata (created enhancement scripts, matched 2024 plans to 2025 plans)
    - Primary applicant auto-population (fixed last name truncation, DOB formatting)
- **2025-11-20**: Epic 8 - Georgia Plan Filtering, PDF Processing, and Metadata Enhancement:
  - **Plan Filtering Implementation**:
    - Added `network_type` column to `health_plans` table
    - Implemented filtering logic in frontend (`PlanSelections.tsx`) and backend API (`health-insurance.ts`)
    - Filtering works by metal tier (Bronze, Silver, Gold, Platinum) and network type (HMO, PPO, EPO, POS)
    - Filtering test script created (`test-georgia-plan-filtering.ts`) to verify logic
  - **PDF Processing**:
    - Created `extract-plans-from-centene-pdfs.ts` script to download Centene SBC PDFs for 2025 and 2026
    - Handled HTTP 301 redirects using `follow-redirects` package
    - Filtered out Spanish and non-English PDFs (comprehensive regex for 40+ language variants)
    - Processed 238 Ambetter PDFs and stored in S3
    - Created auto-update script (`auto-update-georgia-plans.ts`) for future processing
    - Created cron setup script (`setup-georgia-plans-cron.sh`) for scheduled updates
  - **Metadata Enhancement**:
    - Created `sync-and-enhance-metadata.ts` script to match 2024 CMS-synced plans (with metadata) to 2025 PDF-based plans (without metadata)
    - Key insight: 2025 plans are dated 2024, so matching works across years by extracting 7-digit plan IDs from `api_plan_id`
    - Enhanced 10 plans with metadata (8 Bronze HMO, 2 Silver HMO)
    - Created diagnostic script (`diagnose-plan-matching.ts`) to inspect plan differences
    - Created `enhance-plan-metadata.ts` script for direct CMS API lookup (not working - API doesn't match PDF plan IDs)
    - Created `sync-and-enhance-metadata.ts` as working alternative (matches existing CMS-synced plans)
  - **Primary Applicant Auto-Population**:
    - Added `useEffect` in `ClientFormPage.tsx` to auto-populate primary applicant name and DOB from client data
    - Fixed last name truncation by using explicit `value` and `onChange` handlers instead of `form.getInputProps`
    - Fixed DOB formatting using `formatDateInput` utility
    - Used `requestAnimationFrame` and `setTimeout` for proper timing
  - **Files Created**:
    - `crm/server/src/scripts/extract-plans-from-centene-pdfs.ts` - Centene PDF download and processing
    - `crm/server/src/scripts/auto-update-georgia-plans.ts` - Auto-update script for future PDFs
    - `crm/server/src/scripts/setup-georgia-plans-cron.sh` - Cron setup script
    - `crm/server/src/scripts/test-georgia-plan-filtering.ts` - Filtering test script
    - `crm/server/src/scripts/enhance-plan-metadata.ts` - Direct CMS API lookup (not working)
    - `crm/server/src/scripts/sync-and-enhance-metadata.ts` - Ma--



---


---

**End of PRD**



## 22. Comprehensive Codebase Analysis & Future Improvement Recommendations

**Date**: 2025-12-25  
**Status**: Analysis Complete  
**Scope**: Full codebase review covering security, code quality, performance, architecture, testing, and future enhancements

---

### 22.1 Executive Summary

This comprehensive analysis reviewed the entire Versa Insurance CRM codebase, identifying **89 SELECT * queries**, **8,050 console.log statements**, **768 TypeScript `any` types**, **0 test files**, and **448 TODO/FIXME comments**. The analysis covers 10 major improvement categories with prioritized recommendations.

**Overall Codebase Health**: 7.5/10
- ‚úÖ **Strengths**: Strong security foundations, good architecture patterns, comprehensive feature set
- ‚ö†Ô∏è **Areas for Improvement**: Testing coverage, code quality metrics, performance optimization, documentation organization

---

### 22.2 Security Improvements

#### 22.2.1 Critical Security Issues

**1. CORS Configuration Too Permissive** üî¥ CRITICAL
- **Location**: `crm/server/src/index.ts:48`
- **Issue**: `app.use(cors())` allows ALL origins
- **Risk**: CSRF attacks, data exfiltration
- **Recommendation**: Whitelist specific origins for production
- **Priority**: Immediate
- **Effort**: 1 hour
- **Reference**: See [[SECURITY_AUDIT_REPORT.md]] for detailed analysis

**2. Socket.io CORS Development Bypass** üî¥ CRITICAL
- **Location**: `crm/server/src/index.ts:530-532`
- **Issue**: Development mode allows any origin
- **Risk**: Could be exploited if NODE_ENV misconfigured
- **Recommendation**: Remove dev bypass or use strict whitelist
- **Priority**: Immediate
- **Effort**: 30 minutes

**3. JWT Token Expiration Too Long** üü† HIGH
- **Location**: `crm/server/src/utils/auth.ts:59`
- **Issue**: 7-day expiration
- **Risk**: Stolen tokens valid too long
- **Recommendation**: Reduce to 1 hour, implement refresh token pattern
- **Priority**: High
- **Effort**: 4 hours

**4. No Rate Limiting on Public Endpoints** üü† HIGH
- **Location**: Multiple endpoints
- **Issue**: Authentication, password reset, form submissions not rate limited
- **Risk**: Brute force attacks, email flooding
- **Recommendation**: Add `express-rate-limit` to all public endpoints
- **Priority**: High
- **Effort**: 2 hours

**5. SELECT * Queries Expose Sensitive Data** üü† HIGH
- **Location**: 89 instances across codebase
- **Issue**: Exposes all columns including sensitive fields
- **Risk**: Data exposure, performance issues
- **Recommendation**: Always specify exact columns needed
- **Priority**: High
- **Effort**: 8 hours (systematic refactoring)

#### 22.2.2 Security Strengths ‚úÖ

1. **SQL Injection Protection** ‚úÖ
   - All queries use parameterized statements
   - Neon SQL template literals prevent injection
   - No string concatenation in queries

2. **Password Security** ‚úÖ
   - Bcrypt hashing with 10 salt rounds
   - Passwords never logged
   - Proper password verification

3. **Input Validation** ‚úÖ
   - Input sanitization middleware exists
   - Email, phone, ZIP code validation
   - XSS prevention via sanitization

4. **No npm Vulnerabilities** ‚úÖ
   - `npm audit` shows 0 vulnerabilities
   - Dependencies are up to date

---

### 22.3 Code Quality & Technical Debt

#### 22.3.1 TypeScript Type Safety

**Issue**: 768 instances of `any` type across frontend codebase
- **Risk**: Runtime errors, reduced IDE support, harder refactoring
- **Recommendation**: 
  - Phase 1: Add explicit types to all function parameters and return types
  - Phase 2: Replace `any` with `unknown` and add type guards
  - Phase 3: Enable strict TypeScript mode
- **Priority**: Medium
- **Effort**: 20 hours (incremental, can be done per-file)

**Current State**:
- TypeScript errors bypassed with `--skipLibCheck` or direct Vite builds
- Many components have implicit `any` types
- API response types not consistently defined

**Recommendation**: Create shared type definitions for all API responses

#### 22.3.2 Code Duplication

**Issue**: 448 TODO/FIXME comments indicate incomplete work
- **Risk**: Technical debt accumulation, inconsistent implementations
- **Recommendation**: 
  - Audit all TODOs and prioritize
  - Create tickets for each TODO
  - Remove obsolete TODOs
- **Priority**: Medium
- **Effort**: 4 hours (audit) + variable (implementation)

**Specific Duplication Patterns**:
- Marketing service patterns (Facebook, LinkedIn, Google, etc.) have similar structure
- **Recommendation**: Create base marketing service class with shared functionality
- **Effort**: 8 hours (refactoring)

#### 22.3.3 Console Logging

**Issue**: 8,050 console.log/error/warn statements across 341 files
- **Risk**: Performance impact, sensitive data exposure, production noise
- **Recommendation**:
  - Implement structured logging (Winston or Pino)
  - Replace console.log with logger service
  - Add log levels (debug, info, warn, error)
  - Sanitize logs to remove PHI
- **Priority**: Medium
- **Effort**: 12 hours (logging infrastructure) + 16 hours (migration)

---

### 22.4 Performance Optimizations

#### 22.4.1 Database Query Optimization

**Issue**: 89 SELECT * queries
- **Impact**: Unnecessary data transfer, slower queries, memory usage
- **Recommendation**: 
  - Replace with specific column selections
  - Add database indexes for frequently queried columns
  - Use EXPLAIN ANALYZE to identify slow queries
- **Priority**: High
- **Effort**: 8 hours (systematic refactoring)

**Specific Optimizations**:
1. **Client Queries**: Only select needed fields (not entire JSONB columns)
2. **Marketing Campaigns**: Add indexes on `status`, `scheduled_date`
3. **Appointments**: Add composite indexes on `(user_id, start_time)`
4. **Notifications**: Add indexes on `(user_id, read, created_at)`

#### 22.4.2 Frontend Performance

**Issue**: Large bundle size (3.2MB JavaScript)
- **Impact**: Slow initial load, poor mobile experience
- **Recommendation**:
  - Implement code splitting with React.lazy()
  - Use dynamic imports for marketing pages
  - Lazy load heavy components (charts, PDF viewers)
  - Optimize images and assets
- **Priority**: Medium
- **Effort**: 12 hours

**Current Bundle Analysis**:
- Main bundle: 3,238.35 kB (819.24 kB gzipped)
- **Recommendation**: Target <500 kB gzipped for initial load

#### 22.4.3 API Response Caching

**Issue**: No caching strategy for frequently accessed data
- **Impact**: Repeated database queries for same data
- **Droplet-Specific Setup**:
  - Install Redis on droplet: `sudo apt install redis-server`
  - Configure Redis persistence (RDB snapshots)
  - Set memory limits (`maxmemory` policy)
  - Monitor Redis with PM2 or systemd
  - Consider DigitalOcean Managed Redis if scaling beyond single droplet
- **Recommendation**:
  - Install and configure Redis on droplet (4 hours)
  - Implement Redis caching for CMS rules, plans, formularies (6 hours)
  - Cache client lists with TTL
  - Cache dashboard metrics
  - Add Redis monitoring
- **Priority**: Medium
- **Effort**: 10 hours total (4 hours Redis setup + 6 hours implementation)

---

### 22.5 Testing Infrastructure

#### 22.5.1 Current State

**Issue**: 0 test files found in codebase
- **Risk**: No automated regression testing, difficult refactoring
- **Impact**: Manual testing required for every change

**Existing Test Scripts** (Manual):
- `test-self-improvement.ts` - AI knowledge detection
- `test-medicare-call-ai.ts` - Medicare AI call testing
- `test-comprehensive-medicare-ai.ts` - Comprehensive scenarios
- `test-complex-medicare-scenarios.ts` - Complex test cases

**Recommendation**: Convert these to formal unit/integration tests

#### 22.5.2 Testing Recommendations

**Priority 1: Critical Path Tests** (High Priority)
- Authentication flow
- Client CRUD operations
- Medicare SOA automation
- Appointment booking
- **Effort**: 16 hours

**Priority 2: Integration Tests** (Medium Priority)
- API endpoints (90%+ coverage goal)
- Database operations
- External service integrations (mocked)
- **Effort**: 24 hours

**Priority 3: E2E Tests** (Medium Priority)
- Critical user workflows
- Business line flows
- Portal flows
- **Effort**: 20 hours

**Recommended Stack**:
- **Unit/Integration**: Vitest (Vite-compatible)
- **E2E**: Playwright (multi-browser support)
- **API Testing**: Supertest

---

### 22.6 Architecture Improvements

#### 22.6.1 Service Layer Organization

**Current State**: Services mixed with routes, some duplication
- **Recommendation**: 
  - Create clear service layer abstraction
  - Extract business logic from routes
  - Implement repository pattern for database access
- **Priority**: Medium
- **Effort**: 16 hours

#### 22.6.2 Error Handling Standardization

**Current State**: Inconsistent error handling patterns
- **Recommendation**:
  - Create custom error classes (AppError, ValidationError, etc.)
  - Implement global error handler middleware
  - Standardize error response format
  - Add request ID tracking
- **Priority**: Medium
- **Effort**: 8 hours

#### 22.6.3 API Versioning

**Current State**: No API versioning strategy
- **Recommendation**:
  - Implement `/api/v1/` prefix for all endpoints
  - Plan for future breaking changes
  - Document API contracts
- **Priority**: Low
- **Effort**: 4 hours

---

### 22.7 Documentation Improvements

#### 22.7.1 Documentation Organization

**Current State**: 
- Large monolithic files (AI_SETUP.md: 1961 lines)
- Duplicate sections
- Mixed concerns (setup, troubleshooting, architecture)
- No clear hierarchy

**Recommendation**: Modular documentation structure
```
crm/docs/
‚îú‚îÄ‚îÄ QUICK_START.md              # Fast onboarding
‚îú‚îÄ‚îÄ SETUP.md                    # Setup instructions only
‚îú‚îÄ‚îÄ ARCHITECTURE.md             # Architecture overview
‚îú‚îÄ‚îÄ API_REFERENCE.md            # API endpoints reference
‚îú‚îÄ‚îÄ TROUBLESHOOTING.md          # Current troubleshooting
‚îú‚îÄ‚îÄ TROUBLESHOOTING_HISTORY.md  # Historical fixes archive
‚îú‚îÄ‚îÄ DEVELOPMENT.md              # Development workflow
‚îî‚îÄ‚îÄ DEPLOYMENT.md               # Deployment instructions
```

**Priority**: Low
**Effort**: 8 hours

#### 22.7.2 Code Documentation

**Current State**: Minimal JSDoc comments
- **Recommendation**: 
  - Add JSDoc to all public functions
  - Document complex business logic
  - Add examples for API endpoints
- **Priority**: Low
- **Effort**: 12 hours (incremental)

---

### 22.8 DevOps & Deployment

#### 22.8.1 CI/CD Pipeline

**Current State**: Manual deployment process via SSH to DigitalOcean droplet
- **Droplet Deployment Process**:
  ```bash
  git pull origin main
  cd crm/server && npm install
  cd crm/client && npm install && npm run build
  pm2 restart crm-server
  sudo nginx -s reload
  ```
- **Recommendation**:
  - Implement GitHub Actions with SSH deployment to droplet
  - Use PM2 zero-downtime restart (single droplet limitation - no blue-green)
  - Add PM2 health checks (`pm2 status`, `pm2 logs`)
  - Implement simple rollback (keep previous build, PM2 restart previous version)
  - Add automated testing before deployment
  - Add Nginx reload after successful deployment
- **Priority**: Medium
- **Effort**: 10 hours (reduced - no blue-green complexity)

#### 22.8.2 Monitoring & Observability

**Current State**: Limited monitoring (PM2 logs, Nginx logs available)
- **Droplet-Specific Tools Available**:
  - PM2 monitoring: `pm2 monit`, `pm2 logs`, `pm2 status`
  - Nginx logs: `/var/log/nginx/access.log`, `/var/log/nginx/error.log`
  - System monitoring: `htop`, `iostat`, DigitalOcean droplet metrics
  - PM2 error logs: `/var/log/pm2/crm-server-error.log`
- **Recommendation**:
  - Set up PM2 monitoring dashboard (`pm2 monit`)
  - Configure Nginx log rotation and analysis
  - Integrate DigitalOcean droplet metrics (CPU, memory, disk, network)
  - Add PM2 error log aggregation
  - Implement error tracking (Sentry - works with droplet)
  - Create simple dashboards using PM2 and Nginx logs
- **Priority**: Medium
- **Effort**: 6 hours (reduced - using existing droplet tools)

#### 22.8.3 Database Migrations

**Current State**: Manual migration execution
- **Recommendation**:
  - Automate migration execution in CI/CD
  - Add migration rollback procedures
  - Document migration dependencies
- **Priority**: Low
- **Effort**: 4 hours


#### 22.8.4 DigitalOcean Droplet Deployment Considerations

**Current Deployment**: Ubuntu 24.04 LTS Droplet with PM2, Nginx, Let's Encrypt SSL

**Infrastructure Stack**:
- **CDN/DDoS Protection**: Cloudflare (traffic flows: Client ‚Üí Cloudflare ‚Üí Nginx ‚Üí Express)
- **SSL/TLS**: Cloudflare handles SSL termination (HTTPS to Cloudflare, then to Nginx)
- **Real Client IPs**: Use `$http_cf_connecting_ip` or `X-Forwarded-For` header (Nginx sees Cloudflare IPs)
- **Edge Caching**: Cloudflare provides static asset caching and DDoS protection at edge
- **Note**: Nginx rate limiting is defense-in-depth (Cloudflare already provides primary DDoS protection)

**Droplet-Specific Recommendations**:

**1. CI/CD Pipeline Adaptation** (Updated from 22.8.1)
- **Current State**: Manual deployment via SSH (`git pull`, `npm install`, `pm2 restart`)
- **Recommendation**:
  - Implement GitHub Actions with SSH deployment to droplet
  - Use PM2 zero-downtime restart instead of blue-green (single droplet limitation)
  - Add PM2 health checks (`pm2 status`, `pm2 logs`)
  - Implement simple rollback (keep previous build, PM2 restart previous version)
  - Add Nginx reload after deployment (`sudo nginx -s reload`)
- **Priority**: Medium
- **Effort**: 10 hours (reduced from 12 - no blue-green complexity)

**2. Monitoring & Observability** (Updated from 22.8.2)
- **Current State**: Limited monitoring, PM2 logs, Nginx logs
- **Droplet-Specific Tools**:
  - PM2 monitoring: `pm2 monit`, `pm2 logs`, `pm2 status`
  - Nginx logs: `/var/log/nginx/access.log`, `/var/log/nginx/error.log`
  - System monitoring: `htop`, `iostat`, DigitalOcean droplet metrics dashboard
  - PM2 error logs: `/var/log/pm2/crm-server-error.log`
- **Recommendation**:
  - Set up PM2 monitoring dashboard
  - Configure Nginx log rotation and analysis
  - Integrate DigitalOcean droplet metrics (CPU, memory, disk)
  - Add PM2 error log aggregation
  - Consider Sentry for error tracking (works with droplet)
- **Priority**: Medium
- **Effort**: 6 hours (reduced from 8 - using existing tools)

**3. Redis Caching Setup** (Updated from 22.4.3)
- **Current State**: No caching implemented
- **Droplet-Specific**:
  - Install Redis on droplet: `sudo apt install redis-server`
  - Configure Redis persistence and memory limits
  - Monitor Redis with PM2 or systemd
  - Consider DigitalOcean Managed Redis if scaling beyond single droplet
- **Recommendation**:
  - Install and configure Redis on droplet
  - Set up Redis persistence (RDB snapshots)
  - Configure memory limits (`maxmemory` policy)
  - Add Redis monitoring to PM2 or systemd
- **Priority**: Medium
- **Effort**: 4 hours (Redis setup) + 6 hours (implementation) = 10 hours total

**4. Nginx-Level Security** (Additional to 22.2)
- **Current State**: Nginx reverse proxy, Let's Encrypt SSL
- **Additional Security Layers**:
  - Nginx rate limiting (in addition to Express rate limiting)
  - Nginx SSL/TLS configuration hardening
  - UFW firewall rules
  - SSH security hardening (key-only authentication)
  - Fail2ban for SSH protection
- **Recommendation**:
  - Configure Nginx rate limiting (`limit_req_zone`, `limit_conn_zone`)
  - Harden SSL/TLS configuration (TLS 1.2+, strong ciphers)
  - Set up UFW firewall (allow 22, 80, 443, deny all else)
  - Disable SSH password authentication (key-only)
  - Install and configure Fail2ban
- **Priority**: High
- **Effort**: 3 hours

**5. Backup & Recovery** (Additional)
- **Current State**: Automated Dropbox backups
- **Recommendation**:
  - Verify database backup automation (Neon PostgreSQL)
  - Verify code backup automation (Dropbox sync)
  - Test backup restoration procedures
  - Document recovery process
- **Priority**: Medium
- **Effort**: 2 hours

**6. PM2 Ecosystem Configuration**
- **Current State**: Manual PM2 process management
- **Recommendation**:
  - Create `ecosystem.config.js` for PM2 process configuration
  - Configure auto-restart on failure
  - Set up log rotation
  - Configure environment variables in ecosystem file
- **Priority**: High
- **Effort**: 1 hour

---

### 22.9 Database Improvements

#### 22.9.1 Indexing Strategy

**Recommendation**: Add indexes for frequently queried columns
- `clients`: `(user_id, line_of_business)`, `(email)`, `(phone)`
- `appointments`: `(user_id, start_time)`, `(client_id)`
- `notifications`: `(user_id, read, created_at)`
- `conversations`: `(client_id, created_at)`
- **Priority**: High
- **Effort**: 2 hours

#### 22.9.2 Query Performance

**Recommendation**: 
- Use EXPLAIN ANALYZE to identify slow queries
- Optimize N+1 query patterns
- Implement query result pagination
- **Priority**: Medium
- **Effort**: 6 hours

#### 22.9.3 Data Archiving

**Recommendation**: 
- Archive old conversations (>2 years)
- Archive completed campaigns
- Implement data retention policies
- **Priority**: Low
- **Effort**: 8 hours

---

### 22.10 Frontend/Backend Patterns

#### 22.10.1 Component Organization

**Current State**: Some large components (DirectMailPage.tsx: 6000+ lines)
- **Recommendation**:
  - Break down large components into smaller, focused components
  - Extract custom hooks for complex logic
  - Create reusable component library
- **Priority**: Medium
- **Effort**: 16 hours (incremental refactoring)

#### 22.10.2 State Management

**Current State**: useState/useEffect for most state
- **Recommendation**:
  - Consider Zustand or Jotai for complex state
  - Implement React Query for server state
  - Reduce prop drilling with context
- **Priority**: Low
- **Effort**: 12 hours

#### 22.10.3 API Client Standardization

**Current State**: `apiRequest` utility exists but could be enhanced
- **Recommendation**:
  - Add request/response interceptors
  - Implement automatic retry logic
  - Add request cancellation
  - Standardize error handling
- **Priority**: Medium
- **Effort**: 6 hours
#### 22.10.4 Mantine to Mantis CSS Migration

**Current State**: Using Mantine UI components with Mantis CSS overrides
- **Mantine Dependencies**: 203 imports across 95 files
- **Current Approach**: `mantis-overrides.css` and `mantis-theme.ts` to style Mantine components as Mantis
- **Mantine Packages**: `@mantine/core`, `@mantine/hooks`, `@mantine/form`, `@mantine/dates`, `@mantine/notifications`, `@mantine/spotlight`
- **Mantis CSS**: Already extracted and available in `mantis-overrides.css` with full design tokens

**Goal**: Migrate to pure Mantis CSS, remove Mantine CSS dependency

**Migration Strategy - Two Approaches**:

**Option A: Keep Mantine Components, Remove Mantine CSS** (Recommended - Lower Risk)
- **Approach**: 
  - Keep Mantine component APIs (Card, Button, Input, etc.)
  - Remove Mantine CSS bundle from build
  - Use only Mantis CSS for all styling
  - Create wrapper components that apply Mantis classes to Mantine components
- **Pros**:
  - Lower risk - component APIs remain unchanged
  - Faster migration (estimated 40-60 hours)
  - Maintains existing functionality
  - Can be done incrementally
- **Cons**:
  - Still depends on Mantine JavaScript bundle
  - Some Mantine-specific features may need workarounds
- **Effort**: 40-60 hours (incremental, page-by-page)
- **Priority**: Medium
- **Risk**: Low

**Option B: Full Component Replacement** (Higher Risk, Cleaner Result)
- **Approach**:
  - Replace all Mantine components with custom components using pure Mantis CSS
  - Remove all Mantine dependencies
  - Build component library from scratch using Mantis design tokens
- **Pros**:
  - Complete independence from Mantine
  - Smaller bundle size (no Mantine JS)
  - Full control over component behavior
  - Cleaner codebase
- **Cons**:
  - Much higher risk and effort
  - Need to rebuild all component functionality
  - Potential for bugs and regressions
  - Longer timeline
- **Effort**: 120-160 hours (full rewrite)
- **Priority**: Low (future consideration)
- **Risk**: High

**Recommended Approach: Option A (Incremental Migration)**

**Phase 1: Foundation (Week 1)**
1. Create Mantis component wrappers (8 hours)
   - `MantisCard`, `MantisButton`, `MantisInput`, `MantisTable`
   - Wrappers apply Mantis CSS classes to Mantine components
2. Remove Mantine CSS from build (4 hours)
   - Configure Vite to exclude Mantine CSS
   - Ensure Mantis CSS loads properly
3. Test core pages (4 hours)
   - Dashboard, Clients, Calendar
   - Fix any styling regressions
**Total**: 16 hours

**Phase 2: Component Migration (Weeks 2-4)**
1. Migrate high-usage components (20 hours)
   - Card, Button, Input, Select, Table (used in 50+ files)
2. Migrate form components (12 hours)
   - TextInput, Textarea, NumberInput, DatePicker
3. Migrate layout components (8 hours)
   - Container, Stack, Group, Grid
4. Migrate feedback components (4 hours)
   - Alert, Notification, Modal, Tooltip
**Total**: 44 hours

**Phase 3: Page-by-Page Migration (Weeks 5-8)**
1. Core pages (16 hours)
   - Dashboard, Clients, Client Detail, Client Form
2. Calendar pages (12 hours)
   - Calendar, Event Types, Booking Pages
3. Settings pages (12 hours)
   - All settings pages
4. Marketing pages (16 hours)
   - All marketing pages
5. Other pages (8 hours)
   - Reviews, Inbox, etc.
**Total**: 64 hours

**Phase 4: Cleanup & Optimization (Week 9)**
1. Remove unused Mantine CSS references (4 hours)
2. Optimize Mantis CSS bundle (4 hours)
3. Update documentation (2 hours)
4. Final testing (6 hours)
**Total**: 16 hours

**Total Estimated Effort**: 140 hours (Option A - Incremental)

**Technical Implementation Details**:

**1. Mantine CSS Removal Process**:
- **Current**: Mantine CSS loaded via `@mantine/core` imports (~200-300 KB)
- **Target**: Remove Mantine CSS, keep only Mantis CSS
- **Method**: 
  - Configure Vite to exclude Mantine CSS from bundle
  - Use `vite.config.ts` to exclude CSS imports
  - Ensure Mantis CSS loads first, then component-specific overrides
- **Verification**: Bundle analyzer to confirm Mantine CSS removed

**2. Component Wrapper Architecture**:
```typescript
// Example: MantisCard wrapper
import { Card, CardProps } from '@mantine/core';
import './mantis-card.css'; // Pure Mantis CSS, no Mantine CSS

export function MantisCard(props: CardProps) {
  return (
    <Card 
      {...props}
      className={`mantis-card ${props.className || ''}`}
      // Mantine JS handles component logic
      // Mantis CSS handles all styling
    />
  );
}
```

**3. Component Mapping Strategy**:

| Mantine Component | Mantis Wrapper | CSS File | Priority |
|------------------|----------------|----------|----------|
| `Card` | `MantisCard` | `mantis-card.css` | High (50+ files) |
| `Button` | `MantisButton` | `mantis-button.css` | High (80+ files) |
| `TextInput` | `MantisInput` | `mantis-input.css` | High (60+ files) |
| `Select` | `MantisSelect` | `mantis-select.css` | High (40+ files) |
| `Table` | `MantisTable` | `mantis-table.css` | High (30+ files) |
| `Modal` | `MantisModal` | `mantis-modal.css` | Medium (20+ files) |
| `Tabs` | `MantisTabs` | `mantis-tabs.css` | Medium (25+ files) |
| `Alert` | `MantisAlert` | `mantis-alert.css` | Medium (15+ files) |
| `Badge` | `MantisBadge` | `mantis-badge.css` | Medium (20+ files) |
| `Stack` | `MantisStack` | `mantis-stack.css` | Low (layout only) |
| `Group` | `MantisGroup` | `mantis-group.css` | Low (layout only) |
| `Grid` | `MantisGrid` | `mantis-grid.css` | Low (layout only) |

**4. CSS Architecture**:
```
crm/client/src/
‚îú‚îÄ‚îÄ mantis-overrides.css          # Global Mantis design tokens (existing)
‚îú‚îÄ‚îÄ components/mantis/
‚îÇ   ‚îú‚îÄ‚îÄ mantis-card.css           # Card-specific Mantis styling
‚îÇ   ‚îú‚îÄ‚îÄ mantis-button.css         # Button-specific Mantis styling
‚îÇ   ‚îú‚îÄ‚îÄ mantis-input.css          # Input-specific Mantis styling
‚îÇ   ‚îú‚îÄ‚îÄ mantis-table.css          # Table-specific Mantis styling
‚îÇ   ‚îî‚îÄ‚îÄ ...                       # Other component CSS files
‚îî‚îÄ‚îÄ components/mantis/
    ‚îú‚îÄ‚îÄ MantisCard.tsx            # Card wrapper component
    ‚îú‚îÄ‚îÄ MantisButton.tsx          # Button wrapper component
    ‚îú‚îÄ‚îÄ MantisInput.tsx           # Input wrapper component
    ‚îî‚îÄ‚îÄ ...                       # Other wrapper components
```

**5. Migration Checklist (Per Page)**:
- [ ] Identify all Mantine component imports
- [ ] Replace imports with Mantis wrappers
- [ ] Verify visual appearance matches Mantis design
- [ ] Test all interactive features (clicks, forms, modals)
- [ ] Test responsive behavior (mobile, tablet, desktop)
- [ ] Test dark mode (if applicable)
- [ ] Verify accessibility (keyboard navigation, screen readers)
- [ ] Check for console errors
- [ ] Verify no Mantine CSS classes in DOM
- [ ] Update component props if needed
- [ ] Document any behavior changes

**6. Risk Mitigation Strategies**:

**Risk 1: Styling Regressions**
- **Mitigation**: 
  - Create visual regression tests (screenshots)
  - Test each page after migration
  - Keep Mantine CSS available during transition (feature flag)
- **Rollback**: Revert to Mantine imports if issues found

**Risk 2: Component Behavior Changes**
- **Mitigation**:
  - Keep Mantine JS packages (component logic unchanged)
  - Only replace CSS, not component APIs
  - Test all interactive features thoroughly
- **Rollback**: Re-enable Mantine CSS if behavior breaks

**Risk 3: Missing Functionality**
- **Mitigation**:
  - Audit all Mantine component features used
  - Create feature parity checklist
  - Test edge cases and advanced features
- **Rollback**: Keep Mantine CSS for specific components if needed

**Risk 4: Performance Issues**
- **Mitigation**:
  - Monitor bundle size after each phase
  - Use bundle analyzer to verify CSS removal
  - Test page load times
- **Rollback**: Revert if bundle size increases unexpectedly

**7. Testing Strategy**:

**Unit Testing**:
- Test wrapper components render correctly
- Test props pass-through to Mantine components
- Test className merging

**Visual Testing**:
- Screenshot comparison (before/after)
- Visual regression testing
- Cross-browser testing (Chrome, Firefox, Safari, Edge)

**Functional Testing**:
- All forms submit correctly
- All modals open/close correctly
- All tables sort/filter correctly
- All navigation works
- All interactive features work

**Performance Testing**:
- Bundle size comparison
- Page load time comparison
- Runtime performance (no degradation)

**8. Migration Order (By Priority)**:

**Tier 1: High-Usage Components (Week 1-2)**
1. Card (50+ files) - 8 hours
2. Button (80+ files) - 10 hours
3. TextInput (60+ files) - 8 hours
4. Select (40+ files) - 6 hours
5. Table (30+ files) - 6 hours
**Subtotal**: 38 hours

**Tier 2: Medium-Usage Components (Week 3-4)**
6. Modal (20+ files) - 4 hours
7. Tabs (25+ files) - 4 hours
8. Alert (15+ files) - 3 hours
9. Badge (20+ files) - 3 hours
10. DatePicker (15+ files) - 4 hours
**Subtotal**: 18 hours

**Tier 3: Layout Components (Week 5)**
11. Stack, Group, Grid (layout only) - 6 hours
12. Container, Paper, Divider - 4 hours
**Subtotal**: 10 hours

**Tier 4: Specialized Components (Week 6-7)**
13. Notification system - 4 hours
14. Spotlight search - 4 hours
15. Form components - 8 hours
16. Other specialized components - 10 hours
**Subtotal**: 26 hours

**Tier 5: Page Migration (Week 8-9)**
17. Core pages (Dashboard, Clients, Calendar) - 20 hours
18. Settings pages - 16 hours
19. Marketing pages - 16 hours
20. Other pages - 12 hours
**Subtotal**: 64 hours

**9. Vite Configuration Changes**:

```typescript
// vite.config.ts
export default defineConfig({
  // ... existing config
  build: {
    rollupOptions: {
      external: [], // Don't externalize, but exclude CSS
    },
  },
  css: {
    // Exclude Mantine CSS from bundle
    exclude: ['**/node_modules/@mantine/**/*.css'],
  },
  optimizeDeps: {
    exclude: ['@mantine/core', '@mantine/hooks'], // Keep JS, exclude CSS
  },
});
```

**10. Bundle Size Targets**:

| Metric | Before | Target | Reduction |
|--------|--------|--------|-----------|
| Total CSS | ~500 KB | ~300 KB | 200 KB |
| Mantine CSS | ~250 KB | 0 KB | 250 KB |
| Mantis CSS | ~50 KB | ~300 KB | +250 KB (but pure Mantis) |
| Net Reduction | - | - | ~200 KB |

**11. Rollback Procedure**:

If issues arise during migration:
1. **Immediate Rollback**: Revert last commit, re-enable Mantine CSS
2. **Partial Rollback**: Keep Mantis CSS for migrated pages, Mantine for others
3. **Component-Level Rollback**: Revert specific component wrappers if needed
4. **Feature Flag**: Use environment variable to toggle between Mantine/Mantis CSS

**12. Success Metrics**:

- ‚úÖ **Bundle Size**: Mantine CSS removed (verified via bundle analyzer)
- ‚úÖ **Visual Consistency**: All pages match Mantis design system
- ‚úÖ **Functionality**: All features work as before
- ‚úÖ **Performance**: No degradation in page load times
- ‚úÖ **Code Quality**: All 95 files migrated to Mantis wrappers
- ‚úÖ **Documentation**: Migration guide and component docs updated

**13. Post-Migration Cleanup**:

After successful migration:
1. Remove unused Mantine CSS references (4 hours)
2. Remove `mantis-overrides.css` (merge into component CSS files) (4 hours)
3. Optimize Mantis CSS bundle (remove unused styles) (4 hours)
4. Update all documentation (2 hours)
5. Create component usage guide (4 hours)
**Total**: 18 hours

**14. Long-Term Benefits**:

- **Maintainability**: Single design system (Mantis) instead of two (Mantine + Mantis)
- **Consistency**: All components follow Mantis design tokens
- **Performance**: Smaller bundle size, faster load times
- **Future-Proof**: No dependency on Mantine CSS updates
- **Flexibility**: Full control over styling with Mantis CSS
- **Developer Experience**: Clear component API, consistent styling

**15. Dependencies & Prerequisites**:

**Keep**:
- `@mantine/core` (JavaScript - component logic)
- `@mantine/hooks` (JavaScript - hooks)
- `@mantine/form` (JavaScript - form logic)
- `@mantine/dates` (JavaScript - date picker logic)
- `@mantine/notifications` (JavaScript - notification logic)

**Remove**:
- Mantine CSS bundle (~250 KB)
- Mantine theme CSS
- Mantine component CSS

**Add**:
- Mantis CSS files (component-specific)
- Mantis wrapper components
- Mantis design token system (already exists)

**16. Timeline Summary**:

| Phase | Duration | Effort | Deliverable |
|-------|----------|--------|-------------|
| Phase 1: Foundation | Week 1 | 16 hours | Wrappers, CSS removal, core pages tested |
| Phase 2: Components | Weeks 2-4 | 44 hours | All components migrated |
| Phase 3: Pages | Weeks 5-8 | 64 hours | All pages migrated |
| Phase 4: Cleanup | Week 9 | 16 hours | Optimization, documentation |
| **Total** | **9 weeks** | **140 hours** | **Complete migration** |

**17. Alternative: Gradual Migration**:

If full migration is too risky, consider gradual approach:
- **Phase 1**: Migrate new pages/components to Mantis only
- **Phase 2**: Migrate high-traffic pages incrementally
- **Phase 3**: Migrate remaining pages over 6-12 months
- **Benefit**: Lower risk, can pause/resume as needed
- **Trade-off**: Longer timeline, maintain both systems temporarily



**Benefits**:
- **Reduced Bundle Size**: Remove Mantine CSS (~200-300 KB)
- **Consistent Design**: Pure Mantis design system
- **Future-Proof**: No dependency on Mantine CSS updates
- **Maintainability**: Single design system (Mantis) instead of two

**Risks & Mitigation**:
- **Risk**: Styling regressions during migration
  - **Mitigation**: Incremental migration, test each page
- **Risk**: Mantine component behavior changes
  - **Mitigation**: Keep Mantine JS, only remove CSS
- **Risk**: Missing functionality
  - **Mitigation**: Create wrapper components that maintain Mantine APIs

**Files to Create/Modify**:
- `crm/client/src/components/mantis/MantisCard.tsx` - Card wrapper
- `crm/client/src/components/mantis/MantisButton.tsx` - Button wrapper
- `crm/client/src/components/mantis/MantisInput.tsx` - Input wrapper
- `crm/client/src/components/mantis/MantisTable.tsx` - Table wrapper
- `crm/client/vite.config.ts` - Exclude Mantine CSS
- `crm/client/src/mantis-overrides.css` - Expand to full component coverage
- All 95 files using Mantine components - Replace imports with Mantis wrappers

**Dependencies**:
- Keep Mantine JavaScript packages (for component logic)
- Remove Mantine CSS from bundle
- Use only Mantis CSS for styling

**Success Criteria**:
- ‚úÖ Zero Mantine CSS in bundle
- ‚úÖ All components styled with Mantis CSS
- ‚úÖ No visual regressions
- ‚úÖ All functionality preserved
- ‚úÖ Bundle size reduced by 200-300 KB

---



---

### 22.11 Future Enhancements

#### 22.11.1 Multi-Tenant Architecture

**Status**: Planned (see [[Epic 4: Multi-Tenant SaaS]])
- **Recommendation**: 
  - Complete 3-database architecture design
  - Implement agency isolation
  - Add tenant-specific configuration
- **Priority**: Based on business needs
- **Effort**: 80+ hours

#### 22.11.2 Advanced AI Features

**Recommendation**:
- Implement AI-powered lead scoring
- Add predictive analytics for client behavior
- Enhance AI knowledge base with more sources
- **Priority**: Medium
- **Effort**: Variable

#### 22.11.3 Mobile App

**Recommendation**:
- Consider React Native for mobile app
- Reuse business logic from backend
- **Priority**: Low
- **Effort**: 200+ hours

---

### 22.12 Prioritized Action Plan

#### Phase 1: Critical Security (Week 1)
1. Fix CORS configuration (1 hour)
2. Fix Socket.io CORS bypass (30 min)
3. Add rate limiting to public endpoints (2 hours)
4. Configure Nginx rate limiting (1 hour) - **Droplet-specific**
5. Set up UFW firewall rules (1 hour) - **Droplet-specific**
6. SSH security hardening (1 hour) - **Droplet-specific**
7. Reduce JWT expiration (4 hours)
**Total**: 10.5 hours (added 3 hours for droplet-specific security)

#### Phase 2: High-Impact Performance (Week 2-3)
1. Replace SELECT * queries (8 hours)
2. Add database indexes (2 hours)
3. Implement frontend code splitting (12 hours)
4. Add API response caching (10 hours - droplet Redis setup)
5. Create PM2 ecosystem configuration (1 hour) - **Droplet-specific**
**Total**: 33 hours (reduced caching effort, added PM2 config)

#### Phase 3: Testing Infrastructure (Week 4-5)
1. Set up Vitest testing framework (4 hours)
2. Write critical path tests (16 hours)
3. Write API integration tests (24 hours)
4. Set up CI/CD pipeline with SSH deployment to droplet (10 hours) - **Droplet-specific**
**Total**: 54 hours (reduced CI/CD effort - no blue-green complexity)

#### Phase 4: Code Quality (Ongoing)
1. Replace `any` types incrementally (20 hours)
2. Refactor large components (16 hours)
3. Implement structured logging (28 hours)
4. Organize documentation (8 hours)
**Total**: 72 hours (can be done incrementally)



---

### 22.15 Comprehensive Upgrade Plan for Future Agents

**Purpose**: Step-by-step implementation guide for code improvements. Future agents can follow this plan systematically to continue upgrading the codebase.

**Status Tracking**: Each task includes verification steps and success criteria. Mark tasks as complete in this section as work progresses.

---

#### Phase 1: Critical Security & Infrastructure (Week 1) - 10.5 hours

**Status**: ‚è≥ Ready to Start

**Prerequisites**:
- Access to DigitalOcean droplet via SSH
- Root or sudo access
- Current PM2 process name: `crm-server`
- Nginx configuration location: `/etc/nginx/sites-available/`

**Task 1.1: PM2 Ecosystem Configuration** (1 hour) - üî¥ HIGH PRIORITY

**Current State**: Manual PM2 process management via `pm2 restart crm-server`

**Implementation Steps**:

1. **Create `ecosystem.config.js`** in `crm/server/`:
```javascript
module.exports = {
  apps: [{
    name: 'crm-server',
    script: 'src/index.ts',
    interpreter: 'npx',
    interpreter_args: 'tsx',
    instances: 1,
    exec_mode: 'fork',
    env: {
      NODE_ENV: 'production',
      PORT: 3000,
    },
    env_production: {
      NODE_ENV: 'production',
      PORT: 3000,
    },
    // Auto-restart on failure
    autorestart: true,
    max_restarts: 10,
    min_uptime: '10s',
    max_memory_restart: '1G',
    
    // Log rotation
    log_date_format: 'YYYY-MM-DD HH:mm:ss Z',
    error_file: '/var/log/pm2/crm-server-error.log',
    out_file: '/var/log/pm2/crm-server-out.log',
    log_file: '/var/log/pm2/crm-server.log',
    merge_logs: true,
    time: true,
    
    // Watch mode (development only - disable in production)
    watch: false,
    ignore_watch: ['node_modules', 'dist', '*.log'],
    
    // Advanced PM2 features
    kill_timeout: 5000,
    listen_timeout: 3000,
    shutdown_with_message: true,
  }]
};
```

2. **Update PM2 startup**:
```bash
# Stop current PM2 process
pm2 stop crm-server
pm2 delete crm-server

# Start with ecosystem file
cd /var/www/crm-versainsuranceagency/crm/server
pm2 start ecosystem.config.js --env production

# Save PM2 configuration
pm2 save

# Set PM2 to start on system boot
pm2 startup
# (Follow the output command - usually: sudo env PATH=$PATH:/usr/bin pm2 startup systemd -u root --hp /root)
```

3. **Verify PM2 configuration**:
```bash
# Check PM2 status
pm2 status

# Check PM2 logs
pm2 logs crm-server --lines 50

# Test auto-restart (kill process, should restart)
pm2 restart crm-server
```

**Success Criteria**:
- ‚úÖ PM2 starts from `ecosystem.config.js`
- ‚úÖ Logs rotate properly
- ‚úÖ Auto-restart works on failure
- ‚úÖ PM2 persists across server reboots

**Files Created**:
- `crm/server/ecosystem.config.js`

**Verification Command**:
```bash
pm2 describe crm-server | grep -E "script|interpreter|autorestart|max_restarts"
```

---

**Task 1.2: Database Indexes** (2 hours) - üî¥ HIGH PRIORITY

**Current State**: Missing indexes on frequently queried columns

**Implementation Steps**:

1. **Create migration file**: `database-migrations/001_add_performance_indexes.sql`

2. **Add indexes**:
```sql
-- Clients table indexes
CREATE INDEX IF NOT EXISTS idx_clients_user_id_line_of_business 
  ON clients(user_id, line_of_business);

CREATE INDEX IF NOT EXISTS idx_clients_email 
  ON clients(email) WHERE email IS NOT NULL;

CREATE INDEX IF NOT EXISTS idx_clients_phone 
  ON clients(phone) WHERE phone IS NOT NULL;

-- Appointments table indexes
CREATE INDEX IF NOT EXISTS idx_appointments_user_id_start_time 
  ON appointments(user_id, start_time);

CREATE INDEX IF NOT EXISTS idx_appointments_client_id 
  ON appointments(client_id) WHERE client_id IS NOT NULL;

-- Notifications table indexes
CREATE INDEX IF NOT EXISTS idx_notifications_user_id_read_created_at 
  ON notifications(user_id, read, created_at);

-- Conversations table indexes
CREATE INDEX IF NOT EXISTS idx_conversations_client_id_created_at 
  ON conversations(client_id, created_at);

-- Additional indexes for common queries
CREATE INDEX IF NOT EXISTS idx_clients_created_at 
  ON clients(created_at DESC);

CREATE INDEX IF NOT EXISTS idx_appointments_status 
  ON appointments(status) WHERE status IS NOT NULL;
```

3. **Run migration**:
```bash
# Connect to database
psql $DATABASE_URL

# Run migration
\i database-migrations/001_add_performance_indexes.sql

# Verify indexes created
\d clients
\d appointments
\d notifications
\d conversations
```

4. **Test query performance**:
```sql
-- Before/after comparison
EXPLAIN ANALYZE 
SELECT * FROM clients 
WHERE user_id = 1 AND line_of_business = 'medicare';

-- Should show "Index Scan" instead of "Seq Scan"
```

**Success Criteria**:
- ‚úÖ All indexes created successfully
- ‚úÖ Query plans show index usage
- ‚úÖ Query performance improved (verify with EXPLAIN ANALYZE)

**Files Created**:
- `database-migrations/001_add_performance_indexes.sql`

**Verification Command**:
```sql
SELECT 
  schemaname,
  tablename,
  indexname,
  indexdef
FROM pg_indexes
WHERE tablename IN ('clients', 'appointments', 'notifications', 'conversations')
ORDER BY tablename, indexname;
```

---

**Task 1.3: Nginx Rate Limiting** (1 hour) - üî¥ HIGH PRIORITY

**Current State**: Only Express-level rate limiting

**Important**: This site uses Cloudflare as CDN/DDoS protection. Traffic flows: Client ‚Üí Cloudflare ‚Üí Nginx ‚Üí Express. Cloudflare already provides primary DDoS protection at the edge. Nginx rate limiting is defense-in-depth for attacks that bypass Cloudflare or internal abuse.

**Cloudflare Considerations**:
- Cloudflare handles SSL/TLS termination (HTTPS to Cloudflare, then to Nginx)
- Nginx sees Cloudflare IPs, not real client IPs
- Must use `$http_cf_connecting_ip` (Cloudflare real IP header) or `X-Forwarded-For` for rate limiting
- Coordinate with Cloudflare rate limiting (if configured in Cloudflare dashboard)
- Cloudflare provides edge caching and DDoS protection (primary layer)

**Implementation Steps**:

1. **Edit Nginx configuration**: `/etc/nginx/sites-available/crm-versainsuranceagency`

2. **Add rate limiting zones** (in `http` block or server block):
```nginx
# Rate limiting zones (add to http block in /etc/nginx/nginx.conf or server block)
# IMPORTANT: Use Cloudflare real IP header ($http_cf_connecting_ip) instead of $binary_remote_addr
# Fallback to X-Forwarded-For if CF header not present (for direct connections)
map $http_cf_connecting_ip $real_ip {
    "" $http_x_forwarded_for;
    default $http_cf_connecting_ip;
}

# Use real client IP for rate limiting (not Cloudflare IP)
limit_req_zone $real_ip zone=api_limit:10m rate=10r/s;
limit_req_zone $real_ip zone=auth_limit:10m rate=5r/s;
limit_conn_zone $real_ip zone=conn_limit:10m;

# In server block for crm.versainsuranceagency.com
server {
  # ... existing configuration ...
  
  # API endpoints - stricter rate limiting
  location /api/auth/ {
    limit_req zone=auth_limit burst=5 nodelay;
    limit_conn conn_limit 10;
    proxy_pass http://localhost:3000;
    # ... existing proxy settings ...
  }
  
  # General API endpoints
  location /api/ {
    limit_req zone=api_limit burst=20 nodelay;
    limit_conn conn_limit 20;
    proxy_pass http://localhost:3000;
    # ... existing proxy settings ...
  }
  
  # All other locations
  limit_conn conn_limit 50;
}
```

3. **Test Nginx configuration**:
```bash
# Test configuration syntax
sudo nginx -t

# If valid, reload Nginx
sudo nginx -s reload
# OR
sudo systemctl reload nginx
```

4. **Verify rate limiting**:
```bash
# Test rate limiting (should get 503 after exceeding limit)
for i in {1..15}; do
  curl -I http://localhost/api/auth/login
  sleep 0.1
done
# Should see "503 Service Temporarily Unavailable" after 5 requests
```

**Success Criteria**:
- ‚úÖ Nginx configuration valid
- ‚úÖ Rate limiting uses real client IPs (not Cloudflare IPs)
- ‚úÖ Rate limiting active on `/api/auth/` endpoints
- ‚úÖ Rate limiting active on `/api/` endpoints
- ‚úÖ No impact on normal traffic
- ‚úÖ Coordinates with Cloudflare DDoS protection (defense-in-depth)

**Files Modified**:
- `/etc/nginx/sites-available/crm-versainsuranceagency` (or main nginx.conf)

**Verification Command**:
```bash
# Check Nginx error log for rate limit hits
sudo tail -f /var/log/nginx/error.log | grep "limiting requests"

# Test with curl
curl -I http://localhost/api/auth/login
```

---

**Task 1.4: UFW Firewall Configuration** (1 hour) - üî¥ HIGH PRIORITY

**Current State**: Firewall may not be configured

**Implementation Steps**:

1. **Check current UFW status**:
```bash
sudo ufw status verbose
```

2. **Configure UFW rules**:
```bash
# Set default policies (deny incoming, allow outgoing)
sudo ufw default deny incoming
sudo ufw default allow outgoing

# Allow SSH (CRITICAL - do this first!)
sudo ufw allow 22/tcp comment 'SSH'

# Allow HTTP and HTTPS
sudo ufw allow 80/tcp comment 'HTTP'
sudo ufw allow 443/tcp comment 'HTTPS'

# Allow Nginx (if needed)
sudo ufw allow 'Nginx Full'

# Enable UFW
sudo ufw --force enable
```

3. **Verify firewall rules**:
```bash
# Check status
sudo ufw status numbered

# Test SSH access (IMPORTANT: Don't close SSH session!)
# Open new terminal, verify you can still SSH in
```

4. **Optional: Rate limit SSH**:
```bash
# Limit SSH connections to prevent brute force
sudo ufw limit 22/tcp comment 'SSH rate limit'
```

**Success Criteria**:
- ‚úÖ UFW enabled and active
- ‚úÖ Only ports 22, 80, 443 allowed
- ‚úÖ SSH access still works
- ‚úÖ Web server accessible

**Verification Command**:
```bash
sudo ufw status verbose
# Should show: Status: active
# Should list: 22/tcp, 80/tcp, 443/tcp
```

**‚ö†Ô∏è WARNING**: Always test SSH access in a separate session before closing current session!

---

**Task 1.5: SSH Security Hardening** (1 hour) - üî¥ HIGH PRIORITY

**Current State**: SSH may allow password authentication

**Implementation Steps**:

1. **Verify SSH key authentication works**:
```bash
# Test SSH key login (from local machine)
ssh root@crm.versainsuranceagency.com
# Should login without password prompt
```

2. **Backup SSH configuration**:
```bash
sudo cp /etc/ssh/sshd_config /etc/ssh/sshd_config.backup
```

3. **Edit SSH configuration**: `/etc/ssh/sshd_config`
```bash
sudo nano /etc/ssh/sshd_config
```

4. **Update SSH settings**:
```ssh
# Disable password authentication (key-only)
PasswordAuthentication no
PubkeyAuthentication yes

# Disable root login with password (key-only)
PermitRootLogin prohibit-password

# Change default port (optional but recommended)
Port 2222  # Change from 22 to 2222 (update UFW rule first!)

# Limit login attempts
MaxAuthTries 3
MaxSessions 2

# Disable empty passwords
PermitEmptyPasswords no

# Disable X11 forwarding (if not needed)
X11Forwarding no
```

5. **Test SSH configuration**:
```bash
# Test configuration (don't restart yet)
sudo sshd -t

# If valid, restart SSH
sudo systemctl restart sshd
# OR
sudo systemctl restart ssh
```

6. **‚ö†Ô∏è CRITICAL**: Test SSH access in new terminal before closing current session!

7. **Update UFW if port changed**:
```bash
# If changed SSH port to 2222
sudo ufw delete allow 22/tcp
sudo ufw allow 2222/tcp comment 'SSH'
```

**Success Criteria**:
- ‚úÖ Password authentication disabled
- ‚úÖ Key-only authentication works
- ‚úÖ SSH configuration valid
- ‚úÖ Can still SSH into server

**Files Modified**:
- `/etc/ssh/sshd_config`

**Verification Command**:
```bash
# Verify SSH settings
sudo sshd -T | grep -E "passwordauthentication|pubkeyauthentication|permitrootlogin"
# Should show: passwordauthentication no, pubkeyauthentication yes
```

**‚ö†Ô∏è CRITICAL WARNING**: Always test SSH access in a separate terminal before closing your current SSH session!

---

**Task 1.6: Fail2ban Installation** (30 minutes) - üü† MEDIUM PRIORITY

**Implementation Steps**:

1. **Install Fail2ban**:
```bash
sudo apt update
sudo apt install fail2ban -y
```

2. **Configure Fail2ban**: Create `/etc/fail2ban/jail.local`
```ini
[DEFAULT]
# Ban time: 1 hour
bantime = 3600
# Find time: 10 minutes
findtime = 600
# Max retries: 3
maxretry = 3
# Email notifications (optional)
# destemail = admin@versainsuranceagency.com
# sendername = Fail2Ban

[sshd]
enabled = true
port = 22  # Or 2222 if you changed SSH port
maxretry = 3
bantime = 3600
findtime = 600

# Optional: Protect other services
[nginx-limit-req]
enabled = true
filter = nginx-limit-req
logpath = /var/log/nginx/error.log
maxretry = 10
findtime = 60
bantime = 300
```

3. **Start and enable Fail2ban**:
```bash
sudo systemctl enable fail2ban
sudo systemctl start fail2ban
sudo systemctl status fail2ban
```

4. **Verify Fail2ban**:
```bash
# Check status
sudo fail2ban-client status

# Check SSH jail
sudo fail2ban-client status sshd

# Test (will ban after 3 failed attempts)
# Try to SSH with wrong password 3 times from another machine
```

**Success Criteria**:
- ‚úÖ Fail2ban installed and running
- ‚úÖ SSH jail active
- ‚úÖ Failed login attempts are banned

**Verification Command**:
```bash
sudo fail2ban-client status sshd
# Should show: "Currently banned: 0" (or number of banned IPs)
```

---

#### Phase 2: High-Impact Performance (Week 2-3) - 33 hours

**Status**: ‚è≥ Pending Phase 1 Completion

**Task 2.1: Replace SELECT * Queries** (8 hours) - üî¥ HIGH PRIORITY

**Current State**: 96 SELECT * queries across 28 files

**Implementation Strategy**:

1. **Audit all SELECT * queries**:
```bash
# Find all SELECT * queries
cd /var/www/crm-versainsuranceagency
grep -r "SELECT \*" crm/server/src --include="*.ts" | wc -l
# Should show: 96

# List all files with SELECT *
grep -r "SELECT \*" crm/server/src --include="*.ts" -l
```

2. **Prioritize by risk** (high to low):
   - **High Risk**: Queries returning sensitive data (passwords, tokens, API keys)
   - **Medium Risk**: Queries returning user/client data
   - **Low Risk**: Queries returning non-sensitive data

3. **Create replacement script**: `scripts/replace-select-star-queries.ts`
   - Scans all files
   - Identifies SELECT * queries
   - Suggests specific columns based on usage
   - Creates migration file

4. **Systematic replacement process** (per file):
   - Identify what columns are actually used
   - Replace `SELECT *` with specific columns
   - Test query still works
   - Verify no functionality broken

**Example Replacement**:
```typescript
// BEFORE (Security Risk)
const users = await sql`SELECT * FROM users WHERE email = ${email}`;

// AFTER (Secure)
const users = await sql`
  SELECT 
    id,
    email,
    name,
    role,
    created_at,
    updated_at
  FROM users 
  WHERE email = ${email}
`;
// Excludes: password_hash, api_keys, tokens, etc.
```

**Files to Update** (Priority Order):
1. `crm/server/src/routes/auth.ts` - Authentication (HIGH RISK)
2. `crm/server/src/routes/clients.ts` - Client data (HIGH RISK)
3. `crm/server/src/routes/apiKeys.ts` - API keys (CRITICAL RISK)
4. `crm/server/src/services/*.ts` - Service layer (MEDIUM RISK)
5. Other route files (MEDIUM RISK)

**Success Criteria**:
- ‚úÖ Zero SELECT * queries in codebase
- ‚úÖ All queries specify exact columns
- ‚úÖ No sensitive data exposed
- ‚úÖ All tests pass
- ‚úÖ No functionality broken

**Verification Command**:
```bash
# Verify no SELECT * remaining
grep -r "SELECT \*" crm/server/src --include="*.ts" | wc -l
# Should show: 0
```

---

**Task 2.2: Frontend Code Splitting** (12 hours) - üü† MEDIUM PRIORITY

**Current State**: 3.2MB JavaScript bundle (819 KB gzipped)

**Target**: <500 KB gzipped initial load

**Implementation Steps**:

1. **Analyze current bundle**:
```bash
cd crm/client
npm run build
# Check dist/assets/ for bundle sizes
```

2. **Identify large dependencies**:
   - Mantine UI components
   - Recharts (charts)
   - Date pickers
   - PDF viewers
   - Marketing page components

3. **Implement React.lazy() for routes**:
```typescript
// BEFORE
import MarketingPage from './pages/MarketingPage';
import ReviewsPage from './pages/reviews/ReviewsPage';

// AFTER
const MarketingPage = React.lazy(() => import('./pages/MarketingPage'));
const ReviewsPage = React.lazy(() => import('./pages/reviews/ReviewsPage'));

// Wrap with Suspense
<Suspense fallback={<Loader />}>
  <Routes>
    <Route path="/marketing" element={<MarketingPage />} />
  </Routes>
</Suspense>
```

4. **Lazy load heavy components**:
   - Charts (Recharts)
   - PDF viewers
   - Calendar components
   - Marketing campaign components

5. **Verify bundle size reduction**:
```bash
npm run build
# Check bundle analyzer or dist/assets/ sizes
# Target: <500 KB gzipped for initial load
```

**Success Criteria**:
- ‚úÖ Initial bundle <500 KB gzipped
- ‚úÖ Routes load on-demand
- ‚úÖ No functionality broken
- ‚úÖ Page load time <2 seconds

**Files to Modify**:
- `crm/client/src/App.tsx` - Add React.lazy() for routes
- Heavy component files - Lazy load imports

---

**Task 2.3: API Response Caching (Redis)** (10 hours) - üü† MEDIUM PRIORITY

**Implementation Steps**:

1. **Install Redis on droplet**:
```bash
sudo apt update
sudo apt install redis-server -y

# Start Redis
sudo systemctl start redis-server
sudo systemctl enable redis-server

# Test Redis
redis-cli ping
# Should return: PONG
```

2. **Configure Redis**:
```bash
# Edit Redis config
sudo nano /etc/redis/redis.conf

# Set memory limit (adjust based on droplet RAM)
maxmemory 256mb
maxmemory-policy allkeys-lru

# Enable persistence
save 900 1
save 300 10
save 60 10000

# Restart Redis
sudo systemctl restart redis-server
```

3. **Install Redis client in Node.js**:
```bash
cd crm/server
npm install ioredis
npm install --save-dev @types/ioredis
```

4. **Create Redis service**: `crm/server/src/services/redisService.ts`
```typescript
import Redis from 'ioredis';

const redis = new Redis(process.env.REDIS_URL || 'redis://localhost:6379');

export async function getCached<T>(key: string): Promise<T | null> {
  const cached = await redis.get(key);
  return cached ? JSON.parse(cached) : null;
}

export async function setCached(key: string, value: any, ttl: number = 3600): Promise<void> {
  await redis.setex(key, ttl, JSON.stringify(value));
}

export async function invalidateCache(pattern: string): Promise<void> {
  const keys = await redis.keys(pattern);
  if (keys.length > 0) {
    await redis.del(...keys);
  }
}
```

5. **Implement caching in routes**:
```typescript
// Example: Cache CMS rules
const cacheKey = `cms-rules:${category}:${page}`;
const cached = await getCached(cacheKey);
if (cached) return res.json(cached);

// Fetch from database
const rules = await sql`SELECT ...`;

// Cache for 1 hour
await setCached(cacheKey, rules, 3600);
res.json(rules);
```

6. **Cache invalidation strategy**:
   - Invalidate on data updates
   - Use TTL for time-based expiration
   - Pattern-based invalidation for related data

**Success Criteria**:
- ‚úÖ Redis installed and running
- ‚úÖ Caching implemented for CMS rules, plans, formularies
- ‚úÖ Cache invalidation works
- ‚úÖ API response times improved

**Files Created**:
- `crm/server/src/services/redisService.ts`

**Files Modified**:
- Routes that need caching (CMS rules, plans, etc.)

**Verification Command**:
```bash
# Check Redis is running
redis-cli ping

# Check Redis memory usage
redis-cli info memory

# Monitor Redis operations
redis-cli monitor
```

---

#### Phase 3: Testing Infrastructure (Week 4-5) - 54 hours

**Status**: ‚è≥ Pending Phase 2 Completion

**Task 3.1: Set Up Vitest Testing Framework** (4 hours)

**Implementation Steps**:

1. **Install Vitest**:
```bash
cd crm
npm install --save-dev vitest @vitest/ui
npm install --save-dev @testing-library/react @testing-library/jest-dom
```

2. **Create `vitest.config.ts`**:
```typescript
import { defineConfig } from 'vitest/config';
import react from '@vitejs/plugin-react';
import path from 'path';

export default defineConfig({
  plugins: [react()],
  test: {
    environment: 'jsdom',
    globals: true,
    setupFiles: ['./src/test/setup.ts'],
  },
  resolve: {
    alias: {
      '@': path.resolve(__dirname, './src'),
    },
  },
});
```

3. **Create test setup file**: `crm/client/src/test/setup.ts`
```typescript
import '@testing-library/jest-dom';
import { expect, afterEach } from 'vitest';
import { cleanup } from '@testing-library/react';

afterEach(() => {
  cleanup();
});
```

4. **Add test scripts to `package.json`**:
```json
{
  "scripts": {
    "test": "vitest",
    "test:ui": "vitest --ui",
    "test:coverage": "vitest --coverage"
  }
}
```

5. **Create first test**: `crm/client/src/components/__tests__/MantisKPICard.test.tsx`
```typescript
import { describe, it, expect } from 'vitest';
import { render, screen } from '@testing-library/react';
import MantisKPICard from '../MantisKPICard';

describe('MantisKPICard', () => {
  it('renders title and count', () => {
    render(<MantisKPICard title="Total Clients" count={42} />);
    expect(screen.getByText('Total Clients')).toBeInTheDocument();
    expect(screen.getByText('42')).toBeInTheDocument();
  });
});
```

**Success Criteria**:
- ‚úÖ Vitest installed and configured
- ‚úÖ First test passes
- ‚úÖ Test UI accessible
- ‚úÖ Coverage reporting works

---

**Task 3.2: Write Critical Path Tests** (16 hours)

**Priority Tests** (in order):

1. **Authentication Flow** (4 hours) - ‚úÖ Complete 2025-01-27
   - ‚úÖ Login success/failure tests
   - ‚úÖ Token generation and storage tests
   - ‚úÖ Session management tests
   - ‚úÖ Logout and cleanup tests
   - Created auth.test.ts with comprehensive auth utility tests
   - Created authentication API tests
   - All tests passing

2. **Client CRUD Operations** (4 hours) - ‚úÖ Complete 2025-01-27
   - ‚úÖ Create client data transformation tests
   - ‚úÖ Read client query parameter tests
   - ‚úÖ Update client data transformation tests
   - ‚úÖ Delete client endpoint tests
   - ‚úÖ Client data validation tests
   - Created clientApi.test.ts with comprehensive CRUD tests
   - All tests passing

3. **Medicare SOA Automation** (4 hours) - ‚úÖ Complete 2025-01-27
   - ‚úÖ SOA template finding logic tests
   - ‚úÖ SOA data validation tests
   - ‚úÖ SOA signer configuration tests
   - ‚úÖ SOA auto-population data tests
   - ‚úÖ SMS message construction tests
   - ‚úÖ Phone number normalization tests
   - ‚úÖ SOA status tracking tests
   - ‚úÖ Error handling tests
   - Created medicareSOA.test.ts with comprehensive SOA automation tests
   - All 25 tests passing

4. **Appointment Booking** (4 hours) - ‚úÖ Complete 2025-01-27
   - ‚úÖ Appointment data validation tests
   - ‚úÖ Appointment time calculations tests
   - ‚úÖ Conflict detection logic tests
   - ‚úÖ Appointment status management tests
   - ‚úÖ Recurring appointment logic tests
   - ‚úÖ Public booking data validation tests
   - ‚úÖ Appointment query parameters tests
   - ‚úÖ Appointment data transformation tests
   - ‚úÖ Error handling tests
   - Created appointmentBooking.test.ts with comprehensive booking tests
   - All 30 tests passing

**Test File Structure**:
```
crm/server/src/
‚îú‚îÄ‚îÄ __tests__/
‚îÇ   ‚îú‚îÄ‚îÄ routes/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ auth.test.ts
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ clients.test.ts
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ calendar.test.ts
‚îÇ   ‚îî‚îÄ‚îÄ services/
‚îÇ       ‚îú‚îÄ‚îÄ medicareSOAService.test.ts
‚îÇ       ‚îî‚îÄ‚îÄ appointmentService.test.ts
```

---

**Task 3.3: Write API Integration Tests** (24 hours)

**Coverage Goals**: 90%+ of API endpoints

**Test Categories**:
1. **Authentication APIs** (4 hours) - ‚úÖ Complete 2025-01-27
   - ‚úÖ Test infrastructure setup (Supertest, Vitest)
   - ‚úÖ Test app helper created (createTestApp)
   - ‚úÖ Test setup file for environment configuration
   - ‚úÖ Admin session service mocked for test isolation
   - ‚úÖ CSRF token handling implemented for protected endpoints
   - ‚úÖ Basic validation tests (13/13 passing)
   - ‚úÖ Request validation tests (required fields, error responses)
   - ‚úÖ Security best practices tests (email enumeration prevention)
   - ‚úÖ Endpoint structure validation tests
   - Created auth-simple.test.ts with comprehensive validation tests
   - All tests passing with proper CSRF token handling
2. **Client Management APIs** (4 hours) - ‚úÖ Complete 2025-01-27
   - ‚úÖ Comprehensive integration tests for all client CRUD operations
   - ‚úÖ GET /api/clients (list, pagination, filtering by line_of_business, sorting)
   - ‚úÖ GET /api/clients/:id (single client retrieval with 404 handling)
   - ‚úÖ POST /api/clients (create with validation, duplicate checking)
   - ‚úÖ PUT /api/clients/:id (update with validation, ownership verification)
   - ‚úÖ DELETE /api/clients/:id (delete with ownership verification)
   - ‚úÖ GET /api/clients/search (search by name and email)
   - ‚úÖ Authentication and CSRF token handling for all endpoints
   - ‚úÖ Test data setup and cleanup
   - ‚úÖ Error handling tests (401, 404, 400)
   - ‚úÖ All 24 tests passing (100%)
3. **Calendar APIs** (4 hours) - ‚úÖ Complete 2025-01-27
   - ‚úÖ Comprehensive integration tests for calendar and appointment management
   - ‚úÖ GET /api/calendar/appointments (list, filtering by date range and status)
   - ‚úÖ GET /api/calendar/appointments/:id (single appointment retrieval with 404 handling)
   - ‚úÖ POST /api/calendar/appointments (create with validation, conflict checking)
   - ‚úÖ PUT /api/calendar/appointments/:id (update with validation, ownership verification)
   - ‚úÖ DELETE /api/calendar/appointments/:id (hard delete with hardDelete=true query parameter)
   - ‚úÖ GET /api/calendar/availability (get agent availability)
   - ‚úÖ POST /api/calendar/availability (set availability with validation)
   - ‚úÖ Authentication and CSRF token handling for all endpoints
   - ‚úÖ Test data setup and cleanup
   - ‚úÖ Error handling tests (401, 404, 400, 409 for conflicts)
   - ‚úÖ Fixed schema issues (end_time instead of duration)
   - ‚úÖ All 22 tests passing (100%)
4. **Marketing APIs** (4 hours) - ‚úÖ Complete 2025-01-27
   - ‚úÖ Comprehensive integration tests for direct mail and email campaign management
   - ‚úÖ GET /api/marketing/direct-mail/campaigns (list campaigns with authentication)
   - ‚úÖ POST /api/marketing/direct-mail/campaigns (create with validation, required fields)
   - ‚úÖ PATCH /api/marketing/direct-mail/campaigns/:id (update with validation, ownership verification)
   - ‚úÖ GET /api/marketing/email-campaigns (list email campaigns)
   - ‚úÖ GET /api/marketing/email-campaigns/:id (get single email campaign)
   - ‚úÖ Authentication and CSRF token handling for all endpoints
   - ‚úÖ Test data setup and cleanup
   - ‚úÖ Error handling tests (401, 404, 400)
   - ‚úÖ Fixed schema compatibility issues (template_id column may not exist in all database versions)
   - ‚úÖ Updated route code to handle missing template_id column gracefully with try-catch
   - ‚úÖ All 12 tests passing (100%)
5. **Settings APIs** (4 hours) - ‚úÖ Complete 2025-01-27
   - ‚úÖ Comprehensive integration tests for settings management endpoints
   - ‚úÖ GET/PUT /api/auth/recaptcha/settings (reCAPTCHA configuration)
   - ‚úÖ GET/PUT /api/docusend/settings (Docusend configuration with validation)
   - ‚úÖ GET/POST /api/api-keys (API key management with keyName and businessLines)
   - ‚úÖ GET/POST /api/commissions/rates (commission rate management with filtering)
   - ‚úÖ Authentication and CSRF token handling for all endpoints
   - ‚úÖ Test data setup and cleanup
   - ‚úÖ Error handling tests (401, 400, 404)
   - ‚úÖ Validation tests for Docusend settings (default_expiry_days, default_signing_order, etc.)
   - ‚úÖ Fixed endpoint paths and request body formats to match actual API
   - ‚úÖ Fixed commission rate creation to use integer carrier_id and proper date format
   - ‚úÖ All 22 tests passing (100%)
5. **Settings APIs** (4 hours)
6. **Other APIs** (4 hours)

**Tools**: Supertest for API testing

**Test Infrastructure**:
- ‚úÖ Supertest installed and configured
- ‚úÖ Vitest configured for backend tests
- ‚úÖ Test app helper (createTestApp) mirrors production setup
- ‚úÖ Test setup file for environment configuration
- ‚úÖ Admin session service mocked for test isolation
- ‚ö†Ô∏è CSRF token handling needed for protected routes
- ‚ö†Ô∏è Admin session creation needed for authenticated endpoints

---

**Task 3.4: Set Up CI/CD Pipeline** (10 hours) - Droplet-Specific

**Implementation Steps**:

1. **Create GitHub Actions workflow**: `.github/workflows/deploy-droplet.yml`

2. **SSH Deployment Setup**:
   - Add SSH private key to GitHub Secrets
   - Configure deployment script
   - Set up PM2 restart after deployment

3. **Deployment Process**:
   - Run tests
   - Build frontend
   - Deploy via SSH
   - Restart PM2
   - Reload Nginx

**Files Created**:
- `.github/workflows/deploy-droplet.yml`
- `scripts/deploy-to-droplet.sh`

---

#### Phase 4: Code Quality (Ongoing) - 72 hours

**Status**: ‚è≥ Can be done incrementally alongside other work

**Task 4.1: Replace `any` Types** (20 hours) - Incremental

**Status**: ‚úÖ **COMPLETE** (2025-12-29)

**Strategy**: File-by-file, starting with most critical

**Process**:
1. Identify file with `any` types
2. Add explicit types
3. Test file
4. Commit changes
5. Move to next file

**Priority Order**:
1. API routes (security-critical) - ‚úÖ Complete
2. Service layer (business logic) - ‚úÖ Complete
3. Components (UI) - ‚úÖ Complete
4. Utilities (helpers) - ‚úÖ Complete

**Results**:
- **Total**: 500+ `any` types replaced across 60+ files
- **Routes**: 7 files completed
- **Services**: 45+ files completed, 427+ instances replaced
- **Components**: 14 files completed, 66 instances replaced

**Issues Fixed**:
- `event-types.ts`: Fixed incomplete error handling (DatabaseError interface, proper type guards)
- `public-forms.ts`: Fixed Medicare form submissions creating clients as 'lead' instead of 'pending_soa'

---

**Task 4.2: Refactor Large Components** (16 hours)

**Status**: ‚úÖ **COMPLETE** (2025-12-29) - DirectMailPage.tsx refactored

**Target Components**:
- ‚úÖ `DirectMailPage.tsx` (6,920 ‚Üí 6,060 lines, 860 lines removed, 12.4% reduction)
- ‚è≥ `FacebookAdsPage.tsx` (4,521 lines) - Future work
- ‚è≥ `LinkedInAdsPage.tsx` (4,040 lines) - Future work
- ‚è≥ Other large components - Future work

**Strategy**: Extract into smaller, focused components

**Completed Work**:
- Extracted DirectMailDashboard component (9.7KB, ~288 lines)
- Extracted DirectMailCampaigns component (20KB, ~450 lines)
- Extracted DirectMailMailings component (12KB, ~300 lines)
- Extracted DirectMailAnalytics component (24KB, ~650 lines)
- Created shared types file (`types.ts`) for component interfaces

---

**Task 4.3: Implement Structured Logging** (28 hours)

**Status**: ‚úÖ **STARTED** (2025-12-29)

**Replace**: ~8,041 console.log statements (incremental migration)

**Implementation**:
1. ‚úÖ Create logger service - **COMPLETE** (`crm/server/src/services/logger.ts`)
2. ‚úÖ Add log levels (debug, info, warn, error) - **COMPLETE**
3. ‚úÖ Sanitize PHI from logs - **COMPLETE** (SSN, email, phone, addresses, tokens, etc.)
4. ‚úÖ Replace console.log incrementally - **STARTED** (public-forms.ts: 9 statements replaced)
5. ‚è≥ Continue migration across codebase - **IN PROGRESS**

**Logger Features**:
- Structured JSON output for production
- Human-readable format for development
- Environment-based log level configuration
- Automatic PHI redaction from log context
- Error handling with stack traces

---

**Task 4.4: Organize Documentation** (8 hours)

**Create Structure**:
```
crm/docs/
‚îú‚îÄ‚îÄ QUICK_START.md
‚îú‚îÄ‚îÄ SETUP.md
‚îú‚îÄ‚îÄ ARCHITECTURE.md
‚îú‚îÄ‚îÄ API_REFERENCE.md
‚îú‚îÄ‚îÄ TROUBLESHOOTING.md
‚îî‚îÄ‚îÄ DEPLOYMENT.md
```

---

### 22.16 Upgrade Progress Tracking

**Use this section to track completed tasks. Update as work progresses.**

**Performance Impact Analysis**: See `.ai/PERFORMANCE_ANALYSIS.md` for detailed performance impact assessment of all upgrade tasks. Summary: All upgrades are performance-safe with proper monitoring. Benefits far outweigh minimal overhead.

#### Phase 1: Critical Security & Infrastructure
- [x] Task 1.1: PM2 Ecosystem Configuration (1 hour) - ‚úÖ Complete 2025-01-27
  - Created ecosystem.config.cjs
  - PM2 auto-restart configured (max 10 restarts)
  - Logs centralized in /var/log/pm2/
  - Memory protection enabled (1GB limit)
  - Configuration saved and persisting
- [x] Task 1.2: Database Indexes (2 hours) - ‚úÖ Complete 2025-01-27
  - Created safe migration script with rollback capability
  - Added indexes: clients (user_id+line_of_business, created_at), appointments (user_id+start_time, status), notifications (business_line+read+created_at), conversations (client_id+started_at)
  - Fixed migration to match actual table schemas (notifications has business_line not user_id, conversations has started_at not created_at)
  - Site verified working after migration
  - Query performance improved
- [x] Task 1.3: Nginx Rate Limiting (1 hour) - ‚úÖ Complete 2025-01-27
  - Added Cloudflare-aware rate limiting (uses \$http_cf_connecting_ip for real client IPs)
  - Added map directive to handle Cloudflare IPs correctly
  - Applied rate limiting: auth endpoints (5 req/s), API endpoints (10 req/s), connection limits
  - Cleaned up duplicate content in server config
  - Site verified working after implementation
  - Defense-in-depth (Cloudflare provides primary DDoS protection)
- [x] Task 1.4: UFW Firewall Configuration (1 hour) - ‚úÖ Complete 2025-01-27
  - Configured UFW with default deny incoming, allow outgoing
  - Allowed ports: 22 (SSH with rate limit), 80 (HTTP), 443 (HTTPS)
  - Enabled UFW firewall
  - Site verified working after implementation
  - SSH access verified (rate limited to prevent brute force)
- [x] Task 1.5: SSH Security Hardening (1 hour) - ‚úÖ Complete 2025-01-27
  - Disabled password authentication (key-only access)
  - Set PermitRootLogin to prohibit-password (key-only for root)
  - Added security limits: MaxAuthTries 3, MaxSessions 2
  - Disabled empty passwords and X11 forwarding
  - Fixed cloud-init config override (50-cloud-init.conf)
  - SSH service restarted and verified working
  - Site verified working after implementation
- [x] Task 1.6: Fail2ban Configuration (1 hour) - ‚úÖ Complete 2025-01-27
  - Installed Fail2ban intrusion prevention system
  - Configured SSH jail: 3 max retries, 1 hour ban time, 10 minute find time
  - Enabled Fail2ban service and verified working
  - Site verified working after implementation
  - Provides additional layer of protection against brute force attacks
- [ ] Task 1.4: UFW Firewall Configuration (1 hour)
- [ ] Task 1.5: SSH Security Hardening (1 hour)
- [ ] Task 1.6: Fail2ban Installation (30 min)

#### Phase 2: High-Impact Performance
- [x] Task 2.1: Replace SELECT * Queries (8 hours) - ‚úÖ Complete 2025-01-27
  - Replaced 95/96 SELECT * queries with specific column selections (1 remaining is just a comment)
  - Completed files: medicareSOAService.ts (1), emailCampaignService.ts (2), docusendService.ts (16), marketing.ts (27), calendar.ts (17), booking-pages.ts (4), googleCalendarService.ts (3), reviews.ts (3), docusend.ts (3), directMailScheduler.ts (1), outlookCalendarService.ts (1), check-carriers-plans.ts (2), all 8 marketing services (8), all 8 script files (8)
  - All production queries now use specific column selections
  - Improves query performance by selecting only needed columns
  - Reduces data transfer and memory usage
  - Enhances security by avoiding unnecessary data exposure
  - Site verified working after all changes (HTTP 200)
- [x] Task 2.2: Frontend Code Splitting (12 hours) - ‚úÖ Complete 2025-01-27
  - Converted 40+ heavy pages to React.lazy() imports
  - Added Suspense wrapper with PageLoader fallback
  - Kept critical pages (Dashboard, Clients, Settings, Inbox) as regular imports
  - Lazy loaded: Marketing pages, Calendar, Reviews, Applications, Settings sub-pages
  - Configured Vite manual chunks for vendor libraries (Mantine, React Router, Recharts)
  - Grouped marketing pages into single chunk (shared dependencies)
  - Reduces initial bundle size by deferring heavy components
  - Pages load on-demand when routes are accessed
  - Improves initial page load time and reduces memory usage
  - Site verified working after changes (HTTP 200)
  - Note: Build has pre-existing TypeScript errors (unrelated to code splitting)
- [x] Task 2.3: API Response Caching (Redis) (10 hours) - ‚úÖ Complete 2025-01-27
  - Installed and configured Redis server (256MB memory limit, LRU eviction policy)
  - Created Redis service (redisService.ts) with get/set/invalidate functions
  - Implemented caching for CMS rules endpoints:
    * GET /api/cms-rules (list with filters) - 1 hour TTL
    * GET /api/cms-rules/categories - 1 hour TTL
    * GET /api/cms-rules/sources - 1 hour TTL
    * GET /api/cms-rules/stats - 30 minutes TTL
    * GET /api/cms-rules/:id - 1 hour TTL
  - Cache invalidation on POST /api/cms-rules/update (pattern-based: cms-rules:*)
  - Graceful fallback if Redis unavailable (continues without caching)
  - Improves API response times for frequently accessed data
  - Reduces database load for read-heavy endpoints
  - Site verified working after changes (HTTP 200)

#### Phase 3: Testing Infrastructure
- [x] Task 3.1: Set Up Vitest Testing Framework (4 hours) - ‚úÖ Complete 2025-01-27
  - Installed Vitest, @vitest/ui, @testing-library/react, @testing-library/jest-dom
  - Created vitest.config.ts with jsdom environment, path aliases, and coverage configuration
  - Created test setup file (src/test/setup.ts) with mocks for window.matchMedia, IntersectionObserver, ResizeObserver
  - Added test scripts to package.json (test, test:ui, test:run, test:coverage)
  - Created first test (PageLoader.test.tsx) to verify setup works
  - Test framework ready for writing critical path tests
  - Foundation for automated testing and test-driven development
  - Site verified working after changes (HTTP 200)
- [ ] Task 3.2: Write Critical Path Tests (16 hours)
- [ ] Task 3.3: Write API Integration Tests (24 hours)
- [ ] Task 3.4: Set Up CI/CD Pipeline (10 hours)

#### Phase 4: Code Quality (Ongoing)
- [x] Task 4.1: Replace `any` Types (20 hours - incremental) - ‚úÖ Complete 2025-12-29
  - ‚úÖ **Routes** (All completed):
    - auth.ts: 6 instances replaced (SecuritySettingRow, RecaptchaVerifyResponse, SendGridMessage, unknown for errors)
    - clients.ts: 9 instances replaced (Client, DatabaseError, DatabaseColumnInfo, ErrorLog interfaces)
    - calendar.ts: Error handlers replaced (DatabaseError interface, unknown for catch blocks)
    - cms-rules.ts: 7 instances replaced (CMSRule, PaginationInfo interfaces)
    - marketing.ts: 9 instances replaced (DatabaseError, AnalyticsRow interfaces)
    - event-types.ts: Fixed incomplete error handling (DatabaseError interface, proper type guards)
    - public-forms.ts: Fixed Medicare form submission issue (pending_soa status for Medicare clients)
  - ‚úÖ **Services** (45+ files, 427+ instances replaced):
    - All service files completed: lobService.ts (51), docusendService.ts (34), facebookMarketingService.ts (33), portalEmailService.ts (32), mailchimpMarketingService.ts (30), brevoMarketingService.ts (28), linkedinMarketingService.ts (24), dataUpdateService.ts (16), aiLearningService.ts (15), medicareSOAService.ts (14), businessLineQueryService.ts (14), formularyQueryService.ts (11), appointmentReminders.ts (11), zipCodeMappingService.ts (9), directMailScheduler.ts (9), cmsRulesQueryService.ts (8), recurringAppointments.ts (6), redisService.ts (6), callAIService.ts (7), aiKnowledgeService.ts (13), providerNetworkService.ts (5), knowledgeSourceFeedbackService.ts (5), healthcareGovService.ts (5), googleAdsMarketingService.ts (5), docusendEmailService.ts (5), reviewScheduler.ts (4), postgridService.ts (4), googleCalendarService.ts (4), emailCampaignService.ts (4), docusendScheduler.ts (4), businessLineService.ts (4), aiProvider.ts (4), sinchSmsService.ts (3), outlookCalendarService.ts (3), giveme5Service.ts (3), callService.ts (3), s3Service.ts (2), reviewSmsService.ts (2), elevenLabsService.ts (2), auditLogService.ts (2), appointmentSmsService.ts (2), reviewEmailService.ts (1), reviewAutomationService.ts (1), notificationService.ts (1), mediaStreamService.ts (1), docusendConfigService.ts (1)
    - All error handling standardized to use `error: unknown` with proper type guards
    - All API response types properly defined with interfaces
  - ‚úÖ **Components** (14 files, 66 instances replaced):
    - PlanSelections.tsx (20), CallDrawer.tsx (20), CallTranscriptionWindow.tsx (8), ClientDocuments.tsx (2), calendar/AvailabilitySettings.tsx (1), calendar/AppointmentForm.tsx (1), SignatureFieldPlacer.tsx (1), SafeSelect.tsx (2), SafeAutocomplete.tsx (2), LeadEmailTemplateRow.tsx (1), HouseholdPremium.tsx (1), ChatWindow.tsx (1), DentalVisionFormModal.tsx, Layout.tsx
  - **Total**: 500+ `any` types replaced across 60+ files
  - **Issues Fixed**:
    - event-types.ts: Fixed incomplete error handling where `error: unknown` was used but properties were accessed without type guards
    - public-forms.ts: Fixed Medicare form submissions creating clients as 'lead' instead of 'pending_soa' (now matches booking page behavior)
  - Site verified working after all changes
- [x] Task 4.2: Refactor Large Components (16 hours) - ‚úÖ Complete 2025-12-29
  - ‚úÖ **DirectMailPage.tsx** refactored (6,920 ‚Üí 6,060 lines, 860 lines removed, 12.4% reduction):
    - Extracted DirectMailDashboard component (9.7KB, ~288 lines)
    - Extracted DirectMailCampaigns component (20KB, ~450 lines)
    - Extracted DirectMailMailings component (12KB, ~300 lines)
    - Extracted DirectMailAnalytics component (24KB, ~650 lines)
    - Created shared types file (types.ts) for component interfaces
    - Remaining tabs are small (Templates: 145 lines, Settings: 135 lines, Recurring: 113 lines)
  - **Benefits**: More modular codebase, easier maintenance, better separation of concerns, reusable components
  - Site verified working after refactoring
- [x] Task 4.3: Implement Structured Logging (28 hours) - ‚úÖ Started 2025-12-29
  - ‚úÖ Created structured logger service (`crm/server/src/services/logger.ts`):
    - Log levels: debug, info, warn, error
    - PHI sanitization (SSN, email, phone, addresses, tokens, etc.)
    - Structured JSON output for production
    - Human-readable format for development
    - Environment-based log level configuration
    - Automatic PHI redaction from log context
  - ‚úÖ Started migration: Updated `public-forms.ts` (9 console statements replaced)
  - ‚è≥ Remaining: ~8,041 console.log statements across codebase (can be migrated incrementally)
  - **Usage**: `import logger from '../services/logger.js'; logger.info('Message', { context });`
- [ ] Task 4.4: Organize Documentation (8 hours)

#### Issues Found and Fixed During Code Upgrade

**Medicare Form Submission Issue** (Fixed 2025-12-29):
- **Problem**: Medicare form submissions from marketing site were creating clients with status 'lead' instead of 'pending_soa', unlike the Medicare booking page which correctly sets 'pending_soa' status.
- **Root Cause**: `public-forms.ts` was hardcoding `status: 'lead'` for all new clients, regardless of business line.
- **Fix**: Modified `handleFormSubmission` to set `initialStatus = 'pending_soa'` if `businessLine === 'medicare'`, otherwise `'lead'`. Also updated lead notification logic to skip notifications for clients with `pending_soa` status (notifications sent after both parties sign SOA).
- **Files Changed**: `crm/server/src/routes/public-forms.ts`
- **Result**: Medicare clients from marketing forms now correctly have 'pending_soa' status and don't appear in CRM until both parties sign SOA, matching booking page behavior.

**Incomplete Error Handling in event-types.ts** (Fixed 2025-12-29):
- **Problem**: Error handling was changed from `error: any` to `error: unknown`, but code still accessed `error?.code` and `error?.constraint` directly, which TypeScript disallows on `unknown` types.
- **Fix**: Defined `DatabaseError` interface and properly cast `unknown` error to `DatabaseError` before accessing properties.
- **Files Changed**: `crm/server/src/routes/event-types.ts`
- **Result**: Proper type safety with correct error handling pattern.

---

### 22.17 Agent Handoff Guidelines

**CRITICAL**: All code upgrades and improvements are permanent and must be maintained by future agents.

**‚≠ê PRIMARY REFERENCE**: See `CODE_STANDARDS.md` in the project root for comprehensive coding patterns and examples. This file documents all upgraded patterns with code examples from the actual codebase.

#### Code Continuity Requirements

**Future agents MUST continue using upgraded code patterns:**

**Quick Reference**: Check `CODE_STANDARDS.md` first for:
- Database query patterns (no SELECT *)
- API response caching (Redis)
- Frontend code splitting (React.lazy)
- Testing standards
- TypeScript patterns
- Performance best practices

1. **Database Queries** (Task 2.1 - COMPLETE):
   - ‚úÖ **ALWAYS** use specific column selections (NO `SELECT *`)
   - ‚úÖ **ALWAYS** reference completed Task 2.1 before writing queries
   - ‚úÖ **NEVER** revert to `SELECT *` patterns
   - ‚úÖ **VERIFY**: 95/96 queries already replaced (1 remaining is a comment)

2. **Caching** (Task 2.3 - COMPLETE):
   - ‚úÖ **ALWAYS** use Redis caching for API responses
   - ‚úÖ **ALWAYS** implement cache invalidation on data updates
   - ‚úÖ **ALWAYS** use `redisService.ts` for caching operations
   - ‚úÖ **NEVER** remove caching without justification

3. **Code Splitting** (Task 2.2 - COMPLETE):
   - ‚úÖ **ALWAYS** use `React.lazy()` for new pages
   - ‚úÖ **ALWAYS** configure Vite manual chunks for vendor libraries
   - ‚úÖ **ALWAYS** wrap lazy-loaded routes in `Suspense` with `PageLoader`
   - ‚úÖ **NEVER** import all pages directly in App.tsx

4. **Testing** (Tasks 3.1, 3.2, 3.3 - COMPLETE):
   - ‚úÖ **ALWAYS** write tests using Vitest (frontend) and Vitest + Supertest (backend)
   - ‚úÖ **ALWAYS** use established test patterns (test app helpers, CSRF handling, admin sessions)
   - ‚úÖ **ALWAYS** run `npm test` before committing
   - ‚úÖ **ALWAYS** follow patterns in existing test files
   - ‚úÖ **NEVER** skip testing for new features

5. **Security** (Tasks 1.1, 1.3, 1.4, 1.5, 1.6 - COMPLETE):
   - ‚úÖ **ALWAYS** maintain PM2 ecosystem configuration
   - ‚úÖ **ALWAYS** maintain Nginx rate limiting (Cloudflare-aware)
   - ‚úÖ **ALWAYS** maintain UFW firewall rules
   - ‚úÖ **ALWAYS** maintain SSH security hardening (key-only access)
   - ‚úÖ **ALWAYS** maintain Fail2ban configuration

6. **Infrastructure** (Task 1.2 - COMPLETE):
   - ‚úÖ **ALWAYS** use database indexes (already added)
   - ‚úÖ **ALWAYS** verify site health after changes
   - ‚úÖ **ALWAYS** reference Section 22.16 (Upgrade Progress Tracking) before starting work

#### Testing Requirements for Future Agents

**Before starting new work:**
1. Run `npm test` in both `crm/client` and `crm/server` directories
2. Verify all existing tests pass (89+ frontend tests, 37+ backend tests)
3. Review Section 22.16 to understand completed upgrades
4. Follow established test patterns when adding new tests

**When adding new features:**
1. Write unit tests using Vitest (frontend) or Vitest + Supertest (backend)
2. Follow patterns in existing test files:
   - `crm/client/src/lib/__tests__/auth.test.ts` - Authentication utilities
   - `crm/client/src/lib/__tests__/clientApi.test.ts` - API client utilities
   - `crm/server/src/__tests__/routes/auth-simple.test.ts` - API integration tests
   - `crm/server/src/__tests__/routes/clients.test.ts` - CRUD integration tests
3. Use test app helpers (`createTestApp`, custom render utilities)
4. Handle CSRF tokens and admin sessions properly
5. Ensure all tests pass before committing

#### Upgrade Maintenance

**Future agents MUST:**
- ‚úÖ Reference Section 22.16 before making changes
- ‚úÖ Update Section 22.16 when completing upgrade tasks
- ‚úÖ Follow established patterns (no reverting to old code)
- ‚úÖ Maintain all completed upgrades (PM2, Redis, code splitting, security)
- ‚úÖ Add tests for new features using established infrastructure

**Future agents MUST NOT:**
- ‚ùå Revert to `SELECT *` queries
- ‚ùå Remove caching without justification
- ‚ùå Remove code splitting
- ‚ùå Remove security hardening
- ‚ùå Skip testing for new features
- ‚ùå Ignore established patterns

#### Documentation for New Agents

**For Future Agents Continuing This Work**:

1. **Always Check Progress First**:
   - Review Section 22.16 (Upgrade Progress Tracking)
   - Identify next uncompleted task
   - Read task details in Section 22.15

2. **Follow Task Order**:
   - Complete tasks in Phase order (1 ‚Üí 2 ‚Üí 3 ‚Üí 4)
   - Within each phase, complete tasks in numerical order
   - Don't skip tasks unless explicitly marked as optional

3. **Update Progress Tracking**:
   - Mark tasks as complete in Section 22.16
   - Add completion date and notes
   - Document any issues encountered

4. **Verification Before Moving On**:
   - Always verify success criteria met
   - Run verification commands
   - Test functionality
   - Update PRD with completion status

5. **Documentation**:
   - Update task notes if approach differs
   - Document any deviations from plan
   - Add troubleshooting notes if issues found

6. **Git Workflow**:
   - Create branch: `improvement/phase-{n}-task-{m}-{description}`
   - Commit with clear messages
   - Test before merging
   - Update PRD progress tracking

**Example Progress Update**:
```markdown
#### Phase 1: Critical Security & Infrastructure
- [x] Task 1.1: PM2 Ecosystem Configuration (1 hour) - ‚úÖ Complete 2025-01-27
  - Created ecosystem.config.js
  - PM2 auto-restart working
  - Logs rotating properly
- [ ] Task 1.2: Database Indexes (2 hours) - ‚è≥ Next
```

---

#### Phase 5: Mantine to Mantis CSS Migration (Future - Optional)
1. Phase 1: Foundation - Mantis wrappers, remove Mantine CSS (16 hours)
2. Phase 2: Component migration - High-usage components (44 hours)
3. Phase 3: Page-by-page migration - All pages (64 hours)
4. Phase 4: Cleanup & optimization (16 hours)
**Total**: 140 hours (incremental, can be done over 9 weeks)
**Priority**: Medium (after Phase 1-4 complete)
**Benefit**: Remove 200-300 KB Mantine CSS, pure Mantis design system

---

### 22.13 Metrics & Success Criteria

#### Code Quality Metrics
- **TypeScript Errors**: Reduce from 900+ to <50
- **Test Coverage**: Achieve 80%+ for critical paths
- **Code Duplication**: Reduce by 30%
- **Bundle Size**: Reduce to <500 kB gzipped

#### Performance Metrics
- **API Response Time**: <200ms for 95th percentile
- **Database Query Time**: <50ms for 95th percentile
- **Frontend Load Time**: <2 seconds initial load
- **Time to Interactive**: <3 seconds

#### Security Metrics
- **Security Audit Score**: Improve from 6.5/10 to 9/10
- **Vulnerability Count**: Maintain 0 known vulnerabilities
- **Rate Limiting**: 100% of public endpoints protected

---

### 22.14 References

- [[SECURITY_AUDIT_REPORT.md]] - Detailed security analysis
- [[AI_SETUP.md]] - AI implementation details
- [[ARCHITECTURE_OVERVIEW.md]] - System architecture
- [[TROUBLESHOOTING.md]] - Common issues and solutions
- [[Epic 4: Multi-Tenant SaaS]] - Multi-tenant architecture plans
- [[Epic 10: Mantis Design System Upgrade]] - UI/UX improvements

**Deployment Context**: All recommendations in Section 22 are tailored for DigitalOcean Droplet deployment (Ubuntu 24.04 LTS, PM2, Nginx, Let's Encrypt SSL). See Section 22.8.4 for droplet-specific considerations.

---

**End of Section 22**



# ============================================
# ARCH (Architecture Document)
# ============================================

# Architecture Document (ARCH)
## Versa Insurance Agency CRM with AI Agent

**Status**: `draft`  
**Version**: 1.0  
**Created**: 2025-01-13  
**Last Updated**: 2025-01-13  
**Owner**: Mario Alasu  
**Domain**: crm.versainsuranceagency.com

---

## 1. System Overview

### 1.1 Architecture Pattern
**Type**: Full-Stack Web Application with Real-Time AI Processing  
**Pattern**: Monolithic Backend + React Frontend + Real-Time WebSocket Communication  
**Deployment**: Single Server (Ubuntu 24.04 LTS) with PM2 Process Management

### 1.2 System Components
- **Frontend**: React 19 SPA (Single Page Application) with Vite
- **Backend**: Express.js REST API + WebSocket Server (Socket.io)
- **Database**: Neon PostgreSQL (Cloud, Serverless)
- **AI Services**: OpenAI GPT-4 + Google Gemini (Multi-Provider Strategy)
- **VoIP**: Twilio Voice SDK (Browser-based calling)
- **Real-Time**: Socket.io for bidirectional communication

### 1.3 High-Level Architecture

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ                    Client Browser                           ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ
‚îÇ  ‚îÇ React App    ‚îÇ  ‚îÇ Twilio Voice ‚îÇ  ‚îÇ Socket.io     ‚îÇ   ‚îÇ
‚îÇ  ‚îÇ (Vite)       ‚îÇ  ‚îÇ SDK          ‚îÇ  ‚îÇ Client       ‚îÇ   ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ
‚îÇ         ‚îÇ                 ‚îÇ                  ‚îÇ            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
          ‚îÇ                 ‚îÇ                  ‚îÇ
          ‚îÇ HTTPS/WSS       ‚îÇ Twilio WebRTC    ‚îÇ WebSocket
          ‚îÇ                 ‚îÇ                  ‚îÇ
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ         ‚îÇ                 ‚îÇ                  ‚îÇ            ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îÇ
‚îÇ  ‚îÇ         Express.js Server (Port 3000)            ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê             ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ REST API     ‚îÇ  ‚îÇ Socket.io    ‚îÇ             ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ Routes       ‚îÇ  ‚îÇ Server       ‚îÇ             ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò             ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ         ‚îÇ                 ‚îÇ                      ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚ñº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê             ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ     AI Service Layer           ‚îÇ             ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ             ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ  ‚îÇ OpenAI   ‚îÇ  ‚îÇ Gemini   ‚îÇ   ‚îÇ             ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ  ‚îÇ GPT-4    ‚îÇ  ‚îÇ Pro      ‚îÇ   ‚îÇ             ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ             ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò             ‚îÇ    ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ
‚îÇ                                                           ‚îÇ
‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îÇ
‚îÇ  ‚îÇ     Neon PostgreSQL Database (Cloud)            ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ Database ‚îÇ  ‚îÇ Database ‚îÇ  ‚îÇ Database ‚îÇ     ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ  ‚îÇ 1 (CRM)  ‚îÇ  ‚îÇ 2 (Future)‚îÇ ‚îÇ 3 (Future)‚îÇ     ‚îÇ    ‚îÇ
‚îÇ  ‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îÇ    ‚îÇ
‚îÇ  ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## 2. Technology Stack

### 2.1 Frontend Stack

| Technology | Version | Purpose |
|------------|---------|---------|
| React | 19 | UI Framework |
| TypeScript | 5.x | Type Safety |
| Vite | Latest | Build Tool & Dev Server |
| Mantine | 8.3.6 | UI Component Library |
| React Router DOM | Latest | Client-Side Routing |
| Tailwind CSS | Latest | Utility-First CSS |
| Socket.io Client | Latest | Real-Time Communication |
| Twilio Voice SDK | Latest | Browser-Based Calling |
| Tabler Icons React | Latest | Icon Library |
| Mantine Form | 8.3.6 | Form Management & Validation |

### 2.2 Backend Stack

| Technology | Version | Purpose |
|------------|---------|---------|
| Node.js | 18.20.8+ | Runtime Environment |
| Express.js | 4.x | Web Framework |
| TypeScript | 5.x | Type Safety |
| Socket.io | Latest | WebSocket Server |
| Neon Serverless | Latest | PostgreSQL Client |
| JWT | Latest | Authentication Tokens |
| Bcrypt | Latest | Password Hashing |
| Helmet | Latest | Security Headers |
| CORS | Latest | Cross-Origin Resource Sharing |
| Express Rate Limit | Latest | API Rate Limiting |

### 2.3 Database Stack

| Technology | Version | Purpose |
|------------|---------|---------|
| PostgreSQL | 15+ | Relational Database |
| Neon | Cloud | Serverless PostgreSQL Hosting |
| Connection Pooling | Built-in | Efficient Connection Management |

### 2.4 AI & External Services

| Service | Purpose | Status |
|---------|---------|--------|
| OpenAI GPT-4 | Primary AI Provider (Conversation, Extraction) | ‚úÖ Active |
| Google Gemini Pro | Fallback AI Provider | ‚úÖ Active |
| Twilio Voice SDK | Browser-Based Phone Calls | ‚úÖ Active |
| SendGrid | Email Delivery (Magic Links, Notifications) | ‚úÖ Active |
| Stripe | Payment Processing (Future) | ‚è≥ Planned |

### 2.5 Infrastructure

| Component | Technology | Purpose |
|-----------|------------|---------|
| Server OS | Ubuntu 24.04 LTS | Host Operating System |
| Process Manager | PM2 | Application Process Management |
| Reverse Proxy | Nginx | HTTP/HTTPS Routing & SSL Termination |
| SSL/TLS | Let's Encrypt | HTTPS Certificates |
| Deployment | Manual (Git + PM2) | Current Deployment Method |

---

## 3. Architecture Diagrams

### 3.1 Request Flow Architecture

```mermaid
sequenceDiagram
    participant Client
    participant Frontend
    participant Backend
    participant Database
    participant AI

    Client->>Frontend: User Action
    Frontend->>Backend: HTTP Request / WebSocket
    Backend->>Database: Query Data
    Database-->>Backend: Return Data
    Backend->>AI: Process Request (if needed)
    AI-->>Backend: AI Response
    Backend-->>Frontend: JSON Response / WebSocket Event
    Frontend-->>Client: Update UI
```

### 3.2 Real-Time AI Processing Flow

```mermaid
sequenceDiagram
    participant Agent
    participant Frontend
    participant Socket.io
    participant AI Service
    participant Database

    Agent->>Frontend: Speaks during call
    Frontend->>Socket.io: Send audio/text chunk
    Socket.io->>AI Service: Process conversation
    AI Service->>Database: Extract & Store client info
    AI Service->>Socket.io: Return extracted data + suggestions
    Socket.io->>Frontend: Real-time update
    Frontend->>Agent: Display extracted fields + AI suggestions
```

### 3.3 Database Architecture (Current & Future)

```mermaid
graph TB
    subgraph "Current Architecture"
        DB1[Database 1<br/>Neon PostgreSQL<br/>CRM Data]
        APP[Express.js App]
        APP --> DB1
    end
    
    subgraph "Future Architecture (Multi-Tenant)"
        DB1_F[Database 1<br/>Agency 1 Data<br/>Stays Unchanged]
        DB2[Database 2<br/>Agencies Management<br/>Users, Subscriptions]
        DB3[Database 3<br/>Multi-Tenant Clients<br/>All Agencies' Data]
        APP_F[Express.js App<br/>with Routing]
        APP_F --> DB1_F
        APP_F --> DB2
        APP_F --> DB3
    end
```

---

## 4. Project Structure

### 4.1 Root Directory Structure

```
/var/www/crm-versainsuranceagency/
‚îú‚îÄ‚îÄ .ai/                          # Project planning documents
‚îÇ   ‚îú‚îÄ‚îÄ prd.md                    # Product Requirements Document
‚îÇ   ‚îú‚îÄ‚îÄ arch.md                   # Architecture Document (this file)
‚îÇ   ‚îî‚îÄ‚îÄ epic-{n}/                 # Epic directories (future)
‚îÇ       ‚îî‚îÄ‚îÄ story-{m}.story.md    # Story files (future)
‚îÇ
‚îú‚îÄ‚îÄ crm/                          # CRM Application Root
‚îÇ   ‚îú‚îÄ‚îÄ client/                   # React Frontend
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ pages/            # Page components
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ components/        # Reusable components
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ hooks/            # Custom React hooks
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ contexts/          # React contexts
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ lib/              # Utilities & API client
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ App.tsx           # Main app component
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ public/               # Static assets
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ package.json
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ vite.config.ts
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ server/                   # Express Backend
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ routes/           # API route handlers
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ controllers/      # Business logic
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ services/         # External service integrations
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ middleware/       # Express middleware
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ db/               # Database connection & queries
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ utils/            # Utility functions
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ types/            # TypeScript type definitions
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ index.ts          # Express server entry point
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ package.json
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ tsconfig.json
‚îÇ   ‚îÇ
‚îÇ   ‚îú‚îÄ‚îÄ database-migrations/      # SQL migration files
‚îÇ   ‚îú‚îÄ‚îÄ database-schema.sql       # Complete schema definition
‚îÇ   ‚îú‚îÄ‚îÄ docs/                     # CRM-specific documentation
‚îÇ   ‚îî‚îÄ‚îÄ package.json              # Root package.json (workspace)
‚îÇ
‚îú‚îÄ‚îÄ website/                      # Marketing Website (separate project)
‚îÇ   ‚îî‚îÄ‚îÄ ...                       # Next.js marketing site
‚îÇ
‚îú‚îÄ‚îÄ docs/                         # Shared documentation
‚îÇ   ‚îú‚îÄ‚îÄ PROJECT-BUILD.md         # Complete build guide
‚îÇ   ‚îú‚îÄ‚îÄ project-scope.md         # Business requirements
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ
‚îî‚îÄ‚îÄ .cursor/                      # Cursor IDE configuration
    ‚îî‚îÄ‚îÄ rules/                    # AI agent rules
```

### 4.2 Frontend Structure (crm/client/src/)

```
client/src/
‚îú‚îÄ‚îÄ pages/                        # Page-level components
‚îÇ   ‚îú‚îÄ‚îÄ DashboardPage.tsx         # Main dashboard
‚îÇ   ‚îú‚îÄ‚îÄ ClientsPage.tsx          # Client list/search
‚îÇ   ‚îú‚îÄ‚îÄ ClientDetailPage.tsx     # Client detail view
‚îÇ   ‚îú‚îÄ‚îÄ ClientFormPage.tsx       # Add/edit client form
‚îÇ   ‚îú‚îÄ‚îÄ ConversationsPage.tsx    # Conversation interface
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ
‚îú‚îÄ‚îÄ components/                   # Reusable UI components
‚îÇ   ‚îú‚îÄ‚îÄ Layout.tsx                # AppShell layout
‚îÇ   ‚îú‚îÄ‚îÄ ProtectedRoute.tsx       # Route protection
‚îÇ   ‚îú‚îÄ‚îÄ ClientCard.tsx           # Client card component
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ
‚îú‚îÄ‚îÄ hooks/                        # Custom React hooks
‚îÇ   ‚îú‚îÄ‚îÄ useAuth.ts               # Authentication hook
‚îÇ   ‚îú‚îÄ‚îÄ useClients.ts            # Client data hook
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ
‚îú‚îÄ‚îÄ contexts/                     # React contexts
‚îÇ   ‚îú‚îÄ‚îÄ AuthContext.tsx          # Authentication context
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ
‚îú‚îÄ‚îÄ lib/                          # Utilities & API
‚îÇ   ‚îú‚îÄ‚îÄ api.ts                   # API client functions
‚îÇ   ‚îú‚îÄ‚îÄ auth.ts                  # Auth utilities
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ
‚îú‚îÄ‚îÄ App.tsx                       # Main app component (router)
‚îî‚îÄ‚îÄ main.tsx                      # Entry point
```

### 4.3 Backend Structure (crm/server/src/)

```
server/src/
‚îú‚îÄ‚îÄ routes/                       # API route handlers
‚îÇ   ‚îú‚îÄ‚îÄ auth.ts                  # Authentication routes
‚îÇ   ‚îú‚îÄ‚îÄ clients.ts               # Client CRUD routes
‚îÇ   ‚îú‚îÄ‚îÄ conversations.ts         # Conversation routes
‚îÇ   ‚îú‚îÄ‚îÄ ai.ts                    # AI service routes
‚îÇ   ‚îú‚îÄ‚îÄ client-portal.ts         # Client portal API
‚îÇ   ‚îú‚îÄ‚îÄ client-auth.ts           # Client authentication
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ
‚îú‚îÄ‚îÄ controllers/                  # Business logic
‚îÇ   ‚îú‚îÄ‚îÄ clientController.ts      # Client operations
‚îÇ   ‚îú‚îÄ‚îÄ aiController.ts          # AI processing
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ
‚îú‚îÄ‚îÄ services/                     # External service integrations
‚îÇ   ‚îú‚îÄ‚îÄ aiService.ts             # AI provider management
‚îÇ   ‚îú‚îÄ‚îÄ emailService.ts          # SendGrid integration
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ
‚îú‚îÄ‚îÄ middleware/                   # Express middleware
‚îÇ   ‚îú‚îÄ‚îÄ auth.ts                  # JWT authentication
‚îÇ   ‚îú‚îÄ‚îÄ errorHandler.ts          # Error handling
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ
‚îú‚îÄ‚îÄ db/                           # Database layer
‚îÇ   ‚îú‚îÄ‚îÄ connection.ts            # Neon connection setup
‚îÇ   ‚îî‚îÄ‚îÄ queries/                 # SQL query functions
‚îÇ
‚îú‚îÄ‚îÄ utils/                        # Utility functions
‚îÇ   ‚îú‚îÄ‚îÄ auth.ts                  # Password hashing, JWT
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ
‚îú‚îÄ‚îÄ types/                        # TypeScript definitions
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îÇ
‚îî‚îÄ‚îÄ index.ts                      # Express server entry point
```

---

## 5. Database Architecture

### 5.1 Current Database (Database 1)

**Provider**: Neon PostgreSQL (Cloud, Serverless)  
**Environment Variable**: `DATABASE_URL`  
**Status**: ‚úÖ Active - Single Agency CRM  
**Primary Key Type**: `SERIAL` (Integer IDs)

#### Core Tables

1. **`users`** - Agent/Admin accounts
   - Authentication (email, password_hash)
   - User profile (first_name, last_name, role)
   - Roles: `agent`, `admin`, `manager`, `super_admin`

2. **`clients`** - Client information
   - Personal info (name, DOB, phone, email, address)
   - Business line (`medicare`, `health-insurance`, `life-insurance`, etc.)
   - Status tracking (draft, active, inactive)
   - Medicare-specific fields (medicare_id, coverage_type, enrollment_status)

3. **`conversations`** - Chat conversations
   - Links clients to agents
   - Optional call integration
   - Timestamps (started_at, ended_at)

4. **`conversation_messages`** - Individual messages
   - Message content and sender (user, client, ai)
   - AI generation flag
   - Timestamps

5. **`client_health_info`** - Health information
   - Medications (array)
   - Conditions (array)
   - Providers (array)

6. **`commissions`** - Commission tracking
   - Links users to clients
   - Business line association
   - Amount, date, status

7. **`password_reset_tokens`** - Password reset
   - Token-based reset flow
   - Expiration tracking

8. **`user_business_lines`** - Business line permissions
   - User-to-business-line mapping
   - Permission management

9. **`business_line_config`** - Business line configurations
   - Configurable business line settings

#### Indexes

- Email indexes for fast lookups
- Phone number indexes for instant client search
- Foreign key indexes for joins
- Composite indexes for common queries

### 5.2 Future Database Architecture (Multi-Tenant)

**Approach**: 3-Database Architecture for HIPAA Compliance

#### Database 1 (Current Agency)
- **Status**: ‚úÖ Active - Stays unchanged
- **Purpose**: Your agency's data (isolated)
- **Schema**: No changes needed

#### Database 2 (Agencies Management) - Future
- **Status**: ‚è≥ Planned
- **Purpose**: Multi-tenant agency management
- **Tables**: `agencies`, `users` (with `agency_id`), `subscriptions`, `audit_logs`
- **Environment Variable**: `AGENCIES_DATABASE_URL`

#### Database 3 (Agencies' Clients) - Future
- **Status**: ‚è≥ Planned
- **Purpose**: Multi-tenant client data
- **Tables**: `clients` (with `agency_id`), `commissions`, `conversations`
- **Environment Variable**: `AGENCIES_CLIENTS_DATABASE_URL`

**Benefits**:
- Database-level isolation (stronger HIPAA compliance)
- Independent scaling
- Clear data boundaries
- Easier backup/restore

**Trade-offs**:
- Cross-database queries require application-level joins
- More complex routing logic
- Higher cost (3 databases)

---

## 6. API Architecture

### 6.1 REST API Endpoints

#### Authentication
- `POST /api/auth/login` - User login
- `POST /api/auth/register` - User registration
- `GET /api/auth/me` - Get current user
- `POST /api/auth/refresh` - Refresh JWT token
- `POST /api/auth/logout` - User logout

#### Clients
- `GET /api/clients` - List/search clients
- `GET /api/clients/:id` - Get client details
- `POST /api/clients` - Create new client
- `PUT /api/clients/:id` - Update client
- `DELETE /api/clients/:id` - Delete client
- `GET /api/clients/by-phone/:phone` - Instant phone lookup

#### Conversations
- `GET /api/clients/:id/conversations` - Get client conversations
- `POST /api/conversations` - Start new conversation
- `POST /api/conversations/:id/messages` - Send message
- `GET /api/conversations/:id` - Get conversation with history

#### AI Services
- `POST /api/ai/extract-form-data` - Extract client info from conversation
- `POST /api/ai/messages/suggest` - Generate AI message suggestions
- ‚è≥ `POST /api/ai/recommendations` - Get plan recommendations (Future)

#### Client Portal (Backend Complete)
- `POST /api/client-auth/magic-link/send` - Send magic link
- `POST /api/client-auth/magic-link/verify` - Verify magic link
- `GET /api/client-portal/profile` - Get client profile
- `GET /api/client-portal/summary` - Get plan summary
- `GET /api/client-portal/members` - Get enrolled members
- `GET /api/client-portal/pcp` - Get PCP information
- `GET /api/client-portal/broker` - Get broker information
- `GET /api/client-documents/*` - Document management

### 6.2 WebSocket Events (Socket.io)

#### Client ‚Üí Server
- `join-conversation` - Join conversation room
- `send-message` - Send message to conversation
- `audio-chunk` - Send audio chunk for processing

#### Server ‚Üí Client
- `conversation-update` - Real-time conversation updates
- `ai-extraction` - AI-extracted client data
- `ai-suggestion` - AI-generated message suggestions
- `error` - Error notifications

### 6.3 API Security

- **Authentication**: JWT tokens (access + refresh)
- **Authorization**: Role-based access control (RBAC)
- **Rate Limiting**: Express rate limit middleware
- **CORS**: Configured for specific origins
- **Helmet**: Security headers
- **Input Validation**: Request validation middleware
- **SQL Injection Prevention**: Parameterized queries (Neon)

---

## 7. Security Architecture

### 7.1 Authentication & Authorization

**Authentication Method**: JWT (JSON Web Tokens)
- **Access Token**: Short-lived (15 minutes)
- **Refresh Token**: Long-lived (7 days)
- **Storage**: HTTP-only cookies (secure, same-site)

**Password Security**:
- Bcrypt hashing (10 rounds)
- Password strength requirements
- Password reset via secure tokens

**Authorization**:
- Role-based access control (RBAC)
- Roles: `agent`, `admin`, `manager`, `super_admin`
- Route-level permission checks

### 7.2 Data Security

**Encryption**:
- **In Transit**: HTTPS/TLS 1.2+ (enforced)
- **At Rest**: Database-level encryption (Neon)
- **Future**: Field-level encryption for PHI (HIPAA)

**Data Isolation**:
- Current: Single agency (no isolation needed)
- Future: Database-level isolation (3-database architecture)

### 7.3 API Security

**Headers**:
- Helmet.js security headers
- CORS configuration
- Content Security Policy (CSP)

**Rate Limiting**:
- API endpoint rate limits
- Authentication endpoint limits
- IP-based throttling

**Input Validation**:
- Request body validation
- SQL injection prevention (parameterized queries)
- XSS prevention (input sanitization)

### 7.4 Audit Logging

**Current**: Basic error logging  
**Future**: Comprehensive audit logging for HIPAA compliance
- All PHI access logged
- User action tracking
- Database query logging

---

## 8. Deployment Architecture

### 8.1 Current Deployment

**Server**: Ubuntu 24.04 LTS (DigitalOcean Droplet)  
**Location**: `/var/www/crm-versainsuranceagency/`  
**Process Manager**: PM2  
**Reverse Proxy**: Nginx  
**SSL/TLS**: Let's Encrypt

### 8.2 Deployment Process

1. **Code Deployment**:
   ```bash
   git pull origin main
   cd crm/server && npm install
   cd crm/client && npm install && npm run build
   pm2 restart crm-server
   ```

2. **Database Migrations**:
   - Manual SQL execution
   - Migration files in `database-migrations/`

3. **Environment Variables**:
   - Stored in `.env` files (not in version control)
   - Required: `DATABASE_URL`, `JWT_SECRET`, `OPENAI_API_KEY`, etc.

### 8.3 Future Deployment Considerations

- **CI/CD Pipeline**: Automated testing and deployment
- **Database Migrations**: Automated migration system
- **Monitoring**: Application performance monitoring (APM)
- **Backup**: Automated database backups
- **Scaling**: Horizontal scaling for multi-tenant architecture

---

## 9. Development Guide

### 9.1 Setup Instructions

**Prerequisites**:
- Node.js (Latest LTS)
- PostgreSQL (Neon Cloud)
- Git

**Initial Setup**:
```bash
cd /var/www/crm-versainsuranceagency/crm
cd server && npm install
cd ../client && npm install
cd ../server && npm run init-db
```

**Environment Variables**:
- Copy `.env.example` to `.env.local` (if exists)
- Set required variables: `DATABASE_URL`, `JWT_SECRET`, `PORT`, `NODE_ENV`
- See `.ai/QUICK-REFERENCE.md` for complete list

### 9.2 Development Workflow

**Start Development Servers**:
```bash
# Terminal 1 - Backend
cd /var/www/crm-versainsuranceagency/crm/server
$env:PORT="3000"; $env:NODE_ENV="development"; npx tsx server/index.ts

# Terminal 2 - Frontend
cd /var/www/crm-versainsuranceagency/crm/client
npx vite --port 5000
```

**Build for Production**:
```bash
# Frontend
cd /var/www/crm-versainsuranceagency/crm/client
npm run build

# Backend (if needed)
cd /var/www/crm-versainsuranceagency/crm/server
npm run build
```

### 9.3 Code Standards

**Database Queries**:
- ‚úÖ Always use `sql` template literals
- ‚úÖ Use PostgreSQL `ANY()` for array filtering
- ‚ùå Never use nested `sql` fragments
- ‚ùå Never use `sql.unsafe()`

**Branch Strategy**:
- `main` - Production (protected)
- `dev` - Development (protected)
- `feature/epic-{n}-story-{m}-{name}` - Feature branches
- `fix/epic-{n}-story-{m}-{name}` - Bug fix branches

**Commit Messages**:
- Use conventional commits: `feat(epic-{n}/story-{m}): description`
- Include story reference in commit message
- See `.cursor/rules/100-git-workflow.mdc` for details

### 9.4 Testing

**Run Tests**:
```bash
cd /var/www/crm-versainsuranceagency/crm/server
npm test
```

**Type Checking**:
```bash
cd /var/www/crm-versainsuranceagency/crm/client
npm run type-check
```

### 9.5 Common Development Tasks

**Add New API Endpoint**:
1. Create route in `crm/server/src/routes/`
2. Register route in `crm/server/src/index.ts`
3. Add authentication middleware if needed
4. Test endpoint with curl or Postman

**Add New Frontend Page**:
1. Create page component in `crm/client/src/pages/`
2. Add route in `crm/client/src/App.tsx`
3. Add navigation link in `crm/client/src/components/Layout.tsx`
4. Build frontend: `cd crm/client && npm run build`

**Database Migration**:
1. Add migration to `crm/server/src/db/init-db.ts`
2. Test migration locally
3. Document changes in `.ai/CHANGELOG.md`

---

## 10. Troubleshooting

### 10.1 Error Diagnosis Process

**Step 1: Identify Error Type**

| Error Pattern | Likely Cause | First Check |
|--------------|--------------|-------------|
| `500 on /` or `500 on /favicon.ico` | Missing frontend build | `test -d crm/client/dist` |
| `500 on /api/*` | Database/query error | Check server logs for `‚ùå Error caught:` |
| `404 on /` or `404 on /api/*` | Route not found | Verify route exists in routes |
| `401 on /api/*` | Authentication failed | Check token/auth middleware |
| `CORS error` | Frontend/backend mismatch | Verify ports and URLs |

**Step 2: Check Server Logs**
```bash
pm2 logs crm-server --lines 100
# or
cd /var/www/crm-versainsuranceagency/crm/server
npm run dev  # View logs in terminal
```

**Step 3: Verify Database Connection**
```bash
curl http://localhost:3000/api/health
# Should return: {"status":"ok","database":"connected"}
```

### 10.2 Common Issues & Solutions

**Issue: Missing Frontend Build (500 on `/`)**
- **Symptom**: `GET / 500 (Internal Server Error)`
- **Diagnosis**: `test -d crm/client/dist || echo "MISSING"`
- **Solution**: `cd crm/client && npm run build`
- **Prevention**: Always build frontend before production deployment

**Issue: Port Already in Use (EADDRINUSE)**
- **Symptom**: `Error: listen EADDRINUSE: address already in use :::3000`
- **Diagnosis**: `lsof -i:3000` or `ps aux | grep "tsx.*index"`
- **Solution**: 
  ```bash
  pkill -f "tsx.*index"
  # or
  lsof -ti:3000 | xargs kill -9
  ```

**Issue: SQL Parameter Errors**
- **Symptom**: `syntax error at or near $3` in server logs
- **Cause**: Nested `sql` fragments cause parameter numbering conflicts
- **Solution**: Use PostgreSQL `ANY()` for array filtering
- **Example**:
  ```typescript
  // ‚úÖ Correct
  const clients = await sql`
    SELECT * FROM clients
    WHERE line_of_business = ANY(${enabledBusinessLines})
  `;
  
  // ‚ùå Wrong
  let orCondition = sql`line_of_business = ${lines[0]}`;
  for (let i = 1; i < lines.length; i++) {
    orCondition = sql`${orCondition} OR ${lines[i]}`;
  }
  ```

**Issue: CORS Errors**
- **Symptom**: `Access to fetch at '...' from origin '...' has been blocked by CORS policy`
- **Diagnosis**: Check CORS configuration in `crm/server/src/config/cors.ts`
- **Solution**: Ensure frontend origin is in allowed origins list
- **Production**: Add `https://client.versainsuranceagency.com` to CORS origins

**Issue: Authentication Failures**
- **Symptom**: `401 Unauthorized` on API endpoints
- **Diagnosis**: Check localStorage for `authToken`
- **Solution**: 
  - Verify token exists: `localStorage.getItem('authToken')`
  - Check token expiration
  - Verify JWT_SECRET matches between frontend and backend

### 10.3 Debugging Tips

**Enable Debug Logging**:
- Backend: Set `NODE_ENV=development` to see detailed error messages
- Frontend: Check browser console for React errors
- Network: Use browser DevTools Network tab to inspect API requests

**Check Database State**:
```bash
# Connect to Neon PostgreSQL
psql $DATABASE_URL

# Check table existence
\dt

# Check recent records
SELECT * FROM clients ORDER BY created_at DESC LIMIT 10;
```

**Verify Environment Variables**:
```bash
# Backend
cd /var/www/crm-versainsuranceagency/crm/server
node -e "require('dotenv').config(); console.log('DATABASE_URL:', process.env.DATABASE_URL ? 'SET' : 'NOT SET');"
```

### 10.4 Performance Issues

**Slow Database Queries**:
- Check for missing indexes
- Use `EXPLAIN ANALYZE` in PostgreSQL
- Avoid `SELECT *` - specify only needed columns

**Frontend Build Issues**:
- Clear cache: `rm -rf crm/client/node_modules/.vite`
- Reinstall dependencies: `cd crm/client && rm -rf node_modules && npm install`
- Check TypeScript errors: `cd crm/client && npm run type-check`

**Memory Issues**:
- Check PM2 memory usage: `pm2 monit`
- Restart services: `pm2 restart crm-server`
- Check for memory leaks in long-running processes

### 10.5 Getting Help

**Documentation**:
- Quick Reference: `.ai/QUICK-REFERENCE.md`
- Architecture: `.ai/arch.md`
- Changelog: `.ai/CHANGELOG.md`
- Project Status: `.ai/PROJECT-STATUS.md`

**Legacy Documentation**:
- Detailed setup: `crm/docs/SETUP.md`
- Troubleshooting: `crm/docs/TROUBLESHOOTING.md`
- AI Setup: `crm/AI_SETUP.md` (being consolidated)

---

## 11. Change Log

### 11.1 Architecture Changes

- **2025-01-13**: Initial ARCH document created
- **2025-01-13**: Documented current single-database architecture
- **2025-01-13**: Documented future 3-database multi-tenant architecture
- **2025-01-13**: Documented technology stack and project structure
- **2025-01-13**: Documented API endpoints and security architecture

### 11.2 Future Changes (To Be Documented)

- Multi-tenant database implementation
- Client portal frontend creation
- Plan recommendation engine
- Advanced security features (HIPAA compliance)
- CI/CD pipeline implementation

---

## 12. Status & Approval

**Status**: `draft`  
**Ready for Review**: Yes  
**Next Steps**: User review and approval

**Approval Workflow**:
1. User reviews ARCH document
2. User approves or requests changes
3. Update status to `approved` when ready
4. Begin Epic 3 (Client Portal) implementation

---

**End of Architecture Document**




# ============================================
# CHANGELOG
# ============================================

# Changelog
## Versa Insurance Agency CRM

**Recent changes and updates to the system.**

---

## January 2025

### Review Management System - Complete Implementation (January 2025)

**Status**: ‚úÖ Complete

#### Overview
Implemented a comprehensive review management system for Versa Insurance Agency CRM, allowing automated review request sending, review collection, and management. The system includes email/SMS invitations, follow-up sequences, rating-based routing, and review deletion functionality.

#### Key Features Implemented

**1. Review Request System**
- Automated review request sending via email and SMS
- Configurable follow-up sequences (max attempts, interval days)
- Review link generation with expiration dates
- Click tracking and email open tracking
- Support for multiple platforms (Google, Facebook)

**2. Review Collection & Submission**
- Public review submission page with rating selection
- Star rating system in email (clickable 1-5 stars)
- Rating-based routing:
  - 4-5 stars: Direct redirect to Google review page
  - 1-3 stars: Internal feedback form
- Review tracking and database storage
- Platform-specific review creation

**3. Automation Triggers**
- On Client Created: Automatically send review request when new client is added
- On Status Change to Client: Send review request when client status changes to "Client"
- Configurable business line filters
- Configurable delay days before sending

**4. Review Management UI**
- Dashboard with review statistics
- My Reviews tab: View all collected public reviews
- Private Feedback tab: View low-rating reviews and feedback
- Settings tab: Comprehensive configuration with collapsible sections
- Review deletion functionality with confirmation modal

**5. Settings & Configuration**
- Enable/disable review system
- Default invitation channel (email, SMS, both)
- Default review platforms (Google, Facebook)
- Rating filter settings (minimum rating for platforms, low rating message)
- Follow-up sequence configuration (enabled, max attempts, interval days)
- Link expiration settings
- Email and link tracking toggles
- Platform URL configuration (Google Business Profile, Facebook Page)
- Automation trigger configuration

**6. Email Templates**
- Clickable star ratings (1-5 stars) in email body
- Each star links to review page with rating parameter
- Production URL enforcement (replaces localhost)
- Tracking URL support for analytics

**7. UI/UX Improvements**
- Collapsible settings sections (matching Portal Settings style)
- All sections collapsed by default
- Dark theme compatibility
- Icons for each settings section
- Proper spacing between sections
- Delete confirmation modal for reviews

#### Technical Implementation

**Backend Changes:**
- `crm/server/src/routes/reviews.ts`:
  - GET/PUT `/api/reviews/config` - Configuration management
  - GET `/api/reviews` - List reviews with pagination and filters
  - DELETE `/api/reviews/:id` - Delete review endpoint
  - POST `/api/reviews/requests` - Create review request
  - GET `/api/reviews/link/:token` - Get review link details
  - POST `/api/reviews/link/:token/submit` - Submit review
  - POST `/api/reviews/track/rating/:requestId` - Track rating selection
  - GET `/api/reviews/stats` - Review statistics

- `crm/server/src/services/reviewEmailService.ts`:
  - Email template with clickable stars
  - Production URL enforcement
  - Tracking URL generation

- `crm/server/src/services/reviewScheduler.ts`:
  - Background job for processing scheduled review requests
  - Follow-up sequence logic
  - Automatic follow-up sending based on configuration

- `crm/server/src/services/reviewAutomationService.ts`:
  - Client creation trigger logic
  - Status change trigger logic
  - Max attempts enforcement (prevents sending more than configured)

- `crm/server/src/db/init-db.ts`:
  - `review_requests` table with `attempt_number` and `follow_up_scheduled_at` columns
  - `reviews` table for storing collected reviews

**Frontend Changes:**
- `crm/client/src/pages/reviews/ReviewsPage.tsx`:
  - Main reviews management page with tab navigation
  - Configuration loading and saving
  - State management for review config

- `crm/client/src/pages/reviews/SettingsTab.tsx`:
  - Comprehensive settings UI with collapsible sections
  - Uses `CollapsibleSection` component (matching Portal Settings style)
  - All sections collapsed by default
  - Dark theme compatible

- `crm/client/src/pages/reviews/MyReviewsTab.tsx`:
  - Display all collected public reviews
  - Pagination support
  - Delete functionality with confirmation modal
  - Review cards with platform badges, ratings, and metadata

- `crm/client/src/pages/reviews/PrivateFeedbackTab.tsx`:
  - Display low-rating reviews and private feedback
  - Filtered reviews (rating <= 3)

- `crm/client/src/pages/reviews/DashboardTab.tsx`:
  - Review statistics and analytics
  - Rating distribution
  - Platform breakdown

- `crm/client/src/pages/ReviewSubmissionPage.tsx`:
  - Public review submission page
  - Rating parameter handling
  - Rating-based routing (4-5 stars ‚Üí Google, 1-3 stars ‚Üí internal form)
  - Review submission to multiple platforms

**Issues Fixed:**
1. **Settings toggle not persisting**: Fixed race condition in `SettingsTab.tsx` where `enabled` toggle would reset after save. Added `isAutoSaving` ref and safeguard to prevent overwriting local state during async operations.

2. **Page refresh on trigger toggles**: Removed auto-save for automation trigger toggles, requiring manual "Save Settings" click to prevent refresh loops.

3. **Localhost URLs in emails**: Enforced production URLs (`https://crm.versainsuranceagency.com`) in all email templates and tracking URLs, replacing any localhost references.

4. **Review link tracking URLs**: Fixed tracking URLs to use production domain instead of localhost.

5. **Platform selection removed**: Removed dropdown for platform selection, automatically posting to all configured platforms in settings.

6. **Default platform set to Google**: Changed default from `['google', 'facebook']` to `['google']` per user preference.

7. **Dark theme compatibility**: Removed explicit white backgrounds from trigger cards and settings sections to allow dark theme adaptation.

8. **Section spacing**: Added proper spacing between collapsible sections to match Portal Settings page style.

9. **Simplified automation triggers**: Removed "On Enrollment Complete" trigger, keeping only "On Client Created" and "On Status Change to Client".

10. **Follow-up sequence implementation**: Implemented configurable follow-up sequences (max attempts, interval days) with automatic scheduling and processing.

**Files Created:**
- `crm/client/src/pages/reviews/ReviewsPage.tsx`
- `crm/client/src/pages/reviews/SettingsTab.tsx`
- `crm/client/src/pages/reviews/MyReviewsTab.tsx`
- `crm/client/src/pages/reviews/PrivateFeedbackTab.tsx`
- `crm/client/src/pages/reviews/DashboardTab.tsx`
- `crm/client/src/pages/reviews/GetReviewsTab.tsx`
- `crm/client/src/pages/reviews/ReportsTab.tsx`
- `crm/client/src/pages/reviews/WidgetsTab.tsx`
- `crm/client/src/pages/reviews/CustomOptionsTab.tsx`
- `crm/client/src/pages/reviews/IntegrationsTab.tsx`
- `crm/client/src/pages/ReviewSubmissionPage.tsx`
- `crm/server/src/services/reviewEmailService.ts`
- `crm/server/src/services/reviewSmsService.ts`
- `crm/server/src/services/reviewScheduler.ts`
- `crm/server/src/services/reviewAutomationService.ts`

**Files Modified:**
- `crm/server/src/routes/reviews.ts` - Complete review management API
- `crm/server/src/db/init-db.ts` - Review tables and migrations
- `crm/client/src/App.tsx` - Review routes
- `crm/server/src/routes/clients.ts` - Integration with review automation triggers

---

### API Key Security Enhancement (January 2025)

**Status**: ‚úÖ Complete

#### Overview
Fixed missing `api_key_hash` column in `api_keys` table that was preventing API key creation. The column was never added to existing tables due to `CREATE TABLE IF NOT EXISTS` not altering existing tables.

#### Changes Made
- Added Migration 005 to `init-db.ts` to check for and add `api_key_hash` column if missing
- Created standalone script `add-api-key-hash-column.ts` for manual migration
- Column now stores bcrypt hashes of API keys for security (similar to password hashing)

**Files Modified**:
- `crm/server/src/db/init-db.ts` - Added Migration 005
- `crm/server/src/scripts/add-api-key-hash-column.ts` - New migration script

---

### Client Portal Impersonation Fixes (January 2025)

**Status**: ‚úÖ Complete

#### Overview
Fixed impersonation functionality that was failing on iPad/mobile devices and some desktop browsers. Implemented cross-origin token passing using `window.postMessage` to bypass browser security restrictions.

#### Changes Made
1. **Cross-Origin Token Passing**
   - CRM now opens client portal window synchronously with placeholder URL
   - Uses `window.postMessage` to send impersonation token from CRM to client portal
   - Client portal listens for `postMessage` events and verifies origin for security
   - Token is then used to authenticate without full page reload

2. **Token Polling & Redirect Logic**
   - Added token polling with timeout (15 seconds max)
   - Refined redirect logic to wait for token verification before redirecting to login
   - Prevents premature redirects during impersonation flow

3. **Error Handling**
   - Added comprehensive logging for debugging impersonation flow
   - Fallback to display URL if `postMessage` fails
   - Better error messages for blocked popups

**Files Modified**:
- `crm/client/src/pages/ClientDetailPage.tsx` - Implemented `postMessage` token passing
- `crm/client-portal/app/(portal)/layout.tsx` - Added `postMessage` listener and token verification
- `crm/client-portal/app/(portal)/dashboard/page.tsx` - Token polling logic

---

### Portal Logo CORS Fixes (January 2025)

**Status**: ‚úÖ Complete

#### Overview
Fixed `ERR_BLOCKED_BY_RESPONSE.NotSameOrigin` errors when loading portal logos in the client portal. Nginx was adding restrictive CORS headers that blocked cross-origin image requests.

#### Changes Made
1. **Nginx Configuration**
   - Added dedicated `location /api/portal-logos/` block
   - Used `proxy_hide_header` to remove restrictive headers from backend
   - Explicitly added `Cross-Origin-Resource-Policy: cross-origin` and `Access-Control-Allow-Origin: *`
   - Added cache headers for better performance

2. **Server Configuration**
   - Explicitly set `Content-Security-Policy` header for logo endpoint
   - Ensured CORS headers are set before any other headers

3. **Client Portal**
   - Re-added `crossOrigin="anonymous"` and `referrerPolicy="no-referrer"` to logo `img` tag
   - Added cache-busting query parameter to force fresh image fetches

**Files Modified**:
- `/etc/nginx/sites-available/crm-versainsuranceagency` - Added logo endpoint CORS configuration
- `crm/server/src/index.ts` - Enhanced logo endpoint with CSP headers
- `crm/client-portal/app/(portal)/layout.tsx` - Logo image attributes and cache-busting

---

### Email Template Configuration Improvements (January 2025)

**Status**: ‚úÖ Complete

#### Overview
Enhanced email template configuration to support template-specific sender names and centralized email settings.

#### Changes Made
1. **Template-Specific Sender Names**
   - Added "From Name" field to each email template (Medicare, Health Insurance Lead, Client Portal Onboarding)
   - Allows different sender names per template type
   - Falls back to global "From Name" if not specified

2. **Centralized Email Settings**
   - Moved common settings (From Name, From Email) to dedicated "Email Settings" section
   - Template-specific settings (Subject, Body, From Name) remain in individual template sections

3. **SendGrid Template Updates**
   - Health Insurance Client Onboarding template includes company logo at top
   - Logo links to company website
   - "Sign In to Your Portal" button added
   - Portal URL displayed prominently

**Files Modified**:
- `crm/client/src/pages/PortalSettingsPage.tsx` - Template-specific sender configuration
- `crm/server/src/services/portalEmailService.ts` - Template content updates
- `crm/server/src/routes/clients.ts` - Company name handling for email templates

---

### Portal Settings & Connectors UI Improvements (January 2025)

**Status**: ‚úÖ Complete

#### Overview
Improved user experience in Portal Settings and Connectors pages with persistent collapsed states and better organization.

#### Changes Made
1. **Persistent Collapsed States**
   - Implemented `localStorage` persistence for collapsed sections
   - Sections remember their state across page refreshes
   - Applied to both Portal Settings and Connectors pages

2. **UI Refinements**
   - Removed unnecessary horizontal divider between Branding and Ads sections
   - Improved section organization and default open states
   - Better visual hierarchy

**Files Modified**:
- `crm/client/src/pages/PortalSettingsPage.tsx` - Collapsed state persistence
- `crm/client/src/pages/ConnectorsPage.tsx` - Collapsed state persistence
- `crm/client/src/components/CollapsibleSection.tsx` - Controlled state support

---

### Broker Page & Profile Enhancements (January 2025)

**Status**: ‚úÖ Complete

#### Overview
Enhanced broker information display in client portal and added company name field to user profile.

#### Changes Made
1. **Broker Page Improvements**
   - Added company name display alongside broker name and email
   - Improved layout alignment using `SimpleGrid` for even distribution
   - Aligned NPN field with company name
   - Consistent font sizing for email and phone number

2. **User Profile Enhancement**
   - Added "Company Name" field to profile page
   - Field appears on same line as last name
   - Automatically migrated existing profiles

**Files Modified**:
- `crm/client-portal/app/(portal)/broker/page.tsx` - Layout and company name display
- `crm/client/src/pages/ProfilePage.tsx` - Company name field
- `crm/server/src/routes/auth.ts` - Company name handling
- `crm/server/src/db/init-db.ts` - Database migration for company_name column

---

### CSRF Protection Improvements (January 2025)

**Status**: ‚úÖ Complete

#### Overview
Exempted public authentication endpoints from CSRF protection to prevent 403 errors on token refresh and magic link operations.

#### Changes Made
- Exempted `/api/auth/refresh` from CSRF protection (uses secure refresh token for validation)
- Exempted `/api/client-auth/magic-link/send` and `/api/client-auth/magic-link/verify` (public client authentication endpoints)
- Prevents 403 errors when client portal calls these endpoints from different domain

**Files Modified**:
- `crm/server/src/middleware/csrf.ts` - Added endpoint exemptions

---

### GiveMe5.ai Review Management Integration (January 2025)

**Status**: ‚úÖ Complete

#### Overview
Integrated GiveMe5.ai for automated review request management. When health insurance clients are set to "Client" status, review invitations are automatically sent via GiveMe5.ai's API.

#### Changes Made

**1. GiveMe5.ai Service**
- Created `giveme5Service.ts` that sends review invitations directly to GiveMe5.ai API
- Supports email and SMS review requests
- Handles phone number formatting (country code extraction)
- Validates required fields (Access Key, Profile ID, email or phone)

**2. Connectors Page Configuration**
- Created dedicated Connectors page (`/connectors`) for managing all integrations
- Moved GiveMe5.ai configuration from Portal Settings to Connectors page
- Configuration fields:
  - Enable/Disable integration (can be toggled off for testing)
  - Access Key (API Token) - Required
  - Profile ID - Required
  - Trigger options:
    - When client is created
    - When status changes to "Client"
    - When enrollment is complete
- Allows easy enable/disable for testing purposes without affecting other portal settings

**3. Automatic Review Invitations**
- Triggers automatically when:
  - Health insurance client is created with "Client" status
  - Health insurance client status is changed to "Client"
- Only sends for health insurance clients (not Medicare)
- Requires email or phone number to send invitation

**4. Database Migration**
- Added `giveme5_config` JSONB column to `portal_config` table
- Migration runs automatically on first access

**Files Created**:
- `crm/server/src/services/giveme5Service.ts` - GiveMe5.ai API integration service
- `crm/server/src/scripts/test-giveme5-connection.ts` - Connection testing script
- `crm/server/src/scripts/test-giveme5-webhook.ts` - Webhook testing script (deprecated - using direct API)
- `crm/client/src/pages/ConnectorsPage.tsx` - New dedicated page for managing all integrations

**Files Modified**:
- `crm/server/src/routes/portal.ts` - Added GiveMe5.ai config to PortalConfig interface and endpoints
- `crm/server/src/routes/clients.ts` - Integrated GiveMe5.ai service into client creation/update flow
- `crm/client/src/pages/PortalSettingsPage.tsx` - Removed GiveMe5.ai configuration (moved to Connectors page)

**API Endpoint Used**:
- `POST https://api.giveme5.ai/review_invitation`
- Required fields: `api_token`, `profileId`
- Optional fields: `first_name`, `last_name`, `email_address`, `country_code`, `mobile_number`

**Documentation**:
- GiveMe5.ai API Documentation: https://intercom.help/giveme5-inc/en/articles/10994876-review-request-automation-through-zapier

---

## January 2025

### Health Insurance Onboarding Email & Plans Page (January 2025)

**Status**: ‚úÖ Complete

#### Overview
Implemented health insurance onboarding email functionality and created a Plans page in the client portal to display plans, carriers, and enrollees.

#### Changes Made

**1. Health Insurance Onboarding Email**
- Created `sendHealthInsuranceOnboardingEmail` function that sends comprehensive onboarding emails with plan details
- Email includes: enrollees, carriers, health plans, dental plans, vision plans, coverage info, broker info
- Automatically sent when health insurance clients are created with `form_submission_data` containing plan selections
- Falls back to simple welcome email if no plan data exists
- Uses SendGrid dynamic templates for easy editing

**2. Plans Page in Client Portal**
- Created `/plans` page that displays:
  - Summary cards (health plans count, enrolled members count, carriers count)
  - Coverage information (year, exchange type, effective date)
  - Enrolled members table
  - Insurance carriers list
  - Health plans table
  - Dental plans table
  - Vision plans table
- Similar structure to dashboard page for consistency
- Only accessible to health insurance clients

**Files Modified**:
- `crm/server/src/services/portalEmailService.ts` - Added onboarding email function
- `crm/server/src/routes/clients.ts` - Updated to send onboarding email for health insurance clients
- `crm/client-portal/app/(portal)/plans/page.tsx` - New plans page
- `crm/client-portal/types/portal.ts` - Updated BrokerInfo interface

### Medicare Client Status Display (January 2025)

**Status**: ‚úÖ Complete

#### Overview
Standardized status display for Medicare clients to show "Lead", "In-Process", or "Client" instead of "Manual Lead".

#### Changes Made
- Updated default status for new Medicare clients from `'manual-lead'` to `'lead'`
- Modified display logic in ClientsPage and ClientDetailPage to show 'manual-lead' as "Lead" for Medicare clients
- Updated form loading logic to convert 'manual-lead' to 'lead' when editing Medicare clients

**Files Modified**:
- `crm/client/src/pages/ClientFormPage.tsx` - Default status and form loading
- `crm/client/src/pages/ClientsPage.tsx` - Status display
- `crm/client/src/pages/ClientDetailPage.tsx` - Status display

### SendGrid Template Refactoring (January 2025)

**Status**: ‚úÖ Complete

#### Overview
Refactored SendGrid template configuration in Portal Settings to be more modular and scalable.

#### Changes Made
- Created reusable `LeadEmailTemplateRow` component
- Defined `LEAD_EMAIL_TEMPLATES` array for configuration
- Added generic `/api/portal/template/create` endpoint
- Supports multiple template types (Medicare, Health Insurance)

**Files Modified**:
- `crm/client/src/components/LeadEmailTemplateRow.tsx` - New reusable component
- `crm/client/src/pages/PortalSettingsPage.tsx` - Refactored to use component
- `crm/server/src/routes/portal.ts` - Added generic template creation endpoint

### Client Portal Branding & Logo Management (January 2025)

**Status**: ‚úÖ Complete

#### Overview
Implemented branding system allowing CRM users to upload custom logos and favicons for the client portal.

#### Changes Made
- Added logo upload functionality (light theme, dark theme, favicon)
- Logo storage on droplet filesystem (`crm/server/public/portal-logos/`)
- Configurable logo dimensions (width/height)
- Dynamic logo display in client portal based on theme
- Auto-save after logo upload

**Files Modified**:
- `crm/server/src/routes/portal.ts` - Logo upload and branding endpoints
- `crm/client/src/pages/PortalSettingsPage.tsx` - Logo upload UI
- `crm/client-portal/app/(portal)/layout.tsx` - Dynamic logo display
- `crm/server/src/index.ts` - Static file serving for logos

### Medicare Email Template Creation (January 2025)

**Status**: ‚úÖ Complete

#### Overview
Implemented programmatic SendGrid template creation for Medicare 101 email template.

#### Changes Made
- Created `createMedicare101Template` function
- Template includes: video links, Medicare Advantage/Supplement expectations, Part B Premium table
- Automatic template ID saving to portal configuration
- Disabled click tracking for direct YouTube links

**Files Modified**:
- `crm/server/src/services/portalEmailService.ts` - Template creation functions
- `crm/server/src/routes/portal.ts` - Template creation endpoints
- `crm/client/src/pages/PortalSettingsPage.tsx` - Template creation UI

---

## November 2025

### Medicare AI Assistant Sections - Collapsible UI (November 12, 2025)

**Status**: ‚úÖ Complete

#### Overview
Made AI Assistant Chat and AI Assistant Summaries sections collapsible on the Medicare view client page.

#### Changes Made
- Added collapsible Card components with ActionIcon buttons
- Both sections collapsed by default
- AI Assistant Chat appears above AI Assistant Summaries

**Files Modified**:
- `crm/client/src/pages/ClientDetailPage.tsx`

### Medicare Form Sections Restoration (November 12, 2025)

**Status**: ‚úÖ Complete

#### Overview
Restored missing Medicare Info and Classification sections to add/edit/view client pages.

#### Changes Made
- Restored Medicare Info section with all fields
- Added Classification section (Business Line, Lead Type, Status)
- Updated view page to match form page layout

**Files Modified**:
- `crm/client/src/pages/ClientFormPage.tsx`
- `crm/client/src/pages/ClientDetailPage.tsx`

---

**Note**: For detailed historical changes, see `crm/AI_SETUP.md` (legacy documentation).



# ============================================
# PROJECT STATUS
# ============================================

# Project Status
## Versa Insurance Agency CRM

**Last Updated**: 2025-01-27  
**Current Phase**: Epic 3 - Client Portal (In Progress)

---

## Epic Status

### Epic 1: Core CRM Foundation
**Status**: ‚úÖ **COMPLETE**

**Completed Features**:
- ‚úÖ Authentication & Security (JWT, refresh tokens, 14 security fixes)
- ‚úÖ Client Management (Full CRUD, phone search, dashboard)
- ‚úÖ Multi-Business Line Support (Medicare, Health Insurance, Life, Group Health, Commercial)
- ‚úÖ AI Field Extraction (28+ fields, 91.8%+ accuracy)
- ‚úÖ Real-Time Conversation Processing
- ‚úÖ Call Integration (Twilio)
- ‚úÖ AI Message Generation
- ‚úÖ Conversation Tracking

### Epic 2: AI Agent Integration
**Status**: ‚úÖ **COMPLETE**

**Completed Features**:
- ‚úÖ AI-powered field extraction from conversations
- ‚úÖ Real-time AI assistance during calls
- ‚úÖ CMS rules integration
- ‚úÖ Carrier and plan recommendations
- ‚úÖ Formulary integration

### Epic 3: Client Portal
**Status**: üöß **CURRENT** (In Progress)

**Completed Stories**:
- ‚úÖ Story 3.1: Client Portal Foundation
  - Next.js App Router setup
  - Authentication system
  - Basic layout and navigation
  - Dashboard page (Medicare & Health Insurance)

- ‚úÖ Story 3.2: Plan Summary Dashboard
  - Health insurance plans display
  - Medicare plans display
  - Coverage information
  - Enrollees display

- ‚úÖ Story 3.3: Document Management
  - Documents page
  - Document download functionality
  - Health insurance document sections

**In Progress**:
- üöß Story 3.4: Scheduling Integration (Planned)
- üöß Story 3.5: Benefits & Coverage Page (Planned)
- üöß Story 3.6: Polish & Testing (Planned)

**Recent Additions**:
- ‚úÖ Plans page (`/plans`) - Lists plans, carriers, and enrollees for health insurance clients
- ‚úÖ Health insurance onboarding email - Comprehensive email with plan details
- ‚úÖ Broker page - Displays broker information for all business lines

### Epic 4: Multi-Tenant SaaS Platform
**Status**: üîÆ **FUTURE**

**Planned Features**:
- Multi-tenant architecture (3-database system)
- Tenant management
- HIPAA compliance enhancements
- Agency-level isolation

### Epic 5: Advanced Features
**Status**: üîÆ **FUTURE**

**Planned Features**:
- Advanced analytics
- Reporting system
- Integration with external systems

---

## Current Metrics

### AI Extraction Accuracy
- **Current**: 91.8%+ accuracy (28/28 fields supported)
- **Target**: 95%+ accuracy

### System Performance
- **Uptime**: Monitoring in progress
- **Response Time**: < 2 seconds for most operations
- **Database**: Neon PostgreSQL (cloud, serverless)

### Development Velocity
- **Active Epics**: 1 (Epic 3)
- **Stories Completed**: 3 of 6 (Epic 3)
- **Stories In Progress**: 0
- **Stories Planned**: 3

---

## Key Achievements

### January 2025
- ‚úÖ Health insurance onboarding email system
- ‚úÖ Plans page in client portal
- ‚úÖ Medicare client status standardization
- ‚úÖ SendGrid template refactoring
- ‚úÖ Client portal branding system

### November 2025
- ‚úÖ Medicare AI Assistant collapsible sections
- ‚úÖ Medicare form sections restoration
- ‚úÖ Broker information auto-population

---

## Next Steps

1. **Complete Epic 3**: Finish remaining client portal stories
2. **Testing**: Comprehensive testing of client portal features
3. **Documentation**: Update architecture document with new features
4. **Epic 4 Planning**: Begin planning for multi-tenant architecture

---

## Blockers & Issues

### Current Blockers
- None

### Known Issues
- Health insurance exchange filter tabs not working (form_submission_data missing in list endpoint)
  - **Status**: Investigating
  - **Impact**: Medium - filtering still works via detail page

---

**For detailed change history, see `.ai/CHANGELOG.md`**






















# ============================================
# QUICK REFERENCE
# ============================================

# Quick Reference Guide
## Versa Insurance Agency CRM

**Quick reference for AI agents working on this codebase.**

## Critical Rules for AI Agents

### 1. Database Queries
- ‚úÖ **ALWAYS** use `sql` template literals with PostgreSQL `ANY()` for array filtering
- ‚ùå **NEVER** use nested `sql` fragments or `sql.unsafe()` (not available)
- ‚ùå **NEVER** use `null` in conditional SQL fragments
- ‚úÖ **Pattern**: `line_of_business = ANY(${enabledBusinessLines})` for arrays

**Correct Pattern:**
```typescript
const clients = await sql`
  SELECT * FROM clients
  WHERE user_id = ${userId}
    AND line_of_business = ANY(${enabledBusinessLines})
`;
```

**Wrong Pattern:**
```typescript
// WRONG: Nested sql fragments
let orCondition = sql`line_of_business = ${lines[0]}`;
for (let i = 1; i < lines.length; i++) {
  orCondition = sql`${orCondition} OR ${lines[i]}`;
}
```

### 2. Port Management
- ‚úÖ **ALWAYS** use explicit ports: Backend 3000, Frontend 5000
- ‚úÖ **ALWAYS** check for port conflicts before starting
- ‚úÖ **ALWAYS** kill existing processes: `pkill -f "tsx.*index"` or `lsof -ti:3000 | xargs kill -9`

### 3. Branch & Environment
- ‚úÖ **ALWAYS** check current branch: `git branch --show-current`
- ‚úÖ **ALWAYS** use `dev` branch for development
- ‚úÖ **ALWAYS** verify environment matches branch

### 4. Server Startup
- ‚úÖ **ALWAYS** use `npx tsx server/index.ts` for backend (NOT `node dist/index.js`)
- ‚úÖ **ALWAYS** set environment variables: `PORT=3000` and `NODE_ENV=development`
- ‚úÖ **ALWAYS** restart server after environment variable changes

### 5. Code Changes
- ‚úÖ **ALWAYS** create feature branch from `dev`
- ‚úÖ **ALWAYS** run tests before committing
- ‚úÖ **ALWAYS** use `--no-verify` if TypeScript errors block critical fixes

## Common Commands

### Setup
```bash
cd /var/www/crm-versainsuranceagency/crm
cd server && npm install
cd ../client && npm install
cd ../server && npm run init-db
```

### Development
```bash
# Terminal 1 - Backend
cd /var/www/crm-versainsuranceagency/crm/server
$env:PORT="3000"; $env:NODE_ENV="development"; npx tsx server/index.ts

# Terminal 2 - Frontend
cd /var/www/crm-versainsuranceagency/crm/client
npx vite --port 5000
```

### Troubleshooting
```bash
pm2 restart crm-server                    # Restart backend
pm2 logs crm-server --lines 100           # View logs
cd crm/client && npm run build            # Build frontend
curl http://localhost:3000/api/health     # Check health
```

## Error Diagnosis - Quick Checks

### Step 1: Identify Error Type

| Error Pattern | Likely Cause | First Check |
|--------------|--------------|-------------|
| `500 on /` or `500 on /favicon.ico` | Missing frontend build | `test -d crm/client/dist` |
| `500 on /api/*` | Database/query error | Check server logs for `‚ùå Error caught:` |
| `404 on /` or `404 on /api/*` | Route not found | Verify route exists in routes |
| `401 on /api/*` | Authentication failed | Check token/auth middleware |
| `CORS error` | Frontend/backend mismatch | Verify ports and URLs |

### Step 2: Most Common Issues

**Missing Frontend Build (500 on `/`)**
```bash
# Check
test -d crm/client/dist && echo "exists" || echo "MISSING - build frontend"

# Fix
cd crm/client && npm run build
```

**Port Conflicts**
```bash
# Check
lsof -i:3000
ps aux | grep "tsx.*index"

# Fix
pkill -f "tsx.*index"
# or
lsof -ti:3000 | xargs kill -9
```

**SQL Parameter Errors**
- **Symptom**: "syntax error at or near $3" in server logs
- **Cause**: Nested `sql` fragments
- **Fix**: Use PostgreSQL `ANY()` for array filtering

## Technology Stack

| Component | Technology | Version |
|-----------|-----------|---------|
| **Frontend** | React | 19 |
| **Frontend Build** | Vite | Latest |
| **UI Library** | Mantine | 8.3.6 |
| **Backend** | Node.js + Express | Latest |
| **Language** | TypeScript | Latest |
| **Database** | Neon PostgreSQL | Cloud |
| **Authentication** | JWT | Latest |
| **AI** | OpenAI GPT-4o-mini | Latest |
| **Voice** | Twilio | Latest |
| **Email** | SendGrid | Latest |

## File Locations

### Backend Routes
- `crm/server/src/routes/clients.ts` - Client management endpoints
- `crm/server/src/routes/calls.ts` - Call and voicemail endpoints
- `crm/server/src/routes/ai.ts` - AI message generation
- `crm/server/src/routes/dashboard.ts` - Dashboard metrics endpoints
- `crm/server/src/routes/portal.ts` - Portal settings and configuration

### Frontend Pages
- `crm/client/src/pages/ClientsPage.tsx` - Client list and management
- `crm/client/src/pages/ClientDetailPage.tsx` - Client detail view
- `crm/client/src/pages/ClientFormPage.tsx` - Client form (create/edit)
- `crm/client/src/pages/PortalSettingsPage.tsx` - Portal configuration
- `crm/client/src/pages/ConnectorsPage.tsx` - Integration connectors (GiveMe5.ai, etc.)

### Database
- `crm/server/src/db/init-db.ts` - Database initialization and migrations
- `crm/server/src/db/connection.ts` - Database connection configuration

## Environment Variables

### Required
- `DATABASE_URL` - Neon PostgreSQL connection string
- `JWT_SECRET` - JWT token signing secret
- `PORT` - Backend server port (default: 3000)
- `NODE_ENV` - Environment (development/production)

### Optional
- `OPENAI_API_KEY` - AI message generation
- `TWILIO_ACCOUNT_SID`, `TWILIO_AUTH_TOKEN` - Voice calls
- `SENDGRID_API_KEY` - Email notifications
- `CMS_API_KEY` - CMS API for federal marketplace states
- `VERICRED_API_KEY` - Vericred API for California

## Need More Details?

- **Full Setup Guide**: See `crm/docs/SETUP.md`
- **Troubleshooting**: See `crm/docs/TROUBLESHOOTING.md`
- **Architecture**: See `.ai/arch.md`
- **Project Status**: See `.ai/PROJECT-STATUS.md`
- **Recent Changes**: See `.ai/CHANGELOG.md`



# ============================================
# DATABASE ARCHITECTURE
# ============================================

# üèóÔ∏è Database Architecture - Versa Insurance CRM

**Purpose**: Single source of truth for database architecture  
**Last Updated**: December 18, 2024  
**Status**: ‚úÖ Production - Two Separate Databases

---

## üìä **Database Overview**

### **System Architecture:**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Marketing Site (Next.js)               ‚îÇ
‚îÇ  Host: quotecaptain.com                 ‚îÇ
‚îÇ  Database: ep-icy-voice-afl8wbfi       ‚îÇ
‚îÇ  Tables: 22 marketing tables            ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                    ‚Üï API only
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  CRM System (React + Express)           ‚îÇ
‚îÇ  Host: crm.versainsuranceagency.com     ‚îÇ
‚îÇ  Database: ep-small-thunder-afvxv0vi   ‚îÇ
‚îÇ  Tables: 81 CRM/business tables         ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

---

## üóÑÔ∏è **Database 1: Marketing Site**

### **Connection Details:**
- **Host**: `ep-icy-voice-afl8wbfi-pooler.us-west-2.aws.neon.tech`
- **Database**: `neondb`
- **Provider**: Neon PostgreSQL
- **Purpose**: Marketing website content management
- **Access**: Marketing site only

### **Tables** (22 total):
```
Marketing Site Tables (All Owned by Marketing Agent):
‚îú‚îÄ‚îÄ admin_csrf_tokens          (Admin security)
‚îú‚îÄ‚îÄ admin_sessions             (Admin auth)
‚îú‚îÄ‚îÄ admin_users                (Marketing admin accounts)
‚îú‚îÄ‚îÄ blog_posts                 (Blog content)
‚îú‚îÄ‚îÄ booking_pages              (Marketing booking pages)
‚îú‚îÄ‚îÄ calendar_settings          (Calendar config)
‚îú‚îÄ‚îÄ case_studies               (Marketing content)
‚îú‚îÄ‚îÄ cms_media                  (Media library)
‚îú‚îÄ‚îÄ cms_menu_items             (Navigation)
‚îú‚îÄ‚îÄ cms_pages                  (Content pages)
‚îú‚îÄ‚îÄ cms_site_settings          (Site config)
‚îú‚îÄ‚îÄ event_types                (Booking event types)
‚îú‚îÄ‚îÄ events                     (Marketing events)
‚îú‚îÄ‚îÄ health_insurance_notifications  (Form settings)
‚îú‚îÄ‚îÄ hipaa_audit_logs          (Security logs)
‚îú‚îÄ‚îÄ newsletter_signups         (Email list)
‚îú‚îÄ‚îÄ page_views                 (Analytics)
‚îú‚îÄ‚îÄ rate_limits                (API throttling)
‚îú‚îÄ‚îÄ resources                  (Marketing resources)
‚îú‚îÄ‚îÄ service_pages              (Service descriptions)
‚îú‚îÄ‚îÄ team_members               (Team profiles)
‚îî‚îÄ‚îÄ testimonials               (Customer reviews)
```

### **Who Manages:**
- **Owner**: Marketing Agent
- **Schema Changes**: Marketing agent only
- **Data Access**: Marketing site only

---

## üóÑÔ∏è **Database 2: CRM System**

### **Connection Details:**
- **Host**: `ep-small-thunder-afvxv0vi-pooler.us-west-2.aws.neon.tech`
- **Database**: `neondb`
- **Provider**: Neon PostgreSQL
- **Purpose**: Complete CRM operations
- **Access**: CRM application only

### **Tables** (81 total):

#### **Core CRM Tables** (35 tables - Owned by CRM Agent):
```
Client Management:
‚îú‚îÄ‚îÄ clients                    (Client records)
‚îú‚îÄ‚îÄ client_sessions            (Client portal sessions)
‚îú‚îÄ‚îÄ client_magic_link_tokens   (Passwordless login)
‚îú‚îÄ‚îÄ client_portal_preferences  (Portal settings)
‚îú‚îÄ‚îÄ client_documents           (Document storage)
‚îú‚îÄ‚îÄ client_enrollments         (Enrollment tracking)
‚îú‚îÄ‚îÄ client_family_members      (Family data)
‚îú‚îÄ‚îÄ client_health_info         (Health information)
‚îú‚îÄ‚îÄ client_primary_care_physicians  (PCP data)
‚îú‚îÄ‚îÄ client_response_patterns   (AI patterns)
‚îú‚îÄ‚îÄ client_broker_assignments  (Broker relationships)

User/Agent Management:
‚îú‚îÄ‚îÄ users                      (CRM users/agents)
‚îú‚îÄ‚îÄ user_ai_preferences        (AI settings)
‚îú‚îÄ‚îÄ user_contracted_carriers   (Carrier contracts)
‚îú‚îÄ‚îÄ password_reset_tokens      (Password recovery)
‚îú‚îÄ‚îÄ refresh_tokens             (Auth tokens)

Appointments/Calendar:
‚îú‚îÄ‚îÄ appointments               (Appointments)
‚îú‚îÄ‚îÄ calendar_sync              (Calendar integration)
‚îú‚îÄ‚îÄ agent_availability         (Agent schedules)
‚îú‚îÄ‚îÄ availability_overrides     (Schedule changes)

Communications:
‚îú‚îÄ‚îÄ conversations              (Customer conversations)
‚îú‚îÄ‚îÄ conversation_messages      (Message history)
‚îú‚îÄ‚îÄ conversation_embeddings    (AI embeddings)
‚îú‚îÄ‚îÄ conversation_outcomes      (Conversation results)
‚îú‚îÄ‚îÄ conversation_patterns      (AI patterns)
‚îú‚îÄ‚îÄ calls                      (Call records)
‚îú‚îÄ‚îÄ call_availability          (Call scheduling)
‚îú‚îÄ‚îÄ voicemails                 (Voicemail storage)
‚îú‚îÄ‚îÄ voicemail_greetings        (Greeting audio)
‚îú‚îÄ‚îÄ twilio_phone_numbers       (Phone inventory)

Financial:
‚îú‚îÄ‚îÄ commissions                (Commission tracking)
‚îú‚îÄ‚îÄ commission_rates           (Commission rules)

System:
‚îú‚îÄ‚îÄ api_keys                   (API authentication)
‚îú‚îÄ‚îÄ portal_config              (CRM configuration)
‚îú‚îÄ‚îÄ portal_ads                 (Portal advertising)
‚îú‚îÄ‚îÄ audit_logs                 (Security audit)
‚îú‚îÄ‚îÄ notifications              (User notifications)
```

#### **Docusend E-Signature System** (9 tables - Owned by CRM Agent):
```
‚îú‚îÄ‚îÄ docusend_documents         (Document storage)
‚îú‚îÄ‚îÄ docusend_envelopes         (Signature envelopes)
‚îú‚îÄ‚îÄ docusend_signers           (Signer info)
‚îú‚îÄ‚îÄ docusend_templates         (Document templates)
‚îú‚îÄ‚îÄ docusend_signature_fields  (Form fields)
‚îú‚îÄ‚îÄ docusend_signed_documents  (Completed docs)
```

#### **CRM Booking System** (9 tables - Owned by CRM Agent):
```
‚ö†Ô∏è Note: These are CRM booking features, NOT marketing site tables!

‚îú‚îÄ‚îÄ booking_pages              (CRM appointment booking)
‚îú‚îÄ‚îÄ booking_page_event_types   (Booking events)
‚îú‚îÄ‚îÄ booking_page_questions     (Custom questions)
‚îú‚îÄ‚îÄ master_pages               (Page templates)
‚îú‚îÄ‚îÄ master_page_event_types    (Template events)
‚îú‚îÄ‚îÄ event_types                (Event definitions)
‚îú‚îÄ‚îÄ event_type_users           (User assignments)
```

#### **CRM Marketing Tools** (4 tables - Owned by CRM Agent):
```
‚ö†Ô∏è Note: These are CRM's internal marketing tools, NOT marketing site tables!

‚îú‚îÄ‚îÄ marketing_campaigns        (CRM campaigns)
‚îú‚îÄ‚îÄ marketing_settings         (Campaign config)
‚îú‚îÄ‚îÄ cms_regulations            (Compliance rules)
‚îú‚îÄ‚îÄ cms_rules                  (Business rules)
```

#### **Health/Insurance Data** (24 tables - Shared/Reference):
```
‚îú‚îÄ‚îÄ health_plans               (Plan catalog)
‚îú‚îÄ‚îÄ health_carriers            (Carrier info)
‚îú‚îÄ‚îÄ health_facilities          (Provider directory)
‚îú‚îÄ‚îÄ medicare_plans             (Medicare catalog)
‚îú‚îÄ‚îÄ medicare_carriers          (Medicare carriers)
‚îú‚îÄ‚îÄ medicare_providers         (Provider directory)
‚îú‚îÄ‚îÄ drug_formularies           (Drug coverage)
‚îú‚îÄ‚îÄ formulary_drugs            (Drug details)
‚îú‚îÄ‚îÄ plan_documents             (Plan materials)
‚îú‚îÄ‚îÄ plan_recommendations       (AI recommendations)
‚îú‚îÄ‚îÄ zip_code_mappings          (Geographic data)
‚îú‚îÄ‚îÄ data_update_logs           (Update tracking)
‚îú‚îÄ‚îÄ brokers                    (Broker directory)
‚îú‚îÄ‚îÄ reviews                    (Plan reviews)
‚îú‚îÄ‚îÄ review_requests            (Review requests)
‚îú‚îÄ‚îÄ review_templates           (Review templates)
‚îú‚îÄ‚îÄ knowledge_detection_patterns  (AI patterns)
‚îú‚îÄ‚îÄ knowledge_detection_pattern_history  (Pattern history)
‚îú‚îÄ‚îÄ knowledge_source_feedback  (Feedback tracking)
‚îú‚îÄ‚îÄ ai_suggestions             (AI recommendations)
‚îú‚îÄ‚îÄ ai_suggestion_feedback     (Feedback)
‚îú‚îÄ‚îÄ ai_performance_metrics     (AI metrics)
‚îú‚îÄ‚îÄ ad_clicks                  (Ad tracking)
‚îú‚îÄ‚îÄ ad_impressions             (Ad metrics)
‚îî‚îÄ‚îÄ mail_logs                  (Email logs)
```

### **Who Manages:**
- **Owner**: CRM Agent
- **Schema Changes**: CRM agent only
- **Data Access**: CRM application only

---

## üö´ **CRITICAL: What This Means**

### ‚ùå **Marketing Agent CANNOT:**
- Access CRM database
- Modify CRM tables
- Read client data
- Touch appointment data

### ‚ùå **CRM Agent CANNOT:**
- Access marketing database
- Modify marketing site tables
- Read marketing admin data
- Touch blog/CMS content

### ‚úÖ **Integration Method:**
```
Marketing Site ‚Üí CRM API ‚Üí CRM Database
             (API calls only, no direct DB access)
```

---

## üîí **Security Principles**

1. **Principle of Least Privilege**: Each system only accesses its own database
2. **API-Only Integration**: Cross-system communication via REST APIs only
3. **No Shared Database**: Complete data isolation
4. **Separate Credentials**: Each database has its own credentials

---

## üìã **Table Naming Confusion Prevention**

### **Tables That Exist in BOTH Databases (Different Purpose):**

| Table Name | In Marketing DB | In CRM DB |
|------------|-----------------|-----------|
| `booking_pages` | ‚úÖ Marketing booking pages | ‚úÖ CRM appointment booking |
| `event_types` | ‚úÖ Marketing events | ‚úÖ CRM event definitions |

**Prevention**: Always check which database you're connected to before assuming ownership!

---

## üîç **Verification Commands**

### **To Check Which Database You're Connected To:**

```sql
-- Check database connection
SELECT current_database(), 
       current_user,
       inet_server_addr() as host;

-- Count tables (quick verification)
SELECT COUNT(*) as table_count 
FROM information_schema.tables 
WHERE table_schema = 'public';

-- Expected Results:
-- Marketing DB: ~22 tables
-- CRM DB: ~81 tables
```

### **To Check Table Ownership:**

```sql
-- Check if marketing-specific tables exist (only in marketing DB)
SELECT EXISTS (
  SELECT 1 FROM information_schema.tables 
  WHERE table_name = 'blog_posts'
) as is_marketing_db;

-- Check if CRM-specific tables exist (only in CRM DB)
SELECT EXISTS (
  SELECT 1 FROM information_schema.tables 
  WHERE table_name = 'clients'
) as is_crm_db;
```

---

## üö® **Before Making ANY Schema Changes:**

### **Required Checklist:**

- [ ] Verify which database I'm connected to
- [ ] Confirm table count matches expected (22 vs 81)
- [ ] Check table ownership in this document
- [ ] Verify no other agent is using this table
- [ ] Document the change
- [ ] Test in development first

---

## üìû **When In Doubt:**

1. **Stop** - Don't make changes
2. **Verify** - Check connection and table count
3. **Document** - Refer to this architecture doc
4. **Ask** - Confirm with Mario if uncertain

---

## üìö **Related Documentation:**

- `.ai/prd.md` - CRM Product Requirements
- `DATABASE_SEPARATION_COMPLETE.md` - Separation history
- `SHARED_DATABASE_ALERT.md` - Initial investigation (archived)

---

**Remember**: TWO separate databases = TWO separate systems. Never assume shared access!

---

**Last Verified**: December 18, 2024  
**Verification Method**: Direct table count and query analysis  
**Status**: ‚úÖ Confirmed Accurate



# ============================================
# FOAM USAGE
# ============================================

# Using Foam with PRD

## What is Foam?

Foam is a VS Code extension that enhances Markdown files with:
- **Wikilinks**: `[[epic-01]]` to link between sections
- **Graph View**: Visualize connections between epics
- **Backlinks**: See what links to each epic
- **Better Navigation**: Jump between related sections

## Setup

‚úÖ **Already Configured**: `.vscode/settings.json` is set up

## Using Foam with PRD

### View Graph
1. Open `.ai/prd.md`
2. Press `Ctrl+Shift+P` (or `Cmd+Shift+P` on Mac)
3. Type "Foam: Show Graph"
4. See visual connections between epics

### Create Links
You can add wikilinks in the PRD:
```markdown
See [[Epic 1: Core CRM Foundation]] for details.
```

### Navigate
- Click on `[[epic-name]]` links to jump to that section
- Use backlinks to see what references each epic

## Benefits

- ‚úÖ **No file splitting needed** - Works with large files
- ‚úÖ **Better navigation** - Graph view shows epic relationships
- ‚úÖ **Easy linking** - Connect related epics with wikilinks
- ‚úÖ **Agent-friendly** - Agents still read `.ai/prd.md` normally

## For AI Agents

Agents should continue to:
1. Read `.ai/prd.md` as the primary source
2. Use Foam features for navigation if needed
3. Follow existing workflow rules

Foam is just a navigation aid - it doesn't change how agents read the PRD.


# ============================================
# EPIC 3 STORIES
# ============================================


## Story 3.1: Client Portal Foundation

# Story 3.1: Client Portal Foundation

**Epic**: [[Epic 3: Client Portal]]  
**Status**: üöß In Progress  
**Priority**: P1 (High)  
**Created**: 2025-01-13  
**Last Updated**: 2025-01-13  
**Implementation Started**: 2025-01-13

---

## Description

Set up Next.js project structure, configure Mantine UI, and integrate with existing backend API. Note: Magic link authentication backend is already implemented at `/api/client-auth/magic-link/*`.

**Context**: The client portal backend API is complete and ready. This story focuses on creating the frontend Next.js application that will consume these APIs. See [[Epic 3: Client Portal]] for full epic context and related stories.

---

## Acceptance Criteria

- [ ] Next.js 14+ project created with App Router
- [ ] Mantine UI configured and styled (consistent with CRM)
- [ ] Magic link authentication frontend implemented (backend API exists at `/api/client-auth/magic-link/*`)
- [ ] Basic login page created (email input ‚Üí magic link request)
- [ ] Token verification page created (handles magic link callback)
- [ ] Integration with existing client portal API endpoints
- [ ] Environment configuration for API URLs

---

## Technical Requirements

### Project Setup
- **Framework**: Next.js 14+ with App Router
- **Location**: `crm/client-portal/` (new directory)
- **UI Library**: Mantine 8.3.6 (consistent with CRM)
- **Styling**: Tailwind CSS + Mantine
- **TypeScript**: Full TypeScript support

### Authentication Flow
1. User enters email on login page
2. Frontend calls `POST /api/client-auth/magic-link/send`
3. User receives email with magic link
4. User clicks link ‚Üí redirects to `/verify?token=...`
5. Frontend calls `POST /api/client-auth/magic-link/verify`
6. On success, store JWT token and redirect to dashboard

### API Integration
- **Base URL**: `http://localhost:3000/api` (development)
- **Endpoints to integrate**:
  - `POST /api/client-auth/magic-link/send`
  - `POST /api/client-auth/magic-link/verify`
  - `GET /api/client-portal/profile`
  - `GET /api/client-portal/summary`
  - `GET /api/client-portal/members`
  - `GET /api/client-portal/pcp`
  - `GET /api/client-portal/broker`
  - `GET /api/client-portal/documents`

### Project Structure
```
crm/client-portal/
‚îú‚îÄ‚îÄ app/
‚îÇ   ‚îú‚îÄ‚îÄ (auth)/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ login/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx          # Magic link login page
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ verify/
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ page.tsx          # Token verification page
‚îÇ   ‚îú‚îÄ‚îÄ (portal)/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ dashboard/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ page.tsx          # Dashboard (future - Story 3.2)
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ layout.tsx            # Portal layout
‚îÇ   ‚îî‚îÄ‚îÄ layout.tsx                # Root layout
‚îú‚îÄ‚îÄ components/
‚îÇ   ‚îú‚îÄ‚îÄ auth/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ LoginForm.tsx
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ VerifyToken.tsx
‚îÇ   ‚îî‚îÄ‚îÄ shared/
‚îÇ       ‚îú‚îÄ‚îÄ Header.tsx
‚îÇ       ‚îî‚îÄ‚îÄ Footer.tsx
‚îú‚îÄ‚îÄ lib/
‚îÇ   ‚îú‚îÄ‚îÄ api.ts                    # API client functions
‚îÇ   ‚îî‚îÄ‚îÄ auth.ts                   # Auth utilities (token storage)
‚îú‚îÄ‚îÄ types/
‚îÇ   ‚îî‚îÄ‚îÄ portal.ts                 # TypeScript types
‚îú‚îÄ‚îÄ public/
‚îÇ   ‚îî‚îÄ‚îÄ assets/
‚îú‚îÄ‚îÄ package.json
‚îú‚îÄ‚îÄ tsconfig.json
‚îú‚îÄ‚îÄ next.config.js
‚îî‚îÄ‚îÄ tailwind.config.ts
```

---

## Implementation Tasks

### Task 1: Project Initialization
- [x] Create `crm/client-portal/` directory
- [x] Initialize Next.js 14+ project with TypeScript
- [x] Configure App Router structure
- [x] Set up package.json with dependencies:
  - `next@16.0.3` (meets 14+ requirement)
  - `react@19.2.0`
  - `react-dom@19.2.0`
  - `@mantine/core@8.3.6`
  - `@mantine/hooks@8.3.6`
  - `@mantine/form@8.3.6`
  - `@mantine/notifications@8.3.6`
  - `@tabler/icons-react@3.35.0`
  - `typescript@5`
  - `tailwindcss@4`

### Task 2: Mantine UI Configuration
- [x] Install and configure Mantine providers
- [x] Set up Mantine theme (consistent with CRM)
- [x] Configure Tailwind CSS
- [x] Create root layout with Mantine providers
- [ ] Test Mantine components rendering (pending manual test)

### Task 3: Authentication Pages
- [x] Create login page (`app/(auth)/login/page.tsx`)
  - Email input field
  - Submit button
  - Loading state
  - Error handling
  - Success message
- [x] Create verify page (`app/(auth)/verify/page.tsx`)
  - Token extraction from URL query
  - API call to verify token
  - Loading state
  - Error handling
  - Success redirect to dashboard

### Task 4: API Client Setup
- [x] Create `lib/api.ts` with API client functions
- [x] Implement `sendMagicLink(email: string)`
- [x] Implement `verifyMagicLink(token: string)`
- [x] Implement `getClientProfile()`
- [x] Add error handling and type safety
- [x] Configure base URL from environment variables

### Task 5: Auth Utilities
- [x] Create `lib/auth.ts` with auth utilities
- [x] Implement token storage (localStorage)
- [x] Implement token retrieval
- [x] Implement token removal (logout)
- [x] Implement client data storage
- [ ] Create auth context/provider (optional - skipped for now)

### Task 6: Environment Configuration
- [x] Create `.env.local` file
- [x] Add `NEXT_PUBLIC_API_URL` variable
- [x] Configure for development (localhost:3000)
- [x] Document environment variables

### Task 7: TypeScript Types
- [x] Create `types/portal.ts`
- [x] Define API response types
- [x] Define client profile types
- [x] Define authentication types

### Task 8: Testing & Verification
- [ ] Test login flow (email ‚Üí magic link request) (pending manual test)
- [ ] Test magic link email delivery (pending manual test)
- [ ] Test token verification flow (pending manual test)
- [ ] Test API integration (all endpoints) (pending manual test)
- [ ] Verify Mantine UI consistency with CRM (pending manual test)
- [ ] Test responsive design (mobile-friendly) (pending manual test)

---

## Dependencies

**External Dependencies**:
- Backend API must be running (port 3000)
- SendGrid email service must be configured
- Database must have `portal_config` table

**Internal Dependencies**:
- None (backend API already complete)

---

## Estimated Effort

**Total**: 1 week (5 working days)

**Breakdown**:
- Project setup: 0.5 days
- Mantine configuration: 0.5 days
- Authentication pages: 1.5 days
- API client setup: 1 day
- Auth utilities: 0.5 days
- Environment config: 0.5 days
- TypeScript types: 0.5 days
- Testing & verification: 1 day

---

## Definition of Done

- [x] Next.js project created and running (Next.js 14.2.18, build successful)
- [x] Mantine UI configured and styled
- [x] Login page functional (email ‚Üí magic link request)
- [x] Verify page functional (token ‚Üí authentication)
- [x] API client integrated with all endpoints
- [ ] Authentication flow working end-to-end (pending manual testing)
- [x] TypeScript types defined
- [x] Environment variables configured
- [x] Code reviewed (no linter errors)
- [ ] Manual testing completed
- [ ] Story marked as complete in PRD (pending testing)

---

## Notes

- Backend API is already implemented and tested
- Magic link authentication backend exists at `/api/client-auth/magic-link/*`
- Client portal API endpoints exist at `/api/client-portal/*`
- Focus on frontend implementation only
- Maintain consistency with CRM UI/UX

---

## Git Branch

**Branch Name**: `feature/epic-3-story-1-client-portal-foundation`

**Commit Convention**: `feat(epic-3/story-1): <description>`

---

## Related Files

- Backend API: `crm/server/src/routes/client-auth.ts`
- Backend API: `crm/server/src/routes/client-portal.ts`
- PRD: `.ai/prd.md` (Epic 3, Story 3.1)
- Architecture: `.ai/arch.md`

---

**Status**: üöß In Progress (7/8 tasks complete, testing pending)  
**Next Story**: Story 3.2 - Plan Summary Dashboard

---

## Implementation Progress

**Completed (2025-01-13)**:
- ‚úÖ Next.js 16.0.3 project initialized with App Router
- ‚úÖ Mantine 8.3.6 configured and integrated
- ‚úÖ Project structure created (app/(auth), app/(portal), components, lib, types)
- ‚úÖ Login page component created with form validation
- ‚úÖ Verify page component created with token handling
- ‚úÖ API client implemented (lib/api.ts)
- ‚úÖ Auth utilities implemented (lib/auth.ts)
- ‚úÖ TypeScript types defined (types/portal.ts)
- ‚úÖ Environment configuration (.env.local)
- ‚úÖ Root page redirects to login/dashboard
- ‚úÖ Portal layout with auth protection

**Pending**:
- ‚è≥ Manual testing of login flow
- ‚è≥ Manual testing of token verification
- ‚è≥ Manual testing of API integration
- ‚è≥ UI/UX verification with CRM consistency

**Build Status (2025-01-13)**:
- ‚úÖ Downgraded to Next.js 14.2.18 (Node.js 18 compatible)
- ‚úÖ Build successful
- ‚úÖ TypeScript compilation successful
- ‚úÖ All pages generated (8/8)
- ‚úÖ Fixed Suspense boundary for useSearchParams
- ‚úÖ Fixed TypeScript headers type issue

---

## Related Stories

- Next: [[Story 3.2: Plan Summary Dashboard]]
- See [[Epic 3: Client Portal]] for all stories in this epic



## Story 3.2: Plan Summary Dashboard

# Story 3.2: Plan Summary Dashboard

**Epic**: [[Epic 3: Client Portal]]  
**Status**: üöß In Progress  
**Priority**: P1 (High)  
**Created**: 2025-01-13  
**Last Updated**: 2025-01-13  
**Implementation Started**: 2025-01-13

---

## Description

Create the main dashboard page showing plan summaries for Health, Dental, and Vision plans with enrolled members and PCP information. This is the primary landing page after authentication.

**Context**: The client portal backend API is complete. This story focuses on creating the dashboard UI that displays plan information, enrolled members, PCP details, and broker information. See [[Epic 3: Client Portal]] for full epic context and related stories.

---

## Acceptance Criteria

- [ ] Dashboard page layout created
- [ ] Health Plan card component with all fields:
  - Enrolled Carrier
  - Plan Type (HMO, PPO, etc.)
  - Metal Tier
  - Member Services Phone
  - Effective Date
  - Covered CA Case # (if applicable)
  - Premium information (Gross, Subsidy, Net)
- [ ] Dental Plan card component
- [ ] Vision Plan card component
- [ ] Enrolled Members section
- [ ] Primary Care Physician section
- [ ] Broker Information section
- [ ] Responsive design (mobile-friendly)

---

## Technical Requirements

### API Endpoints

- `GET /api/client-portal/health-insurance` - Returns health insurance data including:
  - `healthPlans[]` - Array of health plans
  - `dentalPlans[]` - Array of dental plans
  - `visionPlans[]` - Array of vision plans
  - `primaryApplicant` - Primary member info
  - `spouse` - Spouse info (if applicable)
  - `children[]` - Children array
  - `planSelections` - Plan selection details including broker
  - `primaryCarePhysician` - PCP name

### Data Structure

**Health Plan Object**:
```typescript
{
  member: string;           // 'primary', 'spouse', 'child-1', etc.
  carrier: string;          // Carrier name
  planName: string;         // Plan name
  metalTier: string;        // Bronze, Silver, Gold, Platinum
  planType: string;         // HMO, PPO, EPO, etc.
  policyNumber?: string;    // Policy number
  grossPremium?: number;    // Gross premium
  aptc?: number;           // Advanced Premium Tax Credit
  caCredit?: number;       // California credit
  netPremium?: number;     // Net premium after credits
  memberServices?: string; // Member services phone
  isSecondary?: boolean;   // If secondary plan
}
```

**Plan Selections**:
```typescript
{
  state: string;
  coverageEffectiveDate?: string;
  coveredCaCaseNumber?: string;
  totalMembersEnrolled: number;
  broker?: {
    name?: string;
    npn?: string;
    email?: string;
    phone?: string;
  };
}
```

---

## Implementation Tasks

### Task 1: Dashboard Layout
- [x] Create dashboard page component
- [x] Set up responsive grid layout
- [x] Add page header with welcome message
- [x] Create section containers for plan cards

### Task 2: Health Plan Card Component
- [x] Create `HealthPlanCard.tsx` component
- [x] Display carrier name
- [x] Display plan type (HMO, PPO, etc.)
- [x] Display metal tier with badge
- [x] Display member services phone (clickable)
- [x] Display effective date
- [x] Display Covered CA case number (if applicable)
- [x] Display premium breakdown (Gross, Subsidy, Net)
- [x] Handle multiple health plans (primary + secondary)
- [x] Add loading and error states

### Task 3: Dental Plan Card Component
- [x] Create `DentalPlanCard.tsx` component
- [x] Display carrier name
- [x] Display plan name
- [x] Display plan type
- [x] Display monthly premium
- [x] Display member services phone
- [x] Handle multiple dental plans (if applicable)

### Task 4: Vision Plan Card Component
- [x] Create `VisionPlanCard.tsx` component
- [x] Display carrier name
- [x] Display plan name
- [x] Display monthly premium
- [x] Display member services phone
- [x] Handle multiple vision plans (if applicable)

### Task 5: Enrolled Members Section
- [x] Create `EnrolledMembers.tsx` component
- [x] Display primary applicant
- [x] Display spouse (if applicable)
- [x] Display children list
- [x] Show member names and DOBs
- [x] Indicate which members are covered

### Task 6: Primary Care Physician Section
- [x] Create `PrimaryCarePhysician.tsx` component
- [x] Display PCP name
- [x] Show "Not assigned" if no PCP
- [x] Add styling consistent with other cards

### Task 7: Broker Information Section
- [x] Create `BrokerInfo.tsx` component
- [x] Display broker name
- [x] Display NPN (if available)
- [x] Display contact information (email, phone)
- [x] Add clickable contact links

### Task 8: API Integration
- [x] Update `lib/api.ts` with `getHealthInsuranceData()` function
- [x] Add error handling for API calls
- [x] Add loading states
- [x] Handle empty states (no plans, no members, etc.)

### Task 9: TypeScript Types
- [x] Update `types/portal.ts` with health insurance types
- [x] Add plan types (HealthPlan, DentalPlan, VisionPlan)
- [x] Add member types (PrimaryApplicant, Spouse, Child)
- [x] Add plan selections type

### Task 10: Responsive Design
- [x] Test mobile layout (SimpleGrid and Grid with responsive spans)
- [x] Ensure cards stack properly on mobile
- [x] Test tablet layout
- [ ] Verify all text is readable on small screens (pending manual test)

---

## Dependencies

**External Dependencies**:
- Backend API must be running (port 3000)
- Client must have health insurance line of business
- Client must be authenticated

**Internal Dependencies**:
- Story 3.1 (Authentication and API client setup)

---

## Estimated Effort

**Total**: 1 week (5 working days)

**Breakdown**:
- Dashboard layout: 0.5 days
- Health Plan card: 1 day
- Dental/Vision cards: 1 day
- Enrolled Members section: 0.5 days
- PCP section: 0.5 days
- Broker section: 0.5 days
- API integration: 1 day
- TypeScript types: 0.5 days
- Responsive design: 0.5 days

---

## Definition of Done

- [x] Dashboard page displays all plan information
- [x] All plan cards show correct data from API
- [x] Enrolled members section displays all family members
- [x] PCP information displays correctly
- [x] Broker information displays correctly
- [x] Responsive design works on mobile, tablet, desktop (code complete, pending manual test)
- [x] Loading states implemented
- [x] Error states implemented
- [x] Empty states handled gracefully
- [x] TypeScript types defined
- [x] Code reviewed (no linter errors, build successful)
- [ ] Manual testing completed

---

## Notes

- Backend API endpoint `/api/client-portal/health-insurance` is already implemented
- Data comes from `form_submission_data` JSON field in clients table
- Some fields may be optional (Covered CA case number, PCP, etc.)
- Handle cases where client has no plans or incomplete data

---

## Git Branch

**Branch Name**: `feature/epic-3-story-2-plan-summary-dashboard`

**Commit Convention**: `feat(epic-3/story-2): <description>`

---

## Related Files

- Backend API: `crm/server/src/routes/client-portal.ts` (health-insurance endpoint)
- PRD: `.ai/prd.md` (Epic 3, Story 3.2)
- Architecture: `.ai/arch.md`
- Story 3.1: `.ai/epic-3/story-3.1.story.md`

---

**Status**: üöß In Progress (9/10 tasks complete, responsive testing pending)  
**Next Story**: Story 3.3 - Document Management

---

## Implementation Progress

**Completed (2025-01-13)**:
- ‚úÖ Dashboard page component with API integration
- ‚úÖ Health Plan Card component (all fields)
- ‚úÖ Dental Plan Card component
- ‚úÖ Vision Plan Card component
- ‚úÖ Enrolled Members component
- ‚úÖ Primary Care Physician component
- ‚úÖ Broker Information component
- ‚úÖ API client function (`getHealthInsuranceData`)
- ‚úÖ TypeScript types (HealthPlan, DentalPlan, VisionPlan, FamilyMember, PlanSelections, HealthInsuranceData)
- ‚úÖ Responsive grid layout (SimpleGrid, Grid with responsive spans)
- ‚úÖ Loading and error states
- ‚úÖ Empty state handling

**Pending**:
- ‚è≥ Manual responsive design testing
- ‚è≥ Manual API integration testing

---

## Related Stories

- Previous: [[Story 3.1: Client Portal Foundation]]
- See [[Epic 3: Client Portal]] for all stories in this epic

